#!/bin/bash
#
# Network Optimizer Agent - Linux Installation Script
#

set -e

echo "=== Network Optimizer Agent Installation ==="
echo "Agent ID: {{ agent_id }}"
echo "Device: {{ device_name }}"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "ERROR: This script must be run as root"
    echo "Please run: sudo $0"
    exit 1
fi

echo "✓ Running as root"

# Detect Linux distribution
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
    OS_VERSION=$VERSION_ID
    echo "✓ Detected $PRETTY_NAME"
else
    echo "WARNING: Could not detect Linux distribution"
    OS="unknown"
fi

# Create necessary directories
echo "Creating directories..."
mkdir -p /opt/network-optimizer
mkdir -p /var/log/network-optimizer
chmod 755 /opt/network-optimizer
chmod 755 /var/log/network-optimizer

# Check for required commands
echo "Checking dependencies..."

if ! command -v curl &> /dev/null; then
    echo "ERROR: curl is not installed"
    echo "Please install curl:"
    case $OS in
        ubuntu|debian)
            echo "  sudo apt-get install curl"
            ;;
        centos|rhel|fedora)
            echo "  sudo yum install curl"
            ;;
        *)
            echo "  Use your package manager to install curl"
            ;;
    esac
    exit 1
fi
echo "✓ curl found"

if ! command -v bc &> /dev/null; then
    echo "Installing bc (basic calculator)..."
    case $OS in
        ubuntu|debian)
            apt-get install -y bc
            ;;
        centos|rhel|fedora)
            yum install -y bc
            ;;
        *)
            echo "WARNING: Could not install bc automatically"
            ;;
    esac
fi

# Check for Docker if Docker metrics are enabled
ENABLE_DOCKER="{{ enable_docker }}"
if [ "$ENABLE_DOCKER" = "True" ] || [ "$ENABLE_DOCKER" = "true" ]; then
    if ! command -v docker &> /dev/null; then
        echo "WARNING: Docker metrics enabled but Docker not found"
        echo "Docker metrics will be disabled"
    else
        echo "✓ Docker found"

        # Check if current user can access Docker
        if docker ps &> /dev/null; then
            echo "✓ Docker access verified"
        else
            echo "WARNING: Cannot access Docker socket"
            echo "You may need to run: sudo usermod -aG docker $USER"
        fi
    fi
fi

# Test InfluxDB connection
echo "Testing InfluxDB connection..."
INFLUXDB_URL="{{ influxdb_url }}"
INFLUXDB_ORG="{{ influxdb_org }}"
INFLUXDB_BUCKET="{{ influxdb_bucket }}"
INFLUXDB_TOKEN="{{ influxdb_token }}"

curl_output=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST "${INFLUXDB_URL}/api/v2/write?org=${INFLUXDB_ORG}&bucket=${INFLUXDB_BUCKET}" \
    -H "Authorization: Token ${INFLUXDB_TOKEN}" \
    -H "Content-Type: text/plain" \
    --data-binary "test,source=installer value=1")

if [ "$curl_output" = "204" ]; then
    echo "✓ InfluxDB connection successful"
else
    echo "WARNING: InfluxDB connection returned HTTP $curl_output"
    echo "Please verify your InfluxDB configuration"
fi

# Make agent script executable
if [ -f "/opt/network-optimizer/agent.sh" ]; then
    chmod +x /opt/network-optimizer/agent.sh
    echo "✓ Agent script configured"
fi

# Check if systemd is available
if command -v systemctl &> /dev/null; then
    if [ -f "/etc/systemd/system/network-optimizer-agent.service" ]; then
        echo "Configuring systemd service..."
        systemctl daemon-reload
        systemctl enable network-optimizer-agent.service
        systemctl restart network-optimizer-agent.service

        # Wait a moment and check status
        sleep 2
        if systemctl is-active --quiet network-optimizer-agent.service; then
            echo "✓ Service started successfully"
        else
            echo "WARNING: Service may have failed to start"
            echo "Check status with: systemctl status network-optimizer-agent.service"
        fi
    fi
else
    echo "WARNING: systemd not found, service will not auto-start"
    echo "You can run the agent manually:"
    echo "  /opt/network-optimizer/agent.sh"
fi

echo ""
echo "=== Installation Complete ==="
echo ""
echo "Service status:"
if command -v systemctl &> /dev/null; then
    systemctl status network-optimizer-agent.service --no-pager || true
fi
echo ""
echo "To view logs:"
echo "  tail -f /var/log/network-optimizer/agent.log"
if command -v journalctl &> /dev/null; then
    echo "  journalctl -u network-optimizer-agent.service -f"
fi
echo ""
echo "To stop the agent:"
echo "  systemctl stop network-optimizer-agent.service"
echo ""
echo "To restart the agent:"
echo "  systemctl restart network-optimizer-agent.service"
echo ""
