#!/bin/bash
#
# Network Optimizer - Linux Agent
#
# Configuration
AGENT_ID="{{ agent_id }}"
DEVICE_NAME="{{ device_name }}"
AGENT_TYPE="{{ agent_type }}"
INFLUXDB_URL="{{ influxdb_url }}"
INFLUXDB_ORG="{{ influxdb_org }}"
INFLUXDB_BUCKET="{{ influxdb_bucket }}"
INFLUXDB_TOKEN="{{ influxdb_token }}"
COLLECTION_INTERVAL={{ collection_interval }}
ENABLE_DOCKER={{ enable_docker }}

# Paths
LOG_DIR="/var/log/network-optimizer"
LOG_FILE="$LOG_DIR/agent.log"

# Ensure log directory exists
mkdir -p "$LOG_DIR"

# Logging function
log() {
    echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] $1" | tee -a "$LOG_FILE"
}

# Send metrics to InfluxDB
send_metric() {
    local measurement=$1
    local tags=$2
    local fields=$3
    local timestamp=$(date +%s)000000000

    local line_protocol="${measurement},agent_id=${AGENT_ID},device=${DEVICE_NAME},agent_type=${AGENT_TYPE}${tags} ${fields} ${timestamp}"

    curl -s -X POST "${INFLUXDB_URL}/api/v2/write?org=${INFLUXDB_ORG}&bucket=${INFLUXDB_BUCKET}" \
        -H "Authorization: Token ${INFLUXDB_TOKEN}" \
        -H "Content-Type: text/plain" \
        --data-binary "$line_protocol" >/dev/null 2>&1

    if [ $? -eq 0 ]; then
        log "Sent metric: $measurement"
    else
        log "ERROR: Failed to send metric: $measurement"
    fi
}

# Collect CPU metrics
collect_cpu_metrics() {
    # Get CPU usage using top
    local cpu_usage=$(top -bn2 -d 0.5 | grep "Cpu(s)" | tail -1 | awk '{print $2}' | sed 's/%us,//')

    # Get load averages
    local load_avg_1=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
    local load_avg_5=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $2}' | sed 's/,//')
    local load_avg_15=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $3}' | sed 's/,//')

    # Get CPU count
    local cpu_count=$(nproc)

    send_metric "cpu_stats" "" "usage_percent=${cpu_usage},load_1m=${load_avg_1},load_5m=${load_avg_5},load_15m=${load_avg_15},cpu_count=${cpu_count}i"
}

# Collect memory metrics
collect_memory_metrics() {
    local mem_total=$(free -b | grep Mem | awk '{print $2}')
    local mem_used=$(free -b | grep Mem | awk '{print $3}')
    local mem_free=$(free -b | grep Mem | awk '{print $4}')
    local mem_available=$(free -b | grep Mem | awk '{print $7}')
    local mem_percent=$(awk "BEGIN {printf \"%.2f\", ($mem_used/$mem_total)*100}")

    local swap_total=$(free -b | grep Swap | awk '{print $2}')
    local swap_used=$(free -b | grep Swap | awk '{print $3}')

    send_metric "memory_stats" "" "total=${mem_total}i,used=${mem_used}i,free=${mem_free}i,available=${mem_available}i,percent=${mem_percent},swap_total=${swap_total}i,swap_used=${swap_used}i"
}

# Collect disk metrics
collect_disk_metrics() {
    # Get disk usage for root filesystem
    local disk_info=$(df -B1 / | tail -1)
    local disk_total=$(echo $disk_info | awk '{print $2}')
    local disk_used=$(echo $disk_info | awk '{print $3}')
    local disk_available=$(echo $disk_info | awk '{print $4}')
    local disk_percent=$(echo $disk_info | awk '{print $5}' | sed 's/%//')

    send_metric "disk_stats" ",mount=/" "total=${disk_total}i,used=${disk_used}i,available=${disk_available}i,percent=${disk_percent}"

    # Get disk I/O stats if available
    if [ -f /proc/diskstats ]; then
        local disk_device=$(df / | tail -1 | awk '{print $1}' | sed 's/\/dev\///' | sed 's/[0-9]*$//')
        local disk_stats=$(grep " ${disk_device} " /proc/diskstats | head -1)

        if [ -n "$disk_stats" ]; then
            local reads_completed=$(echo $disk_stats | awk '{print $4}')
            local writes_completed=$(echo $disk_stats | awk '{print $8}')

            send_metric "disk_io" ",device=${disk_device}" "reads=${reads_completed}i,writes=${writes_completed}i"
        fi
    fi
}

# Collect network metrics
collect_network_metrics() {
    # Get all network interfaces except loopback
    for iface in $(ls /sys/class/net/ | grep -v lo); do
        if [ -f "/sys/class/net/${iface}/statistics/rx_bytes" ]; then
            local rx_bytes=$(cat /sys/class/net/${iface}/statistics/rx_bytes)
            local tx_bytes=$(cat /sys/class/net/${iface}/statistics/tx_bytes)
            local rx_packets=$(cat /sys/class/net/${iface}/statistics/rx_packets)
            local tx_packets=$(cat /sys/class/net/${iface}/statistics/tx_packets)
            local rx_errors=$(cat /sys/class/net/${iface}/statistics/rx_errors)
            local tx_errors=$(cat /sys/class/net/${iface}/statistics/tx_errors)

            send_metric "network_stats" ",interface=${iface}" "rx_bytes=${rx_bytes}i,tx_bytes=${tx_bytes}i,rx_packets=${rx_packets}i,tx_packets=${tx_packets}i,rx_errors=${rx_errors}i,tx_errors=${tx_errors}i"
        fi
    done
}

# Collect Docker metrics
collect_docker_metrics() {
    if [ "$ENABLE_DOCKER" != "True" ] && [ "$ENABLE_DOCKER" != "true" ]; then
        return
    fi

    if ! command -v docker &> /dev/null; then
        return
    fi

    # Get running container count
    local container_count=$(docker ps -q 2>/dev/null | wc -l)
    send_metric "docker_stats" "" "running_containers=${container_count}i"

    # Get stats for each running container
    docker ps --format '{{.Names}}' 2>/dev/null | while read container; do
        local stats=$(docker stats --no-stream --format "{{.CPUPerc}},{{.MemUsage}},{{.NetIO}},{{.BlockIO}}" "$container" 2>/dev/null)

        if [ -n "$stats" ]; then
            local cpu=$(echo $stats | cut -d',' -f1 | sed 's/%//')
            local mem=$(echo $stats | cut -d',' -f2 | awk '{print $1}' | numfmt --from=iec)

            send_metric "docker_container" ",container=${container}" "cpu_percent=${cpu},memory_bytes=${mem}i"
        fi
    done
}

# Send heartbeat
send_heartbeat() {
    local uptime_seconds=$(cat /proc/uptime | awk '{print int($1)}')
    send_metric "agent_heartbeat" "" "status=1i,uptime=${uptime_seconds}i"
}

# Signal handlers for graceful shutdown
shutdown() {
    log "Received shutdown signal, stopping agent..."
    exit 0
}

trap shutdown SIGTERM SIGINT

# Main collection loop
log "Starting Network Optimizer Linux agent"
log "Agent ID: $AGENT_ID"
log "Device: $DEVICE_NAME"
log "Collection interval: ${COLLECTION_INTERVAL}s"
log "Docker metrics: $ENABLE_DOCKER"

# Send initial heartbeat
send_heartbeat

while true; do
    # Collect all metrics
    collect_cpu_metrics
    collect_memory_metrics
    collect_disk_metrics
    collect_network_metrics
    collect_docker_metrics
    send_heartbeat

    # Wait for next collection
    sleep $COLLECTION_INTERVAL
done
