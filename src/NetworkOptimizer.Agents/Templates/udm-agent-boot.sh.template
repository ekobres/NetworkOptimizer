#!/bin/bash
#
# Network Optimizer Agent - Boot Script for UDM/UCG
# This script runs on boot via /data/on_boot.d/
#
# Agent ID: {{ agent_id }}
# Device: {{ device_name }}
#

AGENT_DIR="/data/network-optimizer"
COLLECTOR_SCRIPT="$AGENT_DIR/metrics-collector.sh"
LOG_FILE="$AGENT_DIR/agent.log"

# Ensure directory exists
mkdir -p "$AGENT_DIR"

# Log startup
echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] Network Optimizer agent starting..." >> "$LOG_FILE"

# Check if metrics collector exists
if [ ! -f "$COLLECTOR_SCRIPT" ]; then
    echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] ERROR: Metrics collector not found at $COLLECTOR_SCRIPT" >> "$LOG_FILE"
    exit 1
fi

# Make sure collector is executable
chmod +x "$COLLECTOR_SCRIPT"

# Kill any existing collector processes
pkill -f "metrics-collector.sh" 2>/dev/null

# Start the metrics collector in background
nohup "$COLLECTOR_SCRIPT" >> "$LOG_FILE" 2>&1 &
COLLECTOR_PID=$!

echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] Started metrics collector (PID: $COLLECTOR_PID)" >> "$LOG_FILE"

# Verify it's running
sleep 2
if ps -p $COLLECTOR_PID > /dev/null 2>&1; then
    echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] Metrics collector is running" >> "$LOG_FILE"
else
    echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] ERROR: Metrics collector failed to start" >> "$LOG_FILE"
    exit 1
fi

exit 0
