#!/bin/bash
#
# Network Optimizer Agent - UDM/UCG Installation Script
#
# This script handles initial setup and dependencies
#

set -e

echo "=== Network Optimizer Agent Installation ==="
echo "Agent ID: {{ agent_id }}"
echo "Device: {{ device_name }}"
echo ""

# Check if running on UDM/UCG
if [ ! -d "/data/on_boot.d" ]; then
    echo "ERROR: This doesn't appear to be a UDM/UCG device"
    echo "Missing /data/on_boot.d directory"
    exit 1
fi

echo "✓ Detected UniFi OS device"

# Create necessary directories
echo "Creating directories..."
mkdir -p /data/network-optimizer
chmod 755 /data/network-optimizer

# Check for required commands
echo "Checking dependencies..."

if ! command -v curl &> /dev/null; then
    echo "ERROR: curl is not installed"
    exit 1
fi
echo "✓ curl found"

if ! command -v tc &> /dev/null; then
    echo "WARNING: tc (traffic control) not found - SQM metrics may not work"
else
    echo "✓ tc found"
fi

# Install speedtest-cli if not present
if ! command -v speedtest-cli &> /dev/null; then
    echo "Installing speedtest-cli..."

    # Try to install via pip if available
    if command -v pip3 &> /dev/null; then
        pip3 install speedtest-cli
        echo "✓ speedtest-cli installed"
    elif command -v pip &> /dev/null; then
        pip install speedtest-cli
        echo "✓ speedtest-cli installed"
    else
        echo "WARNING: pip not found, speedtest-cli not installed"
        echo "Speedtests will be disabled"
    fi
else
    echo "✓ speedtest-cli found"
fi

# Test InfluxDB connection
echo "Testing InfluxDB connection..."
INFLUXDB_URL="{{ influxdb_url }}"
INFLUXDB_ORG="{{ influxdb_org }}"
INFLUXDB_BUCKET="{{ influxdb_bucket }}"
INFLUXDB_TOKEN="{{ influxdb_token }}"

curl_output=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST "${INFLUXDB_URL}/api/v2/write?org=${INFLUXDB_ORG}&bucket=${INFLUXDB_BUCKET}" \
    -H "Authorization: Token ${INFLUXDB_TOKEN}" \
    -H "Content-Type: text/plain" \
    --data-binary "test,source=installer value=1")

if [ "$curl_output" = "204" ]; then
    echo "✓ InfluxDB connection successful"
else
    echo "WARNING: InfluxDB connection returned HTTP $curl_output"
    echo "Please verify your InfluxDB configuration"
fi

# Make boot script executable
if [ -f "/data/on_boot.d/99-network-optimizer.sh" ]; then
    chmod +x /data/on_boot.d/99-network-optimizer.sh
    echo "✓ Boot script configured"
fi

# Make collector executable
if [ -f "/data/network-optimizer/metrics-collector.sh" ]; then
    chmod +x /data/network-optimizer/metrics-collector.sh
    echo "✓ Metrics collector configured"
fi

echo ""
echo "=== Installation Complete ==="
echo ""
echo "The agent will start automatically on next reboot."
echo "To start the agent now, run:"
echo "  /data/on_boot.d/99-network-optimizer.sh"
echo ""
echo "To view logs:"
echo "  tail -f /data/network-optimizer/agent.log"
echo "  tail -f /data/network-optimizer/collector.log"
echo ""
