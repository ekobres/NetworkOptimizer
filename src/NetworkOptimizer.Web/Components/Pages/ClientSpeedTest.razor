@page "/client-speedtest"
@rendermode InteractiveServer
@implements IDisposable
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.Web.Components.Shared
@inject ClientSpeedTestService ClientSpeedTestService
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@inject IJSRuntime JS

@* Uses unified Iperf3Result model with Direction field to distinguish test sources *@

<PageTitle>Client Speed Test - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Client Speed Test</h1>
    <p class="page-description">Test LAN speed from any device - phones, tablets, laptops</p>
</div>

<div class="client-speedtest-container">
    <!-- Test Instructions -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Run a Speed Test</h2>
        </div>
        <div class="card-body">
            <div class="test-options">
                <!-- OpenSpeedTest Option -->
                <div class="test-option">
                    <div class="test-option-header">
                        <h3>Browser Speed Test</h3>
                        <span class="badge badge-primary">Recommended</span>
                    </div>
                    <p>Run a speed test directly from any web browser. Works on all devices.</p>

                    @if (!string.IsNullOrEmpty(openSpeedTestUrl))
                    {
                        <div class="test-option-actions">
                            <a href="@(openSpeedTestUrl)?Run" target="_blank" class="btn btn-primary">
                                Run Speed Test
                            </a>
                            <span class="form-help">Opens in a new tab and auto-starts</span>
                        </div>
                        <div class="url-copy-row">
                            <code class="url-display">@openSpeedTestUrl</code>
                            <button class="btn-icon" title="Copy URL" @onclick="CopySpeedTestUrl">
                                @if (urlCopied)
                                {
                                    <span class="copy-check">âœ“</span>
                                }
                                else
                                {
                                    <span class="copy-icon">ðŸ“‹</span>
                                }
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <strong>Configuration Required:</strong> Set <code>HOST_IP</code> or <code>HOST_NAME</code> in your environment to enable browser speed testing.
                        </div>
                    }
                </div>

                <!-- iperf3 Option -->
                <div class="test-option">
                    <div class="test-option-header">
                        <h3>iperf3 Client</h3>
                        <span class="badge badge-secondary">Advanced</span>
                    </div>
                    <p>Use the iperf3 command-line tool for precise measurements.</p>

                    @if (iperf3ServerEnabled)
                    {
                        <div class="code-block">
                            <code>
                                <span class="code-comment"># Test upload speed (client to server, 4 streams)</span><br />
                                iperf3 -c @serverHost -P 4<br />
                                <br />
                                <span class="code-comment"># Test download speed (server to client, 4 streams)</span><br />
                                iperf3 -c @serverHost -P 4 -R<br />
                                <br />
                                <span class="code-comment"># Full bidirectional test (runs both directions simultaneously)</span><br />
                                iperf3 -c @serverHost -P 4 --bidir
                            </code>
                        </div>
                        <p class="form-help">
                            Install iperf3:<br />
                            <code>apt install iperf3</code> (Linux)<br />
                            <code>brew install iperf3</code> (Mac)<br />
                            <a href="https://iperf.fr/iperf-download.php" target="_blank">iperf.fr</a> (Windows)
                        </p>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <strong>Server Not Running:</strong> iperf3 server mode is disabled.
                            <br />
                            <span class="form-help">
                                Set <code>IPERF3_SERVER_ENABLED=true</code> in your environment to enable.
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Test History -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Test History</h2>
            <div class="header-actions">
                <button class="btn btn-sm btn-secondary" @onclick="LoadHistory" disabled="@loading">
                    @if (loading)
                    {
                        <span class="spinner"></span>
                        <span>Loading...</span>
                    }
                    else
                    {
                        <span>Refresh</span>
                    }
                </button>
            </div>
        </div>
        <div class="card-body">
            @if (testHistory.Count > 0)
            {
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Device</th>
                                <th>Source</th>
                                <th>
                                    <span class="tooltip-wrapper tooltip-bottom">
                                        â†“ Mbps
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <strong>From Device</strong><br />
                                            Data transferred from the client device.
                                        </span>
                                    </span>
                                </th>
                                <th>
                                    <span class="tooltip-wrapper tooltip-bottom">
                                        â†‘ Mbps
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <strong>To Device</strong><br />
                                            Data transferred to the client device.
                                        </span>
                                    </span>
                                </th>
                                <th>Ping</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var result in pagedHistory)
                            {
                                var isExpanded = expandedHistoryId == result.Id;
                                <tr class="history-row-clickable @(isExpanded ? "history-row-expanded" : "")"
                                    @onclick="@(() => ToggleHistoryExpand(result.Id))">
                                    <td>@result.TestTime.ToLocalTime().ToString("MMM dd HH:mm")</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(result.DeviceName))
                                        {
                                            <span>@result.DeviceName</span>
                                            <br />
                                            <code class="text-muted">@result.DeviceHost</code>
                                        }
                                        else
                                        {
                                            <code>@result.DeviceHost</code>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @GetSourceBadgeClass(result.Direction)">
                                            @GetSourceLabel(result.Direction)
                                        </span>
                                    </td>
                                    <td>
                                        <span class="speed-value">@result.DownloadMbps.ToString("F1")</span>
                                        <span class="speed-unit">Mbps</span>
                                    </td>
                                    <td>
                                        <span class="speed-value">@result.UploadMbps.ToString("F1")</span>
                                        <span class="speed-unit">Mbps</span>
                                    </td>
                                    <td>
                                        @if (result.PingMs.HasValue)
                                        {
                                            <span>@result.PingMs.Value.ToString("F0") ms</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="expand-chevron">
                                        <span>@(isExpanded ? "â–²" : "â–¼")</span>
                                    </td>
                                </tr>
                                <tr class="history-details-row">
                                    <td colspan="7">
                                        <div class="expand-wrapper @(isExpanded ? "expanded" : "")">
                                            <div class="expand-content">
                                                <div class="history-details">
                                                    <SpeedTestDetails Result="result" PathAnalysis="result.PathAnalysis" />
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (historyTotalPages > 1)
                {
                    <div class="pagination">
                        <button class="btn btn-sm btn-secondary" disabled="@(historyPage <= 1)" @onclick="() => historyPage--">Prev</button>
                        <span class="pagination-info">Page @historyPage of @historyTotalPages</span>
                        <button class="btn btn-sm btn-secondary" disabled="@(historyPage >= historyTotalPages)" @onclick="() => historyPage++">Next</button>
                    </div>
                }
            }
            else if (!loading)
            {
                <div class="empty-state">
                    <p>No client speed tests recorded yet.</p>
                    <p class="form-help">Run a speed test from any device to see results here.</p>
                </div>
            }
        </div>
    </div>

    <!-- How it Works -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">How it Works</h2>
        </div>
        <div class="card-body">
            <div class="info-section">
                <h4>Browser Speed Test (OpenSpeedTest)</h4>
                <ol>
                    <li>Open the speed test page from any device on your LAN</li>
                    <li>Click Start to run the test</li>
                    <li>Results are automatically sent to this server</li>
                    <li>Device is identified by IP address and matched to UniFi client list</li>
                </ol>

                <h4 style="margin-top: 1.5rem;">iperf3 Client</h4>
                <ol>
                    <li>Install iperf3 on your device</li>
                    <li>Run the command to connect to this server on port 5201</li>
                    <li>Server automatically captures and records results</li>
                    <li>Device is identified by the connecting IP address</li>
                </ol>

                <p class="form-help">
                    <strong>Note:</strong> This tests the LAN speed between client devices and the Network Optimizer server.
                    It's useful for identifying wireless bottlenecks, cable issues, or switch problems.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .client-speedtest-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .test-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .test-option {
        background: var(--bg-tertiary);
        border-radius: var(--border-radius);
        padding: 1.25rem;
    }

    .test-option-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .test-option-header h3 {
        margin: 0;
        font-size: 1rem;
    }

    .test-option p {
        margin: 0 0 1rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .test-option-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .url-copy-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding: 0.5rem;
        background: var(--bg-primary);
        border-radius: var(--border-radius);
    }

    .url-display {
        flex: 1;
        font-size: 0.8125rem;
        color: var(--text-secondary);
        word-break: break-all;
    }

    .btn-icon {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        font-size: 1rem;
        opacity: 0.7;
        transition: opacity 0.15s;
    }

    .btn-icon:hover {
        opacity: 1;
    }

    .copy-check {
        color: var(--success-color, #22c55e);
    }

    .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-primary {
        background: var(--accent-color);
        color: white;
    }

    .badge-secondary {
        background: var(--bg-secondary);
        color: var(--text-secondary);
    }

    .badge-openspeedtest {
        background: #0ea5e9;
        color: white;
    }

    .badge-iperf3 {
        background: #22c55e;
        color: white;
    }

    .code-block {
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        padding: 1rem;
        font-family: var(--font-mono);
        font-size: 0.8125rem;
        overflow-x: auto;
        margin-bottom: 1rem;
    }

    .code-block code {
        color: var(--text-primary);
    }

    .code-comment {
        color: var(--text-muted);
    }

    .speed-value {
        font-weight: 600;
        font-size: 1rem;
    }

    .speed-unit {
        color: var(--text-muted);
        font-size: 0.75rem;
        margin-left: 0.25rem;
    }

    .text-muted {
        color: var(--text-muted);
    }

    .info-section h4 {
        font-size: 0.9375rem;
        margin: 0 0 0.75rem;
    }

    .info-section ol {
        margin: 0 0 1rem;
        padding-left: 1.5rem;
    }

    .info-section li {
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
    }

    .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .pagination-info {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    /* Expandable rows */
    .history-row-clickable {
        cursor: pointer;
    }

    .history-row-clickable:hover {
        background: var(--bg-tertiary);
    }

    .history-row-expanded {
        background: var(--bg-tertiary);
    }

    .expand-chevron {
        text-align: center;
        color: var(--text-muted);
        width: 2rem;
    }

    .history-details-row td {
        padding: 0 !important;
        border: none !important;
    }

    .expand-wrapper {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .expand-wrapper.expanded {
        max-height: 1000px;
    }

    .expand-content {
        padding: 1rem;
        background: var(--bg-primary);
        border-top: 1px solid var(--border-color);
    }

</style>

@code {
    private List<Iperf3Result> testHistory = new();
    private bool loading = false;
    private System.Threading.Timer? _pollTimer;

    // Configuration
    private string? openSpeedTestUrl;
    private bool iperf3ServerEnabled;
    private string serverHost = "localhost";

    // Pagination
    private int historyPage = 1;
    private int historyPageSize = 15;
    private int historyTotalPages => (int)Math.Ceiling(testHistory.Count / (double)historyPageSize);
    private IEnumerable<Iperf3Result> pagedHistory => testHistory.Skip((historyPage - 1) * historyPageSize).Take(historyPageSize);

    // Expandable rows
    private int? expandedHistoryId = null;

    // Copy URL state
    private bool urlCopied = false;

    protected override async Task OnInitializedAsync()
    {
        // Load configuration
        iperf3ServerEnabled = Configuration.GetValue("Iperf3Server:Enabled", false);

        // Construct OpenSpeedTest URL from HOST_NAME or HOST_IP
        var hostName = Configuration["HOST_NAME"];
        var hostIp = Configuration["HOST_IP"];
        if (!string.IsNullOrEmpty(hostName))
        {
            openSpeedTestUrl = $"http://{hostName}:3005";
            serverHost = hostName;
        }
        else if (!string.IsNullOrEmpty(hostIp))
        {
            openSpeedTestUrl = $"http://{hostIp}:3005";
            serverHost = hostIp;
        }

        await LoadHistory();

        // Start polling for new results every 5 seconds
        _pollTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadHistory();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task LoadHistory()
    {
        loading = true;
        StateHasChanged();

        try
        {
            testHistory = await ClientSpeedTestService.GetResultsAsync(100);
            historyPage = 1;
        }
        catch (Exception)
        {
            // History load errors are not critical
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private static string GetSourceLabel(SpeedTestDirection direction)
    {
        return direction switch
        {
            SpeedTestDirection.BrowserToServer => "Browser",
            SpeedTestDirection.ClientToServer => "iperf3",
            _ => "Gateway"
        };
    }

    private static string GetSourceBadgeClass(SpeedTestDirection direction)
    {
        return direction switch
        {
            SpeedTestDirection.BrowserToServer => "badge-openspeedtest",
            SpeedTestDirection.ClientToServer => "badge-iperf3",
            _ => "badge-secondary"
        };
    }

    private void ToggleHistoryExpand(int resultId)
    {
        expandedHistoryId = expandedHistoryId == resultId ? null : resultId;
    }

    private async Task CopySpeedTestUrl()
    {
        if (!string.IsNullOrEmpty(openSpeedTestUrl))
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", openSpeedTestUrl);
            urlCopied = true;
            StateHasChanged();

            // Reset after 2 seconds
            await Task.Delay(2000);
            urlCopied = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _pollTimer?.Dispose();
    }
}
