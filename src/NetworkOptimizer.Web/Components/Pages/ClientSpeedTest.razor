@page "/sites/{SiteId:int}/client-speedtest"
@rendermode InteractiveServer
@implements IDisposable
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.Storage.Helpers
@using NetworkOptimizer.Web.Components.Shared
@using NetworkOptimizer.Core.Helpers
@using NetworkOptimizer.UniFi
@inject ClientSpeedTestService ClientSpeedTestService
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@inject IJSRuntime JS
@inject IHttpClientFactory HttpClientFactory
@inject UniFiConnectionService ConnectionService
@inject Iperf3ServerService Iperf3Server

@* Uses unified Iperf3Result model with Direction field to distinguish test sources *@

<PageTitle>Client Speed Test - Network Optimizer</PageTitle>

<a href="/sites/@SiteId/speedtest" class="back-link" title="Back to LAN Speed Test">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
</a>

<div class="page-header">
    <h1>Client Speed Test</h1>
    <p class="page-description">Test LAN speed from any device - phones, tablets, laptops</p>
</div>

<div class="client-speedtest-container">
    <!-- Test Instructions -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Run a Speed Test</h2>
        </div>
        <div class="card-body">
            <div class="test-options">
                <!-- OpenSpeedTest Option -->
                <div class="test-option">
                    <div class="test-option-header">
                        <h3>Browser Speed Test</h3>
                        <span class="badge badge-primary">Recommended</span>
                    </div>
                    <p>
                        Run a speed test directly from any web browser using <a href="https://openspeedtest.com" target="_blank" rel="noopener noreferrer">OpenSpeedTestâ„¢</a>. Works on all devices.
                        @if (openSpeedTestUrl?.StartsWith("https://") == true)
                        {
                            <text> Location data is collected with each test (with your permission), and results can be seen in the <a href="javascript:void(0)" onclick="document.getElementById('coverage-map').scrollIntoView({behavior: 'smooth'})">Speed / Coverage Map</a> below.</text>
                        }
                    </p>

                    @if (openSpeedTestAvailable)
                    {
                        <div class="test-option-actions">
                            <a href="@GetSpeedTestRunUrl()" target="_blank" rel="opener" class="btn btn-primary">
                                Run Speed Test
                            </a>
                            <span class="form-help">Opens in a new tab and auto-starts</span>
                        </div>
                        <div class="url-copy-row">
                            <input type="text" class="url-display" value="@GetSpeedTestCopyUrl()" readonly />
                            <button type="button" class="btn-icon" title="Copy URL" onclick="copyFromInput(this)">
                                <span class="copy-icon">ðŸ“‹</span>
                                <span class="copy-check" style="display:none;">âœ“</span>
                            </button>
                        </div>
                        <p class="form-help browser-tip">
                            <strong>Tip:</strong> For &gt; 2.5 GbE LANs, Chrome gives the fastest results.
                            Firefox limits performance, especially on uploads.
                        </p>
                    }
                    else if (string.IsNullOrEmpty(openSpeedTestUrl))
                    {
                        <div class="alert alert-warning">
                            <strong>Configuration Required:</strong> Set <code>HOST_IP</code> or <code>HOST_NAME</code> in your environment to enable browser speed testing.
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info" style="border-color: var(--text-muted); background: var(--bg-secondary);">
                            <strong>Not Available:</strong> Browser speed testing is not running. Check your configuration - this feature may not be supported on your platform.
                        </div>
                    }
                    @if (openSpeedTestUrl?.StartsWith("https://") != true)
                    {
                        <div class="alert alert-info" style="border-color: var(--text-muted); background: var(--bg-secondary);">
                            <strong>Coverage Map:</strong> The browser test can capture your device's location (with permission), which feeds into the Speed / Coverage Map. If you want location data from mobile devices, you'll need HTTPS - browsers require a secure connection for location access on mobile. This means reverse-proxying the speedtest server through something like Caddy or nginx.
                        </div>
                    }
                </div>

                <!-- iperf3 Option -->
                <div class="test-option">
                    <div class="test-option-header">
                        <h3>iperf3 to Server</h3>
                        <span class="badge badge-secondary">Advanced</span>
                    </div>
                    <p>Run iperf3 from any device on your network to test LAN throughput to this server (<code>@serverHost</code>).</p>

                    @if (iperf3ServerEnabled && Iperf3Server.StartupFailed)
                    {
                        <div class="alert alert-danger">
                            <strong>Server Failed to Start:</strong> @Iperf3Server.FailureMessage
                            <br />
                            <span class="form-help">
                                @if (OperatingSystem.IsWindows())
                                {
                                    <text>Check Task Manager for iperf3.exe and end the process, then restart the app.</text>
                                }
                                else if (OperatingSystem.IsMacOS())
                                {
                                    <text>Check for existing iperf3: <code class="code-dark">pkill iperf3</code> or use Activity Monitor
                                    <br />
                                    Then restart: <code class="code-dark">launchctl unload ~/Library/LaunchAgents/net.ozarkconnect.networkoptimizer.plist && launchctl load ~/Library/LaunchAgents/net.ozarkconnect.networkoptimizer.plist</code></text>
                                }
                                else
                                {
                                    <text>Check if another iperf3 server is already running:
                                    <code class="code-dark">ps aux | grep iperf3</code>
                                    <br />
                                    If so, stop it: <code class="code-dark">systemctl stop iperf3 && systemctl disable iperf3</code>
                                    <br />
                                    Then restart the container: <code class="code-dark">docker restart network-optimizer</code></text>
                                }
                            </span>
                        </div>
                    }
                    else if (iperf3ServerEnabled)
                    {
                        <div class="code-block">
                            <code>
                                <span class="code-comment"># Run from another device (laptop, phone, etc.) to test LAN speed</span><br />
                                <br />
                                <span class="code-comment"># Test upload speed (your device to this server, 4 streams)</span><br />
                                iperf3 -c @serverHost -P 4@(GetExtraDataArg())<br />
                                <br />
                                <span class="code-comment"># Test download speed (this server to your device, 4 streams)</span><br />
                                iperf3 -c @serverHost -P 4 -R@(GetExtraDataArg())<br />
                                <br />
                                <span class="code-comment"># OR full bidirectional test (runs both directions simultaneously)</span><br />
                                iperf3 -c @serverHost -P 4 --bidir@(GetExtraDataArg())
                            </code>
                        </div>
                        @if (SiteId != 1001)
                        {
                            <div class="form-help" style="margin-bottom: 0.75rem;">
                                <span class="text-muted">The <code>--extra-data @SiteId</code> flag identifies this site so results are recorded correctly.</span>
                            </div>
                        }
                        <div class="form-help install-help">
                            <div class="install-header">Install iperf3 on client device:</div>
                            <div class="install-item"><code>sudo apt install iperf3</code> <span class="text-muted">(Linux)</span></div>
                            <div class="install-item"><code>brew install iperf3</code> <span class="text-muted">(Mac)</span></div>
                            <div class="install-item"><a href="https://iperf.fr/iperf-download.php" target="_blank" rel="noopener noreferrer">iperf.fr</a> <span class="text-muted">(Windows)</span></div>
                            <div class="install-item">Various clients available on iOS App Store and Google Play</div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <strong>Server Not Running:</strong> iperf3 server mode is disabled.
                            <br />
                            <span class="form-help">
                                Set <code>IPERF3_SERVER_ENABLED=true</code> in your environment to enable.
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Test History -->
    <div class="card">
        <div class="card-header history-card-header">
            <div class="header-title-row">
                <h2 class="card-title">Test History</h2>
                <div class="header-actions">
                    <button class="btn btn-sm btn-secondary" @onclick="() => LoadHistory()" disabled="@loading">
                        @if (loading)
                        {
                            <span class="spinner"></span>
                            <span>Loading...</span>
                        }
                        else
                        {
                            <span>Refresh</span>
                        }
                    </button>
                </div>
            </div>
            @if (testHistory.Count > 0)
            {
                <div class="history-search-row">
                    <SpeedTestSearchFilter @bind-SearchFilter="historySearchFilter"
                                           OnSearch="OnFilterChanged"
                                           ShowStatus="true"
                                           ResultCount="filteredHistory.Count" />
                </div>
            }
        </div>
        <div class="card-body">
            @if (testHistory.Count > 0)
            {
                <div class="table-responsive" id="history-table">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Device</th>
                                <th>Source</th>
                                <th class="hide-mobile">
                                    <span class="tooltip-wrapper tooltip-bottom">
                                        â†“ Mbps
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <strong>From Device</strong><br />
                                            Data transferred from the client device.
                                        </span>
                                    </span>
                                </th>
                                <th class="hide-mobile">
                                    <span class="tooltip-wrapper tooltip-bottom">
                                        â†‘ Mbps
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <strong>To Device</strong><br />
                                            Data transferred to the client device.
                                        </span>
                                    </span>
                                </th>
                                <th class="show-mobile">Mbps</th>
                                <th class="hide-mobile">Ping</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var result in pagedHistory)
                            {
                                var isExpanded = expandedHistoryId == result.Id || _collapsingHistoryId == result.Id;
                                <tr id="result-@result.Id"
                                    class="history-row-clickable @(isExpanded ? "history-row-expanded" : "")"
                                    @onclick="@(async () => await ToggleHistoryExpand(result.Id))">
                                    <td>@result.TestTime.ToLocalTime().ToString("MMM dd HH:mm")</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(result.DeviceName))
                                        {
                                            <span>@result.DeviceName</span>
                                            <br />
                                            <code class="text-muted">@result.DeviceHost</code>
                                        }
                                        else
                                        {
                                            <code>@result.DeviceHost</code>
                                        }
                                    </td>
                                    <td>
                                        @{
                                            var vpnType = DetectVpnType(result);
                                        }
                                        @if (vpnType != null)
                                        {
                                            <span class="badge badge-vpn-@vpnType.ToLowerInvariant()">@vpnType</span>
                                        }
                                        <span class="badge @GetSourceBadgeClass(result.Direction)">
                                            @GetSourceLabel(result.Direction)
                                        </span>
                                    </td>
                                    <td class="hide-mobile">
                                        @if (result.DownloadMbps > 0)
                                        {
                                            <span class="speed-value">@result.DownloadMbps.ToString("F1")</span>
                                            <span class="speed-unit">Mbps</span>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td class="hide-mobile">
                                        @if (result.UploadMbps > 0)
                                        {
                                            <span class="speed-value">@result.UploadMbps.ToString("F1")</span>
                                            <span class="speed-unit">Mbps</span>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td class="show-mobile">@($"{(result.DownloadMbps > 0 ? $"â†“{result.DownloadMbps:F0}" : "")}{(result.DownloadMbps > 0 && result.UploadMbps > 0 ? " " : "")}{(result.UploadMbps > 0 ? $"â†‘{result.UploadMbps:F0}" : "")}")</td>
                                    <td class="hide-mobile">
                                        @if (result.PingMs.HasValue)
                                        {
                                            <span>@(result.PingMs.Value % 1 == 0 && result.PingMs.Value >= 10 ? result.PingMs.Value.ToString("F0") : result.PingMs.Value.ToString("F1")) ms</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="expand-chevron">
                                        <span>@(isExpanded ? "â–²" : "â–¼")</span>
                                    </td>
                                </tr>
                                <tr class="history-details-row">
                                    <td colspan="7">
                                        <div class="expand-wrapper @(isExpanded ? "expanded" : "")">
                                            <div class="expand-content">
                                                <div class="history-details">
                                                    <SpeedTestDetails Result="result" PathAnalysis="result.PathAnalysis" OnDelete="HandleDeleteResult" OnNotesChanged="HandleNotesChanged" IsInTableRow="true" />
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (historyTotalPages > 1)
                {
                    <div class="pagination" id="history-pagination">
                        <button class="btn btn-sm btn-secondary" disabled="@(historyPage <= 1)" @onclick="() => ChangePage(-1)">Prev</button>
                        <span class="pagination-info">Page @historyPage of @historyTotalPages (@filteredHistory.Count@(string.IsNullOrEmpty(historySearchFilter) ? " total" : $" of {testHistory.Count}"))</span>
                        <button class="btn btn-sm btn-secondary" disabled="@(historyPage >= historyTotalPages)" @onclick="() => ChangePage(1)">Next</button>
                    </div>
                }
            }
            else if (!loading)
            {
                <div class="empty-state">
                    <p>No client speed tests recorded yet.</p>
                    <p class="form-help">Run a speed test from any device to see results here.</p>
                </div>
            }
        </div>
    </div>

    <!-- Test Locations Map -->
    <div id="coverage-map">
        <SpeedTestMap Results="testHistory"
                      OnRefresh="() => LoadHistory()"
                      OnResultClick="ScrollToResult" />
    </div>

    <!-- How it Works -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">How it Works</h2>
        </div>
        <div class="card-body">
            <div class="info-section">
                <h4>Browser Speed Test (OpenSpeedTestâ„¢)</h4>
                <ol>
                    <li>Open the speed test page from any device on your LAN</li>
                    <li>Click Start to run the test</li>
                    <li>Results are automatically sent to this server</li>
                    <li>Device is identified by IP address and matched to UniFi client list</li>
                </ol>

                <h4 style="margin-top: 1.5rem;">iperf3 to Server</h4>
                <ol>
                    <li>Install iperf3 on another device (laptop, phone, etc.)</li>
                    <li>Run the command to connect to this server on port 5201</li>
                    <li>Server automatically captures and records results</li>
                    <li>Device is identified by the connecting IP address</li>
                </ol>

                <p class="form-help">
                    <strong>Note:</strong> This tests the LAN speed between client devices and the Network Optimizer server.
                    It's useful for identifying wireless bottlenecks, cable issues, switch problems, or network congestion.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .back-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: var(--border-radius);
        color: var(--text-secondary);
        background: var(--bg-tertiary);
        transition: all 0.15s ease;
        margin-bottom: 0.75rem;
    }

    .back-link:hover {
        color: var(--text-primary);
        background: var(--bg-hover);
    }

    .client-speedtest-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .test-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .test-option {
        background: var(--bg-tertiary);
        border-radius: var(--border-radius);
        padding: 1.25rem;
    }

    .form-help.install-help {
        color: var(--text-primary);
    }

    .install-help code {
        background: var(--bg-primary);
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.8125rem;
    }

    .install-header {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .install-item {
        padding-left: 1rem;
        margin-top: 0.25rem;
    }

    .test-option-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .test-option-header h3 {
        margin: 0;
        font-size: 1rem;
    }

    .test-option p {
        margin: 0 0 1rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .test-option-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .url-copy-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding: 0.5rem;
        background: var(--bg-primary);
        border-radius: var(--border-radius);
    }

    .test-option .browser-tip {
        margin-top: 1rem;
    }

    .url-display {
        flex: 1;
        font-size: 0.8125rem;
        color: var(--text-secondary);
        word-break: break-all;
        background: transparent;
        border: none;
        outline: none;
        font-family: monospace;
        width: 100%;
    }

    .btn-icon {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        font-size: 1rem;
        opacity: 0.7;
        transition: opacity 0.15s;
    }

    .btn-icon:hover {
        opacity: 1;
    }

    .copy-check {
        color: var(--success-color);
    }

    .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-primary {
        background: var(--success-color);
        color: white;
    }

    .badge-secondary {
        background: var(--accent-color);
        color: white;
    }

    .badge-openspeedtest {
        background: var(--success-color);
        color: white;
    }

    .badge-iperf3 {
        background: var(--accent-color);
        color: white;
    }

    .badge-vpn-tailscale {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
        margin-right: 0.25rem;
    }

    .badge-vpn-teleport {
        background: rgba(168, 85, 247, 0.2);
        color: var(--purple-light);
        margin-right: 0.25rem;
    }

    .badge-vpn-vpn {
        background: rgba(20, 184, 166, 0.2);
        color: #2dd4bf;
        margin-right: 0.25rem;
    }

    .badge-vpn-wan {
        background: rgba(125, 211, 252, 0.2);
        color: #7dd3fc;
        margin-right: 0.25rem;
    }

    .code-block {
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        padding: 1rem;
        font-family: var(--font-mono);
        font-size: 0.8125rem;
        overflow-x: auto;
        margin-bottom: 1rem;
    }

    .code-block code {
        color: var(--text-primary);
        white-space: nowrap;
        display: block;
    }

    .code-comment {
        color: var(--text-muted);
    }

    .speed-value {
        font-weight: 600;
        font-size: 1rem;
    }

    .speed-unit {
        color: var(--text-muted);
        font-size: 0.75rem;
        margin-left: 0.25rem;
    }

    .text-muted {
        color: var(--text-muted);
    }

    .info-section h4 {
        font-size: 0.9375rem;
        margin: 0 0 0.75rem;
    }

    .info-section ol {
        margin: 0 0 1rem;
        padding-left: 1.5rem;
    }

    .info-section li {
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
    }

    .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .pagination-info {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    /* Expandable rows */
    .history-row-clickable {
        cursor: pointer;
    }

    .history-row-clickable:hover {
        background: var(--bg-tertiary);
    }

    .history-row-expanded {
        background: var(--bg-tertiary);
    }

    /* History card header with search */
    .history-card-header {
        flex-direction: column;
        align-items: stretch !important;
        gap: 0.75rem;
    }

    .header-title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .history-search-row {
        padding-top: 0.5rem;
        border-top: 1px solid var(--border-color);
    }

</style>

@code {
    [Parameter] public int SiteId { get; set; }

    private List<Iperf3Result> testHistory = new();
    private bool loading = false;
    private System.Threading.Timer? _pollTimer;
    private List<NetworkInfo>? _networks;

    // Configuration
    private string? openSpeedTestUrl;
    private string? openSpeedTestHealthCheckUrl;  // Internal HTTP URL for health checks
    private bool iperf3ServerEnabled;
    private bool openSpeedTestAvailable;
    private string serverHost = "<server IP>";

    // OpenSpeedTest health check cache
    private static DateTime _lastHealthCheck = DateTime.MinValue;
    private static bool _lastHealthResult = false;
    private static readonly TimeSpan HealthCheckCacheDuration = TimeSpan.FromSeconds(30);

    // Search filter (uses shared SpeedTestFilterHelper for consistency with repository)
    private string historySearchFilter = "";

    // Filtered results based on search filter
    private List<Iperf3Result> filteredHistory => string.IsNullOrEmpty(historySearchFilter)
        ? testHistory
        : testHistory.Where(r => SpeedTestFilterHelper.MatchesFilter(r, historySearchFilter.ToLowerInvariant())).ToList();

    // Pagination
    private int historyPage = 1;
    private int historyPageSize = 15;
    private int historyTotalPages => (int)Math.Ceiling(filteredHistory.Count / (double)historyPageSize);
    private IEnumerable<Iperf3Result> pagedHistory => filteredHistory.Skip((historyPage - 1) * historyPageSize).Take(historyPageSize);

    // Expandable rows
    private int? expandedHistoryId = null;
    private int? _collapsingHistoryId = null; // Track row being collapsed for smooth transition

    protected override async Task OnInitializedAsync()
    {
        // Load networks for VPN detection
        _networks = await ConnectionService.GetNetworksAsync(SiteId);

        // Load configuration
        iperf3ServerEnabled = Configuration.GetValue("Iperf3Server:Enabled", false);

        // Construct OpenSpeedTest URL - supports HTTPS when proxied
        var hostName = Configuration["HOST_NAME"];
        var hostIp = Configuration["HOST_IP"];
        var openSpeedTestHost = Configuration["OPENSPEEDTEST_HOST"];
        var openSpeedTestPortConfig = Configuration["OPENSPEEDTEST_PORT"];
        var openSpeedTestPort = !string.IsNullOrEmpty(openSpeedTestPortConfig) ? openSpeedTestPortConfig : "3005";
        var openSpeedTestHttps = Configuration["OPENSPEEDTEST_HTTPS"]?.Equals("true", StringComparison.OrdinalIgnoreCase) == true;
        var openSpeedTestHttpsPortConfig = Configuration["OPENSPEEDTEST_HTTPS_PORT"];
        var openSpeedTestHttpsPort = !string.IsNullOrEmpty(openSpeedTestHttpsPortConfig) ? openSpeedTestHttpsPortConfig : "443";

        // OPENSPEEDTEST_HOST defaults to HOST_NAME
        if (string.IsNullOrEmpty(openSpeedTestHost))
            openSpeedTestHost = hostName;

        // Build health check URL - use 127.0.0.1 explicitly (localhost can resolve to IPv6 on Windows)
        openSpeedTestHealthCheckUrl = $"http://127.0.0.1:{openSpeedTestPort}";

        // Set serverHost for iperf3 instructions (main app host, not speedtest UI host)
        // Priority: HOST_NAME > HOST_IP > auto-detected IP from network interface
        // Note: Configuration[] returns empty string (not null) for missing keys, so use IsNullOrEmpty
        serverHost = !string.IsNullOrEmpty(hostName) ? hostName
            : !string.IsNullOrEmpty(hostIp) ? hostIp
            : NetworkUtilities.DetectLocalIpFromInterfaces() ?? "<server IP>";

        // Build display URL - prefer HTTPS when configured, else HTTP
        if (!string.IsNullOrEmpty(openSpeedTestHost))
        {
            if (openSpeedTestHttps)
            {
                // HTTPS URL (behind proxy)
                openSpeedTestUrl = openSpeedTestHttpsPort == "443"
                    ? $"https://{openSpeedTestHost}"
                    : $"https://{openSpeedTestHost}:{openSpeedTestHttpsPort}";
            }
            else
            {
                // HTTP URL (direct access)
                openSpeedTestUrl = $"http://{openSpeedTestHost}:{openSpeedTestPort}";
            }
        }
        else
        {
            // Fallback: HOST_IP > auto-detected IP (HTTP only)
            var fallbackIp = !string.IsNullOrEmpty(hostIp) ? hostIp : NetworkUtilities.DetectLocalIpFromInterfaces();
            if (!string.IsNullOrEmpty(fallbackIp))
            {
                openSpeedTestUrl = $"http://{fallbackIp}:{openSpeedTestPort}";
            }
        }

        // Check if OpenSpeedTest is actually reachable
        if (openSpeedTestHttps)
        {
            // HTTPS configured = user has a working proxy setup, trust them
            openSpeedTestAvailable = true;
        }
        else if (!string.IsNullOrEmpty(openSpeedTestHealthCheckUrl))
        {
            openSpeedTestAvailable = await CheckOpenSpeedTestHealthAsync();
        }

        await LoadHistory();

        // Start polling for new results every 5 seconds
        _pollTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadHistory(resetPage: false);
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task LoadHistory(bool resetPage = true)
    {
        loading = true;
        StateHasChanged();

        try
        {
            // Load all results for this site (map handles its own time filtering)
            testHistory = await ClientSpeedTestService.GetResultsAsync(SiteId, count: 0);
            if (resetPage)
            {
                historyPage = 1;
            }
        }
        catch (Exception)
        {
            // History load errors are not critical
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task<bool> CheckOpenSpeedTestHealthAsync()
    {
        // Return cached result if still valid
        if (DateTime.UtcNow - _lastHealthCheck < HealthCheckCacheDuration)
        {
            return _lastHealthResult;
        }

        try
        {
            // Don't follow redirects - just check if the service responds
            using var handler = new HttpClientHandler { AllowAutoRedirect = false };
            using var client = new HttpClient(handler) { Timeout = TimeSpan.FromSeconds(2) };
            var response = await client.GetAsync(openSpeedTestHealthCheckUrl);
            // Accept 2xx or 3xx (redirects) as "running"
            _lastHealthResult = response.IsSuccessStatusCode ||
                ((int)response.StatusCode >= 300 && (int)response.StatusCode < 400);
        }
        catch
        {
            _lastHealthResult = false;
        }

        _lastHealthCheck = DateTime.UtcNow;
        return _lastHealthResult;
    }

    private static string GetSourceLabel(SpeedTestDirection direction)
    {
        return direction switch
        {
            SpeedTestDirection.BrowserToServer => "Browser",
            SpeedTestDirection.ClientToServer => "iperf3",
            _ => "Gateway"
        };
    }

    private static string GetSourceBadgeClass(SpeedTestDirection direction)
    {
        return direction switch
        {
            SpeedTestDirection.BrowserToServer => "badge-openspeedtest",
            SpeedTestDirection.ClientToServer => "badge-iperf3",
            _ => "badge-secondary"
        };
    }

    /// <summary>
    /// Detects VPN/WAN type based on client IP and known network subnets.
    /// Returns "Tailscale", "VPN", "Teleport", "WAN", or null for LAN.
    /// </summary>
    // TODO: Consider unifying with SpeedTestMap.DetectVpnType (different signature - this takes Iperf3Result and checks PathAnalysis, that takes IP string directly)
    private string? DetectVpnType(Iperf3Result result)
    {
        var clientIp = result.DeviceHost;
        if (string.IsNullOrEmpty(clientIp) || !System.Net.IPAddress.TryParse(clientIp, out _))
            return null;

        // Check for Tailscale CGNAT range: 100.64.0.0/10 (100.64.0.0 - 100.127.255.255)
        // Always check this regardless of path validity
        if (clientIp.StartsWith("100."))
        {
            var parts = clientIp.Split('.');
            if (parts.Length >= 2 && int.TryParse(parts[1], out int secondOctet))
            {
                if (secondOctet >= 64 && secondOctet <= 127)
                    return "Tailscale";
            }
        }

        // Check for VPN-purpose networks (even if path is valid - gateway devices on VPN networks)
        if (_networks != null)
        {
            var matchingNetwork = _networks.FirstOrDefault(n => NetworkUtilities.IsIpInSubnet(clientIp, n.IpSubnet));

            // If in a UniFi VPN network, label as VPN
            if (matchingNetwork?.Purpose == "remote-user-vpn")
                return "VPN";

            // If 192.168.x.x not in any known network, label as Teleport
            // (Even if path is valid - the device may exist but the IP range is external/VPN)
            // Only check if we have networks loaded (otherwise we can't distinguish)
            if (clientIp.StartsWith("192.168.") && matchingNetwork == null && _networks.Count > 0)
                return "Teleport";

            // If not in any known network and not a private IP range, it's WAN (public internet)
            if (matchingNetwork == null && !IsPrivateIp(clientIp))
                return "WAN";
        }

        return null;
    }

    /// <summary>
    /// Checks if an IP address is in a private range (RFC 1918 or CGNAT).
    /// </summary>
    private static bool IsPrivateIp(string ipAddress)
    {
        // 10.0.0.0/8
        if (ipAddress.StartsWith("10."))
            return true;

        // 172.16.0.0/12 (172.16.x.x - 172.31.x.x)
        if (ipAddress.StartsWith("172."))
        {
            var parts = ipAddress.Split('.');
            if (parts.Length >= 2 && int.TryParse(parts[1], out int secondOctet))
            {
                if (secondOctet >= 16 && secondOctet <= 31)
                    return true;
            }
        }

        // 192.168.0.0/16
        if (ipAddress.StartsWith("192.168."))
            return true;

        // 100.64.0.0/10 (CGNAT)
        if (ipAddress.StartsWith("100."))
        {
            var parts = ipAddress.Split('.');
            if (parts.Length >= 2 && int.TryParse(parts[1], out int secondOctet))
            {
                if (secondOctet >= 64 && secondOctet <= 127)
                    return true;
            }
        }

        return false;
    }

    private async Task ChangePage(int delta)
    {
        var hadExpanded = expandedHistoryId.HasValue;
        expandedHistoryId = null;
        _collapsingHistoryId = null;
        historyPage += delta;

        if (hadExpanded)
        {
            StateHasChanged();
            await Task.Delay(50); // Let the DOM update
            await JS.InvokeVoidAsync("eval", "const container = document.querySelector('.page-content'); document.getElementById('history-pagination')?.scrollIntoView({ behavior: 'smooth', block: 'end' }); container?.addEventListener('scrollend', () => container.scrollBy({ top: 50, behavior: 'smooth' }), { once: true });");
        }
    }

    private void OnFilterChanged(string filter)
    {
        historyPage = 1;
        expandedHistoryId = null;
        StateHasChanged();
    }

    private async Task ToggleHistoryExpand(int resultId)
    {
        if (expandedHistoryId == resultId)
        {
            // Clicking same row - just collapse
            expandedHistoryId = null;
        }
        else if (expandedHistoryId.HasValue)
        {
            // Switching rows - expand new one first, then collapse old after transition
            var oldId = expandedHistoryId.Value;
            _collapsingHistoryId = oldId;
            expandedHistoryId = resultId;
            StateHasChanged();

            // Wait for expand animation, then collapse old
            await Task.Delay(50);
            _collapsingHistoryId = null;

            // Scroll into view if off-screen
            await JS.InvokeVoidAsync("eval", $@"
                setTimeout(() => {{
                    var el = document.getElementById('result-{resultId}');
                    if (el) {{
                        var rect = el.getBoundingClientRect();
                        if (rect.top < 0 || rect.bottom > window.innerHeight) {{
                            el.scrollIntoView({{ behavior: 'smooth', block: 'start' }});
                        }}
                    }}
                }}, 260);
            ");
        }
        else
        {
            // No row expanded - just expand
            expandedHistoryId = resultId;
        }
    }

    private async Task HandleDeleteResult(int resultId)
    {
        var deleted = await ClientSpeedTestService.DeleteResultAsync(resultId);
        if (deleted)
        {
            // Remove from local list and collapse the row
            testHistory.RemoveAll(r => r.Id == resultId);
            expandedHistoryId = null;
            StateHasChanged();
        }
    }

    private async Task HandleNotesChanged((int Id, string? Notes) args)
    {
        await ClientSpeedTestService.UpdateNotesAsync(SiteId, args.Id, args.Notes);
    }

    private async Task ScrollToResult(int resultId)
    {
        // Find which page the result is on
        var index = testHistory.FindIndex(r => r.Id == resultId);
        if (index >= 0)
        {
            var targetPage = (index / historyPageSize) + 1;
            if (historyPage != targetPage)
            {
                historyPage = targetPage;
            }
        }

        // Expand the result
        expandedHistoryId = resultId;
        StateHasChanged();

        // Give time for the DOM to update, then scroll
        await Task.Delay(100);
        await JS.InvokeVoidAsync("eval", $@"
            (function() {{
                var el = document.getElementById('result-{resultId}');
                if (el) {{
                    el.scrollIntoView({{ behavior: 'smooth', block: 'center' }});
                    // Brief highlight effect
                    el.style.transition = 'background-color 0.3s';
                    el.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
                    setTimeout(function() {{ el.style.backgroundColor = ''; }}, 1500);
                }}
            }})();
        ");
    }

    // Only include siteId in URL for non-default sites (reduces friction for home users)
    private string GetSpeedTestCopyUrl() =>
        SiteId == 1001 ? openSpeedTestUrl! : $"{openSpeedTestUrl}?siteId={SiteId}";

    private string GetSpeedTestRunUrl() =>
        SiteId == 1001 ? $"{openSpeedTestUrl}?Run" : $"{openSpeedTestUrl}?siteId={SiteId}&Run";

    // Only include --extra-data for non-default sites (reduces friction for home users)
    private string GetExtraDataArg() =>
        SiteId == 1001 ? "" : $" --extra-data {SiteId}";

    public void Dispose()
    {
        _pollTimer?.Dispose();
    }
}
