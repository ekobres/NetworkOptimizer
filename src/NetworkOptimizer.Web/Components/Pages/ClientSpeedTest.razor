@page "/client-speedtest"
@rendermode InteractiveServer
@implements IDisposable
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.Web.Components.Shared
@using NetworkOptimizer.Core.Helpers
@using NetworkOptimizer.UniFi
@inject ClientSpeedTestService ClientSpeedTestService
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@inject IJSRuntime JS
@inject IHttpClientFactory HttpClientFactory
@inject UniFiConnectionService ConnectionService

@* Uses unified Iperf3Result model with Direction field to distinguish test sources *@

<PageTitle>Client Speed Test - Network Optimizer</PageTitle>

<a href="/speedtest" class="back-link" title="Back to LAN Speed Test">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
</a>

<div class="page-header">
    <h1>Client Speed Test</h1>
    <p class="page-description">Test LAN speed from any device - phones, tablets, laptops</p>
</div>

<div class="client-speedtest-container">
    <!-- Test Instructions -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Run a Speed Test</h2>
        </div>
        <div class="card-body">
            <div class="test-options">
                <!-- OpenSpeedTest Option -->
                <div class="test-option">
                    <div class="test-option-header">
                        <h3>Browser Speed Test</h3>
                        <span class="badge badge-primary">Recommended</span>
                    </div>
                    <p>
                        Run a speed test directly from any web browser using <a href="https://openspeedtest.com" target="_blank">OpenSpeedTestâ„¢</a>. Works on all devices.
                        @if (openSpeedTestUrl?.StartsWith("https://") == true)
                        {
                            <text> Location data is collected with each test (with your permission), and results can be seen in the Speed / Coverage Map below.</text>
                        }
                    </p>

                    @if (openSpeedTestAvailable)
                    {
                        <div class="test-option-actions">
                            <a href="@(openSpeedTestUrl)?Run" target="_blank" class="btn btn-primary">
                                Run Speed Test
                            </a>
                            <span class="form-help">Opens in a new tab and auto-starts</span>
                        </div>
                        <div class="url-copy-row">
                            <code class="url-display">@openSpeedTestUrl</code>
                            <button class="btn-icon" title="Copy URL" @onclick="CopySpeedTestUrl">
                                @if (urlCopied)
                                {
                                    <span class="copy-check">âœ“</span>
                                }
                                else
                                {
                                    <span class="copy-icon">ðŸ“‹</span>
                                }
                            </button>
                        </div>
                        <p class="form-help browser-tip">
                            <strong>Tip:</strong> For &gt; 2.5 GbE LANs, Chrome gives the fastest results.
                            Firefox limits performance, especially on uploads.
                        </p>
                    }
                    else if (string.IsNullOrEmpty(openSpeedTestUrl))
                    {
                        <div class="alert alert-warning">
                            <strong>Configuration Required:</strong> Set <code>HOST_IP</code> or <code>HOST_NAME</code> in your environment to enable browser speed testing.
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info" style="border-color: var(--text-muted); background: var(--bg-secondary);">
                            <strong>Not Available:</strong> OpenSpeedTestâ„¢ is not running. This feature requires Docker deployment. Use iperf3 for native installs.
                        </div>
                    }
                    @if (openSpeedTestUrl?.StartsWith("https://") != true)
                    {
                        <div class="alert alert-info" style="border-color: var(--text-muted); background: var(--bg-secondary);">
                            <strong>Coverage Map:</strong> The browser test can capture your device's location (with permission), which feeds into the Speed / Coverage Map. If you want location data from mobile devices, you'll need HTTPS - browsers require a secure connection for location access on mobile. This means reverse-proxying the speedtest server through something like Caddy or nginx.
                        </div>
                    }
                </div>

                <!-- iperf3 Option -->
                <div class="test-option">
                    <div class="test-option-header">
                        <h3>iperf3 Client</h3>
                        <span class="badge badge-secondary">Advanced</span>
                    </div>
                    <p>Use the iperf3 command-line tool for precise measurements.</p>

                    @if (iperf3ServerEnabled)
                    {
                        <div class="code-block">
                            <code>
                                <span class="code-comment"># Test upload speed (client to server, 4 streams)</span><br />
                                iperf3 -c @serverHost -P 4<br />
                                <br />
                                <span class="code-comment"># Test download speed (server to client, 4 streams)</span><br />
                                iperf3 -c @serverHost -P 4 -R<br />
                                <br />
                                <span class="code-comment"># Full bidirectional test (runs both directions simultaneously)</span><br />
                                iperf3 -c @serverHost -P 4 --bidir
                            </code>
                        </div>
                        <div class="form-help install-help">
                            <div class="install-header">Install iperf3:</div>
                            <div class="install-item"><code>sudo apt install iperf3</code> <span class="text-muted">(Linux)</span></div>
                            <div class="install-item"><code>brew install iperf3</code> <span class="text-muted">(Mac)</span></div>
                            <div class="install-item"><a href="https://iperf.fr/iperf-download.php" target="_blank">iperf.fr</a> <span class="text-muted">(Windows)</span></div>
                            <div class="install-item">Various clients available on iOS App Store and Google Play</div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <strong>Server Not Running:</strong> iperf3 server mode is disabled.
                            <br />
                            <span class="form-help">
                                Set <code>IPERF3_SERVER_ENABLED=true</code> in your environment to enable.
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Test History -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Test History</h2>
            <div class="header-actions">
                <button class="btn btn-sm btn-secondary" @onclick="() => LoadHistory()" disabled="@loading">
                    @if (loading)
                    {
                        <span class="spinner"></span>
                        <span>Loading...</span>
                    }
                    else
                    {
                        <span>Refresh</span>
                    }
                </button>
            </div>
        </div>
        <div class="card-body">
            @if (testHistory.Count > 0)
            {
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Device</th>
                                <th>Source</th>
                                <th>
                                    <span class="tooltip-wrapper tooltip-bottom">
                                        â†“ Mbps
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <strong>From Device</strong><br />
                                            Data transferred from the client device.
                                        </span>
                                    </span>
                                </th>
                                <th>
                                    <span class="tooltip-wrapper tooltip-bottom">
                                        â†‘ Mbps
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <strong>To Device</strong><br />
                                            Data transferred to the client device.
                                        </span>
                                    </span>
                                </th>
                                <th>Ping</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var result in pagedHistory)
                            {
                                var isExpanded = expandedHistoryId == result.Id;
                                <tr id="result-@result.Id"
                                    class="history-row-clickable @(isExpanded ? "history-row-expanded" : "")"
                                    @onclick="@(() => ToggleHistoryExpand(result.Id))">
                                    <td>@result.TestTime.ToLocalTime().ToString("MMM dd HH:mm")</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(result.DeviceName))
                                        {
                                            <span>@result.DeviceName</span>
                                            <br />
                                            <code class="text-muted">@result.DeviceHost</code>
                                        }
                                        else
                                        {
                                            <code>@result.DeviceHost</code>
                                        }
                                    </td>
                                    <td>
                                        @{
                                            var vpnType = DetectVpnType(result);
                                        }
                                        @if (vpnType != null)
                                        {
                                            <span class="badge badge-vpn-@vpnType.ToLowerInvariant()">@vpnType</span>
                                        }
                                        <span class="badge @GetSourceBadgeClass(result.Direction)">
                                            @GetSourceLabel(result.Direction)
                                        </span>
                                    </td>
                                    <td>
                                        <span class="speed-value">@result.DownloadMbps.ToString("F1")</span>
                                        <span class="speed-unit">Mbps</span>
                                    </td>
                                    <td>
                                        <span class="speed-value">@result.UploadMbps.ToString("F1")</span>
                                        <span class="speed-unit">Mbps</span>
                                    </td>
                                    <td>
                                        @if (result.PingMs.HasValue)
                                        {
                                            <span>@result.PingMs.Value.ToString("F0") ms</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="expand-chevron">
                                        <span>@(isExpanded ? "â–²" : "â–¼")</span>
                                    </td>
                                </tr>
                                <tr class="history-details-row">
                                    <td colspan="7">
                                        <div class="expand-wrapper @(isExpanded ? "expanded" : "")">
                                            <div class="expand-content">
                                                <div class="history-details">
                                                    <SpeedTestDetails Result="result" PathAnalysis="result.PathAnalysis" />
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (historyTotalPages > 1)
                {
                    <div class="pagination">
                        <button class="btn btn-sm btn-secondary" disabled="@(historyPage <= 1)" @onclick="() => historyPage--">Prev</button>
                        <span class="pagination-info">Page @historyPage of @historyTotalPages</span>
                        <button class="btn btn-sm btn-secondary" disabled="@(historyPage >= historyTotalPages)" @onclick="() => historyPage++">Next</button>
                    </div>
                }
            }
            else if (!loading)
            {
                <div class="empty-state">
                    <p>No client speed tests recorded yet.</p>
                    <p class="form-help">Run a speed test from any device to see results here.</p>
                </div>
            }
        </div>
    </div>

    <!-- Test Locations Map -->
    <SpeedTestMap Results="testHistory" OnRefresh="() => LoadHistory()" OnResultClick="ScrollToResult" />

    <!-- How it Works -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">How it Works</h2>
        </div>
        <div class="card-body">
            <div class="info-section">
                <h4>Browser Speed Test (OpenSpeedTestâ„¢)</h4>
                <ol>
                    <li>Open the speed test page from any device on your LAN</li>
                    <li>Click Start to run the test</li>
                    <li>Results are automatically sent to this server</li>
                    <li>Device is identified by IP address and matched to UniFi client list</li>
                </ol>

                <h4 style="margin-top: 1.5rem;">iperf3 Client</h4>
                <ol>
                    <li>Install iperf3 on your device</li>
                    <li>Run the command to connect to this server on port 5201</li>
                    <li>Server automatically captures and records results</li>
                    <li>Device is identified by the connecting IP address</li>
                </ol>

                <p class="form-help">
                    <strong>Note:</strong> This tests the LAN speed between client devices and the Network Optimizer server.
                    It's useful for identifying wireless bottlenecks, cable issues, switch problems, or network congestion.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .back-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: var(--border-radius);
        color: var(--text-secondary);
        background: var(--bg-tertiary);
        transition: all 0.15s ease;
        margin-bottom: 0.75rem;
    }

    .back-link:hover {
        color: var(--text-primary);
        background: var(--bg-hover);
    }

    .client-speedtest-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .test-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .test-option {
        background: var(--bg-tertiary);
        border-radius: var(--border-radius);
        padding: 1.25rem;
    }

    .form-help.install-help {
        color: var(--text-primary);
    }

    .install-help code {
        background: var(--bg-primary);
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.8125rem;
    }

    .install-header {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .install-item {
        padding-left: 1rem;
        margin-top: 0.25rem;
    }

    .test-option-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .test-option-header h3 {
        margin: 0;
        font-size: 1rem;
    }

    .test-option p {
        margin: 0 0 1rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .test-option-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .url-copy-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding: 0.5rem;
        background: var(--bg-primary);
        border-radius: var(--border-radius);
    }

    .test-option .browser-tip {
        margin-top: 1rem;
    }

    .url-display {
        flex: 1;
        font-size: 0.8125rem;
        color: var(--text-secondary);
        word-break: break-all;
    }

    .btn-icon {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        font-size: 1rem;
        opacity: 0.7;
        transition: opacity 0.15s;
    }

    .btn-icon:hover {
        opacity: 1;
    }

    .copy-check {
        color: var(--success-color);
    }

    .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-primary {
        background: var(--success-color);
        color: white;
    }

    .badge-secondary {
        background: var(--accent-color);
        color: white;
    }

    .badge-openspeedtest {
        background: var(--success-color);
        color: white;
    }

    .badge-iperf3 {
        background: var(--accent-color);
        color: white;
    }

    .badge-vpn-tailscale {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
        margin-right: 0.25rem;
    }

    .badge-vpn-teleport {
        background: rgba(168, 85, 247, 0.2);
        color: #c084fc;
        margin-right: 0.25rem;
    }

    .code-block {
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        padding: 1rem;
        font-family: var(--font-mono);
        font-size: 0.8125rem;
        overflow-x: auto;
        margin-bottom: 1rem;
    }

    .code-block code {
        color: var(--text-primary);
        white-space: nowrap;
        display: block;
    }

    .code-comment {
        color: var(--text-muted);
    }

    .speed-value {
        font-weight: 600;
        font-size: 1rem;
    }

    .speed-unit {
        color: var(--text-muted);
        font-size: 0.75rem;
        margin-left: 0.25rem;
    }

    .text-muted {
        color: var(--text-muted);
    }

    .info-section h4 {
        font-size: 0.9375rem;
        margin: 0 0 0.75rem;
    }

    .info-section ol {
        margin: 0 0 1rem;
        padding-left: 1.5rem;
    }

    .info-section li {
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
    }

    .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .pagination-info {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    /* Expandable rows */
    .history-row-clickable {
        cursor: pointer;
    }

    .history-row-clickable:hover {
        background: var(--bg-tertiary);
    }

    .history-row-expanded {
        background: var(--bg-tertiary);
    }

    .expand-chevron {
        text-align: center;
        color: var(--text-muted);
        width: 2rem;
    }

    .history-details-row td {
        padding: 0 !important;
        border: none !important;
    }

    .expand-wrapper {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .expand-wrapper.expanded {
        max-height: 1000px;
    }

    .expand-content {
        padding: 1rem;
        background: var(--bg-primary);
        border-top: 1px solid var(--border-color);
    }

</style>

@code {
    private List<Iperf3Result> testHistory = new();
    private bool loading = false;
    private System.Threading.Timer? _pollTimer;
    private List<NetworkInfo>? _networks;

    // Configuration
    private string? openSpeedTestUrl;
    private string? openSpeedTestHealthCheckUrl;  // Internal HTTP URL for health checks
    private bool iperf3ServerEnabled;
    private bool openSpeedTestAvailable;
    private string serverHost = "<server IP>";

    // OpenSpeedTest health check cache
    private static DateTime _lastHealthCheck = DateTime.MinValue;
    private static bool _lastHealthResult = false;
    private static readonly TimeSpan HealthCheckCacheDuration = TimeSpan.FromSeconds(30);

    // Pagination
    private int historyPage = 1;
    private int historyPageSize = 15;
    private int historyTotalPages => (int)Math.Ceiling(testHistory.Count / (double)historyPageSize);
    private IEnumerable<Iperf3Result> pagedHistory => testHistory.Skip((historyPage - 1) * historyPageSize).Take(historyPageSize);

    // Expandable rows
    private int? expandedHistoryId = null;

    // Copy URL state
    private bool urlCopied = false;

    protected override async Task OnInitializedAsync()
    {
        // Load networks for VPN detection
        _networks = await ConnectionService.GetNetworksAsync();

        // Load configuration
        iperf3ServerEnabled = Configuration.GetValue("Iperf3Server:Enabled", false);

        // Construct OpenSpeedTest URL - supports HTTPS when proxied
        var hostName = Configuration["HOST_NAME"];
        var hostIp = Configuration["HOST_IP"];
        var openSpeedTestHost = Configuration["OPENSPEEDTEST_HOST"];
        var openSpeedTestPort = Configuration["OPENSPEEDTEST_PORT"] ?? "3005";
        var openSpeedTestHttps = Configuration["OPENSPEEDTEST_HTTPS"]?.Equals("true", StringComparison.OrdinalIgnoreCase) == true;
        var openSpeedTestHttpsPort = Configuration["OPENSPEEDTEST_HTTPS_PORT"] ?? "443";

        // OPENSPEEDTEST_HOST defaults to HOST_NAME
        if (string.IsNullOrEmpty(openSpeedTestHost))
            openSpeedTestHost = hostName;

        // Build health check URL - always use localhost (most reliable with host networking)
        openSpeedTestHealthCheckUrl = $"http://localhost:{openSpeedTestPort}";

        // Set serverHost for iperf3 instructions (main app host, not speedtest UI host)
        // Priority: HOST_NAME > HOST_IP > auto-detected IP from network interface
        // Note: Configuration[] returns empty string (not null) for missing keys, so use IsNullOrEmpty
        serverHost = !string.IsNullOrEmpty(hostName) ? hostName
            : !string.IsNullOrEmpty(hostIp) ? hostIp
            : NetworkUtilities.DetectLocalIpFromInterfaces() ?? "<server IP>";

        // Build display URL - prefer HTTPS when configured, else HTTP
        if (!string.IsNullOrEmpty(openSpeedTestHost))
        {
            if (openSpeedTestHttps)
            {
                // HTTPS URL (behind proxy)
                openSpeedTestUrl = openSpeedTestHttpsPort == "443"
                    ? $"https://{openSpeedTestHost}"
                    : $"https://{openSpeedTestHost}:{openSpeedTestHttpsPort}";
            }
            else
            {
                // HTTP URL (direct access)
                openSpeedTestUrl = $"http://{openSpeedTestHost}:{openSpeedTestPort}";
            }
        }
        else
        {
            // Fallback: HOST_IP > auto-detected IP (HTTP only)
            var fallbackIp = !string.IsNullOrEmpty(hostIp) ? hostIp : NetworkUtilities.DetectLocalIpFromInterfaces();
            if (!string.IsNullOrEmpty(fallbackIp))
            {
                openSpeedTestUrl = $"http://{fallbackIp}:{openSpeedTestPort}";
            }
        }

        // Check if OpenSpeedTest is actually reachable (using internal HTTP URL)
        if (!string.IsNullOrEmpty(openSpeedTestHealthCheckUrl))
        {
            openSpeedTestAvailable = await CheckOpenSpeedTestHealthAsync();
        }

        await LoadHistory();

        // Start polling for new results every 5 seconds
        _pollTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadHistory(resetPage: false);
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task LoadHistory(bool resetPage = true)
    {
        loading = true;
        StateHasChanged();

        try
        {
            testHistory = await ClientSpeedTestService.GetResultsAsync(100);
            if (resetPage)
            {
                historyPage = 1;
            }
        }
        catch (Exception)
        {
            // History load errors are not critical
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task<bool> CheckOpenSpeedTestHealthAsync()
    {
        // Return cached result if still valid
        if (DateTime.UtcNow - _lastHealthCheck < HealthCheckCacheDuration)
        {
            return _lastHealthResult;
        }

        try
        {
            // Don't follow redirects - just check if the service responds
            using var handler = new HttpClientHandler { AllowAutoRedirect = false };
            using var client = new HttpClient(handler) { Timeout = TimeSpan.FromSeconds(2) };
            var response = await client.GetAsync(openSpeedTestHealthCheckUrl);
            // Accept 2xx or 3xx (redirects) as "running"
            _lastHealthResult = response.IsSuccessStatusCode ||
                ((int)response.StatusCode >= 300 && (int)response.StatusCode < 400);
        }
        catch
        {
            _lastHealthResult = false;
        }

        _lastHealthCheck = DateTime.UtcNow;
        return _lastHealthResult;
    }

    private static string GetSourceLabel(SpeedTestDirection direction)
    {
        return direction switch
        {
            SpeedTestDirection.BrowserToServer => "Browser",
            SpeedTestDirection.ClientToServer => "iperf3",
            _ => "Gateway"
        };
    }

    private static string GetSourceBadgeClass(SpeedTestDirection direction)
    {
        return direction switch
        {
            SpeedTestDirection.BrowserToServer => "badge-openspeedtest",
            SpeedTestDirection.ClientToServer => "badge-iperf3",
            _ => "badge-secondary"
        };
    }

    /// <summary>
    /// Detects VPN type based on client IP and known network subnets.
    /// Returns "Tailscale", "Teleport", or null for LAN/unknown.
    /// </summary>
    private string? DetectVpnType(Iperf3Result result)
    {
        // Only check external clients (no valid path)
        if (result.PathAnalysis?.Path?.IsValid == true)
            return null;

        var clientIp = result.DeviceHost;
        if (string.IsNullOrEmpty(clientIp) || !System.Net.IPAddress.TryParse(clientIp, out _))
            return null;

        // Check for Tailscale CGNAT range: 100.64.0.0/10 (100.64.0.0 - 100.127.255.255)
        if (clientIp.StartsWith("100."))
        {
            var parts = clientIp.Split('.');
            if (parts.Length >= 2 && int.TryParse(parts[1], out int secondOctet))
            {
                if (secondOctet >= 64 && secondOctet <= 127)
                    return "Tailscale";
            }
        }

        // Check for 192.168.x.x not in any known network â†’ Teleport
        if (clientIp.StartsWith("192.168.") && _networks != null)
        {
            var isInKnownNetwork = _networks.Any(n => IsIpInSubnet(clientIp, n.IpSubnet));
            if (!isInKnownNetwork)
                return "Teleport";
        }

        return null;
    }

    /// <summary>
    /// Checks if an IP address is within a CIDR subnet.
    /// </summary>
    private static bool IsIpInSubnet(string ipAddress, string? cidr)
    {
        if (string.IsNullOrEmpty(cidr))
            return false;

        var parts = cidr.Split('/');
        if (parts.Length != 2 ||
            !System.Net.IPAddress.TryParse(ipAddress, out var ip) ||
            !System.Net.IPAddress.TryParse(parts[0], out var subnetIp) ||
            !int.TryParse(parts[1], out var prefixLength))
            return false;

        var ipBytes = ip.GetAddressBytes();
        var subnetBytes = subnetIp.GetAddressBytes();

        if (ipBytes.Length != subnetBytes.Length)
            return false;

        int fullBytes = prefixLength / 8;
        int remainingBits = prefixLength % 8;

        for (int i = 0; i < fullBytes && i < ipBytes.Length; i++)
        {
            if (ipBytes[i] != subnetBytes[i])
                return false;
        }

        if (fullBytes < ipBytes.Length && remainingBits > 0)
        {
            byte mask = (byte)(0xFF << (8 - remainingBits));
            if ((ipBytes[fullBytes] & mask) != (subnetBytes[fullBytes] & mask))
                return false;
        }

        return true;
    }

    private void ToggleHistoryExpand(int resultId)
    {
        expandedHistoryId = expandedHistoryId == resultId ? null : resultId;
    }

    private async Task ScrollToResult(int resultId)
    {
        // Find which page the result is on
        var index = testHistory.FindIndex(r => r.Id == resultId);
        if (index >= 0)
        {
            var targetPage = (index / historyPageSize) + 1;
            if (historyPage != targetPage)
            {
                historyPage = targetPage;
            }
        }

        // Expand the result
        expandedHistoryId = resultId;
        StateHasChanged();

        // Give time for the DOM to update, then scroll
        await Task.Delay(100);
        await JS.InvokeVoidAsync("eval", $@"
            (function() {{
                var el = document.getElementById('result-{resultId}');
                if (el) {{
                    el.scrollIntoView({{ behavior: 'smooth', block: 'center' }});
                    // Brief highlight effect
                    el.style.transition = 'background-color 0.3s';
                    el.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
                    setTimeout(function() {{ el.style.backgroundColor = ''; }}, 1500);
                }}
            }})();
        ");
    }

    private async Task CopySpeedTestUrl()
    {
        if (!string.IsNullOrEmpty(openSpeedTestUrl))
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", openSpeedTestUrl);
            urlCopied = true;
            StateHasChanged();

            // Reset after 2 seconds
            await Task.Delay(2000);
            urlCopied = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _pollTimer?.Dispose();
    }
}
