@page "/settings"
@rendermode InteractiveServer
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Storage.Models
@inject UniFiConnectionService ConnectionService
@inject SqmService SqmService
@inject CellularModemService ModemService
@inject UniFiSshService SshService
@inject GatewaySpeedTestService GatewayService
@inject SystemSettingsService SystemSettings

<PageTitle>Settings - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Settings</h1>
    <p class="page-description">Configure Network Optimizer connections and preferences</p>
</div>

<div class="settings-container">
    <!-- UniFi Controller Connection -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">UniFi Controller Connection</h2>
            <span class="status-badge status-@controllerStatus.ToLower()">@controllerStatus</span>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">Controller URL</label>
                <input type="text" class="form-control" @bind="controllerUrl" placeholder="https://192.168.1.1" autocomplete="off" />
                <small class="form-help">Use local-only credentials for security</small>
            </div>

            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" @bind="controllerUsername" placeholder="admin" autocomplete="off" />
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" @bind="controllerPassword" autocomplete="new-password" placeholder="@(hasControllerPassword ? "Saved â€” enter new to update" : "Enter password")" />
            </div>

            <div class="form-group">
                <label class="form-label">Site</label>
                <input type="text" class="form-control" @bind="controllerSite" placeholder="default" autocomplete="off" />
                <small class="form-help">Usually "default" for local UniFi OS devices</small>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="rememberCredentials" />
                    <span>Remember credentials</span>
                </label>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="TestControllerConnection" disabled="@testingController">
                    @if (testingController)
                    {
                        <span class="spinner"></span>
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </button>
                <button class="btn btn-success" @onclick="SaveAndConnectController" disabled="@testingController">
                    @if (ConnectionService.IsConnected)
                    {
                        <span>Reconnect</span>
                    }
                    else
                    {
                        <span>Connect</span>
                    }
                </button>
                @if (ConnectionService.IsConnected)
                {
                    <button class="btn btn-warning" @onclick="DisconnectController">
                        Disconnect
                    </button>
                }
            </div>

            @if (!string.IsNullOrEmpty(controllerMessage))
            {
                <div class="alert alert-@controllerMessageClass">
                    @controllerMessage
                </div>
            }
        </div>
    </div>

    <!-- TC Monitor Configuration -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">TC Monitor</h2>
            <span class="status-badge status-@tcMonitorStatus.ToLower()">@tcMonitorStatus</span>
        </div>
        <div class="card-body">
            <p class="section-description">
                TC Monitor runs on your gateway and exposes SQM rates via HTTP. Deploy it from the SQM Manager page.
            </p>

            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Port</label>
                    <input type="number" class="form-control" @bind="tcMonitorPort" min="1" max="65535" />
                </div>
                <div class="form-group" style="flex: 0; align-self: flex-end;">
                    <button class="btn btn-primary" @onclick="TestTcMonitor" disabled="@testingTcMonitor">
                        @if (testingTcMonitor)
                        {
                            <span class="spinner"></span>
                            <span>Testing...</span>
                        }
                        else
                        {
                            <span>Test</span>
                        }
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(tcMonitorMessage))
            {
                <div class="alert alert-@tcMonitorMessageClass">
                    @tcMonitorMessage
                </div>
            }
        </div>
    </div>

    <!-- Gateway SSH Configuration -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Gateway SSH</h2>
            <span class="status-badge status-@(gatewaySettings?.Enabled == true ? "connected" : "disconnected")">
                @(gatewaySettings?.Enabled == true ? "Configured" : "Not Configured")
            </span>
        </div>
        <div class="card-body">
            <p class="section-description">
                Configure SSH credentials for your UniFi Gateway/UDM. Used for gateway agents,
                speed tests, and direct gateway management. The gateway typically has different
                SSH credentials than network devices.
            </p>

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label class="form-label">Gateway Host / IP</label>
                    <input type="text" class="form-control" @bind="gatewayHost" placeholder="192.168.1.1" />
                    <small class="form-help">IP address of your UniFi Gateway/UDM</small>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">SSH Port</label>
                    <input type="number" class="form-control" @bind="gatewayPort" />
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" @bind="gatewayUsername" placeholder="root" autocomplete="off" />
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" @bind="gatewayPassword" placeholder="@(hasGatewayPassword ? "Saved â€” enter new to update" : "Enter password")" autocomplete="new-password" />
            </div>

            <div class="form-group">
                <label class="form-label">Private Key Path (alternative to password)</label>
                <input type="text" class="form-control" @bind="gatewayPrivateKeyPath" placeholder="/app/ssh-keys/gateway_key" />
                <small class="form-help">Leave blank to use password authentication</small>
            </div>

            <div class="form-group">
                <label class="form-check">
                    <input type="checkbox" @bind="gatewayEnabled" />
                    <span>Enable gateway SSH access</span>
                </label>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="SaveGatewaySettings" disabled="@savingGatewaySettings">
                    @if (savingGatewaySettings)
                    {
                        <span class="spinner"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Gateway Settings</span>
                    }
                </button>
                <button class="btn btn-secondary" @onclick="TestGatewayConnection" disabled="@testingGatewayConnection">
                    @if (testingGatewayConnection)
                    {
                        <span class="spinner"></span>
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test SSH Connection</span>
                    }
                </button>
                <button class="btn btn-secondary" @onclick="CheckIperf3Status" disabled="@checkingIperf3">
                    @if (checkingIperf3)
                    {
                        <span class="spinner"></span>
                        <span>Checking...</span>
                    }
                    else
                    {
                        <span>Check iperf3 Status</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(gatewayMessage))
            {
                <div class="alert alert-@gatewayMessageClass">
                    @gatewayMessage
                </div>
            }

            @if (iperf3Status != null)
            {
                <div class="iperf3-status" style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0;">iperf3 Status</h4>
                    <div class="info-row">
                        <span class="info-label">Installed:</span>
                        <span class="info-value">@(iperf3Status.IsInstalled ? "Yes" : "No")</span>
                    </div>
                    @if (iperf3Status.IsInstalled && !string.IsNullOrEmpty(iperf3Status.Version))
                    {
                        <div class="info-row">
                            <span class="info-label">Version:</span>
                            <span class="info-value">@iperf3Status.Version</span>
                        </div>
                    }
                    <div class="info-row">
                        <span class="info-label">Running:</span>
                        <span class="info-value">@(iperf3Status.IsRunning ? $"Yes (port {iperf3Status.Port})" : "No")</span>
                    </div>
                    @if (!string.IsNullOrEmpty(iperf3Status.ServiceName))
                    {
                        <div class="info-row">
                            <span class="info-label">Service:</span>
                            <span class="info-value">@iperf3Status.ServiceName</span>
                        </div>
                    }
                    @if (!iperf3Status.IsRunning && iperf3Status.IsInstalled)
                    {
                        <button class="btn btn-success btn-sm" style="margin-top: 0.5rem;" @onclick="StartIperf3Server" disabled="@startingIperf3">
                            @if (startingIperf3)
                            {
                                <span class="spinner-sm"></span>
                                <span>Starting...</span>
                            }
                            else
                            {
                                <span>Start iperf3 Server</span>
                            }
                        </button>
                    }
                </div>
            }

            @if (gatewaySettings?.LastTestedAt != null)
            {
                <div class="form-help" style="margin-top: 1rem;">
                    Last tested: @gatewaySettings.LastTestedAt?.ToString("g") - @gatewaySettings.LastTestResult
                </div>
            }
        </div>
    </div>

    <!-- UniFi Device SSH Configuration -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">UniFi Device SSH</h2>
            <span class="status-badge status-@(sshSettings?.Enabled == true ? "connected" : "disconnected")">
                @(sshSettings?.Enabled == true ? "Configured" : "Not Configured")
            </span>
        </div>
        <div class="card-body">
            <p class="section-description">
                Configure shared SSH credentials for UniFi network devices (Access Points, Switches, Modems).
                All UniFi devices on a network share the same SSH credentials.
                These credentials are used for cellular modem monitoring and speed tests.
            </p>

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" @bind="sshUsername" placeholder="root" />
                    <small class="form-help">Usually 'root' for UniFi devices</small>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Port</label>
                    <input type="number" class="form-control" @bind="sshPort" />
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" @bind="sshPassword" placeholder="@(hasSshPassword ? "Saved â€” enter new to update" : "Enter password")" />
            </div>

            <div class="form-group">
                <label class="form-label">Private Key Path (alternative to password)</label>
                <input type="text" class="form-control" @bind="sshPrivateKeyPath" placeholder="/app/ssh-keys/id_rsa" />
                <small class="form-help">Leave blank to use password authentication</small>
            </div>

            <div class="form-group">
                <label class="form-check">
                    <input type="checkbox" @bind="sshEnabled" />
                    <span>Enable SSH access for device operations</span>
                </label>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="SaveSshSettings" disabled="@savingSshSettings">
                    @if (savingSshSettings)
                    {
                        <span class="spinner"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save SSH Settings</span>
                    }
                </button>
                <button class="btn btn-secondary" @onclick="TestSshConnection" disabled="@testingSshConnection">
                    @if (testingSshConnection)
                    {
                        <span class="spinner"></span>
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(sshMessage))
            {
                <div class="alert alert-@sshMessageClass">
                    @sshMessage
                </div>
            }

            @if (sshSettings?.LastTestedAt != null)
            {
                <div class="form-help" style="margin-top: 1rem;">
                    Last tested: @sshSettings.LastTestedAt?.ToString("g") - @sshSettings.LastTestResult
                </div>
            }
        </div>
    </div>

    <!-- Cellular Modem Configuration -->
    <div class="card" id="cellular-modem">
        <div class="card-header">
            <h2 class="card-title">Cellular Modem (5G/LTE)</h2>
            <span class="status-badge status-@modemStatus.ToLower()">@modemStatus</span>
        </div>
        <div class="card-body">
            <p class="section-description">
                Monitor cellular modems (U5G-Max, etc.) for signal strength and cell info.
                Stats are polled every 5 minutes. Requires SSH credentials configured above.
            </p>

            <!-- Discovered Modems from UniFi Controller -->
            <h4>Auto-Discovered Modems</h4>
            <div class="action-buttons" style="margin-bottom: 1rem;">
                <button class="btn btn-secondary" @onclick="LoadDiscoveredModems" disabled="@(!ConnectionService.IsConnected || loadingDiscoveredModems)">
                    @if (loadingDiscoveredModems)
                    {
                        <span class="spinner"></span>
                        <span>Scanning...</span>
                    }
                    else
                    {
                        <span>Scan for Modems</span>
                    }
                </button>
            </div>

            @if (!ConnectionService.IsConnected)
            {
                <p class="form-help">Connect to UniFi controller above to discover modems automatically.</p>
            }
            else if (discoveredModems.Count > 0)
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Model</th>
                            <th>Host</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var discovered in discoveredModems)
                        {
                            var isConfigured = modemConfigs.Any(m => m.Host == discovered.Host);
                            <tr>
                                <td>@discovered.Name</td>
                                <td><code>@discovered.Model</code></td>
                                <td><code>@discovered.Host</code></td>
                                <td>
                                    @if (discovered.IsOnline)
                                    {
                                        <span class="status-badge status-connected">Online</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disconnected">Offline</span>
                                    }
                                </td>
                                <td>
                                    @if (isConfigured)
                                    {
                                        <span class="status-badge status-connected">Configured</span>
                                    }
                                    else
                                    {
                                        <button class="btn btn-success btn-sm" @onclick="() => AddDiscoveredModem(discovered)" disabled="@savingModem">
                                            Add
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else if (ConnectionService.IsConnected && !loadingDiscoveredModems)
            {
                <p class="form-help">No cellular modems (U5G-Max, U-LTE) found. Click "Scan for Modems" to search.</p>
            }

            <!-- Configured Modems -->
            <h4 style="margin-top: 1.5rem;">Configured Modems</h4>
            @if (modemConfigs.Count > 0)
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Host</th>
                            <th>Status</th>
                            <th>Last Polled</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var modem in modemConfigs)
                        {
                            <tr>
                                <td>@modem.Name</td>
                                <td><code>@modem.Host</code></td>
                                <td>
                                    @if (modem.Enabled)
                                    {
                                        <span class="status-badge status-connected">Enabled</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disconnected">Disabled</span>
                                    }
                                </td>
                                <td>@(modem.LastPolled?.ToLocalTime().ToString("g") ?? "Never")</td>
                                <td>
                                    <button class="btn btn-secondary btn-sm" @onclick="() => EditModem(modem)">Edit</button>
                                    <button class="btn btn-secondary btn-sm" @onclick="() => TestModemConnection(modem)">Refresh</button>
                                    <button class="btn btn-danger btn-sm" @onclick="() => DeleteModem(modem)">Delete</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="empty-state">No modems configured. Scan for modems above or add one manually.</p>
            }

            <!-- Manual Add Form (collapsed by default, expands when editing) -->
            <details style="margin-top: 1.5rem;" open="@modemFormExpanded">
                <summary style="cursor: pointer; font-weight: 500;" @onclick="() => modemFormExpanded = !modemFormExpanded">@(editingModem?.Id > 0 ? "Edit Modem" : "Add Modem Manually")</summary>
                <div style="padding-top: 1rem;">
                    <p class="form-help">
                        Only use manual entry if auto-discovery doesn't find your modem.
                    </p>

                    @if (editingModem != null)
                    {
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" @bind="editingModem.Name" placeholder="U5G-Max Primary" />
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Host / IP</label>
                                <input type="text" class="form-control" @bind="editingModem.Host" placeholder="192.168.1.100" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">QMI Device Path</label>
                                <input type="text" class="form-control" @bind="editingModem.QmiDevice" placeholder="/dev/wwan0qmi0" />
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Polling Interval (sec)</label>
                                <input type="number" class="form-control" @bind="editingModem.PollingIntervalSeconds" min="60" max="3600" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-check">
                                <input type="checkbox" @bind="editingModem.Enabled" />
                                <span>Enable polling</span>
                            </label>
                        </div>
                    }

                    <div class="action-buttons">
                        <button class="btn btn-primary" @onclick="SaveModem" disabled="@savingModem">
                            @if (savingModem)
                            {
                                <span class="spinner"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>@(editingModem?.Id > 0 ? "Update Modem" : "Add Modem")</span>
                            }
                        </button>
                        @if (editingModem?.Id > 0)
                        {
                            <button class="btn btn-secondary" @onclick="CancelEditModem">Cancel</button>
                        }
                    </div>
                </div>
            </details>

            @if (!string.IsNullOrEmpty(modemMessage))
            {
                <div class="alert alert-@modemMessageClass" style="margin-top: 1rem;">
                    @modemMessage
                </div>
            }
        </div>
    </div>

    <!-- InfluxDB Configuration -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">InfluxDB Configuration</h2>
            <span class="status-badge status-@influxStatus.ToLower()">@influxStatus</span>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">InfluxDB URL</label>
                <input type="text" class="form-control" @bind="influxUrl" placeholder="http://influxdb:8086" />
            </div>

            <div class="form-group">
                <label class="form-label">Organization</label>
                <input type="text" class="form-control" @bind="influxOrg" placeholder="network-optimizer" />
            </div>

            <div class="form-group">
                <label class="form-label">Bucket</label>
                <input type="text" class="form-control" @bind="influxBucket" placeholder="network_optimizer" />
            </div>

            <div class="form-group">
                <label class="form-label">Auth Token</label>
                <input type="password" class="form-control" @bind="influxToken" />
            </div>

            <div class="form-group">
                <label class="form-label">Retention Period</label>
                <select class="form-control" @bind="influxRetention">
                    <option value="7d">7 Days</option>
                    <option value="30d">30 Days</option>
                    <option value="90d">90 Days</option>
                    <option value="1y">1 Year</option>
                    <option value="inf">Infinite</option>
                </select>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="TestInfluxConnection">
                    @if (testingInflux)
                    {
                        <span class="spinner"></span>
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </button>
                <button class="btn btn-success" @onclick="SaveInfluxSettings" disabled="@(influxStatus != "Connected")">
                    Save Settings
                </button>
            </div>

            @if (!string.IsNullOrEmpty(influxMessage))
            {
                <div class="alert alert-@influxMessageClass">
                    @influxMessage
                </div>
            }
        </div>
    </div>

    <!-- Grafana Dashboard -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Grafana Dashboards</h2>
        </div>
        <div class="card-body">
            <div class="grafana-info">
                <p>Access pre-built Grafana dashboards for detailed metrics visualization.</p>
                <div class="dashboard-links">
                    <a href="http://localhost:3000/d/network-overview" target="_blank" class="dashboard-link">
                        <span class="link-icon">ðŸ“Š</span>
                        <span>Network Overview</span>
                    </a>
                    <a href="http://localhost:3000/d/sqm-performance" target="_blank" class="dashboard-link">
                        <span class="link-icon">âš¡</span>
                        <span>SQM Performance</span>
                    </a>
                    <a href="http://localhost:3000/d/switch-deep-dive" target="_blank" class="dashboard-link">
                        <span class="link-icon">ðŸ”Œ</span>
                        <span>Switch Deep-Dive</span>
                    </a>
                    <a href="http://localhost:3000/d/ap-performance" target="_blank" class="dashboard-link">
                        <span class="link-icon">ðŸ“¡</span>
                        <span>AP Performance</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    @* License Information - hidden for now
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">License</h2>
        </div>
        <div class="card-body">
            <div class="license-info">
                <div class="info-row">
                    <span class="info-label">License Type:</span>
                    <span class="info-value">@licenseType</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Licensed To:</span>
                    <span class="info-value">@licensedTo</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Controller ID:</span>
                    <span class="info-value">@controllerId</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Activation Date:</span>
                    <span class="info-value">@activationDate</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span class="info-value status-@licenseStatus.ToLower()">@licenseStatus</span>
                </div>
            </div>

            @if (licenseStatus == "Grace Period")
            {
                <div class="alert alert-warning">
                    <strong>Grace Period Active:</strong> Controller ID changed. You have @gracePeriodDays days remaining to re-activate your license.
                </div>
            }

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="ActivateLicense">
                    Enter License Key
                </button>
                <button class="btn btn-secondary" @onclick="RequestReactivation">
                    Request Re-activation
                </button>
            </div>
        </div>
    </div>
    *@

    <!-- Application Settings -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Application Settings</h2>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">Monitoring Interval (seconds)</label>
                <input type="number" class="form-control" @bind="monitoringInterval" min="30" max="3600" />
                <small class="form-help">How often to poll devices for metrics</small>
            </div>

            <div class="form-group">
                <label class="form-label">Alert Retention (days)</label>
                <input type="number" class="form-control" @bind="alertRetention" min="1" max="365" />
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="enableNotifications" />
                    <span>Enable email notifications for critical issues</span>
                </label>
            </div>

            @if (enableNotifications)
            {
                <div class="form-group">
                    <label class="form-label">Notification Email</label>
                    <input type="email" class="form-control" @bind="notificationEmail" />
                </div>
            }

            <div class="form-group">
                <label class="form-label">Theme</label>
                <select class="form-control" @bind="theme">
                    <option value="dark">Dark (Default)</option>
                    <option value="light">Light</option>
                    <option value="auto">Auto (System)</option>
                </select>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" @onclick="SaveAppSettings">
                    Save Application Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Speed Test Settings -->
    <div class="card" id="speed-test-settings">
        <div class="card-header">
            <h2 class="card-title">Speed Test Settings</h2>
        </div>
        <div class="card-body">
            <p class="section-description">Configure iperf3 speed test parameters. Parallel streams can be configured per device type.</p>

            <h4 style="margin-top: 0; margin-bottom: 0.75rem; color: var(--text-secondary);">Parallel Streams by Device Type</h4>
            <div class="form-row" style="display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Gateway</label>
                    <input type="number" class="form-control" @bind="iperf3GatewayParallelStreams" min="1" max="16" style="width: 80px;" />
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">UniFi Devices</label>
                    <input type="number" class="form-control" @bind="iperf3UniFiParallelStreams" min="1" max="16" style="width: 80px;" />
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Other Devices</label>
                    <input type="number" class="form-control" @bind="iperf3OtherParallelStreams" min="1" max="16" style="width: 80px;" />
                </div>
            </div>
            <small class="form-help" style="display: block; margin-bottom: 1rem;">Number of parallel TCP streams (1-16). Higher values may achieve better throughput on high-bandwidth connections.</small>

            <div class="form-group">
                <label class="form-label">Test Duration (seconds)</label>
                <input type="number" class="form-control" @bind="iperf3Duration" min="3" max="60" style="width: 100px;" />
                <small class="form-help">Duration of each test direction (3-60 seconds)</small>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" @onclick="SaveIperf3Settings" disabled="@savingIperf3Settings">
                    @if (savingIperf3Settings)
                    {
                        <span class="spinner"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Settings</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(iperf3Message))
            {
                <div class="alert alert-@iperf3MessageClass">
                    @iperf3Message
                </div>
            }
        </div>
    </div>

    <!-- Data Management -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Data Management</h2>
        </div>
        <div class="card-body">
            <div class="data-actions">
                <div class="action-item">
                    <h4>Export Configuration</h4>
                    <p>Export all settings and configuration to a JSON file</p>
                    <button class="btn btn-secondary" @onclick="ExportConfig">Export Config</button>
                </div>

                <div class="action-item">
                    <h4>Import Configuration</h4>
                    <p>Import settings from a previously exported JSON file</p>
                    <button class="btn btn-secondary" @onclick="ImportConfig">Import Config</button>
                </div>

                <div class="action-item">
                    <h4>Clear Cache</h4>
                    <p>Clear cached data and temporary files</p>
                    <button class="btn btn-warning" @onclick="ClearCache">Clear Cache</button>
                </div>

                <div class="action-item danger-zone">
                    <h4>Reset All Settings</h4>
                    <p>Reset all configuration to defaults (does not affect InfluxDB data)</p>
                    <button class="btn btn-danger" @onclick="ResetSettings">Reset to Defaults</button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // UniFi Controller
    private string controllerUrl = "https://192.168.1.1";
    private string controllerUsername = "";
    private string controllerPassword = "";
    private string controllerSite = "default";
    private bool rememberCredentials = true;
    private string controllerStatus = "Disconnected";
    private bool testingController = false;
    private string controllerMessage = "";
    private string controllerMessageClass = "";
    private string? controllerInfo = null;

    // TC Monitor
    private int tcMonitorPort = 8088;
    private string tcMonitorStatus = "Unknown";
    private bool testingTcMonitor = false;
    private string tcMonitorMessage = "";
    private string tcMonitorMessageClass = "";

    // Cellular Modem
    private List<ModemConfiguration> modemConfigs = new();
    private ModemConfiguration editingModem = new() { Port = 22, Username = "root", QmiDevice = "/dev/wwan0qmi0", PollingIntervalSeconds = 300, Enabled = true };
    private string modemStatus = "Unknown";
    private bool savingModem = false;
    private string modemMessage = "";
    private string modemMessageClass = "";
    private List<DiscoveredModem> discoveredModems = new();
    private bool loadingDiscoveredModems = false;
    private bool modemFormExpanded = false;

    // Gateway SSH
    private GatewaySshSettings? gatewaySettings;
    private string gatewayHost = "";
    private string gatewayUsername = "root";
    private string gatewayPassword = "";
    private string gatewayPrivateKeyPath = "";
    private int gatewayPort = 22;
    private bool gatewayEnabled = false;
    private bool savingGatewaySettings = false;
    private bool testingGatewayConnection = false;
    private bool checkingIperf3 = false;
    private bool startingIperf3 = false;
    private string gatewayMessage = "";
    private string gatewayMessageClass = "";
    private Iperf3Status? iperf3Status;

    // UniFi Device SSH
    private UniFiSshSettings? sshSettings;
    private string sshUsername = "root";
    private string sshPassword = "";
    private string sshPrivateKeyPath = "";
    private int sshPort = 22;
    private bool sshEnabled = false;
    private bool savingSshSettings = false;
    private bool testingSshConnection = false;
    private string sshMessage = "";
    private string sshMessageClass = "";

    // Password saved status (for placeholder text)
    private bool hasControllerPassword = false;
    private bool hasGatewayPassword = false;
    private bool hasSshPassword = false;

    // Speed Test Settings
    private int iperf3GatewayParallelStreams = 3;
    private int iperf3UniFiParallelStreams = 3;
    private int iperf3OtherParallelStreams = 10;
    private int iperf3Duration = 10;
    private bool savingIperf3Settings = false;
    private string iperf3Message = "";
    private string iperf3MessageClass = "";

    // InfluxDB
    private string influxUrl = "http://influxdb:8086";
    private string influxOrg = "network-optimizer";
    private string influxBucket = "network_optimizer";
    private string influxToken = "";
    private string influxRetention = "30d";
    private string influxStatus = "Disconnected";
    private bool testingInflux = false;
    private string influxMessage = "";
    private string influxMessageClass = "";

    // License
    private string licenseType = "Standard";
    private string licensedTo = "John Doe";
    private string controllerId = "abc123def456";
    private string activationDate = "Dec 01, 2024";
    private string licenseStatus = "Active";
    private int gracePeriodDays = 30;

    // Application Settings
    private int monitoringInterval = 300;
    private int alertRetention = 30;
    private bool enableNotifications = false;
    private string notificationEmail = "";
    private string theme = "dark";

    protected override async Task OnInitializedAsync()
    {
        // Load saved configuration if available
        if (ConnectionService.CurrentConfig != null)
        {
            controllerUrl = ConnectionService.CurrentConfig.ControllerUrl;
            controllerUsername = ConnectionService.CurrentConfig.Username;
            // Don't load password - keep it empty for security
            controllerSite = ConnectionService.CurrentConfig.Site;
            rememberCredentials = ConnectionService.CurrentConfig.RememberCredentials;
        }

        // Check if controller has saved password
        var connectionSettings = await ConnectionService.GetSettingsAsync();
        hasControllerPassword = connectionSettings.HasCredentials;

        UpdateControllerStatus();
        await LoadGatewaySettings();
        await LoadSshSettings();
        await LoadModemConfigs();
        await LoadDiscoveredModems();
        await LoadIperf3Settings();
    }

    private async Task LoadIperf3Settings()
    {
        try
        {
            var settings = await SystemSettings.GetIperf3SettingsAsync();
            iperf3GatewayParallelStreams = settings.GatewayParallelStreams;
            iperf3UniFiParallelStreams = settings.UniFiParallelStreams;
            iperf3OtherParallelStreams = settings.OtherParallelStreams;
            iperf3Duration = settings.DurationSeconds;
        }
        catch (Exception ex)
        {
            iperf3Message = $"Error loading speed test settings: {ex.Message}";
            iperf3MessageClass = "danger";
        }
    }

    private async Task SaveIperf3Settings()
    {
        savingIperf3Settings = true;
        iperf3Message = "";
        StateHasChanged();

        try
        {
            // Validate inputs
            iperf3GatewayParallelStreams = Math.Clamp(iperf3GatewayParallelStreams, 1, 16);
            iperf3UniFiParallelStreams = Math.Clamp(iperf3UniFiParallelStreams, 1, 16);
            iperf3OtherParallelStreams = Math.Clamp(iperf3OtherParallelStreams, 1, 16);
            iperf3Duration = Math.Clamp(iperf3Duration, 3, 60);

            await SystemSettings.SaveIperf3SettingsAsync(new Iperf3Settings
            {
                GatewayParallelStreams = iperf3GatewayParallelStreams,
                UniFiParallelStreams = iperf3UniFiParallelStreams,
                OtherParallelStreams = iperf3OtherParallelStreams,
                DurationSeconds = iperf3Duration
            });

            iperf3Message = "Speed test settings saved successfully";
            iperf3MessageClass = "success";
        }
        catch (Exception ex)
        {
            iperf3Message = $"Error saving speed test settings: {ex.Message}";
            iperf3MessageClass = "danger";
        }
        finally
        {
            savingIperf3Settings = false;
            StateHasChanged();
        }
    }

    private async Task LoadGatewaySettings()
    {
        try
        {
            gatewaySettings = await GatewayService.GetSettingsAsync();
            gatewayHost = gatewaySettings.Host ?? "";
            gatewayUsername = gatewaySettings.Username;
            gatewayPort = gatewaySettings.Port;
            gatewayPrivateKeyPath = gatewaySettings.PrivateKeyPath ?? "";
            gatewayEnabled = gatewaySettings.Enabled;
            tcMonitorPort = gatewaySettings.TcMonitorPort;
            hasGatewayPassword = !string.IsNullOrEmpty(gatewaySettings.Password);
            // Don't load password - keep it empty for security
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error loading gateway settings: {ex.Message}";
            gatewayMessageClass = "danger";
        }
    }

    private async Task SaveGatewaySettings()
    {
        savingGatewaySettings = true;
        gatewayMessage = "";
        StateHasChanged();

        try
        {
            var settings = gatewaySettings ?? new GatewaySshSettings();
            settings.Host = gatewayHost;
            settings.Username = gatewayUsername;
            settings.Port = gatewayPort;
            settings.PrivateKeyPath = string.IsNullOrWhiteSpace(gatewayPrivateKeyPath) ? null : gatewayPrivateKeyPath;
            settings.Enabled = gatewayEnabled;
            settings.TcMonitorPort = tcMonitorPort;

            // If using private key, clear the password; otherwise update if new one entered
            if (!string.IsNullOrWhiteSpace(gatewayPrivateKeyPath))
            {
                settings.Password = null;
            }
            else if (!string.IsNullOrEmpty(gatewayPassword))
            {
                settings.Password = gatewayPassword;
            }

            gatewaySettings = await GatewayService.SaveSettingsAsync(settings);
            gatewayPassword = ""; // Clear password field
            hasGatewayPassword = !string.IsNullOrEmpty(gatewaySettings.Password);
            gatewayMessage = "Gateway settings saved successfully";
            gatewayMessageClass = "success";
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error saving gateway settings: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            savingGatewaySettings = false;
            StateHasChanged();
        }
    }

    private async Task TestGatewayConnection()
    {
        if (string.IsNullOrWhiteSpace(gatewayHost))
        {
            gatewayMessage = "Please enter a gateway host first";
            gatewayMessageClass = "warning";
            StateHasChanged();
            return;
        }

        testingGatewayConnection = true;
        gatewayMessage = $"Testing SSH connection to {gatewayHost}...";
        gatewayMessageClass = "info";
        StateHasChanged();

        try
        {
            // Save settings first if password was entered
            if (!string.IsNullOrEmpty(gatewayPassword))
            {
                await SaveGatewaySettings();
            }

            var (success, message) = await GatewayService.TestConnectionAsync();
            if (success)
            {
                gatewayMessage = "SSH connection successful!";
                gatewayMessageClass = "success";
                await LoadGatewaySettings(); // Refresh to show last tested time
            }
            else
            {
                gatewayMessage = $"SSH connection failed: {message}";
                gatewayMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            testingGatewayConnection = false;
            StateHasChanged();
        }
    }

    private async Task CheckIperf3Status()
    {
        checkingIperf3 = true;
        gatewayMessage = "Checking iperf3 status...";
        gatewayMessageClass = "info";
        StateHasChanged();

        try
        {
            iperf3Status = await GatewayService.CheckIperf3StatusAsync();
            if (!string.IsNullOrEmpty(iperf3Status.Error))
            {
                gatewayMessage = iperf3Status.Error;
                gatewayMessageClass = "warning";
            }
            else
            {
                gatewayMessage = "";
            }
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error checking iperf3: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            checkingIperf3 = false;
            StateHasChanged();
        }
    }

    private async Task StartIperf3Server()
    {
        startingIperf3 = true;
        gatewayMessage = "Starting iperf3 server...";
        gatewayMessageClass = "info";
        StateHasChanged();

        try
        {
            var (success, message) = await GatewayService.StartIperf3ServerAsync();
            if (success)
            {
                gatewayMessage = message;
                gatewayMessageClass = "success";
                // Refresh status
                iperf3Status = await GatewayService.CheckIperf3StatusAsync();
            }
            else
            {
                gatewayMessage = $"Failed to start iperf3: {message}";
                gatewayMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            startingIperf3 = false;
            StateHasChanged();
        }
    }

    private async Task LoadSshSettings()
    {
        try
        {
            sshSettings = await SshService.GetSettingsAsync();
            sshUsername = sshSettings.Username;
            sshPort = sshSettings.Port;
            sshPrivateKeyPath = sshSettings.PrivateKeyPath ?? "";
            sshEnabled = sshSettings.Enabled;
            hasSshPassword = !string.IsNullOrEmpty(sshSettings.Password);
            // Don't load password - keep it empty for security
        }
        catch (Exception ex)
        {
            sshMessage = $"Error loading SSH settings: {ex.Message}";
            sshMessageClass = "danger";
        }
    }

    private async Task SaveSshSettings()
    {
        savingSshSettings = true;
        sshMessage = "";
        StateHasChanged();

        try
        {
            var settings = sshSettings ?? new UniFiSshSettings();
            settings.Username = sshUsername;
            settings.Port = sshPort;
            settings.PrivateKeyPath = string.IsNullOrWhiteSpace(sshPrivateKeyPath) ? null : sshPrivateKeyPath;
            settings.Enabled = sshEnabled;

            // If using private key, clear the password; otherwise update if new one entered
            if (!string.IsNullOrWhiteSpace(sshPrivateKeyPath))
            {
                settings.Password = null;
            }
            else if (!string.IsNullOrEmpty(sshPassword))
            {
                settings.Password = sshPassword;
            }

            sshSettings = await SshService.SaveSettingsAsync(settings);
            sshPassword = ""; // Clear password field
            hasSshPassword = !string.IsNullOrEmpty(sshSettings.Password);
            sshMessage = "SSH settings saved successfully";
            sshMessageClass = "success";
        }
        catch (Exception ex)
        {
            sshMessage = $"Error saving SSH settings: {ex.Message}";
            sshMessageClass = "danger";
        }
        finally
        {
            savingSshSettings = false;
            StateHasChanged();
        }
    }

    private async Task TestSshConnection()
    {
        // Check if connected to the controller
        if (!ConnectionService.IsConnected || ConnectionService.Client == null)
        {
            sshMessage = "Connect to UniFi controller first to test SSH connection.";
            sshMessageClass = "warning";
            StateHasChanged();
            return;
        }

        testingSshConnection = true;
        sshMessage = "Finding an Access Point to test SSH...";
        sshMessageClass = "info";
        StateHasChanged();

        try
        {
            // Save settings first if password was entered
            if (!string.IsNullOrEmpty(sshPassword))
            {
                await SaveSshSettings();
            }

            // Get devices from the controller and find an online AP
            var devices = await ConnectionService.Client.GetDevicesAsync();
            var onlineAp = devices
                .Where(d => d.Type == "uap" && d.State == 1 && !string.IsNullOrEmpty(d.Ip))
                .FirstOrDefault();

            if (onlineAp == null)
            {
                sshMessage = "No online Access Points found. Ensure you have adopted APs in your network.";
                sshMessageClass = "warning";
                testingSshConnection = false;
                StateHasChanged();
                return;
            }

            sshMessage = $"Testing SSH connection to {onlineAp.Name} ({onlineAp.Ip})...";
            StateHasChanged();

            var (success, message) = await SshService.TestConnectionAsync(onlineAp.Ip);
            if (success)
            {
                sshMessage = $"SSH connection to {onlineAp.Name} successful!";
                sshMessageClass = "success";
                await LoadSshSettings(); // Refresh to show last tested time
            }
            else
            {
                sshMessage = $"SSH connection failed: {message}";
                sshMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            sshMessage = $"Error: {ex.Message}";
            sshMessageClass = "danger";
        }
        finally
        {
            testingSshConnection = false;
            StateHasChanged();
        }
    }

    private async Task LoadModemConfigs()
    {
        try
        {
            modemConfigs = await ModemService.GetModemsAsync();
            modemStatus = modemConfigs.Any(m => m.Enabled) ? "Active" : "Inactive";
        }
        catch (Exception ex)
        {
            modemStatus = "Error";
            modemMessage = $"Error loading modem configs: {ex.Message}";
            modemMessageClass = "danger";
        }
    }

    private async Task LoadDiscoveredModems()
    {
        if (!ConnectionService.IsConnected)
        {
            return;
        }

        loadingDiscoveredModems = true;
        StateHasChanged();

        try
        {
            discoveredModems = await ModemService.DiscoverModemsAsync();
        }
        catch (Exception ex)
        {
            modemMessage = $"Error discovering modems: {ex.Message}";
            modemMessageClass = "warning";
        }
        finally
        {
            loadingDiscoveredModems = false;
            StateHasChanged();
        }
    }

    private async Task AddDiscoveredModem(DiscoveredModem discovered)
    {
        // Check if already configured
        if (modemConfigs.Any(m => m.Host == discovered.Host))
        {
            modemMessage = $"{discovered.Name} is already configured";
            modemMessageClass = "warning";
            StateHasChanged();
            return;
        }

        savingModem = true;
        modemMessage = "";
        StateHasChanged();

        try
        {
            var config = new ModemConfiguration
            {
                Name = discovered.Name,
                Host = discovered.Host,
                Port = 22,
                Username = "root",
                ModemType = discovered.Model,
                QmiDevice = "/dev/wwan0qmi0",
                PollingIntervalSeconds = 300,
                Enabled = true
            };

            await ModemService.SaveModemAsync(config);
            modemMessage = $"Added {discovered.Name} to monitored modems";
            modemMessageClass = "success";
            await LoadModemConfigs();
        }
        catch (Exception ex)
        {
            modemMessage = $"Error adding modem: {ex.Message}";
            modemMessageClass = "danger";
        }
        finally
        {
            savingModem = false;
            StateHasChanged();
        }
    }

    private void UpdateControllerStatus()
    {
        if (ConnectionService.IsConnected)
        {
            controllerStatus = "Connected";
            controllerInfo = ConnectionService.IsUniFiOs ? "UniFi OS" : "Standalone";
        }
        else if (!string.IsNullOrEmpty(ConnectionService.LastError))
        {
            controllerStatus = "Error";
        }
        else
        {
            controllerStatus = "Disconnected";
        }
    }

    private async Task<UniFiConnectionConfig> BuildConfigAsync()
    {
        // Use newly entered password, or fall back to stored password from database
        var password = controllerPassword;
        if (string.IsNullOrEmpty(password))
        {
            password = await ConnectionService.GetStoredPasswordAsync() ?? "";
        }

        return new UniFiConnectionConfig
        {
            ControllerUrl = controllerUrl,
            Username = controllerUsername,
            Password = password,
            Site = string.IsNullOrWhiteSpace(controllerSite) ? "default" : controllerSite,
            RememberCredentials = rememberCredentials
        };
    }

    private async Task TestControllerConnection()
    {
        testingController = true;
        controllerMessage = "";
        StateHasChanged();

        try
        {
            var config = await BuildConfigAsync();
            var (success, error, info) = await ConnectionService.TestConnectionAsync(config);

            if (success)
            {
                controllerStatus = "Connected";
                controllerInfo = info;
                controllerMessage = $"Successfully connected: {info}";
                controllerMessageClass = "success";
            }
            else
            {
                controllerStatus = "Error";
                controllerMessage = $"Connection failed: {error}";
                controllerMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            controllerStatus = "Error";
            controllerMessage = $"Error: {ex.Message}";
            controllerMessageClass = "danger";
        }
        finally
        {
            testingController = false;
            StateHasChanged();
        }
    }

    private async Task SaveAndConnectController()
    {
        testingController = true;
        controllerMessage = "";
        StateHasChanged();

        try
        {
            var config = await BuildConfigAsync();
            var success = await ConnectionService.ConnectAsync(config);

            if (success)
            {
                controllerStatus = "Connected";
                controllerInfo = ConnectionService.IsUniFiOs ? "UniFi OS" : "Standalone";
                controllerMessage = $"Connected and saved! ({controllerInfo})";
                controllerMessageClass = "success";
                hasControllerPassword = true;
                controllerPassword = ""; // Clear the password field
            }
            else
            {
                controllerStatus = "Error";
                controllerMessage = $"Connection failed: {ConnectionService.LastError}";
                controllerMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            controllerStatus = "Error";
            controllerMessage = $"Error: {ex.Message}";
            controllerMessageClass = "danger";
        }
        finally
        {
            testingController = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectController()
    {
        await ConnectionService.DisconnectAsync();
        controllerStatus = "Disconnected";
        controllerMessage = "Disconnected from controller";
        controllerMessageClass = "info";
        controllerInfo = null;
        StateHasChanged();
    }

    private async Task TestTcMonitor()
    {
        testingTcMonitor = true;
        tcMonitorMessage = "";
        StateHasChanged();

        try
        {
            var (available, error) = await SqmService.TestTcMonitorAsync(null, tcMonitorPort);

            if (available)
            {
                tcMonitorStatus = "Connected";
                tcMonitorMessage = "TC Monitor is responding";
                tcMonitorMessageClass = "success";
            }
            else
            {
                tcMonitorStatus = "Offline";
                tcMonitorMessage = error ?? "TC Monitor is not responding";
                tcMonitorMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            tcMonitorStatus = "Error";
            tcMonitorMessage = $"Error: {ex.Message}";
            tcMonitorMessageClass = "danger";
        }
        finally
        {
            testingTcMonitor = false;
            StateHasChanged();
        }
    }

    // Modem methods
    private void EditModem(ModemConfiguration modem)
    {
        editingModem = new ModemConfiguration
        {
            Id = modem.Id,
            Name = modem.Name,
            Host = modem.Host,
            Port = modem.Port,
            Username = modem.Username,
            Password = modem.Password,
            PrivateKeyPath = modem.PrivateKeyPath,
            ModemType = modem.ModemType,
            QmiDevice = modem.QmiDevice,
            Enabled = modem.Enabled,
            PollingIntervalSeconds = modem.PollingIntervalSeconds
        };
        modemMessage = "";
        modemFormExpanded = true;  // Expand the form when editing
        StateHasChanged();
    }

    private void CancelEditModem()
    {
        editingModem = new ModemConfiguration
        {
            Port = 22,
            Username = "root",
            QmiDevice = "/dev/wwan0qmi0",
            PollingIntervalSeconds = 300,
            Enabled = true
        };
        modemFormExpanded = false;  // Collapse the form when canceling
        modemMessage = "";
        StateHasChanged();
    }

    private async Task SaveModem()
    {
        if (string.IsNullOrWhiteSpace(editingModem.Name) || string.IsNullOrWhiteSpace(editingModem.Host))
        {
            modemMessage = "Name and Host are required";
            modemMessageClass = "danger";
            return;
        }

        savingModem = true;
        modemMessage = "";
        StateHasChanged();

        try
        {
            await ModemService.SaveModemAsync(editingModem);
            modemMessage = editingModem.Id > 0 ? "Modem updated successfully" : "Modem added successfully";
            modemMessageClass = "success";

            // Refresh list and reset form
            await LoadModemConfigs();
            CancelEditModem();
        }
        catch (Exception ex)
        {
            modemMessage = $"Error saving modem: {ex.Message}";
            modemMessageClass = "danger";
        }
        finally
        {
            savingModem = false;
            StateHasChanged();
        }
    }

    private async Task DeleteModem(ModemConfiguration modem)
    {
        try
        {
            await ModemService.DeleteModemAsync(modem.Id);
            modemMessage = $"Deleted modem: {modem.Name}";
            modemMessageClass = "success";
            await LoadModemConfigs();
        }
        catch (Exception ex)
        {
            modemMessage = $"Error deleting modem: {ex.Message}";
            modemMessageClass = "danger";
        }
        StateHasChanged();
    }

    private async Task TestModemConnection(ModemConfiguration modem)
    {
        modemMessage = $"Polling {modem.Name}...";
        modemMessageClass = "info";
        StateHasChanged();

        try
        {
            var (success, message) = await ModemService.PollModemAsync(modem);
            if (success)
            {
                modemMessage = message;
                modemMessageClass = "success";
                // Reload modem list to show updated LastPolled timestamp
                modemConfigs = await ModemService.GetModemsAsync();
            }
            else
            {
                modemMessage = message;
                modemMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            modemMessage = $"Error: {ex.Message}";
            modemMessageClass = "danger";
        }
        StateHasChanged();
    }

    private async Task TestInfluxConnection()
    {
        testingInflux = true;
        influxMessage = "";
        StateHasChanged();

        try
        {
            await Task.Delay(1500);
            // TODO: Implement actual connection test
            influxStatus = "Connected";
            influxMessage = "Successfully connected to InfluxDB";
            influxMessageClass = "success";
        }
        catch
        {
            influxStatus = "Error";
            influxMessage = "Failed to connect. Check URL and token.";
            influxMessageClass = "danger";
        }
        finally
        {
            testingInflux = false;
            StateHasChanged();
        }
    }

    private async Task SaveInfluxSettings()
    {
        // TODO: Implement save
        await Task.CompletedTask;
    }

    private async Task ActivateLicense()
    {
        // TODO: Implement license activation
        await Task.CompletedTask;
    }

    private async Task RequestReactivation()
    {
        // TODO: Implement reactivation request
        await Task.CompletedTask;
    }

    private async Task SaveAppSettings()
    {
        // TODO: Implement save
        await Task.CompletedTask;
    }

    private async Task ExportConfig()
    {
        // TODO: Implement export
        await Task.CompletedTask;
    }

    private async Task ImportConfig()
    {
        // TODO: Implement import
        await Task.CompletedTask;
    }

    private async Task ClearCache()
    {
        // TODO: Implement cache clear
        await Task.CompletedTask;
    }

    private async Task ResetSettings()
    {
        // TODO: Implement reset
        await Task.CompletedTask;
    }
}
