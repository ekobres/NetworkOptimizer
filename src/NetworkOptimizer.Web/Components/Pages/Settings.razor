@page "/settings"
@rendermode InteractiveServer
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Web.Services.Ssh
@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.Storage.Interfaces
@using NetworkOptimizer.Core.Interfaces
@inject UniFiConnectionService ConnectionService
@inject IGatewaySshService GatewaySshService
@inject IAuditRepository AuditRepository
@inject ISpeedTestRepository SpeedTestRepository
@inject AuditService AuditService
@inject SqmService SqmService
@inject CellularModemService ModemService
@inject UniFiSshService SshService
@inject GatewaySpeedTestService GatewayService
@inject SystemSettingsService SystemSettings
@inject IAdminAuthService AdminAuth
@using NetworkOptimizer.Web.Components.Shared

<PageTitle>Settings - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Settings</h1>
    <p class="page-description">Configure Network Optimizer connections and preferences</p>
</div>

<div class="settings-container">
    <!-- 1. UniFi Console Connection -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">UniFi Console (Controller) Connection</h2>
            <span class="status-badge status-@controllerStatus.ToLower()">@controllerStatus</span>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">Console URL</label>
                <input type="text" class="form-control" @bind="controllerUrl" placeholder="https://192.168.1.1" autocomplete="off" data-1p-ignore data-lpignore="true" data-bwignore />
                <small class="form-help">UniFi OS device (UDM, UCG, UDR, or Cloud Key) or self-hosted Network Server. Use local-only credentials for security.</small>
            </div>

            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" @bind="controllerUsername" placeholder="admin" autocomplete="off" data-1p-ignore data-lpignore="true" data-bwignore />
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" @bind="controllerPassword" autocomplete="new-password" placeholder="@(hasControllerPassword ? "Saved â€” enter new to update" : "Enter password")" data-1p-ignore data-lpignore="true" data-bwignore />
            </div>

            <div class="form-group">
                <label class="form-label">Site</label>
                <div class="input-with-button">
                    @if (availableSites.Count > 0)
                    {
                        <select class="form-control" @bind="controllerSite">
                            @foreach (var site in availableSites)
                            {
                                <option value="@site.Name">@site.Description (@site.Name) - @site.DeviceCount devices</option>
                            }
                        </select>
                    }
                    else
                    {
                        <input type="text" class="form-control" @bind="controllerSite" placeholder="default" autocomplete="off" data-1p-ignore data-lpignore="true" data-bwignore />
                    }
                    <button type="button" class="btn btn-secondary btn-sm" @onclick="ListSites" disabled="@loadingSites">
                        @if (loadingSites)
                        {
                            <span class="spinner"></span>
                        }
                        else
                        {
                            <span>List Sites</span>
                        }
                    </button>
                </div>
                <small class="form-help">Leave as "default" for most local UniFi OS devices. If you have multiple sites or are unsure, click "List Sites" to fetch available sites.</small>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="rememberCredentials" />
                    <span>Remember credentials</span>
                </label>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="ignoreControllerSSLErrors" />
                    <span>Ignore SSL certificate errors</span>
                </label>
                <small class="form-help">Enable this for UniFi Consoles with self-signed certificates (default)</small>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="SaveAndConnectController" disabled="@testingController">
                    @if (ConnectionService.IsConnected)
                    {
                        <span>Update</span>
                    }
                    else
                    {
                        <span>Connect</span>
                    }
                </button>
                <button class="btn btn-secondary" @onclick="TestControllerConnection" disabled="@testingController">
                    @if (testingController)
                    {
                        <span class="spinner"></span>
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </button>
                @if (ConnectionService.IsConnected)
                {
                    <button class="btn btn-warning" @onclick="DisconnectController">
                        Disconnect
                    </button>
                }
            </div>

            @if (!string.IsNullOrEmpty(controllerMessage))
            {
                <div class="alert alert-@controllerMessageClass">
                    @controllerMessage
                </div>
            }

            <details class="setup-guide" open="@(!ConnectionService.IsConnected)">
                <summary>How to Create a UniFi Local Account</summary>
                <div class="setup-guide-content">
                    <p>Network Optimizer requires a <strong>Local Access Only</strong> account on your UniFi Console (Controller). Ubiquiti SSO accounts will not work.</p>

                    <h4>Quick Setup</h4>
                    <p>For the easiest setup, create a <strong>Local Access Only</strong> account with <strong>Super Admin</strong> role.</p>

                    <h4>Restricted Setup (Recommended)</h4>
                    <p>For a more secure, least-privilege configuration:</p>
                    <ol>
                        <li>Open UniFi Network: <code>https://&lt;gateway-ip&gt;</code> or <code>https://unifi.ui.com</code></li>
                        <li>Sign in to your Console</li>
                        <li>Click <strong>Admin &amp; Users</strong> at the bottom of the side menu</li>
                        <li>Click <strong>Create New</strong> at the top</li>
                        <li>Select <strong>Create New User</strong></li>
                        <li>Enter a name and email for this service account</li>
                        <li>Check <strong>Admin</strong></li>
                        <li>Check <strong>Restrict to Local Access Only</strong></li>
                        <li>Uncheck <strong>Use a Predefined Role</strong></li>
                        <li>Set permissions:
                            <ul>
                                <li><strong>Network:</strong> View Only</li>
                                <li><strong>Protect:</strong> View Only</li>
                                <li><strong>User &amp; Account Management:</strong> None</li>
                            </ul>
                        </li>
                        <li>Set a secure password and save</li>
                    </ol>
                    <p>Use this username and password in the fields above.</p>
                </div>
            </details>
        </div>
    </div>

    <!-- 2. Admin Password -->
    <div class="card" id="admin-password">
        <div class="card-header">
            <h2 class="card-title">Admin Password</h2>
            <span class="status-badge status-@(adminPasswordSource == AdminPasswordSource.None ? "disconnected" : "connected")">
                @GetAdminPasswordSourceLabel()
            </span>
        </div>
        <div class="card-body">
            <p class="section-description">
                Set an admin password to protect access to this application. The password can be configured here
                (stored encrypted in the database) or via the <code>APP_PASSWORD</code> environment variable.
                Database password takes priority when enabled.
            </p>

            <div class="info-row" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <span class="info-label">Current Source:</span>
                <span class="info-value">
                    @switch (adminPasswordSource)
                    {
                        case AdminPasswordSource.Database:
                            <span style="color: var(--success);">Database (User Configured)</span>
                            break;
                        case AdminPasswordSource.Environment:
                            <span style="color: var(--warning);">Environment Variable (APP_PASSWORD)</span>
                            break;
                        case AdminPasswordSource.AutoGenerated:
                            <span style="color: var(--warning);">Auto-Generated (see startup logs)</span>
                            break;
                        case AdminPasswordSource.None:
                            <span style="color: var(--danger);">Not Configured</span>
                            break;
                    }
                </span>
            </div>

            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" class="form-control" @bind="adminNewPassword" @bind:event="oninput" @bind:after="OnAdminPasswordInput" placeholder="Enter new password" autocomplete="new-password" />
            </div>

            <div class="form-group">
                <label class="form-label">Confirm Password</label>
                <input type="password" class="form-control" @bind="adminConfirmPassword" @bind:event="oninput" @bind:after="OnAdminPasswordInput" placeholder="Confirm new password" autocomplete="new-password" />
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="SaveAdminPassword" disabled="@savingAdminPassword">
                    @if (savingAdminPassword)
                    {
                        <span class="spinner"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Password</span>
                    }
                </button>
                @if (adminPasswordSource == AdminPasswordSource.Database)
                {
                    <button class="btn btn-warning" @onclick="ClearAdminPassword" disabled="@savingAdminPassword">
                        Clear Database Password
                    </button>
                }
            </div>

            @if (!string.IsNullOrEmpty(adminPasswordMessage))
            {
                <div class="alert alert-@adminPasswordMessageClass">
                    @adminPasswordMessage
                </div>
            }
        </div>
    </div>

    <!-- 3. Gateway SSH -->
    <div class="card" id="gateway-ssh">
        <div class="card-header">
            <h2 class="card-title">Gateway SSH</h2>
            <span class="status-badge status-@(gatewaySettings?.Enabled == true ? "connected" : "disconnected")">
                @(gatewaySettings?.Enabled == true ? "Configured" : "Not Configured")
            </span>
        </div>
        <div class="card-body">
            <p class="section-description">
                Configure SSH credentials for your UniFi Gateway or UniFi OS Device. Used for
                iperf3 speed tests against the gateway and Adaptive SQM. Not required for
                Security Audit or LAN Speed Tests to other devices.
            </p>

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label class="form-label">Gateway Host / IP</label>
                    <input type="text" class="form-control" @bind="gatewayHost" placeholder="192.168.1.1" />
                    <small class="form-help">IP address of your UniFi Gateway/UDM</small>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">SSH Port</label>
                    <input type="number" class="form-control" @bind="gatewayPort" />
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" @bind="gatewayUsername" placeholder="root" autocomplete="off" data-1p-ignore data-lpignore="true" data-bwignore />
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" @bind="gatewayPassword" placeholder="@(hasGatewayPassword ? "Saved â€” enter new to update" : "Enter password")" autocomplete="new-password" data-1p-ignore data-lpignore="true" data-bwignore />
            </div>

            <div class="form-group">
                <label class="form-label">Private Key Path (alternative to password)</label>
                <input type="text" class="form-control" @bind="gatewayPrivateKeyPath" placeholder="/app/ssh-keys/gateway_key" />
                <small class="form-help">Leave blank to use password authentication</small>
            </div>

            <div class="form-group">
                <label class="form-check">
                    <input type="checkbox" @bind="gatewayEnabled" />
                    <span>Enable gateway SSH access</span>
                </label>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="SaveGatewaySettings" disabled="@savingGatewaySettings">
                    @if (savingGatewaySettings)
                    {
                        <span class="spinner"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Gateway Settings</span>
                    }
                </button>
                <button class="btn btn-secondary" @onclick="TestGatewayConnection" disabled="@testingGatewayConnection">
                    @if (testingGatewayConnection)
                    {
                        <span class="spinner"></span>
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test SSH Connection</span>
                    }
                </button>
                <button class="btn btn-secondary" @onclick="CheckIperf3Status" disabled="@checkingIperf3">
                    @if (checkingIperf3)
                    {
                        <span class="spinner"></span>
                        <span>Checking...</span>
                    }
                    else
                    {
                        <span>Check iperf3 Status</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(gatewayMessage))
            {
                <div class="alert alert-@gatewayMessageClass alert-with-tooltip">
                    <span class="alert-text">@gatewayMessage</span>
                    @if (gatewayMessageClass == "danger")
                    {
                        <SshTroubleshootingTooltip Context="gateway" HideSettingsLink="true" />
                    }
                </div>
            }

            @if (iperf3Status != null)
            {
                <div class="iperf3-status" style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0;">iperf3 Status</h4>
                    <div class="info-row">
                        <span class="info-label">Installed:</span>
                        <span class="info-value">@(iperf3Status.IsInstalled ? "Yes" : "No")</span>
                    </div>
                    @if (iperf3Status.IsInstalled && !string.IsNullOrEmpty(iperf3Status.Version))
                    {
                        <div class="info-row">
                            <span class="info-label">Version:</span>
                            <span class="info-value">@iperf3Status.Version</span>
                        </div>
                    }
                    <div class="info-row">
                        <span class="info-label">Running:</span>
                        <span class="info-value">@(iperf3Status.IsRunning ? $"Yes (port {iperf3Status.Port})" : "No")</span>
                    </div>
                    @if (!string.IsNullOrEmpty(iperf3Status.ServiceName))
                    {
                        <div class="info-row">
                            <span class="info-label">Service:</span>
                            <span class="info-value">@iperf3Status.ServiceName</span>
                        </div>
                    }
                    @if (!iperf3Status.IsRunning && iperf3Status.IsInstalled)
                    {
                        <button class="btn btn-success btn-sm" style="margin-top: 0.5rem;" @onclick="StartIperf3Server" disabled="@startingIperf3">
                            @if (startingIperf3)
                            {
                                <span class="spinner-sm"></span>
                                <span>Starting...</span>
                            }
                            else
                            {
                                <span>Start iperf3 Server</span>
                            }
                        </button>
                    }
                </div>
            }

            @if (gatewaySettings?.LastTestedAt != null)
            {
                <div class="form-help" style="margin-top: 1rem;">
                    Last tested: @gatewaySettings.LastTestedAt?.ToLocalTime().ToString("g") - @gatewaySettings.LastTestResult
                </div>
            }

            <details class="setup-guide" open="@(gatewaySettings?.Enabled != true)">
                <summary>How to Enable Gateway SSH</summary>
                <div class="setup-guide-content">
                    <p><strong>For Cloud Gateways (UCG, UDM, UDM Pro, etc.):</strong></p>
                    <ol>
                        <li>Open UniFi Network: <code>https://&lt;gateway-ip&gt;</code> or <code>https://unifi.ui.com</code></li>
                        <li>Sign in to your Console</li>
                        <li>Click <strong>Settings</strong> on the bottom portion of the side menu</li>
                        <li>Navigate to <strong>Control Plane</strong> â†’ <strong>Console</strong></li>
                        <li>Enable <strong>SSH</strong> and set a secure password</li>
                    </ol>
                    <p>Use <code>root</code> as the username and the SSH password you set above.</p>
                    <p><strong>For UXG (non-Cloud Gateway):</strong> Enable SSH using the Device SSH steps below, but enter those credentials here in Gateway SSH.</p>
                </div>
            </details>
        </div>
    </div>

    <!-- 4. Device SSH -->
    <div class="card" id="device-ssh">
        <div class="card-header">
            <h2 class="card-title">Device SSH</h2>
            <span class="status-badge status-@(sshSettings?.Enabled == true ? "connected" : "disconnected")">
                @(sshSettings?.Enabled == true ? "Configured" : "Not Configured")
            </span>
        </div>
        <div class="card-body">
            <p class="section-description">
                Configure shared SSH credentials for UniFi network devices (Access Points, Switches, Modems).
                All UniFi devices on a network share the same SSH credentials.
                These credentials are used for cellular modem monitoring and speed tests, and provide the
                default credentials for custom speed test devices.
            </p>

            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Port</label>
                    <input type="number" class="form-control" @bind="sshPort" />
                </div>
                <div class="form-group" style="flex: 2;">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" @bind="sshUsername" placeholder="Your Device SSH username" autocomplete="off" data-1p-ignore data-lpignore="true" data-bwignore />
                    <small class="form-help">Set in UniFi Network (see below for instructions), usually randomly generated by default</small>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-control" @bind="sshPassword" placeholder="@(hasSshPassword ? "Saved â€” enter new to update" : "Enter password")" autocomplete="new-password" data-1p-ignore data-lpignore="true" data-bwignore />
            </div>

            <div class="form-group">
                <label class="form-label">Private Key Path (alternative to password)</label>
                <input type="text" class="form-control" @bind="sshPrivateKeyPath" placeholder="/app/ssh-keys/id_rsa" />
                <small class="form-help">Leave blank to use password authentication</small>
            </div>

            <div class="form-group">
                <label class="form-check">
                    <input type="checkbox" @bind="sshEnabled" />
                    <span>Enable SSH access for device operations</span>
                </label>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="SaveSshSettings" disabled="@savingSshSettings">
                    @if (savingSshSettings)
                    {
                        <span class="spinner"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save SSH Settings</span>
                    }
                </button>
                <button class="btn btn-secondary" @onclick="TestSshConnection" disabled="@testingSshConnection">
                    @if (testingSshConnection)
                    {
                        <span class="spinner"></span>
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(sshMessage))
            {
                <div class="alert alert-@sshMessageClass alert-with-tooltip">
                    <span class="alert-text">@sshMessage</span>
                    @if (sshMessageClass == "danger")
                    {
                        <SshTroubleshootingTooltip Context="devices" HideSettingsLink="true" />
                    }
                </div>
            }

            @if (sshSettings?.LastTestedAt != null)
            {
                <div class="form-help" style="margin-top: 1rem;">
                    Last tested: @sshSettings.LastTestedAt?.ToLocalTime().ToString("g") - @sshSettings.LastTestResult
                </div>
            }

            <details class="setup-guide" open="@(sshSettings?.Enabled != true)">
                <summary>How to Enable UniFi Device SSH</summary>
                <div class="setup-guide-content">
                    <ol>
                        <li>Open UniFi Network: <code>https://&lt;gateway-ip&gt;</code> or <code>https://unifi.ui.com</code></li>
                        <li>Sign in to your Console</li>
                        <li>Click <strong>UniFi Devices</strong> on the side menu</li>
                        <li>In the left-hand filter menu, select <strong>Device Updates and Settings</strong> at the bottom</li>
                        <li>Expand <strong>Device SSH Settings</strong> at the bottom</li>
                        <li>Check <strong>Device SSH Authentication</strong></li>
                        <li>Set a username and secure password (optionally add SSH public keys)</li>
                        <li>Save</li>
                    </ol>
                    <p><strong>Note:</strong> This is a separate credential from Gateway SSH.</p>
                </div>
            </details>
        </div>
    </div>

    <!-- 5. Adaptive SQM Monitor -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Adaptive SQM Monitor</h2>
            <span class="status-badge status-@tcMonitorStatus.ToLower()">@tcMonitorStatus</span>
        </div>
        <div class="card-body">
            <p class="section-description">
                The Adaptive SQM Monitor runs on your gateway and exposes current SQM rates via HTTP for the dashboard. Deploy it from the SQM Manager page.
            </p>

            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Port</label>
                    <input type="number" class="form-control" @bind="tcMonitorPort" min="1" max="65535" />
                </div>
                <div class="form-group" style="flex: 0; align-self: flex-end;">
                    <button class="btn btn-primary" @onclick="TestTcMonitor" disabled="@testingTcMonitor">
                        @if (testingTcMonitor)
                        {
                            <span class="spinner"></span>
                            <span>Testing...</span>
                        }
                        else
                        {
                            <span>Test</span>
                        }
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(tcMonitorMessage))
            {
                <div class="alert alert-@tcMonitorMessageClass">
                    @tcMonitorMessage
                </div>
            }
        </div>
    </div>

    <!-- 6. Cellular Modem -->
    <div class="card" id="cellular-modem">
        <div class="card-header">
            <h2 class="card-title">Cellular Modem (5G/LTE)</h2>
            <span class="status-badge status-@modemStatus.ToLower()">@modemStatus</span>
        </div>
        <div class="card-body">
            <p class="section-description">
                Monitor cellular modems (U5G-Max, etc.) for signal strength and cell info.
                Stats are polled every 5 minutes. Requires SSH credentials configured above.
            </p>

            @if (sshSettings?.HasCredentials != true)
            {
                <div class="alert alert-warning" style="margin-bottom: 1rem;">
                    <strong>SSH credentials required:</strong> Configure Device SSH credentials above before adding modems.
                    <a href="#device-ssh" style="margin-left: 0.5rem;">Go to Device SSH Settings</a>
                </div>
            }

            <!-- Discovered Modems from UniFi Console -->
            <h4>Auto-Discovered Modems</h4>
            <div class="action-buttons" style="margin-bottom: 1rem;">
                <button class="btn btn-secondary" @onclick="LoadDiscoveredModems" disabled="@(!ConnectionService.IsConnected || loadingDiscoveredModems)">
                    @if (loadingDiscoveredModems)
                    {
                        <span class="spinner"></span>
                        <span>Scanning...</span>
                    }
                    else
                    {
                        <span>Scan for Modems</span>
                    }
                </button>
            </div>

            @if (!ConnectionService.IsConnected)
            {
                <p class="form-help">Connect to UniFi Console above to discover modems automatically.</p>
            }
            else if (discoveredModems.Count > 0)
            {
                <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Model</th>
                            <th>Host</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var discovered in discoveredModems)
                        {
                            var isConfigured = modemConfigs.Any(m => m.Host == discovered.Host);
                            <tr>
                                <td>@discovered.Name</td>
                                <td><code>@discovered.Model</code></td>
                                <td><code>@discovered.Host</code></td>
                                <td>
                                    @if (discovered.IsOnline)
                                    {
                                        <span class="status-badge status-connected">Online</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disconnected">Offline</span>
                                    }
                                </td>
                                <td>
                                    @if (isConfigured)
                                    {
                                        <span class="status-badge status-connected">Configured</span>
                                    }
                                    else if (sshSettings?.HasCredentials != true)
                                    {
                                        <span class="status-badge status-warning" title="Configure SSH credentials first">SSH Required</span>
                                    }
                                    else
                                    {
                                        <button class="btn btn-success btn-sm" @onclick="() => AddDiscoveredModem(discovered)" disabled="@savingModem">
                                            Add
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                </div>
            }
            else if (ConnectionService.IsConnected && !loadingDiscoveredModems)
            {
                <p class="form-help">No cellular modems (U5G-Max, U-LTE) found. Click "Scan for Modems" to search.</p>
            }

            <!-- Configured Modems -->
            <h4 style="margin-top: 1.5rem;">Configured Modems</h4>
            @if (modemConfigs.Count > 0)
            {
                <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Host</th>
                            <th>Status</th>
                            <th>Last Polled</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var modem in modemConfigs)
                        {
                            <tr>
                                <td>@modem.Name</td>
                                <td><code>@modem.Host</code></td>
                                <td>
                                    @if (modem.Enabled)
                                    {
                                        <span class="status-badge status-connected">Enabled</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disconnected">Disabled</span>
                                    }
                                </td>
                                <td>@(modem.LastPolled?.ToLocalTime().ToString("g") ?? "Never")</td>
                                <td>
                                    <button class="btn btn-secondary btn-sm" @onclick="() => EditModem(modem)">Edit</button>
                                    <button class="btn btn-secondary btn-sm" @onclick="() => TestModemConnection(modem)">Refresh</button>
                                    <button class="btn btn-danger btn-sm" @onclick="() => DeleteModem(modem)">Delete</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                </div>
            }
            else
            {
                <p class="empty-state">No modems configured. Scan for modems above or add one manually.</p>
            }

            <!-- Manual Add Form (collapsed by default, expands when editing) -->
            <details style="margin-top: 1.5rem;" open="@modemFormExpanded">
                <summary style="cursor: pointer; font-weight: 500;" @onclick="() => modemFormExpanded = !modemFormExpanded">@(editingModem?.Id > 0 ? "Edit Modem" : "Add Modem Manually")</summary>
                <div style="padding-top: 1rem;">
                    <p class="form-help">
                        Only use manual entry if auto-discovery doesn't find your modem.
                    </p>

                    @if (editingModem != null)
                    {
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" @bind="editingModem.Name" placeholder="U5G-Max Primary" />
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Host / IP</label>
                                <input type="text" class="form-control" @bind="editingModem.Host" placeholder="192.168.1.100" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">QMI Device Path</label>
                                <input type="text" class="form-control" @bind="editingModem.QmiDevice" placeholder="/dev/wwan0qmi0" />
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Polling Interval (sec)</label>
                                <input type="number" class="form-control" @bind="editingModem.PollingIntervalSeconds" min="60" max="3600" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-check">
                                <input type="checkbox" @bind="editingModem.Enabled" />
                                <span>Enable polling</span>
                            </label>
                        </div>
                    }

                    <div class="action-buttons">
                        <button class="btn btn-primary" @onclick="SaveModem" disabled="@savingModem">
                            @if (savingModem)
                            {
                                <span class="spinner"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>@(editingModem?.Id > 0 ? "Update Modem" : "Add Modem")</span>
                            }
                        </button>
                        @if (editingModem?.Id > 0)
                        {
                            <button class="btn btn-secondary" @onclick="CancelEditModem">Cancel</button>
                        }
                    </div>
                </div>
            </details>

            @if (!string.IsNullOrEmpty(modemMessage))
            {
                <div class="alert alert-@modemMessageClass" style="margin-top: 1rem;">
                    @modemMessage
                </div>
            }
        </div>
    </div>

    <!-- 7. Speed Test Settings -->
    <div class="card" id="speed-test-settings">
        <div class="card-header">
            <h2 class="card-title">Speed Test Settings</h2>
        </div>
        <div class="card-body">
            <p class="section-description">Configure iperf3 speed test parameters. Parallel streams can be configured per device type.</p>

            <h4 style="margin-top: 0; margin-bottom: 0.75rem; color: var(--text-secondary);">Parallel Streams by Device Type</h4>
            <div class="form-row" style="display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Gateway</label>
                    <input type="number" class="form-control" @bind="iperf3GatewayParallelStreams" min="1" max="16" style="width: 80px;" />
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">UniFi Devices</label>
                    <input type="number" class="form-control" @bind="iperf3UniFiParallelStreams" min="1" max="16" style="width: 80px;" />
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Other Devices</label>
                    <input type="number" class="form-control" @bind="iperf3OtherParallelStreams" min="1" max="16" style="width: 80px;" />
                </div>
            </div>
            <small class="form-help" style="display: block; margin-bottom: 1rem;">Number of parallel TCP streams (1-16). Higher values may achieve better throughput on high-bandwidth connections.</small>

            <div class="form-group">
                <label class="form-label">Test Duration (seconds)</label>
                <input type="number" class="form-control" @bind="iperf3Duration" min="3" max="60" style="width: 100px;" />
                <small class="form-help">Duration of each test direction (3-60 seconds)</small>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" @onclick="SaveIperf3Settings" disabled="@savingIperf3Settings">
                    @if (savingIperf3Settings)
                    {
                        <span class="spinner"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Settings</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(iperf3Message))
            {
                <div class="alert alert-@iperf3MessageClass">
                    @iperf3Message
                </div>
            }
        </div>
    </div>

    @* InfluxDB Configuration - hidden until time-series metrics are implemented
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">InfluxDB Configuration</h2>
            <span class="status-badge status-@influxStatus.ToLower()">@influxStatus</span>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">InfluxDB URL</label>
                <input type="text" class="form-control" @bind="influxUrl" placeholder="http://influxdb:8086" />
            </div>

            <div class="form-group">
                <label class="form-label">Organization</label>
                <input type="text" class="form-control" @bind="influxOrg" placeholder="network-optimizer" />
            </div>

            <div class="form-group">
                <label class="form-label">Bucket</label>
                <input type="text" class="form-control" @bind="influxBucket" placeholder="network_optimizer" autocomplete="off" data-1p-ignore data-lpignore="true" data-bwignore />
            </div>

            <div class="form-group">
                <label class="form-label">Auth Token</label>
                <input type="text" class="form-control" @bind="influxToken" autocomplete="off" data-1p-ignore data-lpignore="true" data-bwignore />
            </div>

            <div class="form-group">
                <label class="form-label">Retention Period</label>
                <select class="form-control" @bind="influxRetention">
                    <option value="7d">7 Days</option>
                    <option value="30d">30 Days</option>
                    <option value="90d">90 Days</option>
                    <option value="1y">1 Year</option>
                    <option value="inf">Infinite</option>
                </select>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="TestInfluxConnection">
                    @if (testingInflux)
                    {
                        <span class="spinner"></span>
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </button>
                <button class="btn btn-success" @onclick="SaveInfluxSettings" disabled="@(influxStatus != "Connected")">
                    Save Settings
                </button>
            </div>

            @if (!string.IsNullOrEmpty(influxMessage))
            {
                <div class="alert alert-@influxMessageClass">
                    @influxMessage
                </div>
            }
        </div>
    </div>

    <!-- Grafana Dashboard -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Grafana Dashboards</h2>
        </div>
        <div class="card-body">
            <div class="grafana-info">
                <p>Access pre-built Grafana dashboards for detailed metrics visualization.</p>
                <div class="dashboard-links">
                    <a href="http://localhost:3000/d/network-overview" target="_blank" class="dashboard-link">
                        <span class="link-icon">ðŸ“Š</span>
                        <span>Network Overview</span>
                    </a>
                    <a href="http://localhost:3000/d/sqm-performance" target="_blank" class="dashboard-link">
                        <span class="link-icon">âš¡</span>
                        <span>Adaptive SQM Performance</span>
                    </a>
                    <a href="http://localhost:3000/d/switch-deep-dive" target="_blank" class="dashboard-link">
                        <span class="link-icon">ðŸ”Œ</span>
                        <span>Switch Deep-Dive</span>
                    </a>
                    <a href="http://localhost:3000/d/ap-performance" target="_blank" class="dashboard-link">
                        <span class="link-icon">ðŸ“¡</span>
                        <span>AP Performance</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    *@

    @* License Information - hidden for now
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">License</h2>
        </div>
        <div class="card-body">
            <div class="license-info">
                <div class="info-row">
                    <span class="info-label">License Type:</span>
                    <span class="info-value">@licenseType</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Licensed To:</span>
                    <span class="info-value">@licensedTo</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Controller ID:</span>
                    <span class="info-value">@controllerId</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Activation Date:</span>
                    <span class="info-value">@activationDate</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span class="info-value status-@licenseStatus.ToLower()">@licenseStatus</span>
                </div>
            </div>

            @if (licenseStatus == "Grace Period")
            {
                <div class="alert alert-warning">
                    <strong>Grace Period Active:</strong> Controller ID changed. You have @gracePeriodDays days remaining to re-activate your license.
                </div>
            }

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="ActivateLicense">
                    Enter License Key
                </button>
                <button class="btn btn-secondary" @onclick="RequestReactivation">
                    Request Re-activation
                </button>
            </div>
        </div>
    </div>
    *@

    <!-- 10. Application Settings -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Application Settings</h2>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">Monitoring Interval (seconds)</label>
                <input type="number" class="form-control" @bind="monitoringInterval" min="30" max="3600" />
                <small class="form-help">How often to poll devices for metrics</small>
            </div>

            <div class="form-group">
                <label class="form-label">Alert Retention (days)</label>
                <input type="number" class="form-control" @bind="alertRetention" min="1" max="365" />
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="enableNotifications" />
                    <span>Enable email notifications for critical issues</span>
                </label>
            </div>

            @if (enableNotifications)
            {
                <div class="form-group">
                    <label class="form-label">Notification Email</label>
                    <input type="email" class="form-control" @bind="notificationEmail" />
                </div>
            }

            <div class="form-group">
                <label class="form-label">Theme</label>
                <select class="form-control" @bind="theme">
                    <option value="dark">Dark (Default)</option>
                    <option value="light">Light</option>
                    <option value="auto">Auto (System)</option>
                </select>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" @onclick="SaveAppSettings">
                    Save Application Settings
                </button>
            </div>
        </div>
    </div>

    <!-- 11. Security Audit -->
    <div class="card" id="security-audit">
        <div class="card-header">
            <h2 class="card-title">Security Audit</h2>
        </div>
        <div class="card-body">
            <p class="section-description">
                Configure how the security audit evaluates device placement on your network.
            </p>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="allowAppleStreamingOnMainNetwork" />
                    <span>Allow Apple streaming devices on main network</span>
                </label>
                <small class="form-help">Apple TV devices on main/corporate VLANs will show as Info instead of Warning</small>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="allowAllStreamingOnMainNetwork" />
                    <span>Allow all streaming devices on main network</span>
                </label>
                <small class="form-help">Apple TV, Roku, Fire TV, Chromecast on main/corporate VLANs will show as Info instead of Warning</small>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="allowNameBrandTVsOnMainNetwork" />
                    <span>Allow name-brand Smart TVs on main network</span>
                </label>
                <small class="form-help">LG, Samsung, Sony TVs on main/corporate VLANs will show as Info instead of Warning</small>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="allowAllTVsOnMainNetwork" />
                    <span>Allow all Smart TVs on main network</span>
                </label>
                <small class="form-help">All Smart TVs on main/corporate VLANs will show as Info instead of Warning</small>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="allowPrintersOnMainNetwork" />
                    <span>Allow printers on main network</span>
                </label>
                <small class="form-help">When unchecked, printers on main/corporate VLANs will trigger recommendations to move them to a Printer or IoT VLAN</small>
            </div>

            <div class="form-group" style="margin-top: 1.5rem;">
                <label class="form-label">For Pi-hole users: Management Port (optional)</label>
                <input type="number" class="form-control" @bind="piholeManagementPort" min="0" max="65535" placeholder="Leave empty for auto-detect" style="width: 240px;" />
                <small class="form-help">Custom HTTP port for Pi-hole admin interface. Leave empty to auto-probe ports 80, 443, 8080. Both HTTP and HTTPS are tried.</small>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" @onclick="SaveAuditSettings" disabled="@savingAuditSettings">
                    @if (savingAuditSettings)
                    {
                        <span class="spinner"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Audit Settings</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(auditSettingsMessage))
            {
                <div class="alert alert-@auditSettingsMessageClass" style="margin-top: 1rem;">
                    @auditSettingsMessage
                </div>
            }
        </div>
    </div>

    <!-- 12. Data Management -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Data Management</h2>
        </div>
        <div class="card-body">
            <div class="data-actions">
                <div class="action-item">
                    <h4>Export Configuration</h4>
                    <p>Export all settings and configuration to a JSON file</p>
                    <button class="btn btn-secondary" disabled title="Coming soon">Export Config</button>
                </div>

                <div class="action-item">
                    <h4>Import Configuration</h4>
                    <p>Import settings from a previously exported JSON file</p>
                    <button class="btn btn-secondary" disabled title="Coming soon">Import Config</button>
                </div>

                <div class="action-item">
                    <h4>Clear Cache</h4>
                    <p>Clear audit history, dismissed issues, and speed test results</p>
                    <button class="btn btn-warning" @onclick="ClearCache">Clear Cache</button>
                    @if (!string.IsNullOrEmpty(cacheMessage))
                    {
                        <div class="status-message @cacheMessageType" style="margin-top: 0.5rem;">@cacheMessage</div>
                    }
                </div>

                <div class="action-item danger-zone">
                    <h4>Reset All Settings</h4>
                    <p>Reset all configuration to defaults</p>
                    <button class="btn btn-danger" disabled title="Coming soon">Reset to Defaults</button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // UniFi Controller
    private string controllerUrl = "https://192.168.1.1";
    private string controllerUsername = "";
    private string controllerPassword = "";
    private string controllerSite = "default";
    private bool rememberCredentials = true;
    private bool ignoreControllerSSLErrors = true;
    private string controllerStatus = "Disconnected";
    private bool testingController = false;
    private string controllerMessage = "";
    private string controllerMessageClass = "";
    private string? controllerInfo = null;
    private List<UniFiSite> availableSites = new();
    private bool loadingSites = false;

    // TC Monitor
    private int tcMonitorPort = 8088;
    private string tcMonitorStatus = "Unknown";
    private bool testingTcMonitor = false;
    private string tcMonitorMessage = "";
    private string tcMonitorMessageClass = "";

    // Cellular Modem
    private List<ModemConfiguration> modemConfigs = new();
    private ModemConfiguration editingModem = new() { Port = 22, Username = "root", QmiDevice = "/dev/wwan0qmi0", PollingIntervalSeconds = 300, Enabled = true };
    private string modemStatus = "Unknown";
    private bool savingModem = false;
    private string modemMessage = "";
    private string modemMessageClass = "";
    private List<DiscoveredModem> discoveredModems = new();
    private bool loadingDiscoveredModems = false;
    private bool modemFormExpanded = false;

    // Gateway SSH
    private GatewaySshSettings? gatewaySettings;
    private string gatewayHost = "";
    private string gatewayUsername = "root";
    private string gatewayPassword = "";
    private string gatewayPrivateKeyPath = "";
    private int gatewayPort = 22;
    private bool gatewayEnabled = true;
    private bool savingGatewaySettings = false;
    private bool testingGatewayConnection = false;
    private bool checkingIperf3 = false;
    private bool startingIperf3 = false;
    private string gatewayMessage = "";
    private string gatewayMessageClass = "";
    private Iperf3Status? iperf3Status;

    // Device SSH
    private UniFiSshSettings? sshSettings;
    private string sshUsername = "";
    private string sshPassword = "";
    private string sshPrivateKeyPath = "";
    private int sshPort = 22;
    private bool sshEnabled = true;
    private bool savingSshSettings = false;
    private bool testingSshConnection = false;
    private string sshMessage = "";
    private string sshMessageClass = "";

    // Password saved status (for placeholder text)
    private bool hasControllerPassword = false;
    private bool hasGatewayPassword = false;
    private bool hasSshPassword = false;

    // Speed Test Settings
    private int iperf3GatewayParallelStreams = 3;
    private int iperf3UniFiParallelStreams = 3;
    private int iperf3OtherParallelStreams = 10;
    private int iperf3Duration = 10;
    private bool savingIperf3Settings = false;
    private string iperf3Message = "";
    private string iperf3MessageClass = "";

    // Admin Password
    private AdminPasswordSource adminPasswordSource = AdminPasswordSource.None;
    private string adminNewPassword = "";
    private string adminConfirmPassword = "";
    private bool savingAdminPassword = false;
    private string adminPasswordMessage = "";
    private string adminPasswordMessageClass = "";

    // Application Settings
    private int monitoringInterval = 300;
    private int alertRetention = 30;
    private bool enableNotifications = false;
    private string notificationEmail = "";
    private string theme = "dark";

    // Security Audit Settings
    private bool allowAppleStreamingOnMainNetwork = false;
    private bool allowAllStreamingOnMainNetwork = false;
    private bool allowNameBrandTVsOnMainNetwork = false;
    private bool allowAllTVsOnMainNetwork = false;
    private bool allowPrintersOnMainNetwork = true;
    private int? piholeManagementPort = null;
    private bool savingAuditSettings = false;
    private string auditSettingsMessage = "";
    private string auditSettingsMessageClass = "";

    protected override async Task OnInitializedAsync()
    {
        // Load saved configuration if available
        if (ConnectionService.CurrentConfig != null)
        {
            controllerUrl = ConnectionService.CurrentConfig.ControllerUrl;
            controllerUsername = ConnectionService.CurrentConfig.Username;
            // Don't load password - keep it empty for security
            controllerSite = ConnectionService.CurrentConfig.Site;
            rememberCredentials = ConnectionService.CurrentConfig.RememberCredentials;
            ignoreControllerSSLErrors = ConnectionService.CurrentConfig.IgnoreControllerSSLErrors;
        }

        // Check if controller has saved password
        var connectionSettings = await ConnectionService.GetSettingsAsync();
        hasControllerPassword = connectionSettings.HasCredentials;

        UpdateControllerStatus();
        await LoadGatewaySettings();
        await LoadSshSettings();
        await LoadModemConfigs();
        await LoadDiscoveredModems();
        await LoadIperf3Settings();
        await LoadAdminPasswordSettings();
        await LoadAuditSettings();
    }

    private async Task LoadIperf3Settings()
    {
        try
        {
            var settings = await SystemSettings.GetIperf3SettingsAsync();
            iperf3GatewayParallelStreams = settings.GatewayParallelStreams;
            iperf3UniFiParallelStreams = settings.UniFiParallelStreams;
            iperf3OtherParallelStreams = settings.OtherParallelStreams;
            iperf3Duration = settings.DurationSeconds;
        }
        catch (Exception ex)
        {
            iperf3Message = $"Error loading speed test settings: {ex.Message}";
            iperf3MessageClass = "danger";
        }
    }

    private async Task SaveIperf3Settings()
    {
        savingIperf3Settings = true;
        iperf3Message = "";
        StateHasChanged();

        try
        {
            // Validate inputs
            iperf3GatewayParallelStreams = Math.Clamp(iperf3GatewayParallelStreams, 1, 16);
            iperf3UniFiParallelStreams = Math.Clamp(iperf3UniFiParallelStreams, 1, 16);
            iperf3OtherParallelStreams = Math.Clamp(iperf3OtherParallelStreams, 1, 16);
            iperf3Duration = Math.Clamp(iperf3Duration, 3, 60);

            await SystemSettings.SaveIperf3SettingsAsync(new Iperf3Settings
            {
                GatewayParallelStreams = iperf3GatewayParallelStreams,
                UniFiParallelStreams = iperf3UniFiParallelStreams,
                OtherParallelStreams = iperf3OtherParallelStreams,
                DurationSeconds = iperf3Duration
            });

            iperf3Message = "Speed test settings saved successfully";
            iperf3MessageClass = "success";
        }
        catch (Exception ex)
        {
            iperf3Message = $"Error saving speed test settings: {ex.Message}";
            iperf3MessageClass = "danger";
        }
        finally
        {
            savingIperf3Settings = false;
            StateHasChanged();
        }
    }

    private async Task LoadGatewaySettings()
    {
        try
        {
            gatewaySettings = await GatewaySshService.GetSettingsAsync();
            gatewayHost = gatewaySettings.Host ?? "";
            gatewayUsername = gatewaySettings.Username;
            gatewayPort = gatewaySettings.Port;
            gatewayPrivateKeyPath = gatewaySettings.PrivateKeyPath ?? "";
            gatewayEnabled = gatewaySettings.Enabled;
            tcMonitorPort = gatewaySettings.TcMonitorPort;
            hasGatewayPassword = !string.IsNullOrEmpty(gatewaySettings.Password);
            // Don't load password - keep it empty for security
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error loading gateway settings: {ex.Message}";
            gatewayMessageClass = "danger";
        }
    }

    private async Task SaveGatewaySettings()
    {
        // Validate required fields
        if (string.IsNullOrWhiteSpace(gatewayHost))
        {
            gatewayMessage = "Gateway Host / IP is required";
            gatewayMessageClass = "danger";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(gatewayUsername))
        {
            gatewayMessage = "Username is required";
            gatewayMessageClass = "danger";
            StateHasChanged();
            return;
        }

        // Must have either: password (new or saved) OR private key
        var hasPassword = !string.IsNullOrEmpty(gatewayPassword) || hasGatewayPassword;
        var hasPrivateKey = !string.IsNullOrWhiteSpace(gatewayPrivateKeyPath);
        if (!hasPassword && !hasPrivateKey)
        {
            gatewayMessage = "Either a password or private key path is required";
            gatewayMessageClass = "danger";
            StateHasChanged();
            return;
        }

        savingGatewaySettings = true;
        gatewayMessage = "";
        StateHasChanged();

        try
        {
            var settings = gatewaySettings ?? new GatewaySshSettings();
            settings.Host = gatewayHost;
            settings.Username = gatewayUsername;
            settings.Port = gatewayPort;
            settings.PrivateKeyPath = string.IsNullOrWhiteSpace(gatewayPrivateKeyPath) ? null : gatewayPrivateKeyPath;
            settings.Enabled = gatewayEnabled;
            settings.TcMonitorPort = tcMonitorPort;

            // If using private key, clear the password; otherwise update if new one entered
            if (!string.IsNullOrWhiteSpace(gatewayPrivateKeyPath))
            {
                settings.Password = null;
            }
            else if (!string.IsNullOrEmpty(gatewayPassword))
            {
                settings.Password = gatewayPassword;
            }

            gatewaySettings = await GatewaySshService.SaveSettingsAsync(settings);
            gatewayPassword = ""; // Clear password field
            hasGatewayPassword = !string.IsNullOrEmpty(gatewaySettings.Password);
            gatewayMessage = "Gateway settings saved successfully";
            gatewayMessageClass = "success";
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error saving gateway settings: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            savingGatewaySettings = false;
            StateHasChanged();
        }
    }

    private async Task TestGatewayConnection()
    {
        if (string.IsNullOrWhiteSpace(gatewayHost))
        {
            gatewayMessage = "Gateway Host / IP is required";
            gatewayMessageClass = "danger";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(gatewayUsername))
        {
            gatewayMessage = "Username is required";
            gatewayMessageClass = "danger";
            StateHasChanged();
            return;
        }

        // Must have either: password (new or saved) OR private key
        var hasPassword = !string.IsNullOrEmpty(gatewayPassword) || hasGatewayPassword;
        var hasPrivateKey = !string.IsNullOrWhiteSpace(gatewayPrivateKeyPath);
        if (!hasPassword && !hasPrivateKey)
        {
            gatewayMessage = "Either a password or private key path is required";
            gatewayMessageClass = "danger";
            StateHasChanged();
            return;
        }

        testingGatewayConnection = true;
        gatewayMessage = $"Testing SSH connection to {gatewayHost}...";
        gatewayMessageClass = "info";
        StateHasChanged();

        try
        {
            (bool success, string message) result;

            // If user entered a new password or key path, test with form values
            // Otherwise test with saved settings (which handles decryption internally)
            if (!string.IsNullOrEmpty(gatewayPassword) || !string.IsNullOrEmpty(gatewayPrivateKeyPath))
            {
                // Test with form values (new password is plain text)
                result = await GatewaySshService.TestConnectionAsync(
                    gatewayHost,
                    gatewayPort,
                    gatewayUsername,
                    gatewayPassword,
                    gatewayPrivateKeyPath);
            }
            else if (hasGatewayPassword)
            {
                // No new credentials entered, test with saved settings
                result = await GatewaySshService.TestConnectionAsync();
            }
            else
            {
                result = (false, "No credentials configured");
            }

            if (result.success)
            {
                gatewayMessage = "SSH connection successful!";
                gatewayMessageClass = "success";

                // Update last tested timestamp on saved settings
                if (gatewaySettings != null)
                {
                    gatewaySettings.LastTestedAt = DateTime.UtcNow;
                    gatewaySettings.LastTestResult = "Success";
                    await GatewaySshService.SaveSettingsAsync(gatewaySettings);
                }
            }
            else
            {
                gatewayMessage = $"SSH connection failed: {result.message}";
                gatewayMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            testingGatewayConnection = false;
            StateHasChanged();
        }
    }

    private async Task CheckIperf3Status()
    {
        checkingIperf3 = true;
        gatewayMessage = "Checking iperf3 status...";
        gatewayMessageClass = "info";
        StateHasChanged();

        try
        {
            iperf3Status = await GatewayService.CheckIperf3StatusAsync();
            if (!string.IsNullOrEmpty(iperf3Status.Error))
            {
                gatewayMessage = iperf3Status.Error;
                gatewayMessageClass = "warning";
            }
            else
            {
                gatewayMessage = "";
            }
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error checking iperf3: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            checkingIperf3 = false;
            StateHasChanged();
        }
    }

    private async Task StartIperf3Server()
    {
        startingIperf3 = true;
        gatewayMessage = "Starting iperf3 server...";
        gatewayMessageClass = "info";
        StateHasChanged();

        try
        {
            var (success, message) = await GatewayService.StartIperf3ServerAsync();
            if (success)
            {
                gatewayMessage = message;
                gatewayMessageClass = "success";
                // Refresh status
                iperf3Status = await GatewayService.CheckIperf3StatusAsync();
            }
            else
            {
                gatewayMessage = $"Failed to start iperf3: {message}";
                gatewayMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            startingIperf3 = false;
            StateHasChanged();
        }
    }

    private async Task LoadSshSettings()
    {
        try
        {
            sshSettings = await SshService.GetSettingsAsync();
            sshUsername = sshSettings.Username;
            sshPort = sshSettings.Port;
            sshPrivateKeyPath = sshSettings.PrivateKeyPath ?? "";
            sshEnabled = sshSettings.Enabled;
            hasSshPassword = !string.IsNullOrEmpty(sshSettings.Password);
            // Don't load password - keep it empty for security
        }
        catch (Exception ex)
        {
            sshMessage = $"Error loading SSH settings: {ex.Message}";
            sshMessageClass = "danger";
        }
    }

    private async Task SaveSshSettings()
    {
        // Validate required fields
        if (string.IsNullOrWhiteSpace(sshUsername))
        {
            sshMessage = "Username is required";
            sshMessageClass = "danger";
            StateHasChanged();
            return;
        }

        // Must have either: password (new or saved) OR private key
        var hasPassword = !string.IsNullOrEmpty(sshPassword) || hasSshPassword;
        var hasPrivateKey = !string.IsNullOrWhiteSpace(sshPrivateKeyPath);
        if (!hasPassword && !hasPrivateKey)
        {
            sshMessage = "Either a password or private key path is required";
            sshMessageClass = "danger";
            StateHasChanged();
            return;
        }

        savingSshSettings = true;
        sshMessage = "";
        StateHasChanged();

        try
        {
            var settings = sshSettings ?? new UniFiSshSettings();
            settings.Username = sshUsername;
            settings.Port = sshPort;
            settings.PrivateKeyPath = string.IsNullOrWhiteSpace(sshPrivateKeyPath) ? null : sshPrivateKeyPath;
            settings.Enabled = sshEnabled;

            // If using private key, clear the password; otherwise update if new one entered
            if (!string.IsNullOrWhiteSpace(sshPrivateKeyPath))
            {
                settings.Password = null;
            }
            else if (!string.IsNullOrEmpty(sshPassword))
            {
                settings.Password = sshPassword;
            }

            sshSettings = await SshService.SaveSettingsAsync(settings);
            sshPassword = ""; // Clear password field
            hasSshPassword = !string.IsNullOrEmpty(sshSettings.Password);
            sshMessage = "SSH settings saved successfully";
            sshMessageClass = "success";
        }
        catch (Exception ex)
        {
            sshMessage = $"Error saving SSH settings: {ex.Message}";
            sshMessageClass = "danger";
        }
        finally
        {
            savingSshSettings = false;
            StateHasChanged();
        }
    }

    private async Task TestSshConnection()
    {
        // Validate credentials first
        if (string.IsNullOrWhiteSpace(sshUsername))
        {
            sshMessage = "Username is required";
            sshMessageClass = "danger";
            StateHasChanged();
            return;
        }

        // Must have either: password (new or saved) OR private key
        var hasPassword = !string.IsNullOrEmpty(sshPassword) || hasSshPassword;
        var hasPrivateKey = !string.IsNullOrWhiteSpace(sshPrivateKeyPath);
        if (!hasPassword && !hasPrivateKey)
        {
            sshMessage = "Either a password or private key path is required";
            sshMessageClass = "danger";
            StateHasChanged();
            return;
        }

        // Check if connected to the controller (needed to find a device to test against)
        if (!ConnectionService.IsConnected || ConnectionService.Client == null)
        {
            sshMessage = "Connect to UniFi controller first to find a device to test SSH against.";
            sshMessageClass = "warning";
            StateHasChanged();
            return;
        }

        testingSshConnection = true;
        sshMessage = "Finding a device to test SSH...";
        sshMessageClass = "info";
        StateHasChanged();

        try
        {
            // Get discovered devices which already have correct effective DeviceType
            // (accounts for UDM-family devices acting as mesh APs)
            var devices = await ConnectionService.GetDiscoveredDevicesAsync();

            // Find first online non-gateway device (AP, switch, or modem)
            var testableTypes = new[]
            {
                NetworkOptimizer.Core.Enums.DeviceType.AccessPoint,
                NetworkOptimizer.Core.Enums.DeviceType.Switch,
                NetworkOptimizer.Core.Enums.DeviceType.CellularModem
            };

            var testDevice = devices
                .Where(d => testableTypes.Contains(d.Type)
                            && d.State == 1 && !string.IsNullOrEmpty(d.IpAddress))
                .FirstOrDefault();

            if (testDevice == null)
            {
                sshMessage = "No online devices found. Ensure you have adopted APs, switches, or modems in your network.";
                sshMessageClass = "warning";
                testingSshConnection = false;
                StateHasChanged();
                return;
            }

            sshMessage = $"Testing SSH connection to {testDevice.Name} ({testDevice.IpAddress})...";
            StateHasChanged();

            // Build a DeviceSshConfiguration from form values to test current settings
            // If password field is empty but we have a saved password, load it for the test
            var testPassword = sshPassword;
            if (string.IsNullOrEmpty(testPassword) && hasSshPassword)
            {
                var savedSettings = await SshService.GetSettingsAsync();
                testPassword = savedSettings?.Password;
            }

            var testConfig = new DeviceSshConfiguration
            {
                Host = testDevice.IpAddress,
                SshUsername = sshUsername,
                SshPassword = testPassword,
                SshPrivateKeyPath = sshPrivateKeyPath
            };

            var (success, message) = await SshService.TestConnectionAsync(testConfig);
            if (success)
            {
                sshMessage = $"SSH connection to {testDevice.Name} successful!";
                sshMessageClass = "success";

                // Update last tested timestamp on saved settings
                if (sshSettings != null)
                {
                    sshSettings.LastTestedAt = DateTime.UtcNow;
                    sshSettings.LastTestResult = "Success";
                    await SshService.SaveSettingsAsync(sshSettings);
                }
            }
            else
            {
                sshMessage = $"SSH connection failed: {message}";
                sshMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            sshMessage = $"Error: {ex.Message}";
            sshMessageClass = "danger";
        }
        finally
        {
            testingSshConnection = false;
            StateHasChanged();
        }
    }

    private async Task LoadModemConfigs()
    {
        try
        {
            modemConfigs = await ModemService.GetModemsAsync();
            modemStatus = modemConfigs.Any(m => m.Enabled) ? "Active" : "Inactive";
        }
        catch (Exception ex)
        {
            modemStatus = "Error";
            modemMessage = $"Error loading modem configs: {ex.Message}";
            modemMessageClass = "danger";
        }
    }

    private async Task LoadDiscoveredModems()
    {
        if (!ConnectionService.IsConnected)
        {
            return;
        }

        loadingDiscoveredModems = true;
        StateHasChanged();

        try
        {
            discoveredModems = await ModemService.DiscoverModemsAsync();
        }
        catch (Exception ex)
        {
            modemMessage = $"Error discovering modems: {ex.Message}";
            modemMessageClass = "warning";
        }
        finally
        {
            loadingDiscoveredModems = false;
            StateHasChanged();
        }
    }

    private async Task AddDiscoveredModem(DiscoveredModem discovered)
    {
        // Check if SSH credentials are configured
        if (sshSettings?.HasCredentials != true)
        {
            modemMessage = "SSH credentials must be configured before adding modems. Please configure them in the Device SSH section above.";
            modemMessageClass = "warning";
            StateHasChanged();
            return;
        }

        // Check if already configured
        if (modemConfigs.Any(m => m.Host == discovered.Host))
        {
            modemMessage = $"{discovered.Name} is already configured";
            modemMessageClass = "warning";
            StateHasChanged();
            return;
        }

        savingModem = true;
        modemMessage = "";
        StateHasChanged();

        try
        {
            var config = new ModemConfiguration
            {
                Name = discovered.Name,
                Host = discovered.Host,
                Port = 22,
                Username = "root",
                ModemType = discovered.Model,
                QmiDevice = "/dev/wwan0qmi0",
                PollingIntervalSeconds = 300,
                Enabled = true
            };

            await ModemService.SaveModemAsync(config);
            modemMessage = $"Added {discovered.Name} to monitored modems";
            modemMessageClass = "success";
            await LoadModemConfigs();
        }
        catch (Exception ex)
        {
            modemMessage = $"Error adding modem: {ex.Message}";
            modemMessageClass = "danger";
        }
        finally
        {
            savingModem = false;
            StateHasChanged();
        }
    }

    private void UpdateControllerStatus()
    {
        if (ConnectionService.IsConnected)
        {
            controllerStatus = "Connected";
            controllerInfo = ConnectionService.IsUniFiOs ? "UniFi OS" : "Standalone";
        }
        else if (!string.IsNullOrEmpty(ConnectionService.LastError))
        {
            controllerStatus = "Error";
        }
        else
        {
            controllerStatus = "Disconnected";
        }
    }

    private async Task<UniFiConnectionConfig> BuildConfigAsync()
    {
        // Use newly entered password, or fall back to stored password from database
        var password = controllerPassword;
        if (string.IsNullOrEmpty(password))
        {
            password = await ConnectionService.GetStoredPasswordAsync() ?? "";
        }

        return new UniFiConnectionConfig
        {
            ControllerUrl = controllerUrl,
            Username = controllerUsername,
            Password = password,
            Site = string.IsNullOrWhiteSpace(controllerSite) ? "default" : controllerSite,
            RememberCredentials = rememberCredentials,
            IgnoreControllerSSLErrors = ignoreControllerSSLErrors
        };
    }

    private async Task TestControllerConnection()
    {
        testingController = true;
        controllerMessage = "";
        StateHasChanged();

        try
        {
            var config = await BuildConfigAsync();
            var (success, error, info) = await ConnectionService.TestConnectionAsync(config);

            if (success)
            {
                controllerStatus = "Connected";
                controllerInfo = info;
                controllerMessage = $"Successfully connected: {info}";
                controllerMessageClass = "success";
            }
            else
            {
                controllerStatus = "Error";
                controllerMessage = $"Connection failed: {error}";
                controllerMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            controllerStatus = "Error";
            controllerMessage = $"Error: {ex.Message}";
            controllerMessageClass = "danger";
        }
        finally
        {
            testingController = false;
            StateHasChanged();
        }
    }

    private async Task SaveAndConnectController()
    {
        testingController = true;
        controllerMessage = "";
        StateHasChanged();

        try
        {
            var config = await BuildConfigAsync();
            var success = await ConnectionService.ConnectAsync(config);

            if (success)
            {
                controllerStatus = "Connected";
                controllerInfo = ConnectionService.IsUniFiOs ? "UniFi OS" : "Standalone";
                controllerMessage = $"Connected and saved! ({controllerInfo})";
                controllerMessageClass = "success";
                hasControllerPassword = true;
                controllerPassword = ""; // Clear the password field
            }
            else
            {
                controllerStatus = "Error";
                controllerMessage = $"Connection failed: {ConnectionService.LastError}";
                controllerMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            controllerStatus = "Error";
            controllerMessage = $"Error: {ex.Message}";
            controllerMessageClass = "danger";
        }
        finally
        {
            testingController = false;
            StateHasChanged();
        }
    }

    private async Task DisconnectController()
    {
        await ConnectionService.DisconnectAsync();
        controllerStatus = "Disconnected";
        controllerMessage = "Disconnected from controller";
        controllerMessageClass = "info";
        controllerInfo = null;
        StateHasChanged();
    }

    private async Task ListSites()
    {
        loadingSites = true;
        controllerMessage = "";
        StateHasChanged();

        try
        {
            var config = await BuildConfigAsync();
            var (success, error, sites) = await ConnectionService.GetSitesAsync(config);

            if (success)
            {
                availableSites = sites;
                if (sites.Count == 1)
                {
                    controllerSite = sites[0].Name;
                    controllerMessage = $"Found 1 site: {sites[0].Description}";
                }
                else
                {
                    controllerMessage = $"Found {sites.Count} sites. Select one from the dropdown.";
                    // Keep current selection if it exists in the list, otherwise select first
                    if (!sites.Any(s => s.Name == controllerSite) && sites.Count > 0)
                    {
                        controllerSite = sites[0].Name;
                    }
                }
                controllerMessageClass = "success";
            }
            else
            {
                controllerMessage = $"Failed to list sites: {error}";
                controllerMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            controllerMessage = $"Error: {ex.Message}";
            controllerMessageClass = "danger";
        }
        finally
        {
            loadingSites = false;
            StateHasChanged();
        }
    }

    private async Task TestTcMonitor()
    {
        testingTcMonitor = true;
        tcMonitorMessage = "";
        StateHasChanged();

        try
        {
            var (available, error) = await SqmService.TestTcMonitorAsync(null, tcMonitorPort);

            if (available)
            {
                tcMonitorStatus = "Connected";
                tcMonitorMessage = "Adaptive SQM Monitor is responding";
                tcMonitorMessageClass = "success";
            }
            else
            {
                tcMonitorStatus = "Offline";
                tcMonitorMessage = error ?? "Adaptive SQM Monitor is not responding";
                tcMonitorMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            tcMonitorStatus = "Error";
            tcMonitorMessage = $"Error: {ex.Message}";
            tcMonitorMessageClass = "danger";
        }
        finally
        {
            testingTcMonitor = false;
            StateHasChanged();
        }
    }

    // Modem methods
    private void EditModem(ModemConfiguration modem)
    {
        editingModem = new ModemConfiguration
        {
            Id = modem.Id,
            Name = modem.Name,
            Host = modem.Host,
            Port = modem.Port,
            Username = modem.Username,
            Password = modem.Password,
            PrivateKeyPath = modem.PrivateKeyPath,
            ModemType = modem.ModemType,
            QmiDevice = modem.QmiDevice,
            Enabled = modem.Enabled,
            PollingIntervalSeconds = modem.PollingIntervalSeconds
        };
        modemMessage = "";
        modemFormExpanded = true;  // Expand the form when editing
        StateHasChanged();
    }

    private void CancelEditModem()
    {
        editingModem = new ModemConfiguration
        {
            Port = 22,
            Username = "root",
            QmiDevice = "/dev/wwan0qmi0",
            PollingIntervalSeconds = 300,
            Enabled = true
        };
        modemFormExpanded = false;  // Collapse the form when canceling
        modemMessage = "";
        StateHasChanged();
    }

    private async Task SaveModem()
    {
        // Check if SSH credentials are configured (for new modems)
        if (editingModem.Id == 0 && sshSettings?.HasCredentials != true)
        {
            modemMessage = "SSH credentials must be configured before adding modems. Please configure them in the Device SSH section above.";
            modemMessageClass = "warning";
            return;
        }

        if (string.IsNullOrWhiteSpace(editingModem.Name) || string.IsNullOrWhiteSpace(editingModem.Host))
        {
            modemMessage = "Name and Host are required";
            modemMessageClass = "danger";
            return;
        }

        savingModem = true;
        modemMessage = "";
        StateHasChanged();

        try
        {
            await ModemService.SaveModemAsync(editingModem);
            modemMessage = editingModem.Id > 0 ? "Modem updated successfully" : "Modem added successfully";
            modemMessageClass = "success";

            // Refresh list and reset form
            await LoadModemConfigs();
            CancelEditModem();
        }
        catch (Exception ex)
        {
            modemMessage = $"Error saving modem: {ex.Message}";
            modemMessageClass = "danger";
        }
        finally
        {
            savingModem = false;
            StateHasChanged();
        }
    }

    private async Task DeleteModem(ModemConfiguration modem)
    {
        try
        {
            await ModemService.DeleteModemAsync(modem.Id);
            modemMessage = $"Deleted modem: {modem.Name}";
            modemMessageClass = "success";
            await LoadModemConfigs();
        }
        catch (Exception ex)
        {
            modemMessage = $"Error deleting modem: {ex.Message}";
            modemMessageClass = "danger";
        }
        StateHasChanged();
    }

    private async Task TestModemConnection(ModemConfiguration modem)
    {
        modemMessage = $"Polling {modem.Name}...";
        modemMessageClass = "info";
        StateHasChanged();

        try
        {
            var (success, message) = await ModemService.PollModemAsync(modem);
            if (success)
            {
                modemMessage = message;
                modemMessageClass = "success";
                // Reload modem list to show updated LastPolled timestamp
                modemConfigs = await ModemService.GetModemsAsync();
            }
            else
            {
                modemMessage = message;
                modemMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            modemMessage = $"Error: {ex.Message}";
            modemMessageClass = "danger";
        }
        StateHasChanged();
    }

    private async Task SaveAppSettings()
    {
        // TODO: Implement save
        await Task.CompletedTask;
    }

    private async Task ExportConfig()
    {
        // TODO: Implement export
        await Task.CompletedTask;
    }

    private async Task ImportConfig()
    {
        // TODO: Implement import
        await Task.CompletedTask;
    }

    private string? cacheMessage;
    private string? cacheMessageType;

    private async Task ClearCache()
    {
        try
        {
            // Clear audit data (results and dismissed issues) from database
            await AuditRepository.ClearAllAuditsAsync();
            await AuditRepository.ClearAllDismissedIssuesAsync();

            // Clear in-memory audit cache
            AuditService.ClearCache();

            // Clear speed test history
            await SpeedTestRepository.ClearIperf3HistoryAsync();

            cacheMessage = "Cache cleared successfully";
            cacheMessageType = "success";
        }
        catch (Exception ex)
        {
            cacheMessage = $"Error clearing cache: {ex.Message}";
            cacheMessageType = "error";
        }
        StateHasChanged();
    }

    private async Task ResetSettings()
    {
        // TODO: Implement reset
        await Task.CompletedTask;
    }

    // Admin Password methods
    private async Task LoadAdminPasswordSettings()
    {
        try
        {
            adminPasswordSource = await AdminAuth.GetPasswordSourceAsync();
        }
        catch (Exception ex)
        {
            adminPasswordMessage = $"Error loading admin settings: {ex.Message}";
            adminPasswordMessageClass = "danger";
        }
    }

    private string GetAdminPasswordSourceLabel()
    {
        return adminPasswordSource switch
        {
            AdminPasswordSource.Database => "Database",
            AdminPasswordSource.Environment => "Env Var",
            AdminPasswordSource.AutoGenerated => "Auto-Gen",
            AdminPasswordSource.None => "Not Set",
            _ => "Unknown"
        };
    }

    private void OnAdminPasswordInput()
    {
        // Clear any previous error message when user types
        if (!string.IsNullOrEmpty(adminPasswordMessage))
        {
            adminPasswordMessage = "";
        }
    }

    private async Task SaveAdminPassword()
    {
        // Validate using service
        var validation = AdminAuth.ValidateNewPassword(adminNewPassword, adminConfirmPassword);
        if (!validation.IsValid)
        {
            adminPasswordMessage = validation.ErrorMessage ?? "Invalid password";
            adminPasswordMessageClass = "danger";
            StateHasChanged();
            return;
        }

        savingAdminPassword = true;
        adminPasswordMessage = "";
        StateHasChanged();

        try
        {
            // Save new password (always enabled when setting a password)
            var passwordToSave = string.IsNullOrEmpty(adminNewPassword) ? null : adminNewPassword;
            await AdminAuth.SaveAdminSettingsAsync(passwordToSave, true);

            // Refresh the source
            adminPasswordSource = await AdminAuth.GetPasswordSourceAsync();

            adminNewPassword = "";
            adminConfirmPassword = "";
            adminPasswordMessage = "Admin password settings saved successfully";
            adminPasswordMessageClass = "success";
        }
        catch (Exception ex)
        {
            adminPasswordMessage = $"Error saving admin password: {ex.Message}";
            adminPasswordMessageClass = "danger";
        }
        finally
        {
            savingAdminPassword = false;
            StateHasChanged();
        }
    }

    private async Task ClearAdminPassword()
    {
        savingAdminPassword = true;
        adminPasswordMessage = "";
        StateHasChanged();

        try
        {
            await AdminAuth.ClearDatabasePasswordAsync();
            adminPasswordSource = await AdminAuth.GetPasswordSourceAsync();

            if (adminPasswordSource == AdminPasswordSource.Environment)
            {
                adminPasswordMessage = "Database password cleared. Now using environment variable (APP_PASSWORD)";
            }
            else
            {
                adminPasswordMessage = "Database password cleared. A new auto-generated password has been created - check the application logs.";
            }
            adminPasswordMessageClass = "success";
        }
        catch (Exception ex)
        {
            adminPasswordMessage = $"Error clearing password: {ex.Message}";
            adminPasswordMessageClass = "danger";
        }
        finally
        {
            savingAdminPassword = false;
            StateHasChanged();
        }
    }

    // Security Audit Settings methods
    private async Task LoadAuditSettings()
    {
        try
        {
            var appleStreaming = await SystemSettings.GetAsync("audit:allowAppleStreamingOnMainNetwork");
            var allStreaming = await SystemSettings.GetAsync("audit:allowAllStreamingOnMainNetwork");
            var nameBrandTVs = await SystemSettings.GetAsync("audit:allowNameBrandTVsOnMainNetwork");
            var allTVs = await SystemSettings.GetAsync("audit:allowAllTVsOnMainNetwork");
            var printers = await SystemSettings.GetAsync("audit:allowPrintersOnMainNetwork");
            var piholePort = await SystemSettings.GetAsync("audit:piholeManagementPort");

            allowAppleStreamingOnMainNetwork = appleStreaming?.ToLower() == "true";
            allowAllStreamingOnMainNetwork = allStreaming?.ToLower() == "true";
            allowNameBrandTVsOnMainNetwork = nameBrandTVs?.ToLower() == "true";
            allowAllTVsOnMainNetwork = allTVs?.ToLower() == "true";
            // Printers default to true if not set
            allowPrintersOnMainNetwork = printers == null || printers.ToLower() == "true";
            // Pi-hole port (null means auto-detect)
            piholeManagementPort = int.TryParse(piholePort, out var port) && port > 0 ? port : null;
        }
        catch (Exception ex)
        {
            auditSettingsMessage = $"Error loading audit settings: {ex.Message}";
            auditSettingsMessageClass = "danger";
        }
    }

    private async Task SaveAuditSettings()
    {
        savingAuditSettings = true;
        auditSettingsMessage = "";
        StateHasChanged();

        try
        {
            await SystemSettings.SetAsync("audit:allowAppleStreamingOnMainNetwork", allowAppleStreamingOnMainNetwork.ToString().ToLower());
            await SystemSettings.SetAsync("audit:allowAllStreamingOnMainNetwork", allowAllStreamingOnMainNetwork.ToString().ToLower());
            await SystemSettings.SetAsync("audit:allowNameBrandTVsOnMainNetwork", allowNameBrandTVsOnMainNetwork.ToString().ToLower());
            await SystemSettings.SetAsync("audit:allowAllTVsOnMainNetwork", allowAllTVsOnMainNetwork.ToString().ToLower());
            await SystemSettings.SetAsync("audit:allowPrintersOnMainNetwork", allowPrintersOnMainNetwork.ToString().ToLower());
            await SystemSettings.SetAsync("audit:piholeManagementPort", piholeManagementPort?.ToString() ?? "");

            auditSettingsMessage = "Audit settings saved successfully";
            auditSettingsMessageClass = "success";
        }
        catch (Exception ex)
        {
            auditSettingsMessage = $"Error saving audit settings: {ex.Message}";
            auditSettingsMessageClass = "danger";
        }
        finally
        {
            savingAuditSettings = false;
            StateHasChanged();
        }
    }
}
