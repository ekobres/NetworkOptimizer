@page "/sites/{SiteId:int}/settings"
@rendermode InteractiveServer
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Web.Components.Shared
@using NetworkOptimizer.Web.Components.Shared.Settings

<PageTitle>Settings - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Settings</h1>
    <p class="page-description">Configure Network Optimizer connections and preferences</p>
</div>

<!-- Global Settings Section -->
<div class="settings-section">
    <div class="settings-section-header">
        <h2>Global Settings</h2>
        <p class="section-description">These settings apply to all sites</p>
    </div>

    <div class="settings-container">
        <AdminPasswordCard />

    </div>
</div>

<div class="settings-actions">
    <a href="/sites" class="btn btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 18px; height: 18px; margin-right: 0.5rem;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Z" />
        </svg>
        Manage Sites
    </a>
</div>

<!-- Site-Specific Settings Section -->
<div class="settings-section">
    <div class="settings-section-header">
        <h2>Site Settings</h2>
        <p class="section-description">These settings are specific to this site</p>
    </div>

    <div class="settings-container">
        <!-- 1. UniFi Console Connection -->
        <ConsoleConnectionCard SiteId="SiteId" />

        <!-- 2. Gateway SSH -->
        <GatewaySshCard SiteId="SiteId" TcMonitorPort="@_tcMonitorPort" />

        <!-- 3. Device SSH -->
        <DeviceSshCard @ref="_deviceSshCard" SiteId="SiteId" OnSettingsChanged="OnDeviceSshChanged" />

        <!-- 4. Adaptive SQM Monitor -->
        <SqmMonitorCard SiteId="SiteId" @bind-TcMonitorPort="_tcMonitorPort" />

        <!-- 5. Cellular Modem -->
        <CellularModemCard SiteId="SiteId" HasSshCredentials="@_hasSshCredentials" />

        <!-- 6. Speed Test Settings -->
        <SpeedTestCard />

        <!-- 7. Security Audit -->
        <SecurityAuditCard SiteId="SiteId" />

        <!-- 8. Application Settings -->
        <ApplicationCard />

        <!-- 9. Data Management -->
        <DataManagementCard SiteId="SiteId" />
    </div>
</div>

<SponsorshipBanner SiteId="SiteId" AlwaysShow="true" />

@code {
    [Parameter]
    public int SiteId { get; set; }

    private int _tcMonitorPort = 8088;
    private bool _hasSshCredentials = false;
    private DeviceSshCard? _deviceSshCard;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && _deviceSshCard != null)
        {
            _hasSshCredentials = _deviceSshCard.HasCredentials;
            StateHasChanged();
        }
    }

    private void OnDeviceSshChanged()
    {
        if (_deviceSshCard != null)
        {
            _hasSshCredentials = _deviceSshCard.HasCredentials;
            StateHasChanged();
        }
    }
}
