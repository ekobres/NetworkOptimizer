@page "/sqm"
@inject SqmService SqmService
@inject SqmDeploymentService DeploymentService
@inject UniFiConnectionService ConnectionService
@inject NetworkOptimizer.Storage.Interfaces.ISpeedTestRepository SpeedTestRepository
@inject TcMonitorClient SqmMonitorClient
@rendermode InteractiveServer
@using SqmConfig = NetworkOptimizer.Sqm.Models.SqmConfiguration
@using NetworkOptimizer.Sqm.Models
@using NetworkOptimizer.Storage.Models

<PageTitle>SQM Manager - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Adaptive SQM Manager</h1>
    <p class="page-description">Dynamic bandwidth optimization with dual-mode (Speedtest + Ping) adjustment</p>
</div>

<div class="sqm-container">
    <!-- Deployment Status -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Deployment Status</h2>
            @if (!isLoading)
            {
                <button class="btn btn-sm btn-secondary" @onclick="() => RefreshStatus()">Refresh</button>
            }
        </div>
        <div class="card-body">
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="alert @(statusSuccess ? "alert-success" : "alert-danger")">@statusMessage</div>
            }

            <div class="deployment-status-content" style="min-height: 90px;">
                @if (isLoading)
                {
                    <div class="loading-status">
                        <span class="spinner"></span>
                        <span>Checking deployment status...</span>
                    </div>
                }
                else
                {
                    <div class="sqm-metrics">
                    <div class="metric">
                        <div class="metric-label">Gateway Connection</div>
                        <div class="metric-value">
                            <span class="status-indicator @(gatewayConnected ? "status-active" : "status-inactive")"></span>
                            @(gatewayConnected ? "Connected" : "Not Connected")
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">UDM Boot</div>
                        <div class="metric-value">
                            <span class="status-indicator @(deploymentStatus?.UdmBootInstalled == true ? "status-active" : "status-inactive")"></span>
                            @if (deploymentStatus?.UdmBootInstalled == true)
                            {
                                <span>@(deploymentStatus?.UdmBootEnabled == true ? "Enabled" : "Installed")</span>
                            }
                            else
                            {
                                <span>Not Installed</span>
                            }
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">SQM Scripts</div>
                        <div class="metric-value">
                            <span class="status-indicator @(deploymentStatus?.IsDeployed == true ? "status-active" : "status-inactive")"></span>
                            @(deploymentStatus?.IsDeployed == true ? "Deployed" : "Not Deployed")
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">SQM Monitor</div>
                        <div class="metric-value">
                            <span class="status-indicator @(deploymentStatus?.TcMonitorRunning == true ? "status-active" : "status-inactive")"></span>
                            @(deploymentStatus?.TcMonitorRunning == true ? "Running" : "Stopped")
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Cron Jobs</div>
                        <div class="metric-value">@(deploymentStatus?.CronJobsConfigured ?? 0) configured</div>
                    </div>
                    </div>

                    @if (gatewayConnected && deploymentStatus?.UdmBootInstalled != true)
                    {
                        <div class="alert alert-warning" style="margin-top: 1rem;">
                            <strong>UDM Boot Required:</strong> Boot scripts in <code>/data/on_boot.d/</code> will not run on reboot without udm-boot installed.
                            <button class="btn btn-sm btn-primary" style="margin-left: 0.5rem;" @onclick="InstallUdmBoot" disabled="@isInstallingUdmBoot">
                                @if (isInstallingUdmBoot)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                    <span>Installing...</span>
                                }
                                else
                                {
                                    <span>Install UDM Boot</span>
                                }
                            </button>
                        </div>
                    }
                }
            </div>

        </div>
    </div>

    <!-- SQM Live Status Dashboard -->
    @if (sqmMonitorData != null && (sqmMonitorData.Wan1?.Active == true || sqmMonitorData.Wan2?.Active == true))
    {
        <div class="sqm-live-dashboard">
            @if (sqmMonitorData.Wan1?.Active == true)
            {
                <div class="wan-status-card">
                    <div class="wan-status-header">
                        <div class="wan-status-title">
                            <span class="wan-status-indicator active"></span>
                            <span class="wan-status-name">@sqmMonitorData.Wan1.Name</span>
                        </div>
                        <span class="wan-status-interface">@sqmMonitorData.Wan1.Interface</span>
                    </div>
                    <div class="wan-status-rate">
                        <span class="rate-value">@sqmMonitorData.Wan1.EffectiveRateMbps.ToString("F0")</span>
                        <span class="rate-unit">Mbps</span>
                    </div>
                    <div class="wan-status-details">
                        @if (sqmMonitorData.Wan1.LastSpeedtest != null)
                        {
                            <div class="detail-section">
                                <div class="detail-header">Last Speedtest</div>
                                <div class="detail-row">
                                    <span class="detail-label">Measured</span>
                                    <span class="detail-value">@sqmMonitorData.Wan1.LastSpeedtest.MeasuredMbps Mbps</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Adjusted</span>
                                    <span class="detail-value">@sqmMonitorData.Wan1.LastSpeedtest.AdjustedMbps Mbps</span>
                                </div>
                                @if (!string.IsNullOrEmpty(sqmMonitorData.Wan1.LastSpeedtest.Timestamp))
                                {
                                    <div class="detail-time">@sqmMonitorData.Wan1.LastSpeedtest.Timestamp</div>
                                }
                            </div>
                        }
                        @if (sqmMonitorData.Wan1.LastPing != null)
                        {
                            <div class="detail-section">
                                <div class="detail-header">Last Ping Adjustment</div>
                                <div class="detail-row">
                                    <span class="detail-label">Latency</span>
                                    <span class="detail-value @(sqmMonitorData.Wan1.LastPing.LatencyMs > 50 ? "text-warning" : "")">@sqmMonitorData.Wan1.LastPing.LatencyMs.ToString("F1") ms</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Rate</span>
                                    <span class="detail-value">@sqmMonitorData.Wan1.LastPing.RateMbps Mbps</span>
                                </div>
                            </div>
                        }
                        @if (sqmMonitorData.Wan1.BaselineMbps > 0)
                        {
                            <div class="baseline-info">
                                Baseline: @sqmMonitorData.Wan1.BaselineMbps Mbps
                            </div>
                        }
                    </div>
                </div>
            }

            @if (sqmMonitorData.Wan2?.Active == true)
            {
                <div class="wan-status-card">
                    <div class="wan-status-header">
                        <div class="wan-status-title">
                            <span class="wan-status-indicator active"></span>
                            <span class="wan-status-name">@sqmMonitorData.Wan2.Name</span>
                        </div>
                        <span class="wan-status-interface">@sqmMonitorData.Wan2.Interface</span>
                    </div>
                    <div class="wan-status-rate">
                        <span class="rate-value">@sqmMonitorData.Wan2.EffectiveRateMbps.ToString("F0")</span>
                        <span class="rate-unit">Mbps</span>
                    </div>
                    <div class="wan-status-details">
                        @if (sqmMonitorData.Wan2.LastSpeedtest != null)
                        {
                            <div class="detail-section">
                                <div class="detail-header">Last Speedtest</div>
                                <div class="detail-row">
                                    <span class="detail-label">Measured</span>
                                    <span class="detail-value">@sqmMonitorData.Wan2.LastSpeedtest.MeasuredMbps Mbps</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Adjusted</span>
                                    <span class="detail-value">@sqmMonitorData.Wan2.LastSpeedtest.AdjustedMbps Mbps</span>
                                </div>
                                @if (!string.IsNullOrEmpty(sqmMonitorData.Wan2.LastSpeedtest.Timestamp))
                                {
                                    <div class="detail-time">@sqmMonitorData.Wan2.LastSpeedtest.Timestamp</div>
                                }
                            </div>
                        }
                        @if (sqmMonitorData.Wan2.LastPing != null)
                        {
                            <div class="detail-section">
                                <div class="detail-header">Last Ping Adjustment</div>
                                <div class="detail-row">
                                    <span class="detail-label">Latency</span>
                                    <span class="detail-value @(sqmMonitorData.Wan2.LastPing.LatencyMs > 50 ? "text-warning" : "")">@sqmMonitorData.Wan2.LastPing.LatencyMs.ToString("F1") ms</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Rate</span>
                                    <span class="detail-value">@sqmMonitorData.Wan2.LastPing.RateMbps Mbps</span>
                                </div>
                            </div>
                        }
                        @if (sqmMonitorData.Wan2.BaselineMbps > 0)
                        {
                            <div class="baseline-info">
                                Baseline: @sqmMonitorData.Wan2.BaselineMbps Mbps
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }

    <!-- WAN 1 Configuration -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">WAN 1 Configuration</h2>
            <label class="toggle-label">
                <input type="checkbox" @bind="wan1Config.Enabled" />
                <span>Enable SQM</span>
            </label>
        </div>
        <div class="card-body @(!wan1Config.Enabled ? "disabled-section" : "")">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Connection Name</label>
                    <input type="text" class="form-control" @bind="wan1Config.Name" placeholder="e.g., Yelcot, Comcast" />
                </div>
                <div class="form-group">
                    <label class="form-label">WAN Interface</label>
                    <select class="form-control" @bind="wan1Config.Interface">
                        @if (wanInterfaces.Any())
                        {
                            @foreach (var wan in wanInterfaces)
                            {
                                <option value="@wan.Interface">@wan.Interface (@wan.Name)</option>
                            }
                        }
                        else
                        {
                            <option value="@wan1Config.Interface">@wan1Config.Interface</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Connection Type</label>
                    <select class="form-control" @bind="wan1Config.ConnectionType" @bind:after="() => UpdateCalculatedSpeeds(wan1Config)">
                        @foreach (var type in Enum.GetValues<ConnectionType>())
                        {
                            <option value="@type">@ConnectionProfile.GetConnectionTypeName(type)</option>
                        }
                    </select>
                    <small class="form-hint">@ConnectionProfile.GetConnectionTypeDescription(wan1Config.ConnectionType)</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Nominal Download Speed (Mbps)</label>
                    <input type="number" class="form-control" @bind="wan1Config.NominalDownload" @bind:after="() => UpdateCalculatedSpeeds(wan1Config)" min="10" max="10000" />
                    <small class="form-hint">Advertised/paid-for download speed</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Nominal Upload Speed (Mbps)</label>
                    <input type="number" class="form-control" @bind="wan1Config.NominalUpload" min="1" max="10000" />
                    <small class="form-hint">Advertised/paid-for upload speed</small>
                </div>
            </div>

            <!-- Calculated Parameters (read-only preview) -->
            <div class="calculated-params">
                <h4>Calculated SQM Parameters</h4>
                <div class="params-grid">
                    <div class="param">
                        <span class="param-label">Speed Range:</span>
                        <span class="param-value">@wan1Config.MinSpeed - @wan1Config.MaxSpeed Mbps</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Absolute Max:</span>
                        <span class="param-value">@wan1Config.AbsoluteMax Mbps</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Overhead:</span>
                        <span class="param-value">@(((wan1Config.Overhead - 1) * 100).ToString("F0"))%</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Latency Baseline:</span>
                        <span class="param-value">@wan1Config.BaselineLatency ms</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Latency Threshold:</span>
                        <span class="param-value">@wan1Config.LatencyThreshold ms</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ping Target Host</label>
                <input type="text" class="form-control" @bind="wan1Config.PingHost" placeholder="1.1.1.1" />
                <small class="form-hint">ISP host/router recommended for accurate latency monitoring</small>
            </div>

            <div class="form-group">
                <label class="form-label">Speedtest Server ID</label>
                <input type="text" class="form-control" @bind="wan1Config.SpeedtestServerId" placeholder="@(wan1Config.ConnectionType == ConnectionType.Starlink ? "59762 (default)" : "Auto-select")" />
                <small class="form-hint">Optional Ookla server ID override</small>
            </div>
        </div>
    </div>

    <!-- WAN 2 Configuration (Dual-WAN) -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">WAN 2 Configuration</h2>
            <label class="toggle-label">
                <input type="checkbox" @bind="wan2Config.Enabled" />
                <span>Enable SQM</span>
            </label>
        </div>
        <div class="card-body @(!wan2Config.Enabled ? "disabled-section" : "")">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Connection Name</label>
                    <input type="text" class="form-control" @bind="wan2Config.Name" placeholder="e.g., Starlink" />
                </div>
                <div class="form-group">
                    <label class="form-label">WAN Interface</label>
                    <select class="form-control" @bind="wan2Config.Interface">
                        @if (wanInterfaces.Any())
                        {
                            @foreach (var wan in wanInterfaces)
                            {
                                <option value="@wan.Interface">@wan.Interface (@wan.Name)</option>
                            }
                        }
                        else
                        {
                            <option value="@wan2Config.Interface">@wan2Config.Interface</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Connection Type</label>
                    <select class="form-control" @bind="wan2Config.ConnectionType" @bind:after="() => UpdateCalculatedSpeeds(wan2Config)">
                        @foreach (var type in Enum.GetValues<ConnectionType>())
                        {
                            <option value="@type">@ConnectionProfile.GetConnectionTypeName(type)</option>
                        }
                    </select>
                    <small class="form-hint">@ConnectionProfile.GetConnectionTypeDescription(wan2Config.ConnectionType)</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Nominal Download Speed (Mbps)</label>
                    <input type="number" class="form-control" @bind="wan2Config.NominalDownload" @bind:after="() => UpdateCalculatedSpeeds(wan2Config)" min="10" max="10000" />
                </div>
                <div class="form-group">
                    <label class="form-label">Nominal Upload Speed (Mbps)</label>
                    <input type="number" class="form-control" @bind="wan2Config.NominalUpload" min="1" max="10000" />
                </div>
            </div>

            <!-- Calculated Parameters -->
            <div class="calculated-params">
                <h4>Calculated SQM Parameters</h4>
                <div class="params-grid">
                    <div class="param">
                        <span class="param-label">Speed Range:</span>
                        <span class="param-value">@wan2Config.MinSpeed - @wan2Config.MaxSpeed Mbps</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Absolute Max:</span>
                        <span class="param-value">@wan2Config.AbsoluteMax Mbps</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Overhead:</span>
                        <span class="param-value">@(((wan2Config.Overhead - 1) * 100).ToString("F0"))%</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Latency Baseline:</span>
                        <span class="param-value">@wan2Config.BaselineLatency ms</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Latency Threshold:</span>
                        <span class="param-value">@wan2Config.LatencyThreshold ms</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ping Target Host</label>
                <input type="text" class="form-control" @bind="wan2Config.PingHost" placeholder="100.64.0.1" />
            </div>

            <div class="form-group">
                <label class="form-label">Speedtest Server ID</label>
                <input type="text" class="form-control" @bind="wan2Config.SpeedtestServerId" placeholder="@(wan2Config.ConnectionType == ConnectionType.Starlink ? "59762 (default)" : "Auto-select")" />
                <small class="form-hint">Optional Ookla server ID override</small>
            </div>
        </div>
    </div>

    <!-- Deployment Actions -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Deployment</h2>
        </div>
        <div class="card-body">
            <p class="info-text">
                SQM uses a dual-mode approach: <strong>Speedtest-based</strong> adjustments run 2x daily (6 AM/6 PM)
                to calibrate baseline speeds, while <strong>Ping-based</strong> adjustments run every 5 minutes
                for real-time latency optimization.
            </p>

            <div class="action-buttons">
                <button class="btn btn-primary" @onclick="DeploySqm" disabled="@(isDeploying || (!wan1Config.Enabled && !wan2Config.Enabled))">
                    @if (isDeploying)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                        <span>Deploying...</span>
                    }
                    else
                    {
                        <span>Deploy SQM Scripts</span>
                    }
                </button>
                <button class="btn btn-secondary" @onclick="DeployTcMonitor" disabled="@isDeploying">
                    Deploy SQM Monitor Only
                </button>
                <button class="btn btn-danger" @onclick="RemoveSqm" disabled="@(isDeploying || deploymentStatus?.IsDeployed != true)">
                    Remove SQM
                </button>
            </div>

            @if (deploymentSteps.Any())
            {
                <div class="deployment-log" style="margin-top: 1rem;">
                    <h4>Deployment Progress</h4>
                    <ul class="step-list">
                        @foreach (var step in deploymentSteps)
                        {
                            <li>@step</li>
                        }
                    </ul>
                </div>
            }
        </div>
    </div>

    <!-- Speedtest History -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Recent Speedtests</h2>
            <button class="btn btn-sm btn-secondary" @onclick="RunSpeedtest" disabled="@(isRunningSpeedtest || deploymentStatus?.IsDeployed != true)">
                @if (isRunningSpeedtest)
                {
                    <span class="spinner-border spinner-border-sm"></span>
                }
                else
                {
                    <span>Run Speedtest Now</span>
                }
            </button>
        </div>
        <div class="card-body">
            @if (speedtestHistory.Any())
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Download</th>
                            <th>Upload</th>
                            <th>Latency</th>
                            <th>Server</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var test in speedtestHistory)
                        {
                            <tr>
                                <td>@test.Timestamp.ToString("MMM dd HH:mm")</td>
                                <td>@test.Download.ToString("F1") Mbps</td>
                                <td>@test.Upload.ToString("F1") Mbps</td>
                                <td>@test.Latency.ToString("F1") ms</td>
                                <td>@test.Server</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="empty-state">
                    <p>No speedtest results yet. Deploy SQM and run a speedtest to see results.</p>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .sqm-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .form-hint {
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin-top: 0.25rem;
        display: block;
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .disabled-section {
        opacity: 0.5;
        pointer-events: none;
    }

    .calculated-params {
        background: var(--surface-secondary);
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 1rem 0;
    }

    .calculated-params h4 {
        margin: 0 0 0.75rem 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .params-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.5rem;
    }

    .param {
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
    }

    .param-label {
        color: var(--text-secondary);
    }

    .param-value {
        font-weight: 500;
        font-family: var(--font-mono);
    }

    .sqm-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .metric {
        text-align: center;
        padding: 1.25rem;
        background: var(--surface-secondary);
        border-radius: 0.5rem;
    }

    .metric-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }

    .metric-value {
        font-size: 1rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-active {
        background: var(--success);
    }

    .status-inactive {
        background: var(--danger);
    }

    .tc-rates-panel h4 {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .tc-rates {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .tc-rate-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--surface-secondary);
        border-radius: 0.5rem;
    }

    .tc-name {
        font-weight: 500;
    }

    .tc-interface {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .tc-rate {
        font-family: var(--font-mono);
        color: var(--primary);
    }

    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .info-text {
        color: var(--text-secondary);
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .deployment-log {
        background: var(--surface-secondary);
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .deployment-log h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
    }

    .step-list {
        margin: 0;
        padding-left: 1.5rem;
        font-family: var(--font-mono);
        font-size: 0.85rem;
    }

    .step-list li {
        margin: 0.25rem 0;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .loading-status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        padding: 2rem;
        color: var(--text-secondary);
    }

    /* SQM Live Dashboard */
    .sqm-live-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .wan-status-card {
        background: linear-gradient(135deg, var(--surface) 0%, var(--surface-secondary) 100%);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .wan-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .wan-status-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .wan-status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--text-secondary);
    }

    .wan-status-indicator.active {
        background: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    }

    .wan-status-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .wan-status-interface {
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-family: var(--font-mono);
    }

    .wan-status-rate {
        text-align: center;
        padding: 1.5rem 0;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }

    .rate-value {
        font-size: 3rem;
        font-weight: 700;
        font-family: var(--font-mono);
        background: linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1;
    }

    .rate-unit {
        display: block;
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .wan-status-details {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .detail-section {
        background: var(--surface-secondary);
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
    }

    .detail-header {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.25rem 0;
    }

    .detail-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .detail-value {
        font-family: var(--font-mono);
        font-weight: 500;
        color: var(--text-primary);
    }

    .detail-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
        font-family: var(--font-mono);
    }

    .baseline-info {
        text-align: center;
        font-size: 0.85rem;
        color: var(--text-secondary);
        padding-top: 0.5rem;
    }

    .text-warning {
        color: #f59e0b;
    }

    .text-muted {
        color: var(--text-secondary);
        font-style: italic;
    }
</style>

@code {
    // Cache settings
    private static readonly TimeSpan CacheDuration = TimeSpan.FromMinutes(5);
    private static DateTime _lastStatusCheck = DateTime.MinValue;
    private static SqmDeploymentStatus? _cachedDeploymentStatus;
    private static List<TcInterfaceStats>? _cachedTcInterfaces;
    private static List<WanInterfaceInfo>? _cachedWanInterfaces;
    private static bool _cachedGatewayConnected;

    // State
    private bool isLoading = true;
    private bool isDeploying = false;
    private bool isRunningSpeedtest = false;
    private bool isInstallingUdmBoot = false;
    private bool gatewayConnected = false;
    private string? statusMessage;
    private bool statusSuccess = false;

    // Deployment status
    private SqmDeploymentStatus? deploymentStatus;
    private List<string> deploymentSteps = new();
    private List<TcInterfaceStats>? tcInterfaces;

    // WAN interfaces from controller
    private List<WanInterfaceInfo> wanInterfaces = new();

    // WAN configurations (defaults overwritten by ApplyDetectedWanInterfaces)
    private WanConfigModel wan1Config = new()
    {
        Enabled = true,
        Name = "WAN1",
        Interface = "",
        ConnectionType = ConnectionType.DocsisCable,
        NominalDownload = 0,
        NominalUpload = 0,
        PingHost = "1.1.1.1"
    };

    private WanConfigModel wan2Config = new()
    {
        Enabled = false,
        Name = "WAN2",
        Interface = "",
        ConnectionType = ConnectionType.DocsisCable,
        NominalDownload = 0,
        NominalUpload = 0,
        PingHost = "1.1.1.1"
    };

    // Speedtest history
    private List<Services.SpeedtestResult> speedtestHistory = new();

    // SQM Monitor data (from HTTP endpoint)
    private TcMonitorResponse? sqmMonitorData;

    protected override void OnInitialized()
    {
        UpdateCalculatedSpeeds(wan1Config);
        UpdateCalculatedSpeeds(wan2Config);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load saved WAN configs from database first
            await LoadSavedConfigsAsync();

            // Check if we have valid cached data
            if (IsCacheValid())
            {
                // Use cached data for deployment status
                gatewayConnected = _cachedGatewayConnected;
                deploymentStatus = _cachedDeploymentStatus;
                wanInterfaces = _cachedWanInterfaces ?? new();
                // Only apply detected interfaces if we don't have saved configs
                if (!hasSavedConfigs)
                    ApplyDetectedWanInterfaces();

                // Always fetch fresh SQM Monitor data for the dashboard
                await LoadSqmMonitorDataAsync();

                isLoading = false;
                StateHasChanged();
            }
            else
            {
                // Load fresh status
                await RefreshStatus(forceRefresh: false);
            }
        }
    }

    private bool hasSavedConfigs = false;

    private async Task LoadSavedConfigsAsync()
    {
        try
        {
            var savedConfigs = await SpeedTestRepository.GetAllSqmWanConfigsAsync();
            if (savedConfigs.Count > 0)
            {
                hasSavedConfigs = true;

                foreach (var saved in savedConfigs)
                {
                    var config = saved.WanNumber == 1 ? wan1Config : wan2Config;
                    config.Enabled = saved.Enabled;
                    config.ConnectionType = (ConnectionType)saved.ConnectionType;
                    config.Name = saved.Name;
                    config.Interface = saved.Interface;
                    config.NominalDownload = saved.NominalDownloadMbps;
                    config.NominalUpload = saved.NominalUploadMbps;
                    config.PingHost = saved.PingHost;
                    config.SpeedtestServerId = saved.SpeedtestServerId;
                    UpdateCalculatedSpeeds(config);
                }
            }
        }
        catch
        {
            // If loading fails, continue with defaults
        }
    }

    private async Task SaveWanConfigsAsync()
    {
        try
        {
            if (wan1Config.Enabled || wan2Config.Enabled)
            {
                // Save WAN 1 config
                var wan1Saved = new SqmWanConfiguration
                {
                    WanNumber = 1,
                    Enabled = wan1Config.Enabled,
                    ConnectionType = (int)wan1Config.ConnectionType,
                    Name = wan1Config.Name,
                    Interface = wan1Config.Interface,
                    NominalDownloadMbps = wan1Config.NominalDownload,
                    NominalUploadMbps = wan1Config.NominalUpload,
                    PingHost = wan1Config.PingHost,
                    SpeedtestServerId = wan1Config.SpeedtestServerId
                };
                await SpeedTestRepository.SaveSqmWanConfigAsync(wan1Saved);

                // Save WAN 2 config
                var wan2Saved = new SqmWanConfiguration
                {
                    WanNumber = 2,
                    Enabled = wan2Config.Enabled,
                    ConnectionType = (int)wan2Config.ConnectionType,
                    Name = wan2Config.Name,
                    Interface = wan2Config.Interface,
                    NominalDownloadMbps = wan2Config.NominalDownload,
                    NominalUploadMbps = wan2Config.NominalUpload,
                    PingHost = wan2Config.PingHost,
                    SpeedtestServerId = wan2Config.SpeedtestServerId
                };
                await SpeedTestRepository.SaveSqmWanConfigAsync(wan2Saved);
            }
        }
        catch
        {
            // If saving fails, continue with deployment
        }
    }

    private static bool IsCacheValid()
    {
        return _cachedDeploymentStatus != null &&
               DateTime.UtcNow - _lastStatusCheck < CacheDuration;
    }

    private static void InvalidateCache()
    {
        _lastStatusCheck = DateTime.MinValue;
    }

    private void ApplyDetectedWanInterfaces()
    {
        if (wanInterfaces.Count == 0)
            return;

        // Apply first WAN to wan1Config
        var wan1 = wanInterfaces[0];
        ApplyWanInterfaceToConfig(wan1, wan1Config);

        // Apply second WAN to wan2Config if available
        if (wanInterfaces.Count > 1)
        {
            var wan2 = wanInterfaces[1];
            ApplyWanInterfaceToConfig(wan2, wan2Config);
        }
        else
        {
            wan2Config.Enabled = false;
        }
    }

    private void ApplyWanInterfaceToConfig(WanInterfaceInfo wan, WanConfigModel config)
    {
        config.Name = wan.Name;
        config.Interface = wan.Interface;
        config.Enabled = true;

        if (!string.IsNullOrEmpty(wan.SuggestedPingIp))
            config.PingHost = wan.SuggestedPingIp;

        // Apply Starlink defaults when detected
        if (wan.Name.Equals("Starlink", StringComparison.OrdinalIgnoreCase))
        {
            config.ConnectionType = ConnectionType.Starlink;
            config.NominalDownload = 400;
            config.NominalUpload = 40;
        }

        UpdateCalculatedSpeeds(config);
    }

    private void UpdateCalculatedSpeeds(WanConfigModel config)
    {
        var profile = new ConnectionProfile
        {
            Type = config.ConnectionType,
            NominalDownloadMbps = config.NominalDownload,
            NominalUploadMbps = config.NominalUpload
        };

        config.MaxSpeed = profile.MaxDownloadMbps;
        config.MinSpeed = profile.MinDownloadMbps;
        config.AbsoluteMax = profile.AbsoluteMaxDownloadMbps;
        config.Overhead = profile.OverheadMultiplier;
        config.BaselineLatency = profile.BaselineLatency;
        config.LatencyThreshold = profile.LatencyThreshold;
    }

    private async Task RefreshStatus(bool forceRefresh = true)
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Test gateway connection
            var connectionResult = await DeploymentService.TestConnectionAsync();
            gatewayConnected = connectionResult.success;

            if (gatewayConnected)
            {
                // Check deployment status
                deploymentStatus = await DeploymentService.CheckDeploymentStatusAsync();

                // Load SQM Monitor data (includes TC rates, speedtest, ping data)
                var gatewayHost = await GetGatewayHostAsync();
                if (!string.IsNullOrEmpty(gatewayHost))
                {
                    sqmMonitorData = await SqmMonitorClient.GetTcStatsAsync(gatewayHost);
                    tcInterfaces = sqmMonitorData?.GetAllInterfaces();
                }

                // Get WAN interfaces from controller
                try
                {
                    wanInterfaces = await SqmService.GetWanInterfacesFromControllerAsync();
                    // Only apply detected interfaces if we don't have saved configs
                    if (!hasSavedConfigs)
                        ApplyDetectedWanInterfaces();
                }
                catch
                {
                    // WAN detection failed, keep defaults
                    wanInterfaces = new();
                }

                // Update cache
                _cachedGatewayConnected = gatewayConnected;
                _cachedDeploymentStatus = deploymentStatus;
                _cachedTcInterfaces = tcInterfaces;
                _cachedWanInterfaces = wanInterfaces;
                _lastStatusCheck = DateTime.UtcNow;
            }
            else
            {
                statusMessage = connectionResult.message;
                statusSuccess = false;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            statusSuccess = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task InstallUdmBoot()
    {
        isInstallingUdmBoot = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var result = await DeploymentService.InstallUdmBootAsync();

            if (result.success)
            {
                statusMessage = result.message;
                statusSuccess = true;
                InvalidateCache();
                await RefreshStatus();
            }
            else
            {
                statusMessage = result.message;
                statusSuccess = false;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            statusSuccess = false;
        }
        finally
        {
            isInstallingUdmBoot = false;
            StateHasChanged();
        }
    }

    private async Task DeploySqm()
    {
        if (!wan1Config.Enabled && !wan2Config.Enabled)
        {
            statusMessage = "Enable at least one WAN interface";
            statusSuccess = false;
            return;
        }

        isDeploying = true;
        deploymentSteps.Clear();
        statusMessage = null;
        StateHasChanged();

        try
        {
            // Save WAN configs to database before deploying
            await SaveWanConfigsAsync();
            deploymentSteps.Add("WAN configurations saved");
            StateHasChanged();

            // Deploy WAN 1 (initial speedtest at 60 seconds)
            if (wan1Config.Enabled)
            {
                deploymentSteps.Add($"Deploying SQM for {wan1Config.Name} ({wan1Config.Interface})...");
                StateHasChanged();

                var config = CreateSqmConfiguration(wan1Config);
                var result = await DeploymentService.DeployAsync(config, initialDelaySeconds: 60);

                if (result.Success)
                {
                    deploymentSteps.AddRange(result.Steps);
                    deploymentSteps.Add($"WAN 1 ({wan1Config.Name}) deployed successfully (initial test in 60s)");
                }
                else
                {
                    throw new Exception($"WAN 1 deployment failed: {result.Error}");
                }
            }

            // Deploy WAN 2 (initial speedtest at 180 seconds to stagger with WAN1)
            if (wan2Config.Enabled)
            {
                deploymentSteps.Add($"Deploying SQM for {wan2Config.Name} ({wan2Config.Interface})...");
                StateHasChanged();

                var config = CreateSqmConfiguration(wan2Config);
                var result = await DeploymentService.DeployAsync(config, initialDelaySeconds: 180);

                if (result.Success)
                {
                    deploymentSteps.AddRange(result.Steps);
                    deploymentSteps.Add($"WAN 2 ({wan2Config.Name}) deployed successfully (initial test in 180s)");
                }
                else
                {
                    throw new Exception($"WAN 2 deployment failed: {result.Error}");
                }
            }

            // Deploy SQM Monitor
            if (wan1Config.Enabled || wan2Config.Enabled)
            {
                deploymentSteps.Add("Deploying SQM Monitor...");
                StateHasChanged();

                var w1 = wan1Config.Enabled ? wan1Config : wan2Config;
                var w2 = wan2Config.Enabled ? wan2Config : wan1Config;

                await DeploymentService.DeploySqmMonitorAsync(
                    $"ifb{w1.Interface}", w1.Name,
                    $"ifb{w2.Interface}", w2.Name);

                deploymentSteps.Add("SQM Monitor deployed");
            }

            statusMessage = "SQM deployment completed successfully!";
            statusSuccess = true;

            // Invalidate cache and refresh status
            InvalidateCache();
            await RefreshStatus();
        }
        catch (Exception ex)
        {
            statusMessage = $"Deployment failed: {ex.Message}";
            statusSuccess = false;
        }
        finally
        {
            isDeploying = false;
            StateHasChanged();
        }
    }

    private async Task DeployTcMonitor()
    {
        isDeploying = true;
        deploymentSteps.Clear();
        statusMessage = null;
        StateHasChanged();

        try
        {
            deploymentSteps.Add("Deploying SQM Monitor...");
            StateHasChanged();

            var success = await DeploymentService.DeploySqmMonitorAsync(
                $"ifb{wan1Config.Interface}", wan1Config.Name,
                $"ifb{wan2Config.Interface}", wan2Config.Name);

            if (success)
            {
                deploymentSteps.Add("SQM Monitor deployed successfully");
                statusMessage = "SQM Monitor deployed!";
                statusSuccess = true;
                InvalidateCache();
                await RefreshStatus();
            }
            else
            {
                statusMessage = "SQM Monitor deployment failed";
                statusSuccess = false;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            statusSuccess = false;
        }
        finally
        {
            isDeploying = false;
            StateHasChanged();
        }
    }

    private async Task RemoveSqm()
    {
        isDeploying = true;
        statusMessage = null;
        deploymentSteps.Clear();
        deploymentSteps.Add("Removing SQM and SQM Monitor...");
        StateHasChanged();

        try
        {
            var (success, steps) = await DeploymentService.RemoveAsync(includeTcMonitor: true);
            deploymentSteps.AddRange(steps);
            StateHasChanged();

            if (success)
            {
                statusMessage = "SQM and SQM Monitor removed successfully";
                statusSuccess = true;
                InvalidateCache();
                await RefreshStatus();
            }
            else
            {
                statusMessage = "Failed to remove SQM scripts";
                statusSuccess = false;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            statusSuccess = false;
            deploymentSteps.Add($"Error: {ex.Message}");
        }
        finally
        {
            isDeploying = false;
            StateHasChanged();
        }
    }

    private async Task RunSpeedtest()
    {
        isRunningSpeedtest = true;
        StatusMessage("Running speedtest...", true);
        StateHasChanged();

        try
        {
            var config = wan1Config.Enabled
                ? CreateSqmConfiguration(wan1Config)
                : CreateSqmConfiguration(wan2Config);

            var result = await DeploymentService.RunSpeedtestAsync(config);

            if (result != null)
            {
                speedtestHistory.Insert(0, result);
                if (speedtestHistory.Count > 10)
                    speedtestHistory.RemoveAt(speedtestHistory.Count - 1);

                StatusMessage($"Speedtest complete: {result.Download:F1} Mbps down, {result.Upload:F1} Mbps up", true);
            }
            else
            {
                StatusMessage("Speedtest failed", false);
            }
        }
        catch (Exception ex)
        {
            StatusMessage($"Speedtest error: {ex.Message}", false);
        }
        finally
        {
            isRunningSpeedtest = false;
            StateHasChanged();
        }
    }

    private SqmConfig CreateSqmConfiguration(WanConfigModel model)
    {
        var config = new SqmConfig
        {
            ConnectionType = model.ConnectionType,
            ConnectionName = model.Name,
            Interface = model.Interface,
            NominalDownloadSpeed = model.NominalDownload,
            NominalUploadSpeed = model.NominalUpload,
            PingHost = model.PingHost,
            PreferredSpeedtestServerId = model.SpeedtestServerId
        };

        config.ApplyProfileSettings();
        return config;
    }

    private void StatusMessage(string message, bool success)
    {
        statusMessage = message;
        statusSuccess = success;
    }

    private async Task<string?> GetGatewayHostAsync()
    {
        try
        {
            var settings = await SpeedTestRepository.GetGatewaySshSettingsAsync();
            return settings?.Host;
        }
        catch
        {
            return null;
        }
    }

    private async Task LoadSqmMonitorDataAsync()
    {
        try
        {
            var gatewayHost = await GetGatewayHostAsync();
            if (!string.IsNullOrEmpty(gatewayHost))
            {
                sqmMonitorData = await SqmMonitorClient.GetTcStatsAsync(gatewayHost);
                tcInterfaces = sqmMonitorData?.GetAllInterfaces();
            }
        }
        catch
        {
            // Silently fail - dashboard just won't show
        }
    }

    // Model for WAN configuration form
    private class WanConfigModel
    {
        public bool Enabled { get; set; }
        public string Name { get; set; } = "";
        public string Interface { get; set; } = "";
        public ConnectionType ConnectionType { get; set; }
        public int NominalDownload { get; set; }
        public int NominalUpload { get; set; }
        public string PingHost { get; set; } = "1.1.1.1";
        public string? SpeedtestServerId { get; set; }

        // Calculated values
        public int MaxSpeed { get; set; }
        public int MinSpeed { get; set; }
        public int AbsoluteMax { get; set; }
        public double Overhead { get; set; }
        public double BaselineLatency { get; set; }
        public double LatencyThreshold { get; set; }
    }
}
