@page "/sqm"
@implements IDisposable
@inject SqmService SqmService
@inject SqmDeploymentService DeploymentService
@inject UniFiConnectionService ConnectionService
@inject NetworkOptimizer.Storage.Interfaces.ISpeedTestRepository SpeedTestRepository
@inject TcMonitorClient SqmMonitorClient
@inject IGatewaySshService GatewaySshService
@inject IJSRuntime JS
@inject ILogger<Sqm> Logger
@rendermode InteractiveServer
@using SqmConfig = NetworkOptimizer.Sqm.Models.SqmConfiguration
@using NetworkOptimizer.Sqm.Models
@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.Web.Services.Ssh

<PageTitle>Adaptive SQM - Network Optimizer</PageTitle>

<NavigationLock OnBeforeInternalNavigation="OnBeforeInternalNavigation" ConfirmExternalNavigation="@HasUndeployedChanges" />

<div class="page-header">
    <h1>Adaptive SQM Manager</h1>
    <p class="page-description">Dynamic bandwidth optimization with dual-mode (Speedtest + Ping) adjustment. Uses 7-day congestion profiles tuned for your connection type to keep SQM tight and bufferbloat in check.</p>
</div>

@if (!ConnectionService.IsConnected && ConnectionService.IsInitialized && !string.IsNullOrEmpty(ConnectionService.LastError))
{
    <div class="connection-banner connection-error">
        <div class="banner-content">
            <span class="banner-icon">!</span>
            <div class="banner-text">
                <strong>UniFi Connection Error</strong>
                <span>@ConnectionService.LastError - WAN detection requires a working UniFi connection.</span>
            </div>
            <a href="/settings" class="btn btn-primary">Check Settings</a>
        </div>
    </div>
}

<div class="sqm-container">
    <!-- Deployment Status -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Deployment Status</h2>
            @if (!isLoading)
            {
                <button class="btn btn-sm btn-secondary" @onclick="ManualRefresh">Refresh</button>
            }
        </div>
        <div class="card-body">
            <div class="deployment-status-content" style="min-height: 90px;">
                @if (isLoading)
                {
                    <div class="loading-status">
                        <span class="spinner"></span>
                        <span>Checking deployment status...</span>
                    </div>
                }
                else
                {
                    <div class="sqm-metrics">
                    <div class="metric">
                        <div class="metric-label">Gateway Connection</div>
                        <div class="metric-value">
                            <span class="status-indicator @(gatewayConnected ? "status-active" : "status-inactive")"></span>
                            @(gatewayConnected ? "Connected" : "Not Connected")
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">UDM Boot</div>
                        <div class="metric-value">
                            <span class="status-indicator @(deploymentStatus?.UdmBootInstalled == true ? "status-active" : "status-inactive")"></span>
                            @if (deploymentStatus?.UdmBootInstalled == true)
                            {
                                <span>@(deploymentStatus?.UdmBootEnabled == true ? "Enabled" : "Installed")</span>
                            }
                            else
                            {
                                <span>Not Installed</span>
                            }
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">SQM Scripts</div>
                        <div class="metric-value">
                            <span class="status-indicator @(deploymentStatus?.IsDeployed == true ? "status-active" : "status-inactive")"></span>
                            @(deploymentStatus?.IsDeployed == true ? "Deployed" : "Not Deployed")
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">SQM Monitor</div>
                        <div class="metric-value">
                            <span class="status-indicator @(deploymentStatus?.TcMonitorRunning == true ? "status-active" : "status-inactive")"></span>
                            @(deploymentStatus?.TcMonitorRunning == true ? "Running" : "Stopped")
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Cron Jobs</div>
                        <div class="metric-value">@(deploymentStatus?.CronJobsConfigured ?? 0) configured</div>
                    </div>
                    </div>

                    @if (!gatewayConfigured)
                    {
                        <div class="alert alert-warning" style="margin-top: 1rem;">
                            <strong>Gateway SSH not configured.</strong>
                            Go to <a href="/settings#gateway-ssh">Settings</a> to configure Gateway SSH credentials before using Adaptive SQM.
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(deploymentStatus?.Error))
                    {
                        <div class="alert alert-danger alert-with-tooltip" style="margin-top: 1rem;">
                            <span class="alert-text"><strong>Connection Error:</strong> @deploymentStatus.Error</span>
                            <SshTroubleshootingTooltip Context="gateway" />
                        </div>
                    }

                    @if (gatewayConnected && deploymentStatus?.UdmBootInstalled != true)
                    {
                        <div class="alert alert-warning" style="margin-top: 1rem;">
                            <strong>UDM Boot Required:</strong> Boot scripts in <code>/data/on_boot.d/</code> will not persist after firmware upgrades or run on boot without udm-boot installed.
                            <button class="btn btn-sm btn-primary" style="margin-left: 0.5rem;" @onclick="InstallUdmBoot" disabled="@isInstallingUdmBoot">
                                @if (isInstallingUdmBoot)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                    <span>Installing...</span>
                                }
                                else
                                {
                                    <span>Install UDM Boot</span>
                                }
                            </button>
                        </div>
                    }
                }
            </div>

        </div>
    </div>

    <!-- Feature Guard: Show message if no WANs have Smart Queues enabled -->
    @if (!isLoading && wanInterfaces.Any() && !sqmEligibleWans.Any())
    {
        <div class="card">
            <div class="card-body">
                <div class="alert alert-info" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                    <div>
                        <strong>Smart Queues Required:</strong> Adaptive SQM requires at least one WAN connection with UniFi Smart Queues (SQM) enabled.
                        Enable Smart Queues in your UniFi controller under <strong>Settings &rarr; Internet &rarr; <em>WAN Connection</em> &rarr; Advanced &rarr; Smart Queues</strong>.
                    </div>
                    <button class="btn btn-primary btn-sm" @onclick="ManualRefresh" disabled="@isLoading" style="white-space: nowrap;">
                        @if (isLoading)
                        {
                            <span>Checking...</span>
                        }
                        else
                        {
                            <span>Check Again</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- SQM Live Status Dashboard (show if monitor responds with active WANs) -->
    @if (sqmMonitorData != null && (sqmMonitorData.Wan1?.Active == true || sqmMonitorData.Wan2?.Active == true))
    {
        <div class="card sqm-dashboard-card">
            <div class="card-header">
                <h2 class="card-title">Live SQM Status</h2>
                <div class="card-header-actions">
                    @if (sqmMonitorData?.Timestamp != default)
                    {
                        <div class="tc-timestamp">
                            <small>Updated: @sqmMonitorData?.Timestamp.ToLocalTime().ToString("HH:mm:ss")</small>
                        </div>
                    }
                    <button class="btn btn-sm btn-secondary" @onclick="RefreshDashboard" disabled="@isRefreshingDashboard">
                        @if (isRefreshingDashboard)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {
                            <span>Refresh</span>
                        }
                    </button>
                </div>
            </div>
            <div class="card-body">
        <div class="sqm-live-dashboard">
            @if (sqmMonitorData?.Wan1?.Active == true)
            {
                <div class="wan-status-card">
                    <div class="wan-status-header">
                        <div class="wan-status-title">
                            <span class="wan-status-indicator active"></span>
                            <span class="wan-status-name">@sqmMonitorData.Wan1.Name</span>
                        </div>
                        <span class="wan-status-interface">@sqmMonitorData.Wan1.Interface</span>
                    </div>
                    <div class="wan-status-rate">
                        @if (sqmMonitorData.Wan1.SpeedtestRunning || (isRunningAdjustment && adjustmentWan == sqmMonitorData.Wan1.Name))
                        {
                            <div class="speedtest-running-indicator">
                                <span class="spinner"></span>
                                <span>Speed test running...</span>
                            </div>
                        }
                        else
                        {
                            <span class="rate-value">@sqmMonitorData.Wan1.EffectiveRateMbps.ToString("F0")</span>
                            <span class="rate-unit">Mbps</span>
                        }
                    </div>
                    @if (sqmMonitorData.Wan1.LastSpeedtestFailed)
                    {
                        <div class="speedtest-failed-indicator">
                            <span class="warning-icon">⚠</span>
                            <span>Last speedtest failed - <a href="./sqm#check-logs">check logs</a></span>
                        </div>
                    }
                    <div class="wan-status-details">
                        @if (sqmMonitorData.Wan1.LastSpeedtest != null)
                        {
                            <div class="detail-section">
                                <div class="detail-header">Last Speedtest</div>
                                <div class="detail-row">
                                    <span class="detail-label">Measured</span>
                                    <span class="detail-value">@sqmMonitorData.Wan1.LastSpeedtest.MeasuredMbps.ToString("F0") Mbps</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Adjusted</span>
                                    <span class="detail-value">@sqmMonitorData.Wan1.LastSpeedtest.AdjustedMbps.ToString("F0") Mbps</span>
                                </div>
                                @if (!string.IsNullOrEmpty(sqmMonitorData.Wan1.LastSpeedtest.Timestamp))
                                {
                                    <div class="detail-time">@sqmMonitorData.Wan1.LastSpeedtest.Timestamp</div>
                                }
                            </div>
                        }
                        @if (sqmMonitorData.Wan1.LastPing != null)
                        {
                            <div class="detail-section">
                                <div class="detail-header">Last Ping Adjustment</div>
                                <div class="detail-row">
                                    <span class="detail-label">Latency</span>
                                    <span class="detail-value @(sqmMonitorData.Wan1.LastPing.LatencyMs > 50 ? "text-warning" : "")">@sqmMonitorData.Wan1.LastPing.LatencyMs.ToString("F1") ms</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Rate</span>
                                    <span class="detail-value">@sqmMonitorData.Wan1.LastPing.RateMbps.ToString("F0") Mbps</span>
                                </div>
                                @if (!string.IsNullOrEmpty(sqmMonitorData.Wan1.LastPing.Timestamp))
                                {
                                    <div class="detail-time">@sqmMonitorData.Wan1.LastPing.Timestamp</div>
                                }
                            </div>
                        }
                        @if (sqmMonitorData.Wan1.BaselineMbps > 0)
                        {
                            <div class="baseline-info">
                                Baseline: @sqmMonitorData.Wan1.BaselineMbps.ToString("F0") Mbps
                            </div>
                        }
                    </div>
                </div>
            }

            @if (sqmMonitorData?.Wan2?.Active == true)
            {
                <div class="wan-status-card">
                    <div class="wan-status-header">
                        <div class="wan-status-title">
                            <span class="wan-status-indicator active"></span>
                            <span class="wan-status-name">@sqmMonitorData.Wan2.Name</span>
                        </div>
                        <span class="wan-status-interface">@sqmMonitorData.Wan2.Interface</span>
                    </div>
                    <div class="wan-status-rate">
                        @if (sqmMonitorData.Wan2.SpeedtestRunning || (isRunningAdjustment && adjustmentWan == sqmMonitorData.Wan2.Name))
                        {
                            <div class="speedtest-running-indicator">
                                <span class="spinner"></span>
                                <span>Speed test running...</span>
                            </div>
                        }
                        else
                        {
                            <span class="rate-value">@sqmMonitorData.Wan2.EffectiveRateMbps.ToString("F0")</span>
                            <span class="rate-unit">Mbps</span>
                        }
                    </div>
                    @if (sqmMonitorData.Wan2.LastSpeedtestFailed)
                    {
                        <div class="speedtest-failed-indicator">
                            <span class="warning-icon">⚠</span>
                            <span>Last speedtest failed - <a href="./sqm#check-logs">check logs</a></span>
                        </div>
                    }
                    <div class="wan-status-details">
                        @if (sqmMonitorData.Wan2.LastSpeedtest != null)
                        {
                            <div class="detail-section">
                                <div class="detail-header">Last Speedtest</div>
                                <div class="detail-row">
                                    <span class="detail-label">Measured</span>
                                    <span class="detail-value">@sqmMonitorData.Wan2.LastSpeedtest.MeasuredMbps.ToString("F0") Mbps</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Adjusted</span>
                                    <span class="detail-value">@sqmMonitorData.Wan2.LastSpeedtest.AdjustedMbps.ToString("F0") Mbps</span>
                                </div>
                                @if (!string.IsNullOrEmpty(sqmMonitorData.Wan2.LastSpeedtest.Timestamp))
                                {
                                    <div class="detail-time">@sqmMonitorData.Wan2.LastSpeedtest.Timestamp</div>
                                }
                            </div>
                        }
                        @if (sqmMonitorData.Wan2.LastPing != null)
                        {
                            <div class="detail-section">
                                <div class="detail-header">Last Ping Adjustment</div>
                                <div class="detail-row">
                                    <span class="detail-label">Latency</span>
                                    <span class="detail-value @(sqmMonitorData.Wan2.LastPing.LatencyMs > 50 ? "text-warning" : "")">@sqmMonitorData.Wan2.LastPing.LatencyMs.ToString("F1") ms</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Rate</span>
                                    <span class="detail-value">@sqmMonitorData.Wan2.LastPing.RateMbps.ToString("F0") Mbps</span>
                                </div>
                                @if (!string.IsNullOrEmpty(sqmMonitorData.Wan2.LastPing.Timestamp))
                                {
                                    <div class="detail-time">@sqmMonitorData.Wan2.LastPing.Timestamp</div>
                                }
                            </div>
                        }
                        @if (sqmMonitorData.Wan2.BaselineMbps > 0)
                        {
                            <div class="baseline-info">
                                Baseline: @sqmMonitorData.Wan2.BaselineMbps.ToString("F0") Mbps
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
            </div>
        </div>
    }

    <!-- Manual SQM Adjustment (show if deployed OR monitor has active WANs) -->
    @if (deploymentStatus?.IsDeployed == true || (sqmMonitorData != null && (sqmMonitorData.Wan1?.Active == true || sqmMonitorData.Wan2?.Active == true)))
    {
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Run SQM Adjustment</h2>
            </div>
            <div class="card-body">
                <p class="info-text">
                    Manually trigger an SQM speedtest adjustment. This runs the same script that executes at 6 AM/6 PM,
                    measuring current speed and adjusting the SQM rate accordingly.
                </p>
                <div class="alert alert-warning" style="margin-bottom: 1rem;">
                    <strong>Warning:</strong> Running a speedtest will temporarily saturate your WAN connection and may interrupt active video calls, gaming, or other real-time activities.
                </div>
                <div class="adjustment-buttons">
                    @if (wan1Config.Enabled && IsWanActiveInMonitor(wan1Config.Name))
                    {
                        <button class="btn btn-primary" @onclick="() => TriggerSqmAdjustment(wan1Config.Name)" disabled="@IsAnySpeedtestRunning">
                            @if (isRunningAdjustment && adjustmentWan == wan1Config.Name)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                                <span>Running...</span>
                            }
                            else
                            {
                                <span>Adjust @wan1Config.Name</span>
                            }
                        </button>
                    }
                    @if (wan2Config.Enabled && IsWanActiveInMonitor(wan2Config.Name))
                    {
                        <button class="btn btn-primary" @onclick="() => TriggerSqmAdjustment(wan2Config.Name)" disabled="@IsAnySpeedtestRunning">
                            @if (isRunningAdjustment && adjustmentWan == wan2Config.Name)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                                <span>Running...</span>
                            }
                            else
                            {
                                <span>Adjust @wan2Config.Name</span>
                            }
                        </button>
                    }
                </div>
                @if (HasFailedSpeedtest && string.IsNullOrEmpty(adjustmentMessage))
                {
                    <div class="alert alert-warning" style="margin-top: 1rem;">
                        <strong>Warning:</strong> One or more WAN connections had a failed speedtest (measured 0 Mbps).
                        This usually indicates the speedtest CLI couldn't connect or timed out.
                        <a href="./sqm#check-logs">Check the logs</a> in the Deployment & Debugging section below for details.
                    </div>
                }
                @if (!string.IsNullOrEmpty(adjustmentMessage))
                {
                    <div class="adjustment-result @(adjustmentSuccess ? "success" : "error")">
                        @adjustmentMessage
                    </div>
                }
            </div>
        </div>
    }

    <!-- Primary WAN Configuration (only show if at least one WAN has Smart Queues enabled) -->
    @if (sqmEligibleWans.Any())
    {
    <div class="card">
        <div class="card-header card-header-collapsible" @onclick="ToggleWan1Section">
            <div class="card-header-left">
                <h2 class="card-title">@(sqmEligibleWans.Count == 1 ? "WAN Configuration" : "Primary WAN Configuration")</h2>
            </div>
            <div class="card-header-right">
                <label class="toggle-label" @onclick:stopPropagation>
                    <input type="checkbox" @bind="wan1Config.Enabled" @bind:after="() => OnEnabledChanged(wan1Config, wan1AvailableInterfaces)" />
                    <span>Enable Adaptive SQM</span>
                </label>
                <span class="issue-type-chevron">@(_wan1Collapsed ? "▼" : "▲")</span>
            </div>
        </div>
        <div class="expand-wrapper @(!_wan1Collapsed ? "expanded" : "")">
            <div class="expand-content">
                <div class="card-body @(!wan1Config.Enabled ? "disabled-section" : "")">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Connection Name</label>
                    <input type="text" class="form-control" @bind="wan1Config.Name" @bind:event="onchange" @bind:after="() => wan1Config.Name = SanitizeWanName(wan1Config.Name)" placeholder="e.g., Yelcot, Comcast" />
                </div>
                <div class="form-group">
                    <label class="form-label">WAN Interface</label>
                    <select class="form-control" @bind="wan1Config.Interface" @bind:after="() => OnInterfaceChanged(wan1Config)">
                        @if (wan1AvailableInterfaces.Any())
                        {
                            @if (string.IsNullOrEmpty(wan1Config.Interface))
                            {
                                <option value="">-- Select Interface --</option>
                            }
                            @foreach (var wan in wan1AvailableInterfaces)
                            {
                                <option value="@wan.Interface">@wan.Interface (@wan.Name)</option>
                            }
                        }
                        else
                        {
                            <option value="@wan1Config.Interface">@wan1Config.Interface</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Connection Type</label>
                    <select class="form-control" @bind="wan1Config.ConnectionType" @bind:after="() => UpdateCalculatedSpeeds(wan1Config)">
                        @foreach (var type in Enum.GetValues<ConnectionType>())
                        {
                            <option value="@type">@ConnectionProfile.GetConnectionTypeName(type)</option>
                        }
                    </select>
                    <small class="form-hint">@ConnectionProfile.GetConnectionTypeDescription(wan1Config.ConnectionType)</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Nominal Download Speed (Mbps)</label>
                    <input type="number" class="form-control" @bind="wan1Config.NominalDownload" @bind:after="() => UpdateCalculatedSpeeds(wan1Config)" min="10" max="10000" />
                    <small class="form-hint">Advertised/paid-for download speed</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Nominal Upload Speed (Mbps)</label>
                    <input type="number" class="form-control" @bind="wan1Config.NominalUpload" min="1" max="10000" />
                    <small class="form-hint">Advertised/paid-for upload speed</small>
                </div>
            </div>

            <!-- Calculated Parameters (read-only preview) -->
            <div class="calculated-params">
                <h4>Calculated SQM Parameters</h4>
                <div class="params-grid">
                    <div class="param">
                        <span class="param-label">Speed Range</span>
                        <span class="param-value">@wan1Config.MinSpeed–@wan1Config.MaxSpeed</span>
                        <span class="param-unit">Mbps</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Absolute Max</span>
                        <span class="param-value">@wan1Config.AbsoluteMax</span>
                        <span class="param-unit">Mbps</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Speed Margin <span class="tooltip-icon" data-tooltip="How aggressively SQM must shape traffic to eliminate bufferbloat. Lower = more aggressive shaping needed.">?</span></span>
                        <span class="param-value">@(((wan1Config.Overhead - 1) * 100).ToString("F0"))%</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Baseline Latency</span>
                        <span class="param-value">@wan1Config.BaselineLatency</span>
                        <span class="param-unit">ms</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Latency Threshold</span>
                        <span class="param-value">@wan1Config.LatencyThreshold</span>
                        <span class="param-unit">ms</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ping Target Host</label>
                <input type="text" class="form-control" @bind="wan1Config.PingHost" placeholder="1.1.1.1" />
                <small class="form-hint">ISP infrastructure IP (first or second hop that responds to pings), or a near Internet host like Google or Cloudflare</small>
            </div>

            <div class="form-group">
                <label class="form-label">Speedtest Server ID</label>
                <input type="text" class="form-control" @bind="wan1Config.SpeedtestServerId" placeholder="@(wan1Config.ConnectionType == ConnectionType.Starlink ? "59762 (default)" : "Auto-select")" />
                <small class="form-hint">Optional Ookla server ID override</small>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Morning Speedtest</label>
                    <div class="time-input">
                        <input type="text" inputmode="numeric" pattern="[0-9]*" class="form-control time-hour"
                               value="@wan1Config.MorningHour.ToString("D2")"
                               @onchange="@(e => wan1Config.MorningHour = ParseTimeValue(e.Value?.ToString(), 0, 23))" />
                        <span class="time-separator">:</span>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" class="form-control time-minute"
                               value="@wan1Config.MorningMinute.ToString("D2")"
                               @onchange="@(e => wan1Config.MorningMinute = ParseTimeValue(e.Value?.ToString(), 0, 59))" />
                    </div>
                    <small class="form-hint">Daily speedtest time (24h format)</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Evening Speedtest</label>
                    <div class="time-input">
                        <input type="text" inputmode="numeric" pattern="[0-9]*" class="form-control time-hour"
                               value="@wan1Config.EveningHour.ToString("D2")"
                               @onchange="@(e => wan1Config.EveningHour = ParseTimeValue(e.Value?.ToString(), 0, 23))" />
                        <span class="time-separator">:</span>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" class="form-control time-minute"
                               value="@wan1Config.EveningMinute.ToString("D2")"
                               @onchange="@(e => wan1Config.EveningMinute = ParseTimeValue(e.Value?.ToString(), 0, 59))" />
                    </div>
                    <small class="form-hint">Daily speedtest time (24h format)</small>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Secondary WAN Configuration (only show if 2+ WANs have Smart Queues enabled) -->
    @if (sqmEligibleWans.Count >= 2)
    {
    <div class="card">
        <div class="card-header card-header-collapsible" @onclick="ToggleWan2Section">
            <div class="card-header-left">
                <h2 class="card-title">Secondary WAN Configuration</h2>
            </div>
            <div class="card-header-right">
                <label class="toggle-label" @onclick:stopPropagation>
                    <input type="checkbox" @bind="wan2Config.Enabled" @bind:after="() => OnEnabledChanged(wan2Config, wan2AvailableInterfaces)" />
                    <span>Enable Adaptive SQM</span>
                </label>
                <span class="issue-type-chevron">@(_wan2Collapsed ? "▼" : "▲")</span>
            </div>
        </div>
        <div class="expand-wrapper @(!_wan2Collapsed ? "expanded" : "")">
            <div class="expand-content">
                <div class="card-body @(!wan2Config.Enabled ? "disabled-section" : "")">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Connection Name</label>
                    <input type="text" class="form-control" @bind="wan2Config.Name" @bind:event="onchange" @bind:after="() => wan2Config.Name = SanitizeWanName(wan2Config.Name)" placeholder="e.g., Starlink" />
                </div>
                <div class="form-group">
                    <label class="form-label">WAN Interface</label>
                    <select class="form-control" @bind="wan2Config.Interface" @bind:after="() => OnInterfaceChanged(wan2Config)">
                        @if (wan2AvailableInterfaces.Any())
                        {
                            @if (string.IsNullOrEmpty(wan2Config.Interface))
                            {
                                <option value="">-- Select Interface --</option>
                            }
                            @foreach (var wan in wan2AvailableInterfaces)
                            {
                                <option value="@wan.Interface">@wan.Interface (@wan.Name)</option>
                            }
                        }
                        else
                        {
                            <option value="@wan2Config.Interface">@wan2Config.Interface</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Connection Type</label>
                    <select class="form-control" @bind="wan2Config.ConnectionType" @bind:after="() => UpdateCalculatedSpeeds(wan2Config)">
                        @foreach (var type in Enum.GetValues<ConnectionType>())
                        {
                            <option value="@type">@ConnectionProfile.GetConnectionTypeName(type)</option>
                        }
                    </select>
                    <small class="form-hint">@ConnectionProfile.GetConnectionTypeDescription(wan2Config.ConnectionType)</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Nominal Download Speed (Mbps)</label>
                    <input type="number" class="form-control" @bind="wan2Config.NominalDownload" @bind:after="() => UpdateCalculatedSpeeds(wan2Config)" min="10" max="10000" />
                </div>
                <div class="form-group">
                    <label class="form-label">Nominal Upload Speed (Mbps)</label>
                    <input type="number" class="form-control" @bind="wan2Config.NominalUpload" min="1" max="10000" />
                </div>
            </div>

            <!-- Calculated Parameters -->
            <div class="calculated-params">
                <h4>Calculated SQM Parameters</h4>
                <div class="params-grid">
                    <div class="param">
                        <span class="param-label">Speed Range</span>
                        <span class="param-value">@wan2Config.MinSpeed–@wan2Config.MaxSpeed</span>
                        <span class="param-unit">Mbps</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Absolute Max</span>
                        <span class="param-value">@wan2Config.AbsoluteMax</span>
                        <span class="param-unit">Mbps</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Speed Margin <span class="tooltip-icon" data-tooltip="How aggressively SQM must shape traffic to eliminate bufferbloat. Lower = more aggressive shaping needed.">?</span></span>
                        <span class="param-value">@(((wan2Config.Overhead - 1) * 100).ToString("F0"))%</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Baseline Latency</span>
                        <span class="param-value">@wan2Config.BaselineLatency</span>
                        <span class="param-unit">ms</span>
                    </div>
                    <div class="param">
                        <span class="param-label">Latency Threshold</span>
                        <span class="param-value">@wan2Config.LatencyThreshold</span>
                        <span class="param-unit">ms</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ping Target Host</label>
                <input type="text" class="form-control" @bind="wan2Config.PingHost" placeholder="100.64.0.1" />
                <small class="form-hint">ISP infrastructure IP (first or second hop that responds to pings), or a near Internet host like Google or Cloudflare</small>
            </div>

            <div class="form-group">
                <label class="form-label">Speedtest Server ID</label>
                <input type="text" class="form-control" @bind="wan2Config.SpeedtestServerId" placeholder="@(wan2Config.ConnectionType == ConnectionType.Starlink ? "59762 (default)" : "Auto-select")" />
                <small class="form-hint">Optional Ookla server ID override</small>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Morning Speedtest</label>
                    <div class="time-input">
                        <input type="text" inputmode="numeric" pattern="[0-9]*" class="form-control time-hour"
                               value="@wan2Config.MorningHour.ToString("D2")"
                               @onchange="@(e => wan2Config.MorningHour = ParseTimeValue(e.Value?.ToString(), 0, 23))" />
                        <span class="time-separator">:</span>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" class="form-control time-minute"
                               value="@wan2Config.MorningMinute.ToString("D2")"
                               @onchange="@(e => wan2Config.MorningMinute = ParseTimeValue(e.Value?.ToString(), 0, 59))" />
                    </div>
                    <small class="form-hint">Staggered from WAN1 to avoid conflicts</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Evening Speedtest</label>
                    <div class="time-input">
                        <input type="text" inputmode="numeric" pattern="[0-9]*" class="form-control time-hour"
                               value="@wan2Config.EveningHour.ToString("D2")"
                               @onchange="@(e => wan2Config.EveningHour = ParseTimeValue(e.Value?.ToString(), 0, 23))" />
                        <span class="time-separator">:</span>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" class="form-control time-minute"
                               value="@wan2Config.EveningMinute.ToString("D2")"
                               @onchange="@(e => wan2Config.EveningMinute = ParseTimeValue(e.Value?.ToString(), 0, 59))" />
                    </div>
                    <small class="form-hint">Staggered from WAN1 to avoid conflicts</small>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Deployment Actions (show if WANs available OR scripts are deployed but need cleanup) -->
    @if (sqmEligibleWans.Any() || deploymentStatus?.IsDeployed == true)
    {
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Deployment & Debugging</h2>
        </div>
        <div class="card-body">
            @if (!sqmEligibleWans.Any() && deploymentStatus?.IsDeployed == true)
            {
                <!-- Orphaned scripts - Smart Queues disabled but scripts still deployed -->
                <div class="alert alert-warning" style="margin-bottom: 1rem;">
                    <strong>Orphaned SQM Scripts Detected:</strong> Adaptive SQM scripts are deployed, but no WAN connections have Smart Queues enabled in UniFi.
                    The scripts and scheduled tasks will not function correctly. You should either re-enable Smart Queues in UniFi, or remove the deployed scripts.
                </div>
                <div class="action-buttons">
                    <button class="btn btn-danger" @onclick="RemoveSqm" disabled="@isDeploying">
                        @if (isDeploying)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                            <span>Removing...</span>
                        }
                        else
                        {
                            <span>Remove Adaptive SQM</span>
                        }
                    </button>
                </div>
            }
            else
            {
                @if (deploymentStatus?.IsDeployed != true)
                {
                    <p class="info-text">
                        Adaptive SQM uses a dual-mode approach: <strong>Speedtest-based</strong> adjustments run 2x daily
                        at configured times, while <strong>Ping-based</strong> adjustments run every 5 minutes
                        for real-time latency optimization.
                    </p>

                    <div class="alert alert-warning" style="margin: 1rem 0 1.5rem;">
                        <strong>Disclaimer:</strong> Using Adaptive SQM may affect your ability to receive tech support from Ubiquiti. If tech support ever needs a support file, you may be required to factory reset and restore from a backup. We've tested this on several device combinations, but deploy at your own risk. If you encounter errors or unexpected behavior, use Remove Adaptive SQM to ensure normal gateway performance.
                    </div>

                    <div class="alert alert-warning" style="margin: 0 0 1.5rem;">
                        <strong>Ookla Speedtest:</strong> For home/personal use only. By deploying, you accept Ookla's
                        <a href="https://www.speedtest.net/about/eula" target="_blank" rel="noopener noreferrer">EULA</a>,
                        <a href="https://www.speedtest.net/about/terms" target="_blank" rel="noopener noreferrer">Terms</a>, and
                        <a href="https://www.speedtest.net/about/privacy" target="_blank" rel="noopener noreferrer">Privacy Policy</a>.
                        EU users: see <a href="https://www.speedtest.net/gdpr-dpa" target="_blank" rel="noopener noreferrer">GDPR DPA</a>.
                    </div>
                }

                <div class="action-buttons">
                    <button class="btn btn-primary" @onclick="DeploySqm" disabled="@isDeploying">
                        @if (isDeploying)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                            <span>Deploying...</span>
                        }
                        else
                        {
                            <span>@(deploymentStatus?.IsDeployed == true ? "Deploy Settings" : "Deploy SQM Scripts")</span>
                        }
                    </button>
                    <span title="@(deploymentStatus?.IsDeployed != true ? "Deploy SQM scripts first" : "")">
                        <button class="btn btn-secondary" @onclick="DeployTcMonitor" disabled="@(isDeploying || deploymentStatus?.IsDeployed != true)">
                            Deploy SQM Monitor Only
                        </button>
                    </span>
                    <button class="btn btn-danger" @onclick="RemoveSqm" disabled="@(isDeploying || deploymentStatus?.IsDeployed != true)">
                        Remove Adaptive SQM
                    </button>
                </div>

            }

            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="alert @(statusSuccess ? "alert-success" : "alert-danger")" style="margin-top: 1rem;">@statusMessage</div>
            }

            @if (deploymentSteps.Any())
            {
                <div class="deployment-log" style="margin-top: 1rem;">
                    <h4>Deployment Progress</h4>
                    <ul class="step-list" id="deployment-step-list">
                        @foreach (var step in deploymentSteps)
                        {
                            <li>@step</li>
                        }
                    </ul>
                </div>
            }

            @if (deploymentStatus?.IsDeployed == true)
            {
                <div class="check-logs-section" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);" id="check-logs">
                    <h4 style="margin-bottom: 0.75rem;">Check SQM Logs</h4>
                    <div class="action-buttons">
                        @if (wan1Config.Enabled && !string.IsNullOrEmpty(wan1Config.Name))
                        {
                            <button class="btn btn-secondary" @onclick="() => CheckWanLogs(wan1Config.Name)" disabled="@isCheckingLogs">
                                @if (isCheckingLogs && checkingLogsWan == wan1Config.Name)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                    <span>Loading...</span>
                                }
                                else
                                {
                                    <span>Check @wan1Config.Name Logs</span>
                                }
                            </button>
                        }
                        @if (wan2Config.Enabled && !string.IsNullOrEmpty(wan2Config.Name))
                        {
                            <button class="btn btn-secondary" @onclick="() => CheckWanLogs(wan2Config.Name)" disabled="@isCheckingLogs">
                                @if (isCheckingLogs && checkingLogsWan == wan2Config.Name)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                    <span>Loading...</span>
                                }
                                else
                                {
                                    <span>Check @wan2Config.Name Logs</span>
                                }
                            </button>
                        }
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(wanLogOutput))
            {
                <div class="deployment-log" style="margin-top: 1rem;">
                    <h4>@wanLogTitle</h4>
                    <pre class="log-output">@wanLogOutput</pre>
                </div>
            }
        </div>
    </div>
    }

</div>

<style>
    .card-header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .sqm-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .form-hint {
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin-top: 0.25rem;
        display: block;
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .disabled-section {
        opacity: 0.5;
        pointer-events: none;
    }

    .calculated-params {
        background: var(--surface-secondary);
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 1rem 0;
    }

    .calculated-params h4 {
        margin: 0 0 0.75rem 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .params-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
    }

    @@media (max-width: 900px) {
        .params-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @@media (max-width: 600px) {
        .params-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .param {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        padding: 0.5rem;
        background: var(--surface);
        border-radius: 0.375rem;
        text-align: center;
    }

    .param-label {
        color: var(--text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .param-value {
        font-weight: 600;
        font-family: var(--font-mono);
        font-size: 1.1rem;
        color: var(--text-primary);
    }

    .param-unit {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .sqm-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .metric {
        text-align: center;
        padding: 1.25rem;
        background: var(--surface-secondary);
        border-radius: 0.5rem;
    }

    .metric-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }

    .metric-value {
        font-size: 1rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-active {
        background: var(--success);
    }

    .status-inactive {
        background: var(--danger);
    }

    .tc-rates-panel h4 {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .tc-rates {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .tc-rate-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--surface-secondary);
        border-radius: 0.5rem;
    }

    .tc-name {
        font-weight: 500;
    }

    .tc-interface {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .tc-rate {
        font-family: var(--font-mono);
        color: var(--primary);
    }

    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .info-text {
        color: var(--text-secondary);
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .deployment-log {
        background: var(--surface-secondary);
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .deployment-log h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
    }

    .step-list {
        margin: 0;
        padding-left: 1.5rem;
        font-family: var(--font-mono);
        font-size: 0.85rem;
    }

    .step-list li {
        margin: 0.25rem 0;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .loading-status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        padding: 2rem;
        color: var(--text-secondary);
    }

    /* SQM Live Dashboard */
    .sqm-live-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, calc(50% - 0.75rem)));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .wan-status-card {
        background: linear-gradient(315deg, var(--surface) 0%, var(--surface-secondary) 100%);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .wan-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .wan-status-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .wan-status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--text-secondary);
    }

    .wan-status-indicator.active {
        background: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    }

    .wan-status-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .wan-status-interface {
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-family: var(--font-mono);
    }

    .wan-status-rate {
        text-align: center;
        padding: 1.5rem 0;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }

    .rate-value {
        font-size: 3rem;
        font-weight: 700;
        font-family: var(--font-mono);
        color: var(--primary);
        line-height: 1;
    }

    .rate-unit {
        display: block;
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .speedtest-running-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--warning-color, #f59e0b);
        font-size: 1rem;
        padding: 0.3rem 0;
    }

    .speedtest-running-indicator .spinner {
        width: 2rem;
        height: 2rem;
        border: 3px solid rgba(245, 158, 11, 0.3);
        border-top-color: var(--warning-color, #f59e0b);
        margin-bottom: 0.5rem;
    }

    .speedtest-failed-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        color: var(--danger-color, #ef4444);
        font-size: 0.875rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 0.375rem;
    }

    .speedtest-failed-indicator .warning-icon {
        font-size: 1rem;
    }

    .speedtest-failed-indicator a {
        color: var(--danger-color, #ef4444);
        text-decoration: underline;
    }

    .log-output {
        background: var(--surface-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: var(--font-mono);
        font-size: 0.8rem;
        line-height: 1.5;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
    }

    .wan-status-details {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .detail-section {
        background: var(--surface-secondary);
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
    }

    .detail-header {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.25rem 0;
    }

    .detail-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .detail-value {
        font-family: var(--font-mono);
        font-weight: 500;
        color: var(--text-primary);
    }

    .detail-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
        font-family: var(--font-mono);
    }

    .baseline-info {
        text-align: center;
        font-size: 0.85rem;
        color: var(--text-secondary);
        padding-top: 0.5rem;
    }

    .text-warning {
        color: #f59e0b;
    }

    .text-muted {
        color: var(--text-secondary);
        font-style: italic;
    }

    .adjustment-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .adjustment-buttons .btn {
        min-width: 150px;
    }

    @@media (max-width: 768px) {
        .adjustment-buttons {
            justify-content: center;
        }

        .metric {
            padding: 0.75rem;
        }

        .sqm-live-dashboard {
            grid-template-columns: 1fr;
            gap: 1rem;
            justify-items: center;
        }

        .wan-status-card {
            padding: 1rem;
            max-width: 400px;
            width: 100%;
        }

        .wan-status-rate {
            padding: 0.75rem 0;
            margin-bottom: 0.75rem;
        }

        .rate-value {
            font-size: 2.25rem;
        }

        .wan-status-details {
            gap: 0.5rem;
        }

        .detail-section {
            padding: 0.5rem 0.75rem;
        }

        .detail-header {
            margin-bottom: 0.25rem;
        }

        .detail-time {
            text-align: center;
        }

        .card-header-right {
            margin-left: 0;
        }

        .card-header .issue-type-chevron {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
        }
    }

    .adjustment-result {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.9rem;
    }

    .adjustment-result.success {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .adjustment-result.error {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Time input styling */
    .time-input {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .time-input .time-hour,
    .time-input .time-minute {
        width: 50px;
        text-align: center;
        font-family: var(--font-mono);
    }

    .time-input .time-separator {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-secondary);
    }
</style>

@code {
    // Cache settings
    private static readonly TimeSpan CacheDuration = TimeSpan.FromMinutes(5);
    private static DateTime _lastStatusCheck = DateTime.MinValue;
    private static SqmDeploymentStatus? _cachedDeploymentStatus;
    private static List<TcInterfaceStats>? _cachedTcInterfaces;
    private static List<WanInterfaceInfo>? _cachedWanInterfaces;
    private static bool _cachedGatewayConnected;
    private static bool _cachedGatewayConfigured;
    private static bool _refreshNeeded = false;  // Flag to trigger refresh on next page load

    // State
    private bool isLoading = true;
    private bool isDeploying = false;
    private bool isInstallingUdmBoot = false;
    private bool gatewayConnected = false;
    private bool gatewayConfigured = false;
    private string? statusMessage;
    private bool statusSuccess = false;

    // SQM Adjustment state
    private bool isRunningAdjustment = false;
    private string? adjustmentWan;
    private string? adjustmentMessage;
    private bool adjustmentSuccess = false;

    // True if any speedtest is running (UI-initiated, external, deploying, or post-deploy window)
    private bool IsAnySpeedtestRunning =>
        isDeploying ||
        isRunningAdjustment ||
        sqmMonitorData?.Wan1?.SpeedtestRunning == true ||
        sqmMonitorData?.Wan2?.SpeedtestRunning == true ||
        (_fastPollingUntil != null && DateTime.UtcNow < _fastPollingUntil);

    // True if any WAN has a failed speedtest (measured 0 Mbps)
    private bool HasFailedSpeedtest =>
        sqmMonitorData?.Wan1?.LastSpeedtestFailed == true ||
        sqmMonitorData?.Wan2?.LastSpeedtestFailed == true;

    // Log checking state
    private bool isCheckingLogs = false;
    private string? checkingLogsWan;
    private string? wanLogOutput;
    private string? wanLogTitle;

    // Deployment status
    private SqmDeploymentStatus? deploymentStatus;
    private List<string> deploymentSteps = new();
    private List<string> deploymentWarnings = new();
    private List<TcInterfaceStats>? tcInterfaces;

    // WAN interfaces from controller
    private List<WanInterfaceInfo> wanInterfaces = new();

    // WANs with Smart Queues enabled (eligible for Adaptive SQM)
    private List<WanInterfaceInfo> sqmEligibleWans => wanInterfaces.Where(w => w.SmartqEnabled).ToList();

    // Filtered interface lists - exclude interfaces already selected by other WAN
    private List<WanInterfaceInfo> wan1AvailableInterfaces => sqmEligibleWans
        .Where(w => string.IsNullOrEmpty(wan2Config.Interface) ||
                    !w.Interface.Equals(wan2Config.Interface, StringComparison.OrdinalIgnoreCase))
        .ToList();

    private List<WanInterfaceInfo> wan2AvailableInterfaces => sqmEligibleWans
        .Where(w => string.IsNullOrEmpty(wan1Config.Interface) ||
                    !w.Interface.Equals(wan1Config.Interface, StringComparison.OrdinalIgnoreCase))
        .ToList();

    // WAN configurations (defaults overwritten by ApplyDetectedWanInterfaces)
    private WanConfigModel wan1Config = new()
    {
        Enabled = false,  // Start disabled - user must select interface and enable
        Name = "WAN1",
        Interface = "",
        ConnectionType = ConnectionType.DocsisCable,
        NominalDownload = 0,
        NominalUpload = 0,
        PingHost = "1.1.1.1"
    };

    private WanConfigModel wan2Config = new()
    {
        Enabled = false,
        Name = "WAN2",
        Interface = "",
        ConnectionType = ConnectionType.DocsisCable,
        NominalDownload = 0,
        NominalUpload = 0,
        PingHost = "1.1.1.1",
        // Staggered schedule: 1 hour earlier than WAN1 to avoid simultaneous speedtests
        MorningHour = 5,
        MorningMinute = 0,
        EveningHour = 18,
        EveningMinute = 0
    };

    // Snapshots of deployed config (for change detection)
    private WanConfigSnapshot? _deployedWan1Snapshot;
    private WanConfigSnapshot? _deployedWan2Snapshot;

    // SQM Monitor data (from HTTP endpoint)
    private TcMonitorResponse? sqmMonitorData;
    private bool isRefreshingDashboard = false;

    // Collapse state for WAN config panels (collapsed when config exists, expanded when needs setup)
    private bool _wan1Collapsed = false;
    private bool _wan2Collapsed = false;

    private void ToggleWan1Section() => _wan1Collapsed = !_wan1Collapsed;
    private void ToggleWan2Section() => _wan2Collapsed = !_wan2Collapsed;

    // Auto-refresh timer (1 minute interval)
    private System.Threading.Timer? _refreshTimer;

    protected override void OnInitialized()
    {
        UpdateCalculatedSpeeds(wan1Config);
        UpdateCalculatedSpeeds(wan2Config);

        // Subscribe to connection changes (handles reconnection after server restart)
        ConnectionService.OnConnectionChanged += OnConnectionChanged;

        // Check cache synchronously BEFORE first render to avoid loading flash
        if (IsCacheValid())
        {
            gatewayConnected = _cachedGatewayConnected;
            gatewayConfigured = _cachedGatewayConfigured;
            deploymentStatus = _cachedDeploymentStatus;
            tcInterfaces = _cachedTcInterfaces;
            wanInterfaces = _cachedWanInterfaces ?? new();
            isLoading = false;  // Prevents "Checking deployment status..." flash
        }
    }

    private async void OnConnectionChanged()
    {
        // Connection changed (reconnect after server restart, etc.) - refresh all data
        await LoadSavedConfigsAsync();
        await RefreshStatus(forceRefresh: true);
        await LoadSqmMonitorDataAsync();
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load saved WAN configs from database
            await LoadSavedConfigsAsync();
            StateHasChanged();

            // Check if a refresh was in progress when user navigated away
            if (_refreshNeeded)
            {
                // Previous refresh didn't complete - do a fresh fetch
                var dashboardTask = LoadSqmMonitorDataAsync();
                _ = RefreshStatus(forceRefresh: true);
                await dashboardTask;
                StateHasChanged();
            }
            // If cache was valid in OnInitialized, just load dashboard data
            else if (!isLoading)
            {
                // Cache was used - just load SQM Monitor data
                if (deploymentStatus?.IsDeployed == true)
                {
                    await LoadSqmMonitorDataAsync();
                    StateHasChanged();
                }
            }
            else
            {
                // Cache was not valid - load everything fresh
                var dashboardTask = LoadSqmMonitorDataAsync();
                _ = RefreshStatus(forceRefresh: false);
                await dashboardTask;
                StateHasChanged();
            }

            // Start auto-refresh timer (adjusts interval based on speedtest status)
            _refreshTimer = new System.Threading.Timer(
                async _ => await InvokeAsync(async () =>
                {
                    if (!isRefreshingDashboard)
                    {
                        await LoadSqmMonitorDataAsync(); // Also adjusts polling interval
                        StateHasChanged();
                    }
                }),
                null,
                TimeSpan.FromSeconds(60),
                TimeSpan.FromSeconds(60));

            // Check if speedtest was already running when page loaded - switch to fast polling immediately
            // (LoadSqmMonitorDataAsync ran before timer existed, so its AdjustRefreshInterval was a no-op)
            AdjustRefreshInterval();
        }
    }

    // Polling interval constants
    private static readonly TimeSpan NormalPollingInterval = TimeSpan.FromSeconds(60);
    private static readonly TimeSpan FastPollingInterval = TimeSpan.FromSeconds(5);
    private static readonly TimeSpan InitialPollDelay = TimeSpan.FromSeconds(3);
    private static readonly TimeSpan PostDeploySingleWanFastPolling = TimeSpan.FromSeconds(20);
    private static readonly TimeSpan PostDeployDualWanFastPolling = TimeSpan.FromSeconds(65);
    private bool _isFastPolling = false;
    private DateTime? _fastPollingUntil = null;

    private void AdjustRefreshInterval(bool useInitialDelay = false)
    {
        if (_refreshTimer == null) return;

        // Fast poll if: speedtest running, UI-initiated adjustment, or within post-deploy window
        var shouldFastPoll = sqmMonitorData?.Wan1?.SpeedtestRunning == true ||
                             sqmMonitorData?.Wan2?.SpeedtestRunning == true ||
                             isRunningAdjustment ||
                             (_fastPollingUntil != null && DateTime.UtcNow < _fastPollingUntil);

        if (shouldFastPoll && !_isFastPolling)
        {
            // Switch to fast polling (with optional initial delay for button-initiated tests)
            var dueTime = useInitialDelay ? InitialPollDelay : FastPollingInterval;
            _refreshTimer.Change(dueTime, FastPollingInterval);
            _isFastPolling = true;
        }
        else if (!shouldFastPoll && _isFastPolling)
        {
            // Switch back to normal polling
            _refreshTimer.Change(NormalPollingInterval, NormalPollingInterval);
            _isFastPolling = false;
            _fastPollingUntil = null; // Clear the post-deploy window
        }
    }

    // Check if current config differs from last deployed state
    private bool HasUndeployedChanges =>
        wan1Config.DiffersFrom(_deployedWan1Snapshot) ||
        wan2Config.DiffersFrom(_deployedWan2Snapshot);

    // Capture snapshots after successful deployment
    private void CaptureDeployedSnapshots()
    {
        _deployedWan1Snapshot = wan1Config.ToSnapshot();
        _deployedWan2Snapshot = wan2Config.ToSnapshot();
    }

    // Handle navigation away with unsaved changes
    private async Task OnBeforeInternalNavigation(LocationChangingContext context)
    {
        if (HasUndeployedChanges)
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm",
                "You have undeployed WAN settings changes. If you leave now, your changes will be lost.\n\nAre you sure you want to leave?");
            if (!confirmed)
            {
                context.PreventNavigation();
            }
        }
    }

    // Track which WANs have saved configurations
    private bool wan1HasSavedConfig = false;
    private bool wan2HasSavedConfig = false;
    // Derived property - true if any WAN has saved config
    private bool hasSavedConfigs => wan1HasSavedConfig || wan2HasSavedConfig;

    // Helper to check if a WAN name is active in monitor data (matches by name, not slot position)
    private bool IsWanActiveInMonitor(string wanName)
    {
        if (sqmMonitorData == null || string.IsNullOrEmpty(wanName))
            return false;

        // Check if name matches either Wan1 or Wan2 in monitor data
        if (sqmMonitorData.Wan1?.Active == true &&
            string.Equals(sqmMonitorData.Wan1.Name, wanName, StringComparison.OrdinalIgnoreCase))
            return true;

        if (sqmMonitorData.Wan2?.Active == true &&
            string.Equals(sqmMonitorData.Wan2.Name, wanName, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    }

    private async Task LoadSavedConfigsAsync()
    {
        try
        {
            var savedConfigs = await SpeedTestRepository.GetAllSqmWanConfigsAsync();
            if (savedConfigs.Count > 0)
            {
                // Get available interfaces (if wanInterfaces is populated from cache)
                var availableInterfaces = sqmEligibleWans
                    .Select(w => w.Interface)
                    .ToHashSet(StringComparer.OrdinalIgnoreCase);

                // Track interfaces already loaded to prevent duplicates (stale DB data protection)
                var loadedInterfaces = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

                foreach (var saved in savedConfigs)
                {
                    // Skip loading config if interface is no longer available
                    if (availableInterfaces.Count > 0 &&
                        !string.IsNullOrEmpty(saved.Interface) &&
                        !availableInterfaces.Contains(saved.Interface))
                    {
                        continue;
                    }

                    // Skip loading config if interface already loaded (duplicate protection)
                    if (!string.IsNullOrEmpty(saved.Interface) && loadedInterfaces.Contains(saved.Interface))
                    {
                        continue;
                    }

                    // Mark this WAN as having a saved config
                    if (saved.WanNumber == 1)
                        wan1HasSavedConfig = true;
                    else
                        wan2HasSavedConfig = true;

                    var config = saved.WanNumber == 1 ? wan1Config : wan2Config;
                    config.Enabled = saved.Enabled;
                    config.ConnectionType = (ConnectionType)saved.ConnectionType;
                    config.Name = saved.Name;
                    config.Interface = saved.Interface;
                    config.NominalDownload = saved.NominalDownloadMbps;
                    config.NominalUpload = saved.NominalUploadMbps;
                    config.PingHost = saved.PingHost;
                    config.SpeedtestServerId = saved.SpeedtestServerId;
                    config.MorningHour = saved.SpeedtestMorningHour;
                    config.MorningMinute = saved.SpeedtestMorningMinute;
                    config.EveningHour = saved.SpeedtestEveningHour;
                    config.EveningMinute = saved.SpeedtestEveningMinute;
                    UpdateCalculatedSpeeds(config);

                    // Track this interface as loaded
                    if (!string.IsNullOrEmpty(saved.Interface))
                        loadedInterfaces.Add(saved.Interface);
                }
            }

            // Set initial collapsed state: collapsed if config exists, expanded if needs setup
            _wan1Collapsed = wan1HasSavedConfig;
            _wan2Collapsed = wan2HasSavedConfig;

            // Capture loaded state as deployed snapshot (saved configs = deployed state)
            if (wan1HasSavedConfig || wan2HasSavedConfig)
            {
                CaptureDeployedSnapshots();
            }
        }
        catch
        {
            // If loading fails, continue with defaults
        }
    }

    private async Task SaveWanConfigsAsync()
    {
        try
        {
            // Save WAN1 config if it has an interface configured (preserves settings when disabled)
            if (!string.IsNullOrEmpty(wan1Config.Interface))
            {
                var wan1Saved = new SqmWanConfiguration
                {
                    WanNumber = 1,
                    Enabled = wan1Config.Enabled,
                    ConnectionType = (int)wan1Config.ConnectionType,
                    Name = wan1Config.Name,
                    Interface = wan1Config.Interface,
                    NominalDownloadMbps = wan1Config.NominalDownload,
                    NominalUploadMbps = wan1Config.NominalUpload,
                    PingHost = wan1Config.PingHost,
                    SpeedtestServerId = wan1Config.SpeedtestServerId,
                    SpeedtestMorningHour = wan1Config.MorningHour,
                    SpeedtestMorningMinute = wan1Config.MorningMinute,
                    SpeedtestEveningHour = wan1Config.EveningHour,
                    SpeedtestEveningMinute = wan1Config.EveningMinute
                };
                await SpeedTestRepository.SaveSqmWanConfigAsync(wan1Saved);
                wan1HasSavedConfig = true;
            }

            // Save WAN2 config if it has an interface configured (preserves settings when disabled)
            if (!string.IsNullOrEmpty(wan2Config.Interface))
            {
                var wan2Saved = new SqmWanConfiguration
                {
                    WanNumber = 2,
                    Enabled = wan2Config.Enabled,
                    ConnectionType = (int)wan2Config.ConnectionType,
                    Name = wan2Config.Name,
                    Interface = wan2Config.Interface,
                    NominalDownloadMbps = wan2Config.NominalDownload,
                    NominalUploadMbps = wan2Config.NominalUpload,
                    PingHost = wan2Config.PingHost,
                    SpeedtestServerId = wan2Config.SpeedtestServerId,
                    SpeedtestMorningHour = wan2Config.MorningHour,
                    SpeedtestMorningMinute = wan2Config.MorningMinute,
                    SpeedtestEveningHour = wan2Config.EveningHour,
                    SpeedtestEveningMinute = wan2Config.EveningMinute
                };
                await SpeedTestRepository.SaveSqmWanConfigAsync(wan2Saved);
                wan2HasSavedConfig = true;
            }
        }
        catch
        {
            // If saving fails, continue with deployment
        }
    }

    private static bool IsCacheValid()
    {
        return _cachedDeploymentStatus != null &&
               DateTime.UtcNow - _lastStatusCheck < CacheDuration;
    }

    private static void InvalidateCache()
    {
        _lastStatusCheck = DateTime.MinValue;
    }

    private void ApplyDetectedWanInterfaces()
    {
        if (wanInterfaces.Count == 0)
            return;

        // Track interfaces already used by saved configs to avoid duplicates
        var usedInterfaces = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        if (wan1HasSavedConfig && !string.IsNullOrEmpty(wan1Config.Interface))
            usedInterfaces.Add(wan1Config.Interface);
        if (wan2HasSavedConfig && !string.IsNullOrEmpty(wan2Config.Interface))
            usedInterfaces.Add(wan2Config.Interface);

        // Get available WANs not already used by saved configs
        var availableWans = sqmEligibleWans.Where(w => !usedInterfaces.Contains(w.Interface)).ToList();

        // Apply first available WAN to wan1Config (only if no saved config for WAN1)
        if (!wan1HasSavedConfig)
        {
            if (availableWans.Count == 1)
            {
                // Only one WAN available - pre-populate interface, ping host, and connection defaults
                // but don't auto-enable. User must consciously enable SQM via checkbox.
                wan1Config.Name = availableWans[0].Name;
                wan1Config.Interface = availableWans[0].Interface;
                wan1Config.Enabled = false;
                if (!string.IsNullOrEmpty(availableWans[0].SuggestedPingIp))
                    wan1Config.PingHost = availableWans[0].SuggestedPingIp!;
                ApplyConnectionDefaults(wan1Config, availableWans[0].Name);
                usedInterfaces.Add(availableWans[0].Interface);
                availableWans.RemoveAt(0);
            }
            else if (availableWans.Count > 1)
            {
                // Multiple WANs - don't auto-select, let user choose
                wan1Config.Enabled = false;
                wan1Config.Interface = "";
            }
            else
            {
                wan1Config.Enabled = false;
            }
        }

        // Apply next available WAN to wan2Config (only if no saved config for WAN2)
        if (!wan2HasSavedConfig)
        {
            // WAN2 never auto-selects - user chooses if they want dual-WAN
            wan2Config.Enabled = false;
            wan2Config.Interface = "";
        }
    }

    private void ApplyWanInterfaceToConfig(WanInterfaceInfo wan, WanConfigModel config)
    {
        config.Name = wan.Name;
        config.Interface = wan.Interface;
        config.Enabled = true;

        // Note: PingHost is NOT auto-set here - it's set via OnInterfaceChanged when user selects

        // Apply connection-specific defaults (Starlink, etc.)
        ApplyConnectionDefaults(config, wan.Name);
    }

    private void UpdateCalculatedSpeeds(WanConfigModel config)
    {
        var profile = new ConnectionProfile
        {
            Type = config.ConnectionType,
            NominalDownloadMbps = config.NominalDownload,
            NominalUploadMbps = config.NominalUpload
        };

        config.MaxSpeed = profile.MaxDownloadMbps;
        config.MinSpeed = profile.MinDownloadMbps;
        config.AbsoluteMax = profile.AbsoluteMaxDownloadMbps;
        config.Overhead = profile.OverheadMultiplier;
        config.BaselineLatency = profile.BaselineLatency;
        config.LatencyThreshold = profile.LatencyThreshold;
    }

    private void ResetWanConfigs()
    {
        // Reset WAN1 to defaults
        wan1Config.Enabled = false;
        wan1Config.Name = "WAN1";
        wan1Config.Interface = "";
        wan1Config.ConnectionType = ConnectionType.DocsisCable;
        wan1Config.NominalDownload = 0;
        wan1Config.NominalUpload = 0;
        wan1Config.PingHost = "1.1.1.1";
        wan1Config.SpeedtestServerId = "";
        wan1Config.MorningHour = 6;
        wan1Config.MorningMinute = 0;
        wan1Config.EveningHour = 19;
        wan1Config.EveningMinute = 0;
        UpdateCalculatedSpeeds(wan1Config);

        // Reset WAN2 to defaults
        wan2Config.Enabled = false;
        wan2Config.Name = "WAN2";
        wan2Config.Interface = "";
        wan2Config.ConnectionType = ConnectionType.DocsisCable;
        wan2Config.NominalDownload = 0;
        wan2Config.NominalUpload = 0;
        wan2Config.PingHost = "1.1.1.1";
        wan2Config.SpeedtestServerId = "";
        wan2Config.MorningHour = 5;
        wan2Config.MorningMinute = 0;
        wan2Config.EveningHour = 18;
        wan2Config.EveningMinute = 0;
        UpdateCalculatedSpeeds(wan2Config);
    }

    /// <summary>
    /// Applies connection-specific defaults based on WAN name.
    /// Centralizes logic for Starlink and other connection types.
    /// Always updates calculated speeds after applying defaults.
    /// </summary>
    private void ApplyConnectionDefaults(WanConfigModel config, string wanName)
    {
        if (wanName.Equals("Starlink", StringComparison.OrdinalIgnoreCase))
        {
            config.ConnectionType = ConnectionType.Starlink;
            config.NominalDownload = 400;
            config.NominalUpload = 40;
            config.SpeedtestServerId = "59762";
        }
        // Add other connection-specific defaults here as needed

        // Always update calculated speeds after applying defaults
        UpdateCalculatedSpeeds(config);
    }

    private void OnEnabledChanged(WanConfigModel config, List<WanInterfaceInfo> availableInterfaces)
    {
        // When enabling, auto-select if only one interface available
        if (config.Enabled && string.IsNullOrEmpty(config.Interface) && availableInterfaces.Count == 1)
        {
            var wan = availableInterfaces[0];
            config.Interface = wan.Interface;

            // Apply all defaults as if user selected it
            if (!string.IsNullOrEmpty(wan.SuggestedPingIp))
                config.PingHost = wan.SuggestedPingIp;

            if (string.IsNullOrEmpty(config.Name) || config.Name == "WAN1" || config.Name == "WAN2")
                config.Name = wan.Name;

            ApplyConnectionDefaults(config, wan.Name);
        }
    }

    private static string SanitizeWanName(string? input)
    {
        if (string.IsNullOrEmpty(input))
            return string.Empty;
        return new string(input.Where(c => char.IsLetterOrDigit(c) || c == ' ' || c == '(' || c == ')' || c == '-' || c == '_').ToArray());
    }

    private void OnInterfaceChanged(WanConfigModel config)
    {
        // Find the WAN info for the selected interface
        var wanInfo = wanInterfaces.FirstOrDefault(w =>
            w.Interface.Equals(config.Interface, StringComparison.OrdinalIgnoreCase));

        if (wanInfo == null)
            return;

        // Set suggested ping IP
        if (!string.IsNullOrEmpty(wanInfo.SuggestedPingIp))
            config.PingHost = wanInfo.SuggestedPingIp;

        // Set name from WAN
        if (string.IsNullOrEmpty(config.Name) || config.Name == "WAN1" || config.Name == "WAN2")
            config.Name = wanInfo.Name;

        // Apply connection-specific defaults (Starlink, etc.)
        ApplyConnectionDefaults(config, wanInfo.Name);
    }

    private async Task ScrollDeploymentLog()
    {
        StateHasChanged();
        await Task.Yield();
        await JS.InvokeVoidAsync("eval",
            "document.querySelector('#deployment-step-list li:last-child')?.scrollIntoView({behavior:'smooth',block:'nearest'})");
    }

    private async Task ManualRefresh()
    {
        statusMessage = null;
        await RefreshStatus();
    }

    private async Task RefreshStatus(bool forceRefresh = true)
    {
        // Mark that a refresh is in progress - if user navs away, next page load will re-fetch
        _refreshNeeded = true;
        isLoading = true;
        StateHasChanged();

        try
        {
            // Check if gateway SSH is configured first
            var settings = await GatewaySshService.GetSettingsAsync();
            gatewayConfigured = settings.Enabled && settings.HasCredentials && !string.IsNullOrEmpty(settings.Host);

            if (!gatewayConfigured)
            {
                // Not configured - don't try to connect
                gatewayConnected = false;
                _cachedGatewayConfigured = false;
                _cachedGatewayConnected = false;
                deploymentStatus = null;
                _cachedDeploymentStatus = null;
                isLoading = false;
                _lastStatusCheck = DateTime.UtcNow;
                StateHasChanged();
                return;
            }

            // Test gateway connection
            var connectionResult = await DeploymentService.TestConnectionAsync();
            gatewayConnected = connectionResult.success;

            if (gatewayConnected)
            {
                // Start deployment status and WAN interface detection in parallel
                var deploymentTask = DeploymentService.CheckDeploymentStatusAsync();
                var wanInterfacesTask = SqmService.GetWanInterfacesFromControllerAsync();

                // Wait for deployment status first (needed to decide if we poll TC Monitor)
                deploymentStatus = await deploymentTask;

                // Only poll TC Monitor if scripts are deployed (avoids 15s timeout when not deployed)
                if (deploymentStatus?.IsDeployed == true)
                {
                    var gatewayHost = await GetGatewayHostAsync();
                    if (!string.IsNullOrEmpty(gatewayHost))
                    {
                        sqmMonitorData = await SqmMonitorClient.GetTcStatsAsync(gatewayHost, forceRefresh: true);
                        tcInterfaces = sqmMonitorData?.GetAllInterfaces();
                    }
                }
                else
                {
                    // Not deployed - clear monitor data
                    sqmMonitorData = null;
                    tcInterfaces = null;
                }

                // Get WAN interfaces result (already running in parallel)
                try
                {
                    wanInterfaces = await wanInterfacesTask;
                    // Only apply detected interfaces if we don't have saved configs
                    if (!hasSavedConfigs)
                        ApplyDetectedWanInterfaces();
                }
                catch
                {
                    // WAN detection failed, keep defaults
                    wanInterfaces = new();
                }

                // Update cache - always update when gateway connected
                _cachedGatewayConfigured = gatewayConfigured;
                _cachedGatewayConnected = gatewayConnected;
                _cachedDeploymentStatus = deploymentStatus;
                _cachedTcInterfaces = tcInterfaces;
                _cachedWanInterfaces = wanInterfaces;
                _lastStatusCheck = DateTime.UtcNow;
            }
            else
            {
                // Gateway not connected - clear stale data and update cache
                _cachedGatewayConfigured = gatewayConfigured;
                _cachedGatewayConnected = false;
                deploymentStatus = new SqmDeploymentStatus { Error = connectionResult.message };
                _cachedDeploymentStatus = deploymentStatus;
                sqmMonitorData = null;
                tcInterfaces = null;
                _cachedTcInterfaces = null;
                _lastStatusCheck = DateTime.UtcNow;
                statusMessage = connectionResult.message;
                statusSuccess = false;
            }
        }
        catch (Exception ex)
        {
            // Error occurred - clear stale data and update cache
            _cachedGatewayConfigured = gatewayConfigured;
            _cachedGatewayConnected = false;
            deploymentStatus = new SqmDeploymentStatus { Error = ex.Message };
            _cachedDeploymentStatus = deploymentStatus;
            sqmMonitorData = null;
            tcInterfaces = null;
            _cachedTcInterfaces = null;
            _lastStatusCheck = DateTime.UtcNow;
            statusMessage = $"Error: {ex.Message}";
            statusSuccess = false;
        }
        finally
        {
            _refreshNeeded = false;  // Refresh completed (or failed) - clear the flag
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task InstallUdmBoot()
    {
        isInstallingUdmBoot = true;
        statusMessage = null;
        StateHasChanged();

        try
        {
            var result = await DeploymentService.InstallUdmBootAsync();

            if (result.success)
            {
                statusMessage = result.message;
                statusSuccess = true;
                InvalidateCache();
                await RefreshStatus();
            }
            else
            {
                statusMessage = result.message;
                statusSuccess = false;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            statusSuccess = false;
        }
        finally
        {
            isInstallingUdmBoot = false;
            StateHasChanged();
        }
    }

    private async Task DeploySqm()
    {
        // Validate: enabled configs must have interface selected
        var wan1Ready = wan1Config.Enabled && !string.IsNullOrEmpty(wan1Config.Interface);
        var wan2Ready = wan2Config.Enabled && !string.IsNullOrEmpty(wan2Config.Interface);

        if (!wan1Ready && !wan2Ready)
        {
            statusMessage = "Enable at least one WAN configuration and select its interface";
            statusSuccess = false;
            return;
        }

        // Validate enabled configs have valid settings
        var errors = new List<string>();
        if (wan1Ready)
        {
            if (wan1Config.NominalDownload <= 0)
                errors.Add($"{wan1Config.Name}: Download speed must be greater than 0");
            if (wan1Config.NominalUpload <= 0)
                errors.Add($"{wan1Config.Name}: Upload speed must be greater than 0");
            if (string.IsNullOrWhiteSpace(wan1Config.PingHost))
                errors.Add($"{wan1Config.Name}: Ping host is required");
        }
        if (wan2Ready)
        {
            if (wan2Config.NominalDownload <= 0)
                errors.Add($"{wan2Config.Name}: Download speed must be greater than 0");
            if (wan2Config.NominalUpload <= 0)
                errors.Add($"{wan2Config.Name}: Upload speed must be greater than 0");
            if (string.IsNullOrWhiteSpace(wan2Config.PingHost))
                errors.Add($"{wan2Config.Name}: Ping host is required");
        }
        if (errors.Count > 0)
        {
            statusMessage = string.Join("; ", errors);
            statusSuccess = false;
            return;
        }

        // Trim inputs before validation
        wan1Config.PingHost = NetworkOptimizer.Sqm.InputSanitizer.TrimPingHost(wan1Config.PingHost) ?? "";
        wan1Config.SpeedtestServerId = NetworkOptimizer.Sqm.InputSanitizer.TrimSpeedtestServerId(wan1Config.SpeedtestServerId);
        wan2Config.PingHost = NetworkOptimizer.Sqm.InputSanitizer.TrimPingHost(wan2Config.PingHost) ?? "";
        wan2Config.SpeedtestServerId = NetworkOptimizer.Sqm.InputSanitizer.TrimSpeedtestServerId(wan2Config.SpeedtestServerId);

        // Security validation: validate inputs before any deployment actions
        if (wan1Ready)
        {
            var pingResult = NetworkOptimizer.Sqm.InputSanitizer.ValidatePingHost(wan1Config.PingHost);
            if (!pingResult.isValid)
                errors.Add($"{wan1Config.Name}: {pingResult.error}");
            var serverIdResult = NetworkOptimizer.Sqm.InputSanitizer.ValidateSpeedtestServerId(wan1Config.SpeedtestServerId);
            if (!serverIdResult.isValid)
                errors.Add($"{wan1Config.Name}: {serverIdResult.error}");
            var interfaceResult = NetworkOptimizer.Sqm.InputSanitizer.ValidateInterface(wan1Config.Interface);
            if (!interfaceResult.isValid)
                errors.Add($"{wan1Config.Name}: {interfaceResult.error}");
        }
        if (wan2Ready)
        {
            var pingResult = NetworkOptimizer.Sqm.InputSanitizer.ValidatePingHost(wan2Config.PingHost);
            if (!pingResult.isValid)
                errors.Add($"{wan2Config.Name}: {pingResult.error}");
            var serverIdResult = NetworkOptimizer.Sqm.InputSanitizer.ValidateSpeedtestServerId(wan2Config.SpeedtestServerId);
            if (!serverIdResult.isValid)
                errors.Add($"{wan2Config.Name}: {serverIdResult.error}");
            var interfaceResult = NetworkOptimizer.Sqm.InputSanitizer.ValidateInterface(wan2Config.Interface);
            if (!interfaceResult.isValid)
                errors.Add($"{wan2Config.Name}: {interfaceResult.error}");
        }
        if (errors.Count > 0)
        {
            statusMessage = string.Join("; ", errors);
            statusSuccess = false;
            return;
        }

        // Disable any configs without interfaces (safety check)
        if (wan1Config.Enabled && string.IsNullOrEmpty(wan1Config.Interface))
            wan1Config.Enabled = false;
        if (wan2Config.Enabled && string.IsNullOrEmpty(wan2Config.Interface))
            wan2Config.Enabled = false;

        // Prevent duplicate interface deployment (both WANs using same interface)
        if (wan1Config.Enabled && wan2Config.Enabled &&
            wan1Config.Interface.Equals(wan2Config.Interface, StringComparison.OrdinalIgnoreCase))
        {
            wan2Config.Enabled = false;
            // Note: This shouldn't happen with proper UI, but protects against stale DB data
        }

        // Prevent duplicate name deployment (both WANs using same name)
        if (wan1Config.Enabled && wan2Config.Enabled &&
            wan1Config.Name.Equals(wan2Config.Name, StringComparison.OrdinalIgnoreCase))
        {
            statusMessage = "Error: Both WAN connections cannot have the same name";
            statusSuccess = false;
            isDeploying = false;
            StateHasChanged();
            return;
        }

        isDeploying = true;
        deploymentSteps.Clear();
        deploymentWarnings.Clear();
        statusMessage = null;
        adjustmentMessage = null;
        StateHasChanged();

        try
        {
            // Clean ALL existing SQM scripts and cron entries first (handles renamed connections)
            deploymentSteps.Add("Cleaning existing SQM scripts and cron entries...");
            await ScrollDeploymentLog();
            var cleanResult = await DeploymentService.CleanAllSqmScriptsAsync();
            if (!cleanResult.success)
            {
                throw new Exception($"Failed to clean existing scripts: {cleanResult.message}");
            }
            deploymentSteps.Add("Existing scripts cleaned");
            await ScrollDeploymentLog();

            // Validate WANs still have Smart Queues enabled - disable any that don't
            var availableInterfaces = sqmEligibleWans.Select(w => w.Interface).ToHashSet(StringComparer.OrdinalIgnoreCase);
            if (wan1Config.Enabled && !availableInterfaces.Contains(wan1Config.Interface))
            {
                wan1Config.Enabled = false;
                deploymentSteps.Add($"Skipping {wan1Config.Name} - Smart Queues no longer enabled in UniFi");
                await ScrollDeploymentLog();
            }
            if (wan2Config.Enabled && !availableInterfaces.Contains(wan2Config.Interface))
            {
                wan2Config.Enabled = false;
                deploymentSteps.Add($"Skipping {wan2Config.Name} - Smart Queues no longer enabled in UniFi");
                await ScrollDeploymentLog();
            }

            // Save WAN configs to database (after validation so disabled WANs are persisted)
            await SaveWanConfigsAsync();
            deploymentSteps.Add("WAN configurations saved");
            await ScrollDeploymentLog();

            // Deploy first WAN (initial speedtest immediately)
            if (wan1Config.Enabled)
            {
                deploymentSteps.Add($"Deploying SQM for {wan1Config.Name} ({wan1Config.Interface})...");
                await ScrollDeploymentLog();

                var config = CreateSqmConfiguration(wan1Config);
                var result = await DeploymentService.DeployAsync(config, initialDelaySeconds: 5);

                // Always add steps (includes output on failure)
                deploymentSteps.AddRange(result.Steps);

                if (result.Success)
                {
                    if (result.HasWarnings)
                    {
                        deploymentWarnings.AddRange(result.Warnings);
                    }
                    deploymentSteps.Add($"{wan1Config.Name} deployed successfully (speedtest in 5s)");
                }
                else
                {
                    throw new Exception($"{wan1Config.Name} deployment failed: {result.Error}");
                }
            }

            // Deploy second WAN (stagger speedtest only if first WAN is also deployed)
            if (wan2Config.Enabled)
            {
                deploymentSteps.Add($"Deploying SQM for {wan2Config.Name} ({wan2Config.Interface})...");
                await ScrollDeploymentLog();

                // If WAN1 is also deployed, stagger the speedtest; otherwise this is the only WAN
                var wan2Delay = wan1Config.Enabled ? 50 : 5;
                var config = CreateSqmConfiguration(wan2Config);
                var result = await DeploymentService.DeployAsync(config, initialDelaySeconds: wan2Delay);

                // Always add steps (includes output on failure)
                deploymentSteps.AddRange(result.Steps);

                if (result.Success)
                {
                    if (result.HasWarnings)
                    {
                        deploymentWarnings.AddRange(result.Warnings);
                    }
                    deploymentSteps.Add($"{wan2Config.Name} deployed successfully (speedtest in {wan2Delay}s)");
                }
                else
                {
                    throw new Exception($"{wan2Config.Name} deployment failed: {result.Error}");
                }
            }

            // Deploy SQM Monitor
            if (wan1Config.Enabled || wan2Config.Enabled)
            {
                deploymentSteps.Add("Deploying SQM Monitor...");
                await ScrollDeploymentLog();

                // Use first enabled WAN for slot 1, second enabled (if any) for slot 2
                var w1 = wan1Config.Enabled ? wan1Config : wan2Config;
                var w1Interface = $"ifb{w1.Interface}";
                var w1Name = w1.Name;

                // Only populate w2 if BOTH WANs are enabled
                var w2Interface = (wan1Config.Enabled && wan2Config.Enabled) ? $"ifb{wan2Config.Interface}" : "";
                var w2Name = (wan1Config.Enabled && wan2Config.Enabled) ? wan2Config.Name : "";

                var (monitorSuccess, monitorError) = await DeploymentService.DeploySqmMonitorAsync(w1Interface, w1Name, w2Interface, w2Name);

                if (!monitorSuccess)
                {
                    deploymentWarnings.Add(monitorError ?? "SQM Monitor deployment failed");
                    deploymentSteps.Add($"⚠️ SQM Monitor deployment failed: {monitorError ?? "Unknown error"}");
                    deploymentSteps.Add("SQM Monitor cleaned up after failure");
                }
                else
                {
                    deploymentSteps.Add("SQM Monitor deployed successfully");
                }
            }

            // Set final status - include warning note if any
            if (deploymentWarnings.Count > 0)
            {
                statusMessage = $"SQM deployment completed with {deploymentWarnings.Count} warning(s). Check the deployment log for details.";
            }
            else
            {
                statusMessage = "SQM deployment completed successfully!";
            }
            statusSuccess = true;

            // Capture deployed state for change detection
            CaptureDeployedSnapshots();

            // Invalidate cache and refresh status
            InvalidateCache();
            await RefreshStatus();

            // Deploy triggers initial speedtests - start fast polling after delay to catch them
            // Duration depends on number of enabled WANs (staggered speedtests)
            var postDeployDuration = (wan1Config.Enabled && wan2Config.Enabled)
                ? PostDeployDualWanFastPolling
                : PostDeploySingleWanFastPolling;
            _fastPollingUntil = DateTime.UtcNow.Add(postDeployDuration);

            // 5s delay + 3s initial poll delay = poll at 8s mark
            _ = Task.Run(async () =>
            {
                await Task.Delay(5000);
                await InvokeAsync(() =>
                {
                    AdjustRefreshInterval(useInitialDelay: true);
                    StateHasChanged();
                });
            });
        }
        catch (Exception ex)
        {
            statusMessage = $"Deployment failed: {ex.Message}";
            statusSuccess = false;
        }
        finally
        {
            isDeploying = false;
            StateHasChanged();
        }
    }

    private async Task DeployTcMonitor()
    {
        isDeploying = true;
        deploymentSteps.Clear();
        deploymentWarnings.Clear();
        statusMessage = null;
        StateHasChanged();

        try
        {
            deploymentSteps.Add("Deploying SQM Monitor...");
            await ScrollDeploymentLog();

            // Use first enabled WAN for slot 1, second enabled (if any) for slot 2
            var w1 = wan1Config.Enabled ? wan1Config : wan2Config;
            var w1Interface = $"ifb{w1.Interface}";
            var w1Name = w1.Name;

            // Only populate w2 if BOTH WANs are enabled
            var w2Interface = (wan1Config.Enabled && wan2Config.Enabled) ? $"ifb{wan2Config.Interface}" : "";
            var w2Name = (wan1Config.Enabled && wan2Config.Enabled) ? wan2Config.Name : "";

            var (success, errorMessage) = await DeploymentService.DeploySqmMonitorAsync(
                w1Interface, w1Name, w2Interface, w2Name);

            if (success)
            {
                deploymentSteps.Add("SQM Monitor deployed successfully");
                statusMessage = "SQM Monitor deployed!";
                statusSuccess = true;
                InvalidateCache();
                await RefreshStatus();
            }
            else
            {
                deploymentSteps.Add($"⚠️ SQM Monitor deployment failed: {errorMessage ?? "Unknown error"}");
                deploymentSteps.Add("SQM Monitor cleaned up after failure");
                statusMessage = $"SQM Monitor deployment failed: {errorMessage ?? "Unknown error"}";
                statusSuccess = false;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            statusSuccess = false;
        }
        finally
        {
            isDeploying = false;
            StateHasChanged();
        }
    }

    private async Task RemoveSqm()
    {
        isDeploying = true;
        statusMessage = null;
        adjustmentMessage = null;
        deploymentSteps.Clear();
        deploymentWarnings.Clear();
        deploymentSteps.Add("Removing SQM and SQM Monitor...");
        await ScrollDeploymentLog();

        try
        {
            var (success, steps) = await DeploymentService.RemoveAsync(includeTcMonitor: true);
            deploymentSteps.AddRange(steps);
            await ScrollDeploymentLog();

            if (success)
            {
                // Clear saved configurations from database
                await SpeedTestRepository.ClearAllSqmWanConfigsAsync();
                deploymentSteps.Add("Cleared saved configurations");
                await ScrollDeploymentLog();

                // Reset UI state and clear saved config flags
                ResetWanConfigs();
                wan1HasSavedConfig = false;
                wan2HasSavedConfig = false;
                _deployedWan1Snapshot = null;
                _deployedWan2Snapshot = null;

                statusMessage = "SQM and SQM Monitor removed successfully";
                statusSuccess = true;
                InvalidateCache();
                await RefreshStatus();
            }
            else
            {
                statusMessage = "Failed to remove SQM scripts";
                statusSuccess = false;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            statusSuccess = false;
            deploymentSteps.Add($"Error: {ex.Message}");
        }
        finally
        {
            isDeploying = false;
            StateHasChanged();
        }
    }

    private async Task TriggerSqmAdjustment(string wanName)
    {
        Logger.LogInformation("[SQM Adjust] Button clicked for {Wan}", wanName);
        adjustmentMessage = null;
        StateHasChanged();

        // Gatekeep: Force refresh to check for externally-running speedtests (cron, CLI, other sessions)
        await LoadSqmMonitorDataAsync();

        // Check if any external speedtest is running (not UI-initiated)
        if (!isRunningAdjustment && (sqmMonitorData?.Wan1?.SpeedtestRunning == true || sqmMonitorData?.Wan2?.SpeedtestRunning == true))
        {
            adjustmentSuccess = false;
            adjustmentMessage = "A speed test is already running. Please wait for it to complete.";
            StateHasChanged();
            return;
        }

        isRunningAdjustment = true;
        adjustmentWan = wanName;
        AdjustRefreshInterval(useInitialDelay: true); // Poll after 3s, then every 5s
        StateHasChanged();

        try
        {
            var (success, message) = await DeploymentService.TriggerSqmAdjustmentAsync(wanName);
            Logger.LogInformation("[SQM Adjust] SSH returned. success={Success}", success);
            adjustmentSuccess = success;
            adjustmentMessage = message;

            // Fire off delayed refreshes without blocking (fast polling will also catch updates)
            if (success)
            {
                _ = Task.Run(async () =>
                {
                    await Task.Delay(2000);
                    await InvokeAsync(RefreshDashboard);
                    await Task.Delay(3000);
                    await InvokeAsync(RefreshDashboard);
                });
            }
        }
        catch (Exception ex)
        {
            adjustmentSuccess = false;
            adjustmentMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isRunningAdjustment = false;
            adjustmentWan = null;
            AdjustRefreshInterval(); // Return to normal polling (or stay fast if external test still running)
            StateHasChanged();
        }
    }

    private async Task CheckWanLogs(string wanName)
    {
        isCheckingLogs = true;
        checkingLogsWan = wanName;
        wanLogOutput = null;
        wanLogTitle = $"Last 50 lines of {wanName} SQM Log";
        StateHasChanged();

        try
        {
            var (success, output) = await DeploymentService.GetWanLogsAsync(wanName, 50);
            if (success)
            {
                wanLogOutput = output;
            }
            else
            {
                wanLogOutput = $"Error: {output}";
            }
        }
        catch (Exception ex)
        {
            wanLogOutput = $"Error: {ex.Message}";
        }
        finally
        {
            isCheckingLogs = false;
            checkingLogsWan = null;
            StateHasChanged();
        }
    }

    private SqmConfig CreateSqmConfiguration(WanConfigModel model)
    {
        var config = new SqmConfig
        {
            ConnectionType = model.ConnectionType,
            ConnectionName = model.Name,
            Interface = model.Interface,
            NominalDownloadSpeed = model.NominalDownload,
            NominalUploadSpeed = model.NominalUpload,
            PingHost = model.PingHost,
            PreferredSpeedtestServerId = model.SpeedtestServerId,
            // Use user-configured schedule times
            SpeedtestSchedule = new List<string>
            {
                $"{model.MorningMinute} {model.MorningHour} * * *",
                $"{model.EveningMinute} {model.EveningHour} * * *"
            }
        };

        config.ApplyProfileSettings();
        return config;
    }

    private void StatusMessage(string message, bool success)
    {
        statusMessage = message;
        statusSuccess = success;
    }

    private int ParseTimeValue(string? value, int min, int max)
    {
        if (string.IsNullOrWhiteSpace(value)) return min;
        if (int.TryParse(value, out int result))
        {
            return Math.Clamp(result, min, max);
        }
        return min;
    }

    private async Task<string?> GetGatewayHostAsync()
    {
        try
        {
            var settings = await SpeedTestRepository.GetGatewaySshSettingsAsync();
            return settings?.Host;
        }
        catch
        {
            return null;
        }
    }

    private async Task LoadSqmMonitorDataAsync()
    {
        // Only poll if SQM is deployed or we have saved enabled WAN configs
        var shouldPoll = deploymentStatus?.IsDeployed == true ||
                         deploymentStatus?.TcMonitorRunning == true ||
                         (wan1HasSavedConfig && wan1Config.Enabled) ||
                         (wan2HasSavedConfig && wan2Config.Enabled);

        if (!shouldPoll)
        {
            return;
        }

        try
        {
            var gatewayHost = await GetGatewayHostAsync();
            if (!string.IsNullOrEmpty(gatewayHost))
            {
                sqmMonitorData = await SqmMonitorClient.GetTcStatsAsync(gatewayHost, forceRefresh: true);
                tcInterfaces = sqmMonitorData?.GetAllInterfaces();

                // Adjust polling rate based on speedtest status
                AdjustRefreshInterval();
            }
        }
        catch
        {
            // Silently fail - dashboard just won't show
        }
    }

    private async Task RefreshDashboard()
    {
        if (isRefreshingDashboard) return;

        isRefreshingDashboard = true;
        StateHasChanged();

        try
        {
            await LoadSqmMonitorDataAsync();
        }
        finally
        {
            isRefreshingDashboard = false;
            StateHasChanged();
        }
    }

    // Model for WAN configuration form
    private class WanConfigModel
    {
        public bool Enabled { get; set; }
        public string Name { get; set; } = "";
        public string Interface { get; set; } = "";
        public ConnectionType ConnectionType { get; set; }
        public int NominalDownload { get; set; }
        public int NominalUpload { get; set; }
        public string PingHost { get; set; } = "1.1.1.1";
        public string? SpeedtestServerId { get; set; }

        // Speedtest schedule
        public int MorningHour { get; set; } = 6;
        public int MorningMinute { get; set; } = 0;
        public int EveningHour { get; set; } = 18;
        public int EveningMinute { get; set; } = 30;

        // Calculated values
        public int MaxSpeed { get; set; }
        public int MinSpeed { get; set; }
        public int AbsoluteMax { get; set; }
        public double Overhead { get; set; }
        public double BaselineLatency { get; set; }
        public double LatencyThreshold { get; set; }

        // Helper to format time display
        public string MorningTimeDisplay => $"{MorningHour:D2}:{MorningMinute:D2}";
        public string EveningTimeDisplay => $"{EveningHour:D2}:{EveningMinute:D2}";

        // Create a snapshot of the deployable config values
        public WanConfigSnapshot ToSnapshot() => new(
            Enabled, Name, Interface, ConnectionType, NominalDownload, NominalUpload,
            PingHost, SpeedtestServerId, MorningHour, MorningMinute, EveningHour, EveningMinute);

        // Check if current config differs from a snapshot
        public bool DiffersFrom(WanConfigSnapshot? snapshot)
        {
            if (snapshot == null) return Enabled; // No snapshot = changes if enabled
            return Enabled != snapshot.Enabled ||
                   Name != snapshot.Name ||
                   Interface != snapshot.Interface ||
                   ConnectionType != snapshot.ConnectionType ||
                   NominalDownload != snapshot.NominalDownload ||
                   NominalUpload != snapshot.NominalUpload ||
                   PingHost != snapshot.PingHost ||
                   SpeedtestServerId != snapshot.SpeedtestServerId ||
                   MorningHour != snapshot.MorningHour ||
                   MorningMinute != snapshot.MorningMinute ||
                   EveningHour != snapshot.EveningHour ||
                   EveningMinute != snapshot.EveningMinute;
        }
    }

    // Immutable snapshot of WAN config for change detection
    private record WanConfigSnapshot(
        bool Enabled, string Name, string Interface, ConnectionType ConnectionType,
        int NominalDownload, int NominalUpload, string PingHost, string? SpeedtestServerId,
        int MorningHour, int MorningMinute, int EveningHour, int EveningMinute);

    public void Dispose()
    {
        ConnectionService.OnConnectionChanged -= OnConnectionChanged;
        _refreshTimer?.Dispose();
    }
}
