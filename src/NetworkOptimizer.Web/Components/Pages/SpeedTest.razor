@page "/speedtest"
@rendermode InteractiveServer
@implements IDisposable
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.Core.Enums
@using NetworkOptimizer.UniFi
@using NetworkOptimizer.UniFi.Models
@inject Iperf3SpeedTestService SpeedTestService
@inject UniFiSshService SshService
@inject UniFiConnectionService ConnectionService
@inject GatewaySpeedTestService GatewaySpeedTestService
@inject INetworkPathAnalyzer PathAnalyzer
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject SystemSettingsService SettingsService
@using NetworkOptimizer.Web.Components.Shared

<PageTitle>LAN Speed Test - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>LAN Speed Test</h1>
    <p class="page-description">Test network bandwidth using iperf3</p>
    @if (localIperf3Status != null && localIperf3Status.IsAvailable)
    {
        <div class="iperf3-version-badge">
            <span class="version-label">Server iperf3 version:</span>
            <span class="status-badge status-connected">@localIperf3Status.Version</span>
        </div>
    }
</div>

<!-- Client Speed Test Promotion -->
<div class="card client-speedtest-card">
    <div class="card-body">
        <div class="client-speedtest-promo">
            <div class="promo-content">
                <h3>Test from Any Device</h3>
                <p>
                    Run speed tests from phones, tablets, laptops, or any device on your network...
                    no SSH required, just open a browser or use iperf3.
                </p>
            </div>
            <a href="/client-speedtest" class="btn btn-primary">
                Client Speed Test →
            </a>
        </div>
    </div>
</div>

@if (localIperf3Status != null && !localIperf3Status.IsAvailable)
{
    <div class="alert alert-danger iperf3-missing-alert">
        <div class="iperf3-missing-content">
            <div class="iperf3-missing-icon">!</div>
            <div class="iperf3-missing-text">
                <strong>iperf3 Not Available on Server</strong>
                <p>
                    The iperf3 tool is not installed or not accessible on this server.
                    Speed tests cannot run without it.
                </p>
                @if (!string.IsNullOrEmpty(localIperf3Status.Error))
                {
                    <p class="iperf3-error-detail"><code>@localIperf3Status.Error</code></p>
                }
                <p class="iperf3-install-hint">
                    <strong>To fix:</strong> Install iperf3 on this server.
                    If running in Docker, ensure iperf3 is included in the container image.
                    If running natively, install via your package manager (e.g., <code>apt install iperf3</code> or <code>brew install iperf3</code>).
                </p>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="RecheckLocalIperf3" disabled="@recheckingIperf3">
                @if (recheckingIperf3)
                {
                    <span class="spinner"></span>
                    <span>Checking...</span>
                }
                else
                {
                    <span>Recheck</span>
                }
            </button>
        </div>
    </div>
}

<div class="speedtest-container @(localIperf3Status != null && !localIperf3Status.IsAvailable ? "locked-out" : "")">
    <!-- Gateway Speed Test Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Gateway Speed Test</h2>
            @if (gatewayLastResult != null)
            {
                <span class="status-badge status-@(gatewayLastResult.Success ? "connected" : "disconnected")">
                    @(gatewayLastResult.Success ? "Success" : "Failed")
                </span>
            }
        </div>
        <div class="card-body">
            @if (gatewayLoading)
            {
                <div class="loading-state">
                    <span class="spinner"></span>
                    <span>Loading...</span>
                </div>
            }
            else if (!gatewayConfigured)
            {
                <div class="alert alert-warning">
                    <strong>Gateway SSH not configured.</strong>
                    Go to <a href="/settings#gateway-ssh">Settings</a> to configure Gateway SSH credentials before running gateway speed tests.
                </div>
            }
            else
            {
                <p class="section-description">
                    Measure throughput to your gateway.
                </p>

                <!-- iperf3 Status -->
                @if (gatewayIperf3Status != null)
                {
                    <div class="iperf3-status">
                        <div class="status-row">
                            <span class="status-label">iperf3 Status:</span>
                            @if (gatewayIperf3Status.IsInstalled)
                            {
                                <span class="status-badge status-connected">Installed</span>
                            }
                            else
                            {
                                <span class="status-badge status-disconnected">Not Found</span>
                            }
                        </div>
                        @if (gatewayIperf3Status.IsRunning)
                        {
                            <div class="status-row">
                                <span class="status-label">Server Running:</span>
                                <span class="status-badge status-connected">Port @gatewayIperf3Status.Port</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(gatewayIperf3Status.Version))
                        {
                            <div class="status-row">
                                <span class="status-label">Version:</span>
                                <span>@gatewayIperf3Status.Version</span>
                            </div>
                        }
                    </div>
                }

                <!-- Last Result Summary -->
                @if (gatewayLastResult != null && gatewayLastResult.Success)
                {
                    <div class="result-box @(gatewayExpanded ? "expanded" : "")" @onclick="() => gatewayExpanded = !gatewayExpanded">
                        <div class="result-box-header">
                            <span class="result-speeds">
                                <span class="result-speed">↓ @gatewayLastResult.DownloadMbps.ToString("F1")</span>
                                <span class="result-speed">↑ @gatewayLastResult.UploadMbps.ToString("F1")</span>
                                <span class="result-unit">Mbps</span>
                                <span class="tooltip-icon" data-tooltip="↓ From gateway ↑ To gateway">?</span>
                            </span>
                            <span class="result-box-right">
                                <span class="result-time">@gatewayLastResult.TestTime.ToLocalTime().ToString("MMM dd, HH:mm")</span>
                                <span class="result-expand-hint">@(gatewayExpanded ? "▲" : "▼")</span>
                            </span>
                        </div>
                        <div class="result-box-details">
                            <div class="result-box-details-inner">
                                <SpeedTestDetails GatewayResult="gatewayLastResult" />
                            </div>
                        </div>
                    </div>
                }
                else if (gatewayLastResult != null && !gatewayLastResult.Success)
                {
                    <div class="alert alert-danger">
                        <strong>Test Failed:</strong> @gatewayLastResult.Error
                    </div>
                }

                <!-- Actions -->
                <div class="gateway-actions">
                    <button class="btn btn-primary test-button" style="width: 9.5rem;" @onclick="RunGatewaySpeedTest" disabled="@gatewayRunning">
                        @if (gatewayRunning)
                        {
                            <div class="test-progress">
                                <div class="progress-bar" style="width: @(testProgressPercent)%"></div>
                            </div>
                            <span class="test-phase">@testProgressPhase...</span>
                        }
                        else
                        {
                            <span>Run Gateway Test</span>
                        }
                    </button>
                    <button class="btn btn-secondary" style="min-width: 7.5rem;" @onclick="CheckGatewayIperf3" disabled="@gatewayCheckingIperf3">
                        @if (gatewayCheckingIperf3)
                        {
                            <span class="spinner"></span>
                            <span>Checking...</span>
                        }
                        else
                        {
                            <span>Check iperf3</span>
                        }
                    </button>
                    <button class="btn btn-secondary" @onclick="@(() => NavigationManager.NavigateTo("/settings#gateway-ssh"))">Settings</button>
                </div>

                @if (gatewayRunning)
                {
                    <div class="alert alert-info alert-progress" style="margin-top: 1rem;">
                        <div class="alert-progress-bar" style="width: @(testProgressPercent)%"></div>
                        <span class="alert-progress-text">Testing gateway... @testProgressPhaseVerbose...</span>
                    </div>
                }
                else if (!string.IsNullOrEmpty(gatewayMessage))
                {
                    @if (gatewayMessageClass == "success" && gatewayLastResult?.Success == true)
                    {
                        <div class="alert alert-success alert-link" style="margin-top: 1rem;" @onclick="ScrollToLatestResult">
                            <span>@gatewayMessage</span>
                            <span class="alert-link-hint">Click to view details →</span>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-@gatewayMessageClass" style="margin-top: 1rem;">
                            @gatewayMessage
                        </div>
                    }
                }
            }
        </div>
    </div>

    <!-- SSH Credentials Status -->
    @if (!sshConfigured)
    {
        <div class="alert alert-warning">
            <strong>SSH credentials not configured.</strong>
            Go to <a href="/settings#device-ssh">Settings</a> to configure Device SSH credentials before running speed tests.
        </div>
    }

    <!-- Discovered Devices from UniFi Console -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">UniFi Device Speed Test</h2>
            <div class="header-actions">
                <button class="btn btn-sm btn-secondary" @onclick="LoadDiscoveredDevices" disabled="@(!ConnectionService.IsConnected || loadingDiscovered)">
                    @if (loadingDiscovered)
                    {
                        <span class="spinner"></span>
                        <span>Scanning...</span>
                    }
                    else
                    {
                        <span>Refresh</span>
                    }
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="section-description">
                Select any non-gateway device to run a speed test. Devices are auto-discovered from your UniFi controller.
            </p>

            @if (!ConnectionService.IsConnected)
            {
                <div class="alert alert-warning">
                    Connect to your UniFi controller in <a href="/settings">Settings</a> to discover devices.
                </div>
            }
            else if (discoveredDevices.Count > 0)
            {
                <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Name</th>
                            <th>Model</th>
                            <th>IP Address</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var device in discoveredDevices)
                        {
                            var isOnline = device.State == 1 && device.Adopted;
                            <tr>
                                <td class="icon-cell"><DeviceIcon Model="@device.FriendlyModelName" Size="md" /></td>
                                <td>@device.Name</td>
                                <td><code>@device.FriendlyModelName</code></td>
                                <td><code>@device.IpAddress</code></td>
                                <td>@device.Type.ToDisplayName()</td>
                                <td>
                                    @if (isOnline)
                                    {
                                        <span class="status-badge status-connected">Online</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disconnected">Offline</span>
                                    }
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-primary btn-sm test-button"
                                                @onclick="() => RunSpeedTestOnDiscovered(device)"
                                                disabled="@(isRunningTest || !isOnline || !sshConfigured || string.IsNullOrEmpty(device.IpAddress))">
                                            @if (runningTestHost == device.IpAddress)
                                            {
                                                <div class="test-progress">
                                                    <div class="progress-bar" style="width: @(testProgressPercent)%"></div>
                                                </div>
                                                <span class="test-phase">@testProgressPhase...</span>
                                            }
                                            else
                                            {
                                                <span>Run Test</span>
                                            }
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                </div>
            }
            else if (!loadingDiscovered)
            {
                <p class="empty-state">No devices found. Click Refresh to scan for devices.</p>
            }

            @if (!string.IsNullOrEmpty(unifiMessage))
            {
                @if (unifiMessageClass == "success")
                {
                    <div class="alert alert-success alert-link" style="margin-top: 1rem;" @onclick="ScrollToLatestResult">
                        <span>@unifiMessage</span>
                        <span class="alert-link-hint">Click to view details →</span>
                    </div>
                }
                else if (unifiMessageClass == "info" && isRunningTest)
                {
                    <div class="alert alert-info alert-progress" style="margin-top: 1rem;">
                        <div class="alert-progress-bar" style="width: @(testProgressPercent)%"></div>
                        <span class="alert-progress-text">@unifiMessage @testProgressPhaseVerbose...</span>
                    </div>
                }
                else
                {
                    <div class="alert alert-@unifiMessageClass" style="margin-top: 1rem;">
                        @unifiMessage
                    </div>
                }
            }
        </div>
    </div>

    <!-- Saved Devices (for repeated testing) -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Other Device Speed Test</h2>
            <div class="header-actions">
                <button class="btn btn-sm btn-secondary" @onclick="() => showAddDevice = !showAddDevice">
                    @(showAddDevice ? "Cancel" : "Add Device")
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="section-description">
                Test speed to servers, desktops, and other devices. SSH credentials are configured in <a href="/settings">Settings</a>.
            </p>

            @if (devices.Count > 0)
            {
                <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Host</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var device in devices)
                        {
                            <tr>
                                <td>@device.Name</td>
                                <td><code>@device.Host</code></td>
                                <td>@device.DeviceType.ToDisplayName()</td>
                                <td>
                                    @if (device.Enabled)
                                    {
                                        <span class="status-badge status-connected">Enabled</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disconnected">Disabled</span>
                                    }
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-primary btn-sm test-button" @onclick="() => RunSpeedTest(device)"
                                                disabled="@(isRunningTest || !device.Enabled || !sshConfigured)">
                                            @if (runningTestHost == device.Host)
                                            {
                                                <div class="test-progress">
                                                    <div class="progress-bar" style="width: @(testProgressPercent)%"></div>
                                                </div>
                                                <span class="test-phase">@testProgressPhase...</span>
                                            }
                                            else
                                            {
                                                <span>Run Test</span>
                                            }
                                        </button>
                                        <button class="btn btn-secondary btn-sm" style="min-width: 5rem; @(device.StartIperf3Server ? "" : "visibility: hidden;")"
                                                @onclick="() => TestConnection(device)" disabled="@(!sshConfigured)">Test SSH</button>
                                        <button class="btn btn-secondary btn-sm" @onclick="() => EditDevice(device)">Edit</button>
                                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteDevice(device)">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                </div>
            }
            else if (!showAddDevice)
            {
                <p class="empty-state">No saved devices. Click "Add Device" to add a server or other device for testing.</p>
            }

            @if (showAddDevice || editingDevice.Id > 0)
            {
                <div class="add-device-form" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <h4>@(editingDevice.Id > 0 ? "Edit Device" : "Add Device")</h4>

                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Device Name</label>
                            <input type="text" class="form-control" @bind="editingDevice.Name" placeholder="My Server" />
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Type</label>
                            <select class="form-control" @bind="editingDevice.DeviceType">
                                @foreach (var deviceType in DeviceTypeExtensions.AllForSpeedTest)
                                {
                                    <option value="@deviceType">@deviceType.ToDisplayName()</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Host / IP Address</label>
                        <input type="text" class="form-control" @bind="editingDevice.Host" placeholder="192.168.1.10" />
                    </div>

                    <div class="form-group">
                        <label class="form-check">
                            <input type="checkbox" @bind="editingDevice.Enabled" />
                            <span>Enable for speed testing</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-check">
                            <input type="checkbox" @bind="editingDevice.StartIperf3Server" />
                            <span>Start iperf3 server before test</span>
                        </label>
                        <span class="form-help">Enable for devices that don't have iperf3 running persistently</span>
                    </div>

                    @if (editingDevice.StartIperf3Server)
                    {
                        <div class="form-group">
                            <label class="form-label">iperf3 Binary Path</label>
                            <input type="text" class="form-control" @bind="editingDevice.Iperf3BinaryPath" placeholder="iperf3" />
                            <span class="form-help">Full path to iperf3 on the remote device (e.g., /usr/local/bin/iperf3). Leave blank to use "iperf3" from PATH.</span>
                        </div>

                        <div class="form-section-header" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            <h5 style="margin: 0 0 0.5rem 0; font-size: 0.95rem;">SSH Credential Overrides <span style="font-weight: normal; color: var(--text-muted);">(optional)</span></h5>
                            <span class="form-help">Leave blank to use global SSH settings from <a href="/settings">Settings</a>. Only fill in fields you want to override.</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">SSH Username</label>
                            <input type="text" class="form-control" @bind="editingDevice.SshUsername" placeholder="(use global setting)" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">SSH Password</label>
                            <input type="password" class="form-control" @bind="editingDevicePassword" placeholder="(use global setting)" />
                            <span class="form-help">Password is encrypted at rest</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">SSH Private Key Path</label>
                            <input type="text" class="form-control" @bind="editingDevice.SshPrivateKeyPath" placeholder="(use global setting)" />
                            <span class="form-help">Path to private key file on the server (e.g., /root/.ssh/id_rsa)</span>
                        </div>
                    }

                    <div class="action-buttons">
                        <button class="btn btn-primary" @onclick="SaveDevice" disabled="@savingDevice">
                            @if (savingDevice)
                            {
                                <span class="spinner"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>@(editingDevice.Id > 0 ? "Update Device" : "Add Device")</span>
                            }
                        </button>
                        <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(savedDeviceMessage))
            {
                @if (savedDeviceMessageClass == "success" && currentResult != null)
                {
                    <div class="alert alert-success alert-link" style="margin-top: 1rem;" @onclick="ScrollToLatestResult">
                        <span>@savedDeviceMessage</span>
                        <span class="alert-link-hint">Click to view details →</span>
                    </div>
                }
                else if (savedDeviceMessageClass == "info" && isRunningTest)
                {
                    <div class="alert alert-info alert-progress" style="margin-top: 1rem;">
                        <div class="alert-progress-bar" style="width: @(testProgressPercent)%"></div>
                        <span class="alert-progress-text">@savedDeviceMessage @testProgressPhaseVerbose...</span>
                    </div>
                }
                else
                {
                    <div class="alert alert-@savedDeviceMessageClass" style="margin-top: 1rem;">
                        @savedDeviceMessage
                    </div>
                }
            }
        </div>
    </div>

    <!-- Current Test Results -->
    @if (currentResult != null)
    {
        <div class="card" id="latest-result">
            <div class="card-header">
                <h2 class="card-title">Latest Test Result</h2>
                <span class="status-badge status-@(currentResult.Success ? "connected" : "disconnected")">
                    @(currentResult.Success ? "Success" : "Failed")
                </span>
            </div>
            <div class="card-body">
                @if (currentResult.Success)
                {
                    <SpeedTestDetails Result="currentResult" />
                }
                else
                {
                    <div class="alert alert-danger">
                        <strong>Test Failed:</strong> @currentResult.ErrorMessage
                    </div>
                }
            </div>
        </div>
    }

    <!-- Test History -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Test History</h2>
            <div class="header-actions">
                <button class="btn btn-sm btn-secondary" @onclick="LoadHistory">Refresh</button>
                @if (testHistory.Count > 0)
                {
                    <button class="btn btn-sm btn-danger" @onclick="ClearHistory" disabled="@clearingHistory">
                        @if (clearingHistory)
                        {
                            <span class="spinner-sm"></span>
                            <span>Clearing...</span>
                        }
                        else
                        {
                            <span>Clear History</span>
                        }
                    </button>
                }
            </div>
        </div>
        <div class="card-body">
            @if (testHistory.Count > 0)
            {
                <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Device</th>
                            <th>
                                <span class="tooltip-wrapper tooltip-bottom">
                                    ↓ Mbps
                                    <span class="tooltip-icon">?</span>
                                    <span class="tooltip-content">
                                        <strong>From Device</strong><br />
                                        Data transferred from the tested device.
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="tooltip-wrapper tooltip-bottom">
                                    ↑ Mbps
                                    <span class="tooltip-icon">?</span>
                                    <span class="tooltip-content">
                                        <strong>To Device</strong><br />
                                        Data transferred to the tested device.
                                    </span>
                                </span>
                            </th>
                            <th>
                                <span class="tooltip-wrapper tooltip-bottom">
                                    Streams
                                    <span class="tooltip-icon">?</span>
                                    <span class="tooltip-content">
                                        Parallel TCP streams used for this test. Configure per device type in <a href="/settings#speed-test-settings">Settings</a>.
                                    </span>
                                </span>
                            </th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var result in pagedHistory)
                        {
                            var isExpanded = expandedHistoryId == result.Id;
                            <tr id="result-@result.Id"
                                class="@(result.Success ? "" : "error-row") @(result.Success ? "history-row-clickable" : "") @(isExpanded ? "history-row-expanded" : "")"
                                @onclick="@(() => { if (result.Success) ToggleHistoryExpand(result.Id); })">
                                <td>@result.TestTime.ToLocalTime().ToString("MMM dd HH:mm")</td>
                                <td>@(result.DeviceName ?? result.DeviceHost)</td>
                                <td>@(result.Success ? result.DownloadMbps.ToString("F1") : "-")</td>
                                <td>@(result.Success ? result.UploadMbps.ToString("F1") : "-")</td>
                                <td>@result.ParallelStreams</td>
                                <td>
                                    @if (result.Success)
                                    {
                                        <span class="status-badge status-connected">OK</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disconnected">Failed</span>
                                        <span class="tooltip-icon tooltip-icon-sm" data-tooltip="@result.ErrorMessage">?</span>
                                    }
                                </td>
                                <td class="expand-chevron">
                                    @if (result.Success)
                                    {
                                        <span>@(isExpanded ? "▲" : "▼")</span>
                                    }
                                </td>
                            </tr>
                            @if (result.Success)
                            {
                                <tr class="history-details-row">
                                    <td colspan="7">
                                        <div class="expand-wrapper @(isExpanded ? "expanded" : "")">
                                            <div class="expand-content">
                                                <div class="history-details">
                                                    @{
                                                        // Use stored path analysis if available, otherwise use result's analysis
                                                        var pathAnalysis = historyPathAnalysis.GetValueOrDefault(result.Id) ?? result.PathAnalysis;
                                                    }
                                                    <SpeedTestDetails Result="result" PathAnalysis="pathAnalysis" />

                                                    @if (pathAnalysis == null && ConnectionService.IsConnected)
                                                    {
                                                        <div class="analyze-path-action">
                                                            <button class="btn btn-sm btn-secondary"
                                                                    @onclick="() => AnalyzeHistoricalPath(result)"
                                                                    @onclick:stopPropagation="true"
                                                                    disabled="@(analyzingResultId == result.Id)">
                                                                @if (analyzingResultId == result.Id)
                                                                {
                                                                    <span>Analyzing...</span>
                                                                }
                                                                else
                                                                {
                                                                    <span>Analyze Path</span>
                                                                }
                                                            </button>
                                                            <span class="analyze-hint">Calculate network path and grade performance</span>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
                </div>
                @if (historyTotalPages > 1)
                {
                    <div class="pagination">
                        <button class="btn btn-sm btn-secondary" disabled="@(historyPage <= 1)" @onclick="() => historyPage--">← Prev</button>
                        <span class="pagination-info">Page @historyPage of @historyTotalPages (@testHistory.Count total)</span>
                        <button class="btn btn-sm btn-secondary" disabled="@(historyPage >= historyTotalPages)" @onclick="() => historyPage++">Next →</button>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <p>No test results yet. Configure a device and run a speed test to see results.</p>
                </div>
            }
        </div>
    </div>

    <!-- Test Locations Map -->
    <SpeedTestMap Results="testHistory"
                  OnRefresh="LoadHistory"
                  OnResultClick="ScrollToResult" />

    <!-- How it Works -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">How it Works</h2>
        </div>
        <div class="card-body">
            <div class="info-section">
                <p>This tool tests the network throughput between your Network Optimizer container and UniFi devices:</p>
                <ol>
                    <li><strong>SSH Connection:</strong> Connects to the device using the shared credentials from <a href="/settings">Settings</a></li>
                    <li><strong>Start Server:</strong> Launches <code>iperf3 -s</code> on the UniFi device (all UniFi devices have iperf3 built-in)</li>
                    <li><strong>To Device:</strong> Runs <code>iperf3 -c &lt;device&gt; -P 3</code> from the container to measure throughput to the device</li>
                    <li><strong>From Device:</strong> Runs <code>iperf3 -c &lt;device&gt; -P 3 -R</code> to measure throughput from the device</li>
                    <li><strong>Cleanup:</strong> Stops the iperf3 server on the device</li>
                </ol>
                <p class="form-help">
                    <strong>Note:</strong> This tests the infrastructure path between Network Optimizer and your UniFi or other devices.
                    Useful for validating AP backhaul, switch uplinks, and identifying cabling or hardware issues.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    /* Page-specific layout */
    .speedtest-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .gateway-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        align-items: center;
    }

    .gateway-actions .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    /* iperf3 status display */
    .iperf3-status {
        background: var(--bg-tertiary);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin: 1rem 0;
        font-size: 0.8125rem;
    }

    .status-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.25rem 0;
    }

    .status-row .status-label {
        color: var(--text-secondary);
        min-width: 120px;
    }

    /* Table row states */
    .error-row {
        opacity: 0.7;
    }

    /* How it works section */
    .info-section ol {
        margin: 1rem 0;
        padding-left: 1.5rem;
    }

    .info-section li {
        margin-bottom: 0.5rem;
    }

    .info-section code {
        background: var(--bg-primary);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .analyze-path-action {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .analyze-hint {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Client speed test link */
    .client-speedtest-link {
        display: inline-block;
        margin-top: 0.5rem;
        padding: 0.375rem 0.75rem;
        background: var(--bg-tertiary);
        border-radius: var(--border-radius);
        color: var(--accent-color);
        text-decoration: none;
        font-size: 0.875rem;
        transition: background-color 0.15s ease;
    }

    .client-speedtest-link:hover {
        background: var(--bg-secondary);
        text-decoration: none;
    }

    /* iperf3 version badge */
    .iperf3-version-badge {
        margin-top: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .iperf3-version-badge .version-label {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .iperf3-version-badge .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    /* iperf3 missing warning */
    .iperf3-missing-alert {
        margin-bottom: 1.5rem;
    }

    .iperf3-missing-content {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .iperf3-missing-icon {
        flex-shrink: 0;
        width: 2.5rem;
        height: 2.5rem;
        background: var(--danger-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.5rem;
    }

    .iperf3-missing-text {
        flex: 1;
    }

    .iperf3-missing-text p {
        margin: 0.5rem 0;
    }

    .iperf3-error-detail {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .iperf3-error-detail code {
        background: rgba(0, 0, 0, 0.1);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
    }

    .iperf3-install-hint {
        font-size: 0.875rem;
        background: rgba(0, 0, 0, 0.05);
        padding: 0.75rem;
        border-radius: var(--border-radius);
        margin-top: 0.75rem !important;
    }

    .iperf3-install-hint code {
        background: rgba(0, 0, 0, 0.1);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
    }

    /* Client speed test promotion card */
    .client-speedtest-card {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        border: 1px solid var(--accent-color);
        margin-bottom: 1.5rem;
    }

    .client-speedtest-promo {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .promo-content {
        flex: 1;
        min-width: 250px;
    }

    .promo-content h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.125rem;
        color: var(--accent-color);
    }

    .promo-content p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .client-speedtest-promo .btn {
        flex-shrink: 0;
        white-space: nowrap;
        margin-right: 2rem;
    }

    @@media (max-width: 768px) {
        .client-speedtest-promo {
            flex-direction: column;
            align-items: stretch;
            text-align: center;
        }

        .client-speedtest-promo .btn {
            align-self: center;
            margin-right: 0;
        }
    }

    /* Locked out state */
    .speedtest-container.locked-out {
        opacity: 0.5;
        pointer-events: none;
        user-select: none;
    }

    .speedtest-container.locked-out::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: transparent;
        cursor: not-allowed;
    }
</style>

@code {
    // Local iperf3 availability
    private LocalIperf3Status? localIperf3Status;
    private bool recheckingIperf3 = false;

    private List<DeviceSshConfiguration> devices = new();
    private DeviceSshConfiguration editingDevice = new() { DeviceType = DeviceType.Server, Enabled = true };
    private List<Iperf3Result> testHistory = new();
    private Iperf3Result? currentResult;
    private bool sshConfigured = false;

    // Pagination
    private int historyPage = 1;
    private int historyPageSize = 10;
    private int historyTotalPages => (int)Math.Ceiling(testHistory.Count / (double)historyPageSize);
    private IEnumerable<Iperf3Result> pagedHistory => testHistory.Skip((historyPage - 1) * historyPageSize).Take(historyPageSize);

    // Discovered devices from UniFi controller (using unified discovery service)
    private List<DiscoveredDevice> discoveredDevices = new();
    private bool loadingDiscovered = false;

    // Saved devices form state
    private bool showAddDevice = false;
    private bool savingDevice = false;
    private bool isRunningTest = false;
    private string? runningTestHost;
    private string editingDevicePassword = ""; // Separate field for password input (not bound to encrypted value)

    // UniFi Device Speed Test messages (discovered devices)
    private string unifiMessage = "";
    private string unifiMessageClass = "";

    // Other Device Speed Test messages (saved devices)
    private string savedDeviceMessage = "";
    private string savedDeviceMessageClass = "";

    // History state
    private bool clearingHistory = false;
    private int? expandedHistoryId = null;

    // Path analysis for historical results (calculated on demand)
    private Dictionary<int, PathAnalysisResult?> historyPathAnalysis = new();
    private int? analyzingResultId = null;

    // Gateway Speed Test state
    private bool gatewayLoading = true;
    private bool gatewayConfigured = false;
    private bool gatewayRunning = false;
    private bool gatewayCheckingIperf3 = false;
    private bool gatewayExpanded = false;
    private string gatewayMessage = "";
    private string gatewayMessageClass = "";
    private GatewaySpeedTestResult? gatewayLastResult;
    private Iperf3Status? gatewayIperf3Status;

    // Test progress indicator (shared across all test types)
    private int testProgressPercent = 0;
    private string testProgressPhase = "";        // Abbreviated for buttons
    private string testProgressPhaseVerbose = ""; // Verbose for alerts
    private System.Timers.Timer? progressTimer;

    protected override async Task OnInitializedAsync()
    {
        // Check local iperf3 availability first (before any other operations)
        localIperf3Status = await SettingsService.CheckLocalIperf3Async();

        // Wait for UniFi controller connection (auto-connect happens in background on startup)
        await ConnectionService.WaitForConnectionAsync();

        await CheckSshConfiguration();
        await LoadGatewayConfiguration();
        await LoadDevices();
        await LoadHistory();
        await LoadDiscoveredDevices();
    }

    private async Task RecheckLocalIperf3()
    {
        recheckingIperf3 = true;
        StateHasChanged();

        try
        {
            localIperf3Status = await SettingsService.CheckLocalIperf3Async(forceRefresh: true);
        }
        finally
        {
            recheckingIperf3 = false;
            StateHasChanged();
        }
    }

    private async Task LoadGatewayConfiguration()
    {
        gatewayLoading = true;
        try
        {
            var settings = await GatewaySpeedTestService.GetSettingsAsync();
            gatewayConfigured = settings.Enabled && settings.HasCredentials && !string.IsNullOrEmpty(settings.Host);
            gatewayLastResult = GatewaySpeedTestService.GetLastResult();
        }
        finally
        {
            gatewayLoading = false;
        }
    }

    private async Task CheckGatewayIperf3()
    {
        gatewayCheckingIperf3 = true;
        gatewayMessage = "";
        StateHasChanged();

        try
        {
            gatewayIperf3Status = await GatewaySpeedTestService.CheckIperf3StatusAsync();

            if (gatewayIperf3Status.IsInstalled)
            {
                if (gatewayIperf3Status.IsRunning)
                {
                    gatewayMessage = $"iperf3 is installed and running on port {gatewayIperf3Status.Port}";
                    gatewayMessageClass = "success";
                }
                else
                {
                    gatewayMessage = "iperf3 is installed but server is not running";
                    gatewayMessageClass = "info";
                }
            }
            else
            {
                gatewayMessage = "iperf3 not found on gateway. Please install it.";
                gatewayMessageClass = "warning";
            }
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error checking iperf3: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            gatewayCheckingIperf3 = false;
            StateHasChanged();
        }
    }

    private async Task RunGatewaySpeedTest()
    {
        gatewayRunning = true;
        gatewayMessage = "";
        StartProgressTimer();
        StateHasChanged();

        try
        {
            gatewayLastResult = await GatewaySpeedTestService.RunSpeedTestAsync();

            if (gatewayLastResult.Success)
            {
                gatewayMessage = $"Test completed: {gatewayLastResult.DownloadMbps:F1} Mbps from / {gatewayLastResult.UploadMbps:F1} Mbps to device";
                gatewayMessageClass = "success";
            }
            else
            {
                gatewayMessage = $"Test failed: {gatewayLastResult.Error}";
                gatewayMessageClass = "danger";
            }

            // Refresh history to show the new result
            await LoadHistory();

            // Set currentResult to show in "Latest Test Result" section
            // (LoadHistory only sets it when null, but we want to show the new result)
            if (gatewayLastResult.Success && testHistory.Count > 0)
            {
                currentResult = testHistory[0];
            }
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error running test: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            StopProgressTimer();
            gatewayRunning = false;
            StateHasChanged();
        }
    }

    private async Task CheckSshConfiguration()
    {
        try
        {
            var settings = await SshService.GetSettingsAsync();
            sshConfigured = settings.Enabled && settings.HasCredentials;
        }
        catch
        {
            sshConfigured = false;
        }
    }

    private async Task LoadDevices()
    {
        try
        {
            devices = await SpeedTestService.GetDevicesAsync();
        }
        catch (Exception ex)
        {
            savedDeviceMessage = $"Error loading devices: {ex.Message}";
            savedDeviceMessageClass = "danger";
        }
    }

    private async Task LoadHistory()
    {
        try
        {
            // Load all results (map handles its own time filtering)
            testHistory = await SpeedTestService.GetRecentResultsAsync(count: 0);
            historyPage = 1; // Reset to first page when loading fresh data

            // Only set currentResult on initial page load (when it's null)
            // After running a test, currentResult is already set with fresh data - don't replace it
            if (currentResult == null && testHistory.Count > 0)
            {
                currentResult = testHistory[0];

                // PathAnalysis is normally a persisted snapshot - only calculate if missing
                // (for backwards compatibility with old tests before PathAnalysis was added)
                if (currentResult.PathAnalysis == null && ConnectionService.IsConnected)
                {
                    try
                    {
                        var path = await PathAnalyzer.CalculatePathAsync(currentResult.DeviceHost, currentResult.LocalIp);
                        currentResult.PathAnalysis = PathAnalyzer.AnalyzeSpeedTest(
                            path,
                            currentResult.DownloadMbps,
                            currentResult.UploadMbps,
                            currentResult.DownloadRetransmits,
                            currentResult.UploadRetransmits,
                            currentResult.DownloadBytes,
                            currentResult.UploadBytes);
                    }
                    catch
                    {
                        // Path analysis failed, leave as null
                    }
                }
            }
        }
        catch (Exception)
        {
            // History load errors are not critical, ignore silently
        }
        StateHasChanged();
    }

    private async Task ClearHistory()
    {
        clearingHistory = true;
        StateHasChanged();

        try
        {
            var count = await SpeedTestService.ClearHistoryAsync();
            testHistory.Clear();
            currentResult = null;
            historyPage = 1;
        }
        catch (Exception)
        {
            // Clear errors are not critical
        }
        finally
        {
            clearingHistory = false;
            StateHasChanged();
        }
    }

    private void EditDevice(DeviceSshConfiguration device)
    {
        editingDevice = new DeviceSshConfiguration
        {
            Id = device.Id,
            Name = device.Name,
            Host = device.Host,
            DeviceType = device.DeviceType,
            Enabled = device.Enabled,
            StartIperf3Server = device.StartIperf3Server,
            SshUsername = device.SshUsername,
            SshPrivateKeyPath = device.SshPrivateKeyPath
            // Note: Don't copy SshPassword - leave blank to not change it
        };
        editingDevicePassword = ""; // Clear password field (user must re-enter to change)
        savedDeviceMessage = "";
        StateHasChanged();
    }

    private void CancelEdit()
    {
        editingDevice = new DeviceSshConfiguration
        {
            DeviceType = DeviceType.Server,
            Enabled = true,
            StartIperf3Server = false
        };
        editingDevicePassword = "";
        showAddDevice = false;
        savedDeviceMessage = "";
        StateHasChanged();
    }

    private async Task SaveDevice()
    {
        if (string.IsNullOrWhiteSpace(editingDevice.Name) || string.IsNullOrWhiteSpace(editingDevice.Host))
        {
            savedDeviceMessage = "Name and Host are required";
            savedDeviceMessageClass = "danger";
            return;
        }

        savingDevice = true;
        savedDeviceMessage = "";
        StateHasChanged();

        try
        {
            // Only set password if user entered a new one (password field is separate from model)
            if (!string.IsNullOrEmpty(editingDevicePassword))
            {
                editingDevice.SshPassword = editingDevicePassword;
            }

            await SpeedTestService.SaveDeviceAsync(editingDevice);
            savedDeviceMessage = editingDevice.Id > 0 ? "Device updated successfully" : "Device added successfully";
            savedDeviceMessageClass = "success";

            await LoadDevices();
            CancelEdit();
        }
        catch (Exception ex)
        {
            savedDeviceMessage = $"Error saving device: {ex.Message}";
            savedDeviceMessageClass = "danger";
        }
        finally
        {
            savingDevice = false;
            StateHasChanged();
        }
    }

    private async Task DeleteDevice(DeviceSshConfiguration device)
    {
        try
        {
            await SpeedTestService.DeleteDeviceAsync(device.Id);
            savedDeviceMessage = $"Deleted device: {device.Name}";
            savedDeviceMessageClass = "success";
            await LoadDevices();
        }
        catch (Exception ex)
        {
            savedDeviceMessage = $"Error deleting device: {ex.Message}";
            savedDeviceMessageClass = "danger";
        }
        StateHasChanged();
    }

    private async Task TestConnection(DeviceSshConfiguration device)
    {
        savedDeviceMessage = $"Testing SSH connection to {device.Name}...";
        savedDeviceMessageClass = "info";
        StateHasChanged();

        try
        {
            // Use device-specific credentials if configured
            var (success, msg) = await SpeedTestService.TestConnectionAsync(device);
            if (success)
            {
                var (iperf3Available, version) = await SpeedTestService.CheckIperf3AvailableAsync(device);
                if (iperf3Available)
                {
                    savedDeviceMessage = $"SSH OK! iperf3 available: {version}";
                    savedDeviceMessageClass = "success";
                }
                else
                {
                    savedDeviceMessage = $"SSH OK, but iperf3 not found: {version}";
                    savedDeviceMessageClass = "warning";
                }
            }
            else
            {
                savedDeviceMessage = $"SSH connection failed: {msg}";
                savedDeviceMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            savedDeviceMessage = $"Error: {ex.Message}";
            savedDeviceMessageClass = "danger";
        }
        StateHasChanged();
    }

    private async Task RunSpeedTest(DeviceSshConfiguration device)
    {
        isRunningTest = true;
        runningTestHost = device.Host;
        savedDeviceMessage = $"Running speed test to {device.Name}...";
        savedDeviceMessageClass = "info";
        StartProgressTimer();
        StateHasChanged();

        try
        {
            currentResult = await SpeedTestService.RunSpeedTestAsync(device);

            if (currentResult.Success)
            {
                savedDeviceMessage = $"Speed test completed: {currentResult.DownloadMbps:F1} Mbps from / {currentResult.UploadMbps:F1} Mbps to device";
                savedDeviceMessageClass = "success";
            }
            else
            {
                savedDeviceMessage = $"Speed test failed: {currentResult.ErrorMessage}";
                savedDeviceMessageClass = "danger";
            }

            await LoadHistory();
        }
        catch (Exception ex)
        {
            savedDeviceMessage = $"Error running speed test: {ex.Message}";
            savedDeviceMessageClass = "danger";
        }
        finally
        {
            StopProgressTimer();
            isRunningTest = false;
            runningTestHost = null;
            StateHasChanged();
        }
    }

    private async Task ScrollToLatestResult()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('latest-result')?.scrollIntoView({ behavior: 'smooth', block: 'start' })");
    }

    private void ToggleHistoryExpand(int resultId)
    {
        expandedHistoryId = expandedHistoryId == resultId ? null : resultId;
    }

    private async Task ScrollToResult(int resultId)
    {
        // Find which page the result is on
        var index = testHistory.FindIndex(r => r.Id == resultId);
        if (index >= 0)
        {
            var targetPage = (index / historyPageSize) + 1;
            if (historyPage != targetPage)
            {
                historyPage = targetPage;
            }
        }

        // Expand the result
        expandedHistoryId = resultId;
        StateHasChanged();

        // Give time for the DOM to update, then scroll
        await Task.Delay(100);
        await JS.InvokeVoidAsync("eval", $@"
            (function() {{
                var el = document.getElementById('result-{resultId}');
                if (el) {{
                    el.scrollIntoView({{ behavior: 'smooth', block: 'center' }});
                    // Brief highlight effect
                    el.style.transition = 'background-color 0.3s';
                    el.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
                    setTimeout(function() {{ el.style.backgroundColor = ''; }}, 1500);
                }}
            }})();
        ");
    }

    private async Task AnalyzeHistoricalPath(Iperf3Result result)
    {
        if (analyzingResultId != null)
            return;

        analyzingResultId = result.Id;
        StateHasChanged();

        try
        {
            var path = await PathAnalyzer.CalculatePathAsync(result.DeviceHost, result.LocalIp);
            var analysis = PathAnalyzer.AnalyzeSpeedTest(
                path,
                result.DownloadMbps,
                result.UploadMbps,
                result.DownloadRetransmits,
                result.UploadRetransmits,
                result.DownloadBytes,
                result.UploadBytes);
            historyPathAnalysis[result.Id] = analysis;
        }
        catch
        {
            // Store null to indicate analysis failed
            historyPathAnalysis[result.Id] = null;
        }
        finally
        {
            analyzingResultId = null;
            StateHasChanged();
        }
    }

    private async Task LoadDiscoveredDevices()
    {
        if (!ConnectionService.IsConnected)
            return;

        // Invalidate cache to get fresh device list
        ConnectionService.InvalidateDeviceCache();

        loadingDiscovered = true;
        StateHasChanged();

        try
        {
            var allDevices = await ConnectionService.GetDiscoveredDevicesAsync();

            // Filter out gateway devices (have dedicated Gateway Speed Test section)
            // and MIPS devices (can't run iperf3)
            discoveredDevices = allDevices
                .Where(d => d.Type != DeviceType.Gateway && !d.IsMipsArchitecture)
                .OrderBy(d => d.Name)
                .ToList();
        }
        catch (Exception ex)
        {
            unifiMessage = $"Error loading devices: {ex.Message}";
            unifiMessageClass = "danger";
        }
        finally
        {
            loadingDiscovered = false;
            StateHasChanged();
        }
    }

    private async Task RunSpeedTestOnDiscovered(DiscoveredDevice device)
    {
        if (string.IsNullOrEmpty(device.IpAddress))
        {
            unifiMessage = $"Device {device.Name} has no IP address";
            unifiMessageClass = "danger";
            return;
        }

        isRunningTest = true;
        runningTestHost = device.IpAddress;
        unifiMessage = $"Running speed test to {device.Name}...";
        unifiMessageClass = "info";
        StartProgressTimer();
        StateHasChanged();

        try
        {
            // Create a temporary device config for the test
            // UniFi devices have iperf3 built-in but don't run it persistently
            var tempDevice = new DeviceSshConfiguration
            {
                Name = device.Name ?? "Unknown Device",
                Host = device.IpAddress,
                DeviceType = device.Type,
                Enabled = true,
                StartIperf3Server = true
            };

            currentResult = await SpeedTestService.RunSpeedTestAsync(tempDevice);

            if (currentResult.Success)
            {
                unifiMessage = $"Speed test completed: {currentResult.DownloadMbps:F1} Mbps from / {currentResult.UploadMbps:F1} Mbps to device";
                unifiMessageClass = "success";
            }
            else
            {
                unifiMessage = $"Speed test failed: {currentResult.ErrorMessage}";
                unifiMessageClass = "danger";
            }

            await LoadHistory();
        }
        catch (Exception ex)
        {
            unifiMessage = $"Error running speed test: {ex.Message}";
            unifiMessageClass = "danger";
        }
        finally
        {
            StopProgressTimer();
            isRunningTest = false;
            runningTestHost = null;
            StateHasChanged();
        }
    }

    // Progress indicator helpers
    // Phases: 0-3s = Starting (13%), 3-13s = From device (43%), 13-23s = To device (100%)
    private DateTime testStartTime;

    private void StartProgressTimer()
    {
        testStartTime = DateTime.UtcNow;
        testProgressPercent = 0;
        testProgressPhase = "Starting";
        testProgressPhaseVerbose = "Starting";

        progressTimer?.Dispose();
        progressTimer = new System.Timers.Timer(250); // Update every 250ms
        progressTimer.Elapsed += (s, e) => UpdateProgress();
        progressTimer.Start();
    }

    private void StopProgressTimer()
    {
        // Capture and null the reference first so UpdateProgress guard works immediately
        var timer = progressTimer;
        progressTimer = null;
        timer?.Stop();
        timer?.Dispose();
        testProgressPercent = 0;
        testProgressPhase = "";
        testProgressPhaseVerbose = "";
    }

    private void UpdateProgress()
    {
        // Guard against race condition - timer callback may fire after Stop()
        if (progressTimer == null) return;

        var elapsed = (DateTime.UtcNow - testStartTime).TotalSeconds;

        if (elapsed < 3)
        {
            // Starting phase: 0-13%
            testProgressPercent = (int)(elapsed / 3 * 13);
            testProgressPhase = "Starting";
            testProgressPhaseVerbose = "Starting";
        }
        else if (elapsed < 13)
        {
            // From device phase: 13-56%
            testProgressPercent = 13 + (int)((elapsed - 3) / 10 * 43);
            testProgressPhase = "↓ Testing";
            testProgressPhaseVerbose = "From device";
        }
        else if (elapsed < 23)
        {
            // To device phase: 56-100%
            testProgressPercent = 56 + (int)((elapsed - 13) / 10 * 44);
            testProgressPhase = "↑ Testing";
            testProgressPhaseVerbose = "To device";
        }
        else
        {
            testProgressPercent = 100;
            testProgressPhase = "Done";
            testProgressPhaseVerbose = "Finishing";
        }

        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        progressTimer?.Dispose();
    }
}
