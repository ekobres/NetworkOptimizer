@page "/speedtest"
@rendermode InteractiveServer
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.UniFi.Models
@using NetworkOptimizer.Core.Helpers
@inject Iperf3SpeedTestService SpeedTestService
@inject UniFiSshService SshService
@inject UniFiConnectionService ConnectionService
@inject GatewaySpeedTestService GatewaySpeedTestService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<PageTitle>LAN Speed Test - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>LAN Speed Test</h1>
    <p class="page-description">Test network bandwidth using iperf3</p>
</div>

<div class="speedtest-container">
    <!-- Gateway Speed Test Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Gateway Speed Test</h2>
            @if (gatewayLastResult != null)
            {
                <span class="status-badge status-@(gatewayLastResult.Success ? "connected" : "disconnected")">
                    @(gatewayLastResult.Success ? "Success" : "Failed")
                </span>
            }
        </div>
        <div class="card-body">
            @if (gatewayLoading)
            {
                <div class="loading-state">
                    <span class="spinner"></span>
                    <span>Loading...</span>
                </div>
            }
            else if (!gatewayConfigured)
            {
                <div class="alert alert-warning">
                    <strong>Gateway SSH not configured.</strong>
                    Go to <a href="/settings">Settings</a> to configure Gateway SSH credentials before running gateway speed tests.
                </div>
            }
            else
            {
                <p class="section-description">
                    Test LAN bandwidth to your gateway using iperf3.
                </p>

                <!-- iperf3 Status -->
                @if (gatewayIperf3Status != null)
                {
                    <div class="iperf3-status">
                        <div class="status-row">
                            <span class="status-label">iperf3 Status:</span>
                            @if (gatewayIperf3Status.IsInstalled)
                            {
                                <span class="status-badge status-connected">Installed</span>
                            }
                            else
                            {
                                <span class="status-badge status-disconnected">Not Found</span>
                            }
                        </div>
                        @if (gatewayIperf3Status.IsRunning)
                        {
                            <div class="status-row">
                                <span class="status-label">Server Running:</span>
                                <span class="status-badge status-connected">Port @gatewayIperf3Status.Port</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(gatewayIperf3Status.Version))
                        {
                            <div class="status-row">
                                <span class="status-label">Version:</span>
                                <span>@gatewayIperf3Status.Version</span>
                            </div>
                        }
                    </div>
                }

                <!-- Last Result Summary -->
                @if (gatewayLastResult != null && gatewayLastResult.Success)
                {
                    <div class="result-box @(gatewayExpanded ? "expanded" : "")" @onclick="() => gatewayExpanded = !gatewayExpanded">
                        <div class="result-box-header">
                            <span class="result-speeds">
                                <span class="result-speed" title="From Device: Data sent from gateway to test server">↓ @gatewayLastResult.DownloadMbps.ToString("F1")</span>
                                <span class="result-speed" title="To Device: Data sent to gateway from test server">↑ @gatewayLastResult.UploadMbps.ToString("F1")</span>
                                <span class="result-unit">Mbps</span>
                            </span>
                            <span class="result-box-right">
                                <span class="result-time">@gatewayLastResult.TestTime.ToLocalTime().ToString("MMM dd, HH:mm")</span>
                                <span class="result-expand-hint">@(gatewayExpanded ? "▲" : "▼")</span>
                            </span>
                        </div>
                        <div class="result-box-details">
                            <div class="result-box-details-inner">
                                <SpeedTestDetails GatewayResult="gatewayLastResult" />
                            </div>
                        </div>
                    </div>
                }
                else if (gatewayLastResult != null && !gatewayLastResult.Success)
                {
                    <div class="alert alert-danger">
                        <strong>Test Failed:</strong> @gatewayLastResult.Error
                    </div>
                }

                <!-- Actions -->
                <div class="gateway-actions">
                    <button class="btn btn-primary" style="min-width: 10.5rem;" @onclick="RunGatewaySpeedTest" disabled="@gatewayRunning">
                        @if (gatewayRunning)
                        {
                            <span class="spinner"></span>
                            <span>Testing...</span>
                        }
                        else
                        {
                            <span>Run Gateway Test</span>
                        }
                    </button>
                    <button class="btn btn-secondary" style="min-width: 7.5rem;" @onclick="CheckGatewayIperf3" disabled="@gatewayCheckingIperf3">
                        @if (gatewayCheckingIperf3)
                        {
                            <span class="spinner"></span>
                            <span>Checking...</span>
                        }
                        else
                        {
                            <span>Check iperf3</span>
                        }
                    </button>
                    <button class="btn btn-secondary" @onclick="@(() => NavigationManager.NavigateTo("/settings"))">Settings</button>
                </div>

                @if (!string.IsNullOrEmpty(gatewayMessage))
                {
                    <div class="alert alert-@gatewayMessageClass" style="margin-top: 1rem;">
                        @gatewayMessage
                    </div>
                }
            }
        </div>
    </div>

    <!-- SSH Credentials Status -->
    @if (!sshConfigured)
    {
        <div class="alert alert-warning">
            <strong>SSH credentials not configured.</strong>
            Go to <a href="/settings">Settings</a> to configure UniFi Device SSH credentials before running speed tests.
        </div>
    }

    <!-- Discovered Devices from UniFi Controller -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">UniFi Device Speed Test</h2>
            <div class="header-actions">
                <button class="btn btn-sm btn-secondary" @onclick="LoadDiscoveredDevices" disabled="@(!ConnectionService.IsConnected || loadingDiscovered)">
                    @if (loadingDiscovered)
                    {
                        <span class="spinner"></span>
                        <span>Scanning...</span>
                    }
                    else
                    {
                        <span>Refresh</span>
                    }
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="section-description">
                Select any non-gateway device to run a speed test. Devices are auto-discovered from your UniFi controller.
            </p>

            @if (!ConnectionService.IsConnected)
            {
                <div class="alert alert-warning">
                    Connect to your UniFi controller in <a href="/settings">Settings</a> to discover devices.
                </div>
            }
            else if (discoveredDevices.Count > 0)
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Model</th>
                            <th>IP Address</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var device in discoveredDevices)
                        {
                            var isOnline = device.State == 1 && device.Adopted;
                            <tr>
                                <td>@device.Name</td>
                                <td><code>@device.FriendlyModelName</code></td>
                                <td><code>@device.Ip</code></td>
                                <td>@GetDeviceTypeDisplay(device.Type)</td>
                                <td>
                                    @if (isOnline)
                                    {
                                        <span class="status-badge status-connected">Online</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disconnected">Offline</span>
                                    }
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-primary btn-sm" style="min-width: 6.5rem;"
                                                @onclick="() => RunSpeedTestOnDiscovered(device)"
                                                disabled="@(isRunningTest || !isOnline || !sshConfigured || string.IsNullOrEmpty(device.Ip))">
                                            @if (runningTestHost == device.Ip)
                                            {
                                                <span class="spinner"></span>
                                                <span>Testing...</span>
                                            }
                                            else
                                            {
                                                <span>Run Test</span>
                                            }
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else if (!loadingDiscovered)
            {
                <p class="empty-state">No devices found. Click Refresh to scan for devices.</p>
            }

            @if (!string.IsNullOrEmpty(unifiMessage))
            {
                @if (unifiMessageClass == "success")
                {
                    <div class="alert alert-success alert-link" style="margin-top: 1rem;" @onclick="ScrollToLatestResult">
                        <span>@unifiMessage</span>
                        <span class="alert-link-hint">Click to view details →</span>
                    </div>
                }
                else
                {
                    <div class="alert alert-@unifiMessageClass" style="margin-top: 1rem;">
                        @unifiMessage
                    </div>
                }
            }
        </div>
    </div>

    <!-- Saved Devices (for repeated testing) -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Other Device Speed Test</h2>
            <div class="header-actions">
                <button class="btn btn-sm btn-secondary" @onclick="() => showAddDevice = !showAddDevice">
                    @(showAddDevice ? "Cancel" : "Add Device")
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="section-description">
                Test speed to servers, desktops, and other devices. SSH credentials are configured in <a href="/settings">Settings</a>.
            </p>

            @if (devices.Count > 0)
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Host</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var device in devices)
                        {
                            <tr>
                                <td>@device.Name</td>
                                <td><code>@device.Host</code></td>
                                <td>@GetSavedDeviceTypeDisplay(device.DeviceType)</td>
                                <td>
                                    @if (device.Enabled)
                                    {
                                        <span class="status-badge status-connected">Enabled</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disconnected">Disabled</span>
                                    }
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-primary btn-sm" style="min-width: 6.5rem;" @onclick="() => RunSpeedTest(device)"
                                                disabled="@(isRunningTest || !device.Enabled || !sshConfigured)">
                                            @if (runningTestHost == device.Host)
                                            {
                                                <span class="spinner"></span>
                                                <span>Testing...</span>
                                            }
                                            else
                                            {
                                                <span>Run Test</span>
                                            }
                                        </button>
                                        <button class="btn btn-secondary btn-sm" style="min-width: 5rem; @(device.StartIperf3Server ? "" : "visibility: hidden;")"
                                                @onclick="() => TestConnection(device)" disabled="@(!sshConfigured)">Test SSH</button>
                                        <button class="btn btn-secondary btn-sm" @onclick="() => EditDevice(device)">Edit</button>
                                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteDevice(device)">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else if (!showAddDevice)
            {
                <p class="empty-state">No saved devices. Click "Add Device" to add a server or other device for testing.</p>
            }

            @if (showAddDevice || editingDevice.Id > 0)
            {
                <div class="add-device-form" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <h4>@(editingDevice.Id > 0 ? "Edit Device" : "Add Device")</h4>

                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Device Name</label>
                            <input type="text" class="form-control" @bind="editingDevice.Name" placeholder="My Server" />
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Type</label>
                            <select class="form-control" @bind="editingDevice.DeviceType">
                                <option value="Server">Server</option>
                                <option value="Desktop">Desktop</option>
                                <option value="AccessPoint">Access Point</option>
                                <option value="Switch">Switch</option>
                                <option value="Gateway">Gateway</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Host / IP Address</label>
                        <input type="text" class="form-control" @bind="editingDevice.Host" placeholder="192.168.1.10" />
                    </div>

                    <div class="form-group">
                        <label class="form-check">
                            <input type="checkbox" @bind="editingDevice.Enabled" />
                            <span>Enable for speed testing</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-check">
                            <input type="checkbox" @bind="editingDevice.StartIperf3Server" />
                            <span>Start iperf3 server before test</span>
                        </label>
                        <span class="form-help">Enable for devices that don't have iperf3 running persistently</span>
                    </div>

                    <div class="form-section-header" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <h5 style="margin: 0 0 0.5rem 0; font-size: 0.95rem;">SSH Credential Overrides <span style="font-weight: normal; color: var(--text-muted);">(optional)</span></h5>
                        <span class="form-help">Leave blank to use global SSH settings from <a href="/settings">Settings</a>. Only fill in fields you want to override.</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">SSH Username</label>
                        <input type="text" class="form-control" @bind="editingDevice.SshUsername" placeholder="(use global setting)" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">SSH Password</label>
                        <input type="password" class="form-control" @bind="editingDevicePassword" placeholder="(use global setting)" />
                        <span class="form-help">Password is encrypted at rest</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">SSH Private Key Path</label>
                        <input type="text" class="form-control" @bind="editingDevice.SshPrivateKeyPath" placeholder="(use global setting)" />
                        <span class="form-help">Path to private key file on the server (e.g., /root/.ssh/id_rsa)</span>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" @onclick="SaveDevice" disabled="@savingDevice">
                            @if (savingDevice)
                            {
                                <span class="spinner"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>@(editingDevice.Id > 0 ? "Update Device" : "Add Device")</span>
                            }
                        </button>
                        <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(savedDeviceMessage))
            {
                @if (savedDeviceMessageClass == "success" && currentResult != null)
                {
                    <div class="alert alert-success alert-link" style="margin-top: 1rem;" @onclick="ScrollToLatestResult">
                        <span>@savedDeviceMessage</span>
                        <span class="alert-link-hint">Click to view details →</span>
                    </div>
                }
                else
                {
                    <div class="alert alert-@savedDeviceMessageClass" style="margin-top: 1rem;">
                        @savedDeviceMessage
                    </div>
                }
            }
        </div>
    </div>

    <!-- Current Test Results -->
    @if (currentResult != null)
    {
        <div class="card" id="latest-result">
            <div class="card-header">
                <h2 class="card-title">Latest Test Result</h2>
                <span class="status-badge status-@(currentResult.Success ? "connected" : "disconnected")">
                    @(currentResult.Success ? "Success" : "Failed")
                </span>
            </div>
            <div class="card-body">
                @if (currentResult.Success)
                {
                    <SpeedTestDetails Result="currentResult" />
                }
                else
                {
                    <div class="alert alert-danger">
                        <strong>Test Failed:</strong> @currentResult.ErrorMessage
                    </div>
                }
            </div>
        </div>
    }

    <!-- Test History -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Test History</h2>
            <div class="header-actions">
                <button class="btn btn-sm btn-secondary" @onclick="LoadHistory">Refresh</button>
                @if (testHistory.Count > 0)
                {
                    <button class="btn btn-sm btn-danger" @onclick="ClearHistory" disabled="@clearingHistory">
                        @if (clearingHistory)
                        {
                            <span class="spinner-sm"></span>
                            <span>Clearing...</span>
                        }
                        else
                        {
                            <span>Clear History</span>
                        }
                    </button>
                }
            </div>
        </div>
        <div class="card-body">
            @if (testHistory.Count > 0)
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Device</th>
                            <th title="From Device: Data sent from device to test server">↓ Mbps</th>
                            <th title="To Device: Data sent to device from test server">↑ Mbps</th>
                            <th title="Parallel TCP streams used for this test. Configure per device type in Settings.">Streams</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var result in pagedHistory)
                        {
                            var isExpanded = expandedHistoryId == result.Id;
                            <tr class="@(result.Success ? "" : "error-row") @(result.Success ? "history-row-clickable" : "") @(isExpanded ? "history-row-expanded" : "")"
                                @onclick="@(() => { if (result.Success) ToggleHistoryExpand(result.Id); })">
                                <td>@result.TestTime.ToLocalTime().ToString("MMM dd HH:mm")</td>
                                <td>@(result.DeviceName ?? result.DeviceHost)</td>
                                <td>@(result.Success ? result.DownloadMbps.ToString("F1") : "-")</td>
                                <td>@(result.Success ? result.UploadMbps.ToString("F1") : "-")</td>
                                <td>@result.ParallelStreams</td>
                                <td>
                                    @if (result.Success)
                                    {
                                        <span class="status-badge status-connected">OK</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disconnected" title="@result.ErrorMessage">Failed</span>
                                    }
                                </td>
                                <td class="expand-chevron">
                                    @if (result.Success)
                                    {
                                        <span>@(isExpanded ? "▲" : "▼")</span>
                                    }
                                </td>
                            </tr>
                            @if (result.Success)
                            {
                                <tr class="history-details-row">
                                    <td colspan="7">
                                        <div class="expand-wrapper @(isExpanded ? "expanded" : "")">
                                            <div class="expand-content">
                                                <div class="history-details">
                                                    <SpeedTestDetails Result="result" />
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
                @if (historyTotalPages > 1)
                {
                    <div class="pagination">
                        <button class="btn btn-sm btn-secondary" disabled="@(historyPage <= 1)" @onclick="() => historyPage--">← Prev</button>
                        <span class="pagination-info">Page @historyPage of @historyTotalPages (@testHistory.Count total)</span>
                        <button class="btn btn-sm btn-secondary" disabled="@(historyPage >= historyTotalPages)" @onclick="() => historyPage++">Next →</button>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <p>No test results yet. Configure a device and run a speed test to see results.</p>
                </div>
            }
        </div>
    </div>

    <!-- How it Works -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">How it Works</h2>
        </div>
        <div class="card-body">
            <div class="info-section">
                <p>This tool tests the network throughput between your Network Optimizer container and UniFi devices:</p>
                <ol>
                    <li><strong>SSH Connection:</strong> Connects to the device using the shared credentials from <a href="/settings">Settings</a></li>
                    <li><strong>Start Server:</strong> Launches <code>iperf3 -s</code> on the UniFi device (all UniFi devices have iperf3 built-in)</li>
                    <li><strong>Upload Test:</strong> Runs <code>iperf3 -c &lt;device&gt; -P 3</code> from the container to test upload speed</li>
                    <li><strong>Download Test:</strong> Runs <code>iperf3 -c &lt;device&gt; -P 3 -R</code> to test download speed</li>
                    <li><strong>Cleanup:</strong> Stops the iperf3 server on the device</li>
                </ol>
                <p class="form-help">
                    <strong>Note:</strong> This tests the wired/wireless path between your Docker host and the device.
                    For APs, this is useful to validate backhaul performance. For switches/gateways, it tests the internal network path.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    /* Page-specific layout */
    .speedtest-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .gateway-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        align-items: center;
    }

    .gateway-actions .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    /* iperf3 status display */
    .iperf3-status {
        background: var(--bg-tertiary);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin: 1rem 0;
    }

    .status-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.25rem 0;
    }

    .status-row .status-label {
        color: var(--text-secondary);
        min-width: 120px;
    }

    /* Table row states */
    .error-row {
        opacity: 0.7;
    }

    /* How it works section */
    .info-section ol {
        margin: 1rem 0;
        padding-left: 1.5rem;
    }

    .info-section li {
        margin-bottom: 0.5rem;
    }

    .info-section code {
        background: var(--bg-primary);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }
</style>

@code {
    private List<DeviceSshConfiguration> devices = new();
    private DeviceSshConfiguration editingDevice = new() { DeviceType = "Server", Enabled = true };
    private List<Iperf3Result> testHistory = new();
    private Iperf3Result? currentResult;
    private bool sshConfigured = false;

    // Pagination
    private int historyPage = 1;
    private int historyPageSize = 10;
    private int historyTotalPages => (int)Math.Ceiling(testHistory.Count / (double)historyPageSize);
    private IEnumerable<Iperf3Result> pagedHistory => testHistory.Skip((historyPage - 1) * historyPageSize).Take(historyPageSize);

    // Discovered devices from UniFi controller
    private List<UniFiDeviceResponse> discoveredDevices = new();
    private bool loadingDiscovered = false;

    // Saved devices form state
    private bool showAddDevice = false;
    private bool savingDevice = false;
    private bool isRunningTest = false;
    private string? runningTestHost;
    private string editingDevicePassword = ""; // Separate field for password input (not bound to encrypted value)

    // UniFi Device Speed Test messages (discovered devices)
    private string unifiMessage = "";
    private string unifiMessageClass = "";

    // Other Device Speed Test messages (saved devices)
    private string savedDeviceMessage = "";
    private string savedDeviceMessageClass = "";

    // History state
    private bool clearingHistory = false;
    private int? expandedHistoryId = null;

    // Gateway Speed Test state
    private bool gatewayLoading = true;
    private bool gatewayConfigured = false;
    private bool gatewayRunning = false;
    private bool gatewayCheckingIperf3 = false;
    private bool gatewayExpanded = false;
    private string gatewayMessage = "";
    private string gatewayMessageClass = "";
    private GatewaySpeedTestResult? gatewayLastResult;
    private Iperf3Status? gatewayIperf3Status;

    protected override async Task OnInitializedAsync()
    {
        await CheckSshConfiguration();
        await LoadGatewayConfiguration();
        await LoadDevices();
        await LoadHistory();
        await LoadDiscoveredDevices();
    }

    private async Task LoadGatewayConfiguration()
    {
        gatewayLoading = true;
        try
        {
            var settings = await GatewaySpeedTestService.GetSettingsAsync();
            gatewayConfigured = settings.Enabled && settings.HasCredentials && !string.IsNullOrEmpty(settings.Host);
            gatewayLastResult = GatewaySpeedTestService.GetLastResult();
        }
        finally
        {
            gatewayLoading = false;
        }
    }

    private async Task CheckGatewayIperf3()
    {
        gatewayCheckingIperf3 = true;
        gatewayMessage = "";
        StateHasChanged();

        try
        {
            gatewayIperf3Status = await GatewaySpeedTestService.CheckIperf3StatusAsync();

            if (gatewayIperf3Status.IsInstalled)
            {
                if (gatewayIperf3Status.IsRunning)
                {
                    gatewayMessage = $"iperf3 is installed and running on port {gatewayIperf3Status.Port}";
                    gatewayMessageClass = "success";
                }
                else
                {
                    gatewayMessage = "iperf3 is installed but server is not running";
                    gatewayMessageClass = "info";
                }
            }
            else
            {
                gatewayMessage = "iperf3 not found on gateway. Please install it.";
                gatewayMessageClass = "warning";
            }
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error checking iperf3: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            gatewayCheckingIperf3 = false;
            StateHasChanged();
        }
    }

    private async Task RunGatewaySpeedTest()
    {
        gatewayRunning = true;
        gatewayMessage = "";
        StateHasChanged();

        try
        {
            gatewayLastResult = await GatewaySpeedTestService.RunSpeedTestAsync();

            if (gatewayLastResult.Success)
            {
                gatewayMessage = $"Test completed: {gatewayLastResult.DownloadMbps:F1} Mbps from / {gatewayLastResult.UploadMbps:F1} Mbps to device";
                gatewayMessageClass = "success";
            }
            else
            {
                gatewayMessage = $"Test failed: {gatewayLastResult.Error}";
                gatewayMessageClass = "danger";
            }

            // Refresh history to show the new result
            await LoadHistory();
        }
        catch (Exception ex)
        {
            gatewayMessage = $"Error running test: {ex.Message}";
            gatewayMessageClass = "danger";
        }
        finally
        {
            gatewayRunning = false;
            StateHasChanged();
        }
    }

    private async Task CheckSshConfiguration()
    {
        try
        {
            var settings = await SshService.GetSettingsAsync();
            sshConfigured = settings.Enabled && settings.HasCredentials;
        }
        catch
        {
            sshConfigured = false;
        }
    }

    private async Task LoadDevices()
    {
        try
        {
            devices = await SpeedTestService.GetDevicesAsync();
        }
        catch (Exception ex)
        {
            savedDeviceMessage = $"Error loading devices: {ex.Message}";
            savedDeviceMessageClass = "danger";
        }
    }

    private async Task LoadHistory()
    {
        try
        {
            testHistory = await SpeedTestService.GetRecentResultsAsync(100);
            historyPage = 1; // Reset to first page when loading fresh data

            // Set currentResult to most recent test
            if (testHistory.Count > 0)
            {
                currentResult = testHistory[0];
            }
        }
        catch (Exception)
        {
            // History load errors are not critical, ignore silently
        }
        StateHasChanged();
    }

    private async Task ClearHistory()
    {
        clearingHistory = true;
        StateHasChanged();

        try
        {
            var count = await SpeedTestService.ClearHistoryAsync();
            testHistory.Clear();
            currentResult = null;
            historyPage = 1;
        }
        catch (Exception)
        {
            // Clear errors are not critical
        }
        finally
        {
            clearingHistory = false;
            StateHasChanged();
        }
    }

    private void EditDevice(DeviceSshConfiguration device)
    {
        editingDevice = new DeviceSshConfiguration
        {
            Id = device.Id,
            Name = device.Name,
            Host = device.Host,
            DeviceType = device.DeviceType,
            Enabled = device.Enabled,
            StartIperf3Server = device.StartIperf3Server,
            SshUsername = device.SshUsername,
            SshPrivateKeyPath = device.SshPrivateKeyPath
            // Note: Don't copy SshPassword - leave blank to not change it
        };
        editingDevicePassword = ""; // Clear password field (user must re-enter to change)
        savedDeviceMessage = "";
        StateHasChanged();
    }

    private void CancelEdit()
    {
        editingDevice = new DeviceSshConfiguration
        {
            DeviceType = "Server",
            Enabled = true,
            StartIperf3Server = false
        };
        editingDevicePassword = "";
        showAddDevice = false;
        savedDeviceMessage = "";
        StateHasChanged();
    }

    private async Task SaveDevice()
    {
        if (string.IsNullOrWhiteSpace(editingDevice.Name) || string.IsNullOrWhiteSpace(editingDevice.Host))
        {
            savedDeviceMessage = "Name and Host are required";
            savedDeviceMessageClass = "danger";
            return;
        }

        savingDevice = true;
        savedDeviceMessage = "";
        StateHasChanged();

        try
        {
            // Only set password if user entered a new one (password field is separate from model)
            if (!string.IsNullOrEmpty(editingDevicePassword))
            {
                editingDevice.SshPassword = editingDevicePassword;
            }

            await SpeedTestService.SaveDeviceAsync(editingDevice);
            savedDeviceMessage = editingDevice.Id > 0 ? "Device updated successfully" : "Device added successfully";
            savedDeviceMessageClass = "success";

            await LoadDevices();
            CancelEdit();
        }
        catch (Exception ex)
        {
            savedDeviceMessage = $"Error saving device: {ex.Message}";
            savedDeviceMessageClass = "danger";
        }
        finally
        {
            savingDevice = false;
            StateHasChanged();
        }
    }

    private async Task DeleteDevice(DeviceSshConfiguration device)
    {
        try
        {
            await SpeedTestService.DeleteDeviceAsync(device.Id);
            savedDeviceMessage = $"Deleted device: {device.Name}";
            savedDeviceMessageClass = "success";
            await LoadDevices();
        }
        catch (Exception ex)
        {
            savedDeviceMessage = $"Error deleting device: {ex.Message}";
            savedDeviceMessageClass = "danger";
        }
        StateHasChanged();
    }

    private async Task TestConnection(DeviceSshConfiguration device)
    {
        savedDeviceMessage = $"Testing SSH connection to {device.Name}...";
        savedDeviceMessageClass = "info";
        StateHasChanged();

        try
        {
            // Use device-specific credentials if configured
            var (success, msg) = await SpeedTestService.TestConnectionAsync(device);
            if (success)
            {
                var (iperf3Available, version) = await SpeedTestService.CheckIperf3AvailableAsync(device);
                if (iperf3Available)
                {
                    savedDeviceMessage = $"SSH OK! iperf3 available: {version}";
                    savedDeviceMessageClass = "success";
                }
                else
                {
                    savedDeviceMessage = $"SSH OK, but iperf3 not found: {version}";
                    savedDeviceMessageClass = "warning";
                }
            }
            else
            {
                savedDeviceMessage = $"SSH connection failed: {msg}";
                savedDeviceMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            savedDeviceMessage = $"Error: {ex.Message}";
            savedDeviceMessageClass = "danger";
        }
        StateHasChanged();
    }

    private async Task RunSpeedTest(DeviceSshConfiguration device)
    {
        isRunningTest = true;
        runningTestHost = device.Host;
        savedDeviceMessage = $"Running speed test to {device.Name}... This may take up to 30 seconds.";
        savedDeviceMessageClass = "info";
        StateHasChanged();

        try
        {
            currentResult = await SpeedTestService.RunSpeedTestAsync(device);

            if (currentResult.Success)
            {
                savedDeviceMessage = $"Speed test completed: {currentResult.DownloadMbps:F1} Mbps from / {currentResult.UploadMbps:F1} Mbps to device";
                savedDeviceMessageClass = "success";
            }
            else
            {
                savedDeviceMessage = $"Speed test failed: {currentResult.ErrorMessage}";
                savedDeviceMessageClass = "danger";
            }

            await LoadHistory();
        }
        catch (Exception ex)
        {
            savedDeviceMessage = $"Error running speed test: {ex.Message}";
            savedDeviceMessageClass = "danger";
        }
        finally
        {
            isRunningTest = false;
            runningTestHost = null;
            StateHasChanged();
        }
    }

    private async Task ScrollToLatestResult()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('latest-result')?.scrollIntoView({ behavior: 'smooth', block: 'start' })");
    }

    private void ToggleHistoryExpand(int resultId)
    {
        expandedHistoryId = expandedHistoryId == resultId ? null : resultId;
    }

    private async Task LoadDiscoveredDevices()
    {
        if (!ConnectionService.IsConnected || ConnectionService.Client == null)
            return;

        loadingDiscovered = true;
        StateHasChanged();

        try
        {
            var allDevices = await ConnectionService.Client.GetDevicesAsync();

            // Filter out gateway devices (UDM, USG, etc.) and MIPS devices (can't run iperf3)
            discoveredDevices = allDevices
                .Where(d => !IsGatewayDevice(d.Type) && !d.IsMipsArchitecture)
                .OrderBy(d => d.Name)
                .ToList();
        }
        catch (Exception ex)
        {
            unifiMessage = $"Error loading devices: {ex.Message}";
            unifiMessageClass = "danger";
        }
        finally
        {
            loadingDiscovered = false;
            StateHasChanged();
        }
    }

    private bool IsGatewayDevice(string? type) => UniFiDeviceTypes.IsGateway(type);

    private async Task RunSpeedTestOnDiscovered(UniFiDeviceResponse device)
    {
        if (string.IsNullOrEmpty(device.Ip))
        {
            unifiMessage = $"Device {device.Name} has no IP address";
            unifiMessageClass = "danger";
            return;
        }

        isRunningTest = true;
        runningTestHost = device.Ip;
        unifiMessage = $"Running speed test to {device.Name}... This may take up to 30 seconds.";
        unifiMessageClass = "info";
        StateHasChanged();

        try
        {
            // Create a temporary device config for the test
            // UniFi devices have iperf3 built-in but don't run it persistently
            var tempDevice = new DeviceSshConfiguration
            {
                Name = device.Name ?? "Unknown Device",
                Host = device.Ip,
                DeviceType = GetDeviceTypeDisplay(device.Type),
                Enabled = true,
                StartIperf3Server = true
            };

            currentResult = await SpeedTestService.RunSpeedTestAsync(tempDevice);

            if (currentResult.Success)
            {
                unifiMessage = $"Speed test completed: {currentResult.DownloadMbps:F1} Mbps from / {currentResult.UploadMbps:F1} Mbps to device";
                unifiMessageClass = "success";
            }
            else
            {
                unifiMessage = $"Speed test failed: {currentResult.ErrorMessage}";
                unifiMessageClass = "danger";
            }

            await LoadHistory();
        }
        catch (Exception ex)
        {
            unifiMessage = $"Error running speed test: {ex.Message}";
            unifiMessageClass = "danger";
        }
        finally
        {
            isRunningTest = false;
            runningTestHost = null;
            StateHasChanged();
        }
    }

    private string GetDeviceTypeDisplay(string? type)
    {
        if (string.IsNullOrEmpty(type))
            return "Unknown";

        return type.ToLowerInvariant() switch
        {
            "uap" => "Access Point",
            "usw" => "Switch",
            "udm" => "Dream Machine",
            "ugw" => "Gateway",
            "uxg" => "Gateway",
            "umbb" => "Cellular Modem",
            "ubb" => "Building Bridge",
            "uck" => "Cloud Key",
            _ => type.ToUpperInvariant()
        };
    }

    private string GetSavedDeviceTypeDisplay(string? type)
    {
        if (string.IsNullOrEmpty(type))
            return "Unknown";

        return type switch
        {
            "AccessPoint" => "Access Point",
            "Server" => "Server",
            "Desktop" => "Desktop",
            "Switch" => "Switch",
            "Gateway" => "Gateway",
            _ => type
        };
    }
}
