@page "/audit"
@using NetworkOptimizer.Reports
@inject AuditService AuditService
@inject IJSRuntime JSRuntime
@inject ILogger<Audit> Logger
@rendermode InteractiveServer

<PageTitle>Security Audit - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Security & Configuration Audit</h1>
    <p class="page-description">Comprehensive network security analysis</p>
</div>

<div class="audit-container">
    <!-- Audit Controls -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Audit Controls</h2>
        </div>
        <div class="card-body">
            <div class="audit-controls">
                <button class="btn btn-primary" @onclick="RunAudit" disabled="@isRunning" style="min-width: 140px;">
                    @if (isRunning)
                    {
                        <span class="spinner"></span>
                        <span>Running...</span>
                    }
                    else
                    {
                        <span>Run Full Audit</span>
                    }
                </button>

                <button class="btn btn-secondary" @onclick="ExportReport" disabled="@(!hasResults)">
                    Export Report
                </button>

                <div class="audit-options">
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includeFirewallRules" />
                        <span>Firewall Rules</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includeVlanSecurity" />
                        <span>VLAN Security</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includePortSecurity" />
                        <span>Port Security</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includeDnsSecurity" />
                        <span>DNS Security</span>
                    </label>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(exportError))
            {
                <div class="alert alert-danger" style="margin-top: 1rem;">
                    @exportError
                </div>
            }

            @if (auditProgress > 0 && isRunning)
            {
                <div class="progress-bar">
                    <div class="progress-fill" style="width: @(auditProgress)%"></div>
                </div>
                <p class="progress-text">@currentStep (@auditProgress%)</p>
            }
        </div>
    </div>

    <!-- Audit Results Summary -->
    @if (hasResults)
    {
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Audit Results Summary</h2>
                <span class="audit-timestamp">Last run: @lastAuditTime</span>
            </div>
            <div class="card-body">
                <div class="results-summary">
                    <div class="summary-score">
                        <div class="score-circle score-@scoreClass">
                            <span class="score-value">@securityScore</span>
                            <span class="score-max">/100</span>
                        </div>
                        <div class="score-label">@scoreLabel</div>
                    </div>

                    <div class="issue-counts">
                        <div class="issue-count @(criticalCount > 0 ? "critical" : "")">
                            <span class="count">@criticalCount</span>
                            <span class="label">Critical</span>
                        </div>
                        <div class="issue-count @(warningCount > 0 ? "warning" : "")">
                            <span class="count">@warningCount</span>
                            <span class="label">Warnings</span>
                        </div>
                        <div class="issue-count info">
                            <span class="count">@infoCount</span>
                            <span class="label">Info</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Issues -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Issues Found</h2>
                <div class="filter-tabs">
                    <button class="tab @(selectedFilter == "all" ? "active" : "")" @onclick='() => selectedFilter = "all"'>All (@issues.Count)</button>
                    <button class="tab @(selectedFilter == "critical" ? "active" : "")" @onclick='() => selectedFilter = "critical"'>Critical (@criticalCount)</button>
                    <button class="tab @(selectedFilter == "warning" ? "active" : "")" @onclick='() => selectedFilter = "warning"'>Warnings (@warningCount)</button>
                    <button class="tab @(selectedFilter == "info" ? "active" : "")" @onclick='() => selectedFilter = "info"'>Info (@infoCount)</button>
                    <button class="tab tab-muted @(selectedFilter == "dismissed" ? "active" : "")" @onclick='() => selectedFilter = "dismissed"'>Dismissed (@dismissedIssues.Count)</button>
                </div>
            </div>
            <div class="card-body">
                <div class="issues-list">
                    @if (selectedFilter == "dismissed")
                    {
                        @foreach (var issue in dismissedIssues)
                        {
                            <div class="issue-item issue-@issue.Severity.ToLower() issue-dismissed">
                                <div class="issue-icon">
                                    @((MarkupString)GetSeverityIcon(issue.Severity))
                                </div>
                                <div class="issue-body">
                                <div class="issue-header">
                                    <span class="issue-severity">@issue.Severity</span>
                                    <span class="issue-category">@issue.Category</span>
                                    <button class="btn btn-sm btn-ghost issue-action" @onclick="() => RestoreIssue(issue)" title="Restore this issue">
                                        Restore
                                    </button>
                                </div>
                                <div class="issue-title">@issue.Title</div>
                                <div class="issue-description">@issue.Description</div>

                                @if (!string.IsNullOrEmpty(issue.DeviceName) || !string.IsNullOrEmpty(issue.PortName))
                                {
                                    <div class="issue-context">
                                        @if (!string.IsNullOrEmpty(issue.DeviceName))
                                        {
                                            <span class="context-item"><strong>Device:</strong> @issue.DeviceName</span>
                                        }
                                        @if (!string.IsNullOrEmpty(issue.Port))
                                        {
                                            <span class="context-item"><strong>Port:</strong> @issue.Port</span>
                                        }
                                        @if (!string.IsNullOrEmpty(issue.PortName))
                                        {
                                            <span class="context-item"><strong>Port Name:</strong> @issue.PortName</span>
                                        }
                                    </div>
                                }
                                </div>
                            </div>
                        }

                        @if (!dismissedIssues.Any())
                        {
                            <div class="no-issues">
                                <p>No dismissed issues.</p>
                            </div>
                        }
                    }
                    else
                    {
                        @foreach (var issue in GetFilteredIssues())
                        {
                            <div class="issue-item issue-@issue.Severity.ToLower()">
                                <div class="issue-icon">
                                    @((MarkupString)GetSeverityIcon(issue.Severity))
                                </div>
                                <div class="issue-body">
                                    <div class="issue-header">
                                        <span class="issue-severity">@issue.Severity</span>
                                        <span class="issue-category">@issue.Category</span>
                                        <button class="btn btn-sm btn-ghost issue-action" @onclick="() => DismissIssue(issue)" title="Dismiss this issue">
                                            Dismiss
                                        </button>
                                    </div>
                                    <div class="issue-title">@issue.Title</div>
                                    <div class="issue-description">@issue.Description</div>

                                    @if (!string.IsNullOrEmpty(issue.DeviceName) || !string.IsNullOrEmpty(issue.PortName))
                                    {
                                        <div class="issue-context">
                                            @if (!string.IsNullOrEmpty(issue.DeviceName))
                                            {
                                                <span class="context-item"><strong>Device:</strong> @issue.DeviceName</span>
                                            }
                                            @if (!string.IsNullOrEmpty(issue.Port))
                                            {
                                                <span class="context-item"><strong>Port:</strong> @issue.Port</span>
                                            }
                                            @if (!string.IsNullOrEmpty(issue.PortName))
                                            {
                                                <span class="context-item"><strong>Port Name:</strong> @issue.PortName</span>
                                            }
                                            @if (!string.IsNullOrEmpty(issue.CurrentNetwork))
                                            {
                                                <span class="context-item"><strong>Network:</strong> @issue.CurrentNetwork@(issue.CurrentVlan.HasValue ? $" (VLAN {issue.CurrentVlan})" : "")</span>
                                            }
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(issue.Recommendation))
                                    {
                                        <div class="issue-recommendation">
                                            <strong>Recommendation:</strong> @issue.Recommendation
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (!GetFilteredIssues().Any())
                        {
                            <div class="no-issues">
                                <p>No issues found in this category.</p>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Network Reference -->
        @if (lastResult?.Networks.Any() == true)
        {
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Network Reference</h2>
                </div>
                <div class="card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Network</th>
                                <th>VLAN</th>
                                <th>Subnet</th>
                                <th>Purpose</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var network in lastResult.Networks.OrderBy(n => n.VlanId))
                            {
                                <tr>
                                    <td>@network.Name</td>
                                    <td>@(network.VlanId == 1 ? $"{network.VlanId} (native)" : network.VlanId.ToString())</td>
                                    <td>@(network.Subnet ?? "N/A")</td>
                                    <td>@network.Purpose</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <!-- DNS Security -->
        @if (includeDnsSecurity && lastResult?.DnsSecurity != null)
        {
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">DNS Security</h2>
                </div>
                <div class="card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Configuration</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>DNS-over-HTTPS (DoH)</td>
                                <td class="@(lastResult.DnsSecurity.DohEnabled ? "status-success" : "status-warning")">
                                    @(lastResult.DnsSecurity.DohEnabled ? "Enabled" : "Disabled")
                                </td>
                                <td>@GetDohStatusDisplay()</td>
                            </tr>
                            <tr>
                                <td>DNS Leak Prevention (Port 53)</td>
                                <td class="@(lastResult.DnsSecurity.DnsLeakProtection ? "status-success" : "status-warning")">
                                    @(lastResult.DnsSecurity.DnsLeakProtection ? "Protected" : "Unprotected")
                                </td>
                                <td>@(lastResult.DnsSecurity.DnsLeakProtection ? "External DNS queries blocked" : "Devices can bypass network DNS")</td>
                            </tr>
                            <tr>
                                <td>DNS-over-TLS (Port 853)</td>
                                <td class="@(lastResult.DnsSecurity.DotBlocked ? "status-success" : "status-warning")">
                                    @(lastResult.DnsSecurity.DotBlocked ? "Blocked" : "Open")
                                </td>
                                <td>@(lastResult.DnsSecurity.DotBlocked ? "DoT queries blocked" : "Devices can use external DoT")</td>
                            </tr>
                            <tr>
                                <td>DoH Bypass Prevention</td>
                                <td class="@(lastResult.DnsSecurity.DohBypassBlocked ? "status-success" : "status-warning")">
                                    @(lastResult.DnsSecurity.DohBypassBlocked ? "Blocked" : "Open")
                                </td>
                                <td>@(lastResult.DnsSecurity.DohBypassBlocked ? "Public DoH providers blocked" : "Devices can use external DoH")</td>
                            </tr>
                            <tr>
                                <td>WAN DNS Configuration</td>
                                <td class="@GetWanDnsStatusClass()">
                                    @GetWanDnsStatus()
                                </td>
                                <td>@GetWanDnsDetails()</td>
                            </tr>
                            <tr>
                                <td>Device DNS Configuration</td>
                                <td class="@GetDeviceDnsStatusClass()">
                                    @GetDeviceDnsStatus()
                                </td>
                                <td>@GetDeviceDnsDetails()</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="dns-summary @(lastResult.DnsSecurity.FullyProtected ? "dns-protected" : "dns-partial")">
                        <strong>Overall:</strong> @(lastResult.DnsSecurity.FullyProtected ? "Full DNS Protection" : "Partial Protection")
                    </div>
                </div>
            </div>
        }

        <!-- Hardening Measures -->
        @if (GetFilteredHardeningMeasures().Any())
        {
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Hardening Measures in Place</h2>
                </div>
                <div class="card-body">
                    <ul class="hardening-list">
                        @foreach (var measure in GetFilteredHardeningMeasures())
                        {
                            <li>@measure</li>
                        }
                    </ul>
                </div>
            </div>
        }

        <!-- Switch/Port Details -->
        @if (includePortSecurity && lastResult?.Switches.Any() == true)
        {
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Switch & Port Details</h2>
                </div>
                <div class="card-body">
                    @foreach (var sw in lastResult.Switches)
                    {
                        <div class="switch-section">
                            <h3 class="switch-title">@FormatDeviceName(sw.Name, sw.IsGateway) <span class="switch-model">(@sw.ModelName)</span></h3>
                            <table class="data-table port-table">
                                <thead>
                                    <tr>
                                        <th>Port</th>
                                        <th>Name</th>
                                        <th>Link</th>
                                        <th>PoE</th>
                                        <th>Port Sec</th>
                                        <th>Forward</th>
                                        <th>Native VLAN</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var port in sw.Ports)
                                    {
                                        var (status, statusClass) = GetPortStatus(port, sw.MaxCustomMacAcls > 0);
                                        // Check for any issues on this port (IoT/Camera placement, etc.)
                                        // TODO: Use SwitchMac as unique identifier instead of name matching
                                        var portIssue = issues.FirstOrDefault(i => !i.IsWireless && i.Port == port.PortIndex.ToString() && (i.DeviceName?.Contains(sw.Name) ?? false));
                                        var hasPortIssue = portIssue != null;
                                        var finalClass = hasPortIssue ? (portIssue!.Severity == "Critical" ? "row-critical" : "row-warning") : statusClass;
                                        var finalStatus = hasPortIssue ? portIssue!.Title : status;
                                        <tr class="@finalClass">
                                            <td>@port.PortIndex</td>
                                            <td>@port.Name</td>
                                            <td>@GetLinkStatus(port)</td>
                                            <td>@GetPoeStatus(port)</td>
                                            <td>@GetPortSecurityStatus(port)</td>
                                            <td>@(port.Forward == "customize" ? "custom" : port.Forward)</td>
                                            <td>@(port.NativeNetwork != null ? $"{port.NativeNetwork} ({port.NativeVlan})" : (port.Forward == "disabled" ? "-" : ""))</td>
                                            <td>@finalStatus</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                            @if (sw.MaxCustomMacAcls == 0)
                            {
                                <p class="switch-note">Note: @sw.ModelName doesn't support MAC ACLs</p>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Wireless Clients -->
        @if (includeVlanSecurity && lastResult?.WirelessClients.Any() == true)
        {
            var apGroups = lastResult.WirelessClients.GroupBy(wc => wc.AccessPointName ?? "Unknown AP").OrderBy(g => g.Key);
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Wireless Clients by Access Point</h2>
                </div>
                <div class="card-body">
                    @foreach (var ap in apGroups)
                    {
                        <div class="ap-section">
                            <h3 class="ap-title">@ap.Key <span class="client-count">(@ap.Count() clients)</span></h3>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Client</th>
                                        <th>Type</th>
                                        <th>Network</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var client in ap.OrderBy(c => c.DisplayName))
                                    {
                                        var clientIssue = issues.FirstOrDefault(i => i.IsWireless && i.ClientMac == client.Mac);
                                        var hasIssue = clientIssue != null;
                                        var statusClass = hasIssue ? (clientIssue!.Severity == "Critical" ? "row-critical" : "row-warning") : "";
                                        var statusText = hasIssue ? clientIssue!.Title : "OK";
                                        var networkDisplay = DisplayFormatters.FormatNetworkWithVlan(client.NetworkName, client.VlanId);
                                        <tr class="@statusClass">
                                            <td>@client.DisplayName</td>
                                            <td>@client.DeviceCategory</td>
                                            <td>@networkDisplay</td>
                                            <td>@statusText</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Port Security Summary -->
        @if (includePortSecurity && lastResult?.Switches.Any() == true)
        {
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Port Security Coverage Summary</h2>
                </div>
                <div class="card-body">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Total</th>
                                <th>Disabled</th>
                                <th>MAC Restricted</th>
                                <th>Unprotected Active</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var sw in lastResult.Switches)
                            {
                                var totalPorts = sw.Ports.Count;
                                var disabledPorts = sw.Ports.Count(p => p.Forward == "disabled");
                                var macRestricted = sw.Ports.Count(p => p.PortSecurityMacs.Any());
                                var unprotectedActive = sw.Ports.Count(p => p.Forward == "native" && p.IsUp && !p.PortSecurityMacs.Any() && !p.IsUplink);
                                <tr>
                                    <td>@sw.Name</td>
                                    <td>@totalPorts</td>
                                    <td>@disabledPorts</td>
                                    <td>@(sw.MaxCustomMacAcls > 0 ? macRestricted.ToString() : "0 (no ACL support)")</td>
                                    <td>@unprotectedActive</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
    else if (!isRunning)
    {
        <div class="card">
            <div class="card-body text-center">
                <div class="empty-state">
                    <div class="empty-icon">üîç</div>
                    <h3>No Audit Results</h3>
                    <p>Run an audit to analyze your network security and configuration.</p>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isRunning = false;
    private bool hasResults = false;
    private int auditProgress = 0;
    private string currentStep = "";
    private string lastAuditTime = "";

    private bool includeFirewallRules = true;
    private bool includeVlanSecurity = true;
    private bool includePortSecurity = true;
    private bool includeDnsSecurity = true;

    private int securityScore = 0;
    private string scoreLabel = "";
    private string scoreClass = "";
    private int criticalCount = 0;
    private int warningCount = 0;
    private int infoCount = 0;

    private string selectedFilter = "all";
    private List<Services.AuditIssue> issues = new();
    private List<Services.AuditIssue> dismissedIssues = new();
    private Services.AuditResult? lastResult;

    protected override async Task OnInitializedAsync()
    {
        // Load previous audit results from database/cache
        var previousResult = await AuditService.LoadLastAuditFromDatabaseAsync();
        if (previousResult != null)
        {
            lastResult = previousResult;
            securityScore = previousResult.Score;
            scoreLabel = previousResult.ScoreLabel;
            scoreClass = previousResult.ScoreClass;

            // Use active (non-dismissed) issues
            var activeIssues = await AuditService.GetActiveIssuesAsync();
            criticalCount = activeIssues.Count(i => i.Severity == "Critical");
            warningCount = activeIssues.Count(i => i.Severity == "Warning");
            infoCount = activeIssues.Count(i => i.Severity == "Info");
            issues = activeIssues;

            // Load dismissed issues
            dismissedIssues = await AuditService.GetDismissedIssuesAsync();

            lastAuditTime = previousResult.CompletedAt.ToString("MMM dd, yyyy HH:mm");
            hasResults = true;
        }
    }

    private async Task RunAudit()
    {
        isRunning = true;
        auditProgress = 0;
        currentStep = "Initializing audit...";
        StateHasChanged();

        try
        {
            await SimulateAuditProgress();

            var result = await AuditService.RunAuditAsync(new Services.AuditOptions
            {
                IncludeFirewallRules = includeFirewallRules,
                IncludeVlanSecurity = includeVlanSecurity,
                IncludePortSecurity = includePortSecurity,
                IncludeDnsSecurity = includeDnsSecurity
            });

            lastResult = result;
            securityScore = result.Score;
            scoreLabel = result.ScoreLabel;
            scoreClass = result.ScoreClass;

            // Use active (non-dismissed) issues
            var activeIssues = await AuditService.GetActiveIssuesAsync();
            criticalCount = activeIssues.Count(i => i.Severity == "Critical");
            warningCount = activeIssues.Count(i => i.Severity == "Warning");
            infoCount = activeIssues.Count(i => i.Severity == "Info");
            issues = activeIssues;

            // Load dismissed issues
            dismissedIssues = await AuditService.GetDismissedIssuesAsync();

            lastAuditTime = DateTime.Now.ToString("MMM dd, yyyy HH:mm");
            hasResults = true;
        }
        finally
        {
            isRunning = false;
            auditProgress = 100;
            StateHasChanged();
        }
    }

    private async Task SimulateAuditProgress()
    {
        var steps = new[]
        {
            ("Connecting to UniFi Controller...", 20),
            ("Analyzing firewall rules...", 40),
            ("Checking VLAN configuration...", 60),
            ("Validating port security...", 80),
            ("Finalizing results...", 100)
        };

        foreach (var (step, progress) in steps)
        {
            currentStep = step;
            auditProgress = progress;
            StateHasChanged();
            await Task.Delay(500);
        }
    }

    private string? exportError;

    private async Task ExportReport()
    {
        exportError = null;

        if (!hasResults || lastResult == null)
        {
            exportError = "No audit results to export. Run an audit first.";
            return;
        }

        try
        {
            Logger.LogInformation("Starting PDF export with {IssueCount} issues, {NetworkCount} networks, {SwitchCount} switches",
                issues.Count, lastResult.Networks.Count, lastResult.Switches.Count);

            // Build report data from audit results
            // Extract clean network name from gateway name for report title
            var gatewayName = lastResult.Switches.FirstOrDefault(s => s.IsGateway)?.Name ?? "Network";
            var networkName = ExtractNetworkName(gatewayName);
            var reportData = new NetworkOptimizer.Reports.ReportData
            {
                ClientName = networkName,
                GeneratedAt = DateTime.Now,
                SecurityScore = new NetworkOptimizer.Reports.SecurityScore
                {
                    Rating = securityScore >= 90 ? NetworkOptimizer.Reports.SecurityRating.Excellent
                           : securityScore >= 75 ? NetworkOptimizer.Reports.SecurityRating.Good
                           : securityScore >= 60 ? NetworkOptimizer.Reports.SecurityRating.Fair
                           : NetworkOptimizer.Reports.SecurityRating.NeedsWork,
                    CriticalIssueCount = criticalCount,
                    WarningCount = warningCount,
                    TotalPorts = lastResult.Statistics?.TotalPorts ?? 0,
                    DisabledPorts = lastResult.Statistics?.DisabledPorts ?? 0,
                    MacRestrictedPorts = lastResult.Statistics?.MacRestrictedPorts ?? 0
                },

                // Networks
                Networks = lastResult.Networks
                    .Select(n => new NetworkOptimizer.Reports.NetworkInfo
                    {
                        NetworkId = n.Id,
                        Name = n.Name,
                        VlanId = n.VlanId,
                        Subnet = n.Subnet ?? "N/A",
                        Purpose = n.Purpose
                    })
                    .ToList(),

                // Switches with ports
                Switches = lastResult.Switches
                    .Select(s => new NetworkOptimizer.Reports.SwitchDetail
                    {
                        Name = s.Name,
                        Model = s.Model ?? "",
                        ModelName = s.ModelName ?? s.Model ?? "",
                        DeviceType = s.DeviceType ?? "",
                        IsGateway = s.IsGateway,
                        MaxCustomMacAcls = s.MaxCustomMacAcls,
                        Ports = s.Ports
                            .Select(p => new NetworkOptimizer.Reports.PortDetail
                            {
                                PortIndex = p.PortIndex,
                                Name = p.Name,
                                IsUp = p.IsUp,
                                Speed = p.Speed,
                                Forward = p.Forward,
                                IsUplink = p.IsUplink,
                                NativeNetwork = p.NativeNetwork,
                                NativeVlan = p.NativeVlan,
                                ExcludedNetworks = p.ExcludedNetworks,
                                PortSecurityEnabled = p.PortSecurityEnabled,
                                PortSecurityMacs = p.PortSecurityMacs,
                                Isolation = p.Isolation,
                                PoeEnabled = p.PoeEnabled,
                                PoePower = p.PoePower,
                                PoeMode = p.PoeMode ?? ""
                            })
                            .ToList()
                    })
                    .ToList(),

                // Critical issues
                CriticalIssues = issues
                    .Where(i => i.Severity == "Critical")
                    .Select(i => new NetworkOptimizer.Reports.AuditIssue
                    {
                        Severity = NetworkOptimizer.Reports.IssueSeverity.Critical,
                        SwitchName = i.DeviceName ?? "Unknown",
                        PortIndex = int.TryParse(i.Port, out var p) ? p : null,
                        PortId = int.TryParse(i.Port, out _) ? null : i.Port,  // Non-integer port IDs (e.g., "WAN1")
                        PortName = i.PortName ?? "",
                        CurrentNetwork = i.CurrentNetwork ?? "",
                        CurrentVlan = i.CurrentVlan,
                        Message = i.Description,
                        RecommendedAction = i.Recommendation,
                        // Wireless fields
                        IsWireless = i.IsWireless,
                        ClientName = i.ClientName,
                        ClientMac = i.ClientMac,
                        AccessPoint = i.AccessPoint
                    })
                    .ToList(),

                // Recommended improvements
                RecommendedImprovements = issues
                    .Where(i => i.Severity == "Warning")
                    .Select(i => new NetworkOptimizer.Reports.AuditIssue
                    {
                        Severity = NetworkOptimizer.Reports.IssueSeverity.Warning,
                        SwitchName = i.DeviceName ?? "Unknown",
                        PortIndex = int.TryParse(i.Port, out var p) ? p : null,
                        PortId = int.TryParse(i.Port, out _) ? null : i.Port,  // Non-integer port IDs (e.g., "WAN1")
                        PortName = i.PortName ?? "",
                        CurrentNetwork = i.CurrentNetwork ?? "",
                        CurrentVlan = i.CurrentVlan,
                        Message = i.Description,
                        RecommendedAction = i.Recommendation,
                        // Wireless fields
                        IsWireless = i.IsWireless,
                        ClientName = i.ClientName,
                        ClientMac = i.ClientMac,
                        AccessPoint = i.AccessPoint
                    })
                    .ToList(),

                // Hardening notes (filtered based on checkbox settings)
                HardeningNotes = GetFilteredHardeningMeasures(),

                // DNS Security (only include if checkbox enabled)
                DnsSecurity = includeDnsSecurity && lastResult.DnsSecurity != null ? new NetworkOptimizer.Reports.DnsSecuritySummary
                {
                    DohEnabled = lastResult.DnsSecurity.DohEnabled,
                    DohState = lastResult.DnsSecurity.DohState,
                    DohProviders = lastResult.DnsSecurity.DohProviders.ToList(),
                    DnsLeakProtection = lastResult.DnsSecurity.DnsLeakProtection,
                    DotBlocked = lastResult.DnsSecurity.DotBlocked,
                    DohBypassBlocked = lastResult.DnsSecurity.DohBypassBlocked,
                    FullyProtected = lastResult.DnsSecurity.FullyProtected,
                    WanDnsServers = lastResult.DnsSecurity.WanDnsServers.ToList(),
                    WanDnsPtrResults = lastResult.DnsSecurity.WanDnsPtrResults.ToList(),
                    WanDnsMatchesDoH = lastResult.DnsSecurity.WanDnsMatchesDoH,
                    WanDnsOrderCorrect = lastResult.DnsSecurity.WanDnsOrderCorrect,
                    WanDnsProvider = lastResult.DnsSecurity.WanDnsProvider,
                    ExpectedDnsProvider = lastResult.DnsSecurity.ExpectedDnsProvider,
                    MismatchedDnsServers = lastResult.DnsSecurity.MismatchedDnsServers.ToList(),
                    MatchedDnsServers = lastResult.DnsSecurity.MatchedDnsServers.ToList(),
                    InterfacesWithMismatch = lastResult.DnsSecurity.InterfacesWithMismatch.ToList(),
                    InterfacesWithoutDns = lastResult.DnsSecurity.InterfacesWithoutDns.ToList(),
                    DeviceDnsPointsToGateway = lastResult.DnsSecurity.DeviceDnsPointsToGateway,
                    TotalDevicesChecked = lastResult.DnsSecurity.TotalDevicesChecked,
                    DevicesWithCorrectDns = lastResult.DnsSecurity.DevicesWithCorrectDns,
                    DhcpDeviceCount = lastResult.DnsSecurity.DhcpDeviceCount
                } : null,

                // Access Points with wireless clients (grouped by AP MAC for accurate grouping)
                AccessPoints = lastResult.WirelessClients
                    .GroupBy(wc => wc.AccessPointMac ?? "unknown")
                    .Select(g =>
                    {
                        var firstClient = g.First();
                        return new NetworkOptimizer.Reports.AccessPointDetail
                        {
                            Name = firstClient.AccessPointName ?? "Unknown AP",
                            Mac = g.Key,
                            Model = firstClient.AccessPointModel,
                            ModelName = firstClient.AccessPointModelName,
                            Clients = g.Select(wc => {
                                var clientIssue = issues.FirstOrDefault(i => i.IsWireless && i.ClientMac == wc.Mac);
                                return new NetworkOptimizer.Reports.WirelessClientDetail
                                {
                                    DisplayName = wc.DisplayName,
                                    Mac = wc.Mac,
                                    Network = wc.NetworkName,
                                    VlanId = wc.VlanId,
                                    DeviceCategory = wc.DeviceCategory,
                                    VendorName = wc.VendorName,
                                    DetectionConfidence = wc.DetectionConfidence,
                                    IsIoT = wc.IsIoT,
                                    IsCamera = wc.IsCamera,
                                    HasIssue = clientIssue != null,
                                    IssueTitle = clientIssue?.Title,
                                    IssueMessage = clientIssue?.Description
                                };
                            }).ToList()
                        };
                    })
                    .OrderBy(ap => ap.Name)
                    .ToList()
            };

            // Generate PDF
            Logger.LogInformation("Generating PDF with {CriticalCount} critical, {WarningCount} warnings, {SwitchCount} switches",
                reportData.CriticalIssues.Count, reportData.RecommendedImprovements.Count, reportData.Switches.Count);
            var generator = new NetworkOptimizer.Reports.PdfReportGenerator();
            var pdfBytes = generator.GenerateReportBytes(reportData);
            Logger.LogInformation("PDF generated: {Size} bytes", pdfBytes.Length);

            // Download file via JS interop
            var fileName = $"NetworkAudit_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            var base64 = Convert.ToBase64String(pdfBytes);
            Logger.LogInformation("Calling JS downloadFile for {FileName}", fileName);
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", base64);
            Logger.LogInformation("PDF download initiated");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error generating PDF report");
            exportError = $"Error generating PDF: {ex.Message}";
            StateHasChanged();
        }
    }

    private IEnumerable<Services.AuditIssue> GetFilteredIssues()
    {
        if (selectedFilter == "all")
            return issues;
        return issues.Where(i => i.Severity.ToLower() == selectedFilter);
    }

    private string GetSeverityIcon(string severity)
    {
        return severity.ToLower() switch
        {
            // Shield with exclamation - critical/danger
            "critical" => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 2L3 7v6c0 5.25 3.85 10.15 9 11 5.15-.85 9-5.75 9-11V7l-9-5zm-1 14h2v2h-2v-2zm0-8h2v6h-2V8z" opacity="0.2"/><path d="M12 2L3 7v6c0 5.25 3.85 10.15 9 11 5.15-.85 9-5.75 9-11V7l-9-5zm0 2.18l7 3.89v5.43c0 4.14-3.01 8.05-7 8.88-3.99-.83-7-4.74-7-8.88V8.07l7-3.89zM11 8h2v6h-2V8zm0 8h2v2h-2v-2z"/></svg>""",
            // Triangle with exclamation - warning
            "warning" => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M1 21h22L12 2 1 21z" opacity="0.2"/><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14h-2v2h2v-2zm0-6h-2v4h2v-4z"/></svg>""",
            // Circle with i - info
            "info" => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-11h2v6h-2v-6zm0-4h2v2h-2V7z"/></svg>""",
            _ => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>"""
        };
    }

    private async Task DismissIssue(Services.AuditIssue issue)
    {
        await AuditService.DismissIssueAsync(issue);

        // Move from active to dismissed
        issues.Remove(issue);
        dismissedIssues.Add(issue);

        // Update counts
        criticalCount = issues.Count(i => i.Severity == "Critical");
        warningCount = issues.Count(i => i.Severity == "Warning");
        infoCount = issues.Count(i => i.Severity == "Info");

        StateHasChanged();
    }

    private async Task RestoreIssue(Services.AuditIssue issue)
    {
        await AuditService.RestoreIssueAsync(issue);

        // Move from dismissed to active
        dismissedIssues.Remove(issue);
        issues.Add(issue);

        // Update counts
        criticalCount = issues.Count(i => i.Severity == "Critical");
        warningCount = issues.Count(i => i.Severity == "Warning");
        infoCount = issues.Count(i => i.Severity == "Info");

        StateHasChanged();
    }

    // Device name formatting uses shared DisplayFormatters class
    private static string ExtractNetworkName(string deviceName) => DisplayFormatters.ExtractNetworkName(deviceName);
    private static string FormatDeviceName(string deviceName, bool isGateway) => DisplayFormatters.FormatDeviceName(deviceName, isGateway);

    private string GetDohStatusDisplay()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;
        return DisplayFormatters.GetDohStatusDisplay(dns.DohEnabled, dns.DohState, dns.DohProviders.ToList(), dns.DohConfigNames.ToList());
    }

    /// <summary>
    /// Filter hardening measures based on which audit sections are enabled.
    /// DNS-related notes are filtered when DNS Security is disabled.
    /// VLAN-related notes are filtered when VLAN Security is disabled.
    /// </summary>
    private List<string> GetFilteredHardeningMeasures()
    {
        if (lastResult?.HardeningMeasures == null)
            return new List<string>();

        return lastResult.HardeningMeasures
            .Where(m => ShouldShowHardeningMeasure(m))
            .ToList();
    }

    private bool ShouldShowHardeningMeasure(string measure)
    {
        var lowerMeasure = measure.ToLowerInvariant();

        // DNS-related measures (filter when DNS Security is disabled)
        if (!includeDnsSecurity)
        {
            if (lowerMeasure.Contains("dns") ||
                lowerMeasure.Contains("doh") ||
                lowerMeasure.Contains("dot") ||
                lowerMeasure.Contains("wan dns") ||
                lowerMeasure.Contains("nextdns") ||
                lowerMeasure.Contains("cloudflare") ||
                lowerMeasure.Contains("point to gateway") ||
                lowerMeasure.Contains("leak prevention"))
            {
                return false;
            }
        }

        // VLAN-related measures (filter when VLAN Security is disabled)
        if (!includeVlanSecurity)
        {
            if (lowerMeasure.Contains("vlan") ||
                lowerMeasure.Contains("isolated") ||
                lowerMeasure.Contains("security vlan") ||
                lowerMeasure.Contains("iot vlan") ||
                lowerMeasure.Contains("camera"))
            {
                return false;
            }
        }

        // Port security measures (filter when Port Security is disabled)
        if (!includePortSecurity)
        {
            if (lowerMeasure.Contains("mac") ||
                lowerMeasure.Contains("port") ||
                lowerMeasure.Contains("acl"))
            {
                return false;
            }
        }

        return true;
    }

    private string GetWanDnsStatusClass()
    {
        if (lastResult?.DnsSecurity == null) return "";
        var dns = lastResult.DnsSecurity;
        if (!dns.WanDnsServers.Any()) return "status-neutral";
        if (dns.WanDnsMatchesDoH && !dns.WanDnsOrderCorrect) return "status-warning";
        if (dns.WanDnsMatchesDoH) return "status-success";
        return "status-warning";
    }

    private string GetWanDnsStatus()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;
        if (!dns.WanDnsServers.Any()) return "Not Configured";
        if (dns.WanDnsMatchesDoH && !dns.WanDnsOrderCorrect) return "Wrong Order";
        if (dns.WanDnsMatchesDoH) return "Matched";
        return "Mismatched";
    }

    private string GetWanDnsDetails()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;
        if (!dns.WanDnsServers.Any() && !dns.InterfacesWithoutDns.Any()) return "No WAN DNS servers configured";

        return DisplayFormatters.GetWanDnsDisplay(
            dns.WanDnsServers.ToList(), dns.WanDnsPtrResults.ToList(),
            dns.MatchedDnsServers.ToList(), dns.MismatchedDnsServers.ToList(),
            dns.InterfacesWithMismatch.ToList(), dns.InterfacesWithoutDns.ToList(),
            dns.WanDnsProvider, dns.ExpectedDnsProvider, dns.WanDnsMatchesDoH, dns.WanDnsOrderCorrect);
    }

    private string GetDeviceDnsStatusClass()
    {
        if (lastResult?.DnsSecurity == null) return "";
        var dns = lastResult.DnsSecurity;
        if (dns.TotalDevicesChecked == 0 && dns.DhcpDeviceCount == 0) return "status-neutral";
        if (dns.DeviceDnsPointsToGateway) return "status-success";
        return "status-warning";
    }

    private string GetDeviceDnsStatus()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;
        if (dns.TotalDevicesChecked == 0 && dns.DhcpDeviceCount == 0) return "No Devices";
        if (dns.DeviceDnsPointsToGateway) return "Correct";
        return "Misconfigured";
    }

    private string GetDeviceDnsDetails()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;
        return DisplayFormatters.GetDeviceDnsDisplay(
            dns.TotalDevicesChecked, dns.DevicesWithCorrectDns, dns.DhcpDeviceCount, dns.DeviceDnsPointsToGateway);
    }

    private string GetLinkStatus(Services.PortReference port) =>
        DisplayFormatters.GetLinkStatus(port.IsUp, port.Speed);

    private string GetPoeStatus(Services.PortReference port) =>
        DisplayFormatters.GetPoeStatus(port.PoePower, port.PoeMode, port.PoeEnabled);

    private string GetPortSecurityStatus(Services.PortReference port) =>
        DisplayFormatters.GetPortSecurityStatus(port.PortSecurityMacs.Count, port.PortSecurityEnabled);

    private (string Status, string StatusClass) GetPortStatus(Services.PortReference port, bool supportsAcls)
    {
        if (port.Forward == "disabled")
            return ("Disabled", "");

        if (!port.IsUp && port.Forward != "disabled")
            return ("Off", "");

        if (port.IsUplink || port.Name.ToLower().Contains("uplink"))
            return ("Trunk", "");

        if (port.Forward == "all")
            return ("Trunk", "");

        if (port.Forward == "custom" || port.Forward == "customize")
        {
            if (port.Name.ToLower().Contains("ap") || port.Name.ToLower().Contains("access point"))
                return ("AP", "");
            return ("OK", "");
        }

        if (port.Forward == "native")
        {
            if (port.IsUp && supportsAcls && !port.PortSecurityMacs.Any() && !port.IsUplink)
                return ("No MAC", "row-warning");
            return ("OK", "");
        }

        return ("OK", "");
    }
}
