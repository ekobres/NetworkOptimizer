@page "/audit"
@inject AuditService AuditService
@inject IJSRuntime JSRuntime
@inject ILogger<Audit> Logger
@rendermode InteractiveServer

<PageTitle>Security Audit - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Security & Configuration Audit</h1>
    <p class="page-description">Comprehensive network security analysis</p>
</div>

<div class="audit-container">
    <!-- Audit Controls -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Audit Controls</h2>
        </div>
        <div class="card-body">
            <div class="audit-controls">
                <button class="btn btn-primary" @onclick="RunAudit" disabled="@isRunning" style="min-width: 140px;">
                    @if (isRunning)
                    {
                        <span class="spinner"></span>
                        <span>Running...</span>
                    }
                    else
                    {
                        <span>Run Full Audit</span>
                    }
                </button>

                <button class="btn btn-secondary" @onclick="ExportReport" disabled="@(!hasResults)">
                    Export Report
                </button>

                <div class="audit-options">
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includeFirewallRules" />
                        <span>Firewall Rules</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includeVlanSecurity" />
                        <span>VLAN Security</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includePortSecurity" />
                        <span>Port Security</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includeDnsLeakDetection" />
                        <span>DNS Leak Detection</span>
                    </label>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(exportError))
            {
                <div class="alert alert-danger" style="margin-top: 1rem;">
                    @exportError
                </div>
            }

            @if (auditProgress > 0 && isRunning)
            {
                <div class="progress-bar">
                    <div class="progress-fill" style="width: @(auditProgress)%"></div>
                </div>
                <p class="progress-text">@currentStep (@auditProgress%)</p>
            }
        </div>
    </div>

    <!-- Audit Results Summary -->
    @if (hasResults)
    {
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Audit Results Summary</h2>
                <span class="audit-timestamp">Last run: @lastAuditTime</span>
            </div>
            <div class="card-body">
                <div class="results-summary">
                    <div class="summary-score">
                        <div class="score-circle score-@scoreClass">
                            <span class="score-value">@securityScore</span>
                            <span class="score-max">/100</span>
                        </div>
                        <div class="score-label">@scoreLabel</div>
                    </div>

                    <div class="issue-counts">
                        <div class="issue-count @(criticalCount > 0 ? "critical" : "")">
                            <span class="count">@criticalCount</span>
                            <span class="label">Critical</span>
                        </div>
                        <div class="issue-count @(warningCount > 0 ? "warning" : "")">
                            <span class="count">@warningCount</span>
                            <span class="label">Warnings</span>
                        </div>
                        <div class="issue-count info">
                            <span class="count">@infoCount</span>
                            <span class="label">Info</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Issues -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Issues Found</h2>
                <div class="filter-tabs">
                    <button class="tab @(selectedFilter == "all" ? "active" : "")" @onclick='() => selectedFilter = "all"'>All (@issues.Count)</button>
                    <button class="tab @(selectedFilter == "critical" ? "active" : "")" @onclick='() => selectedFilter = "critical"'>Critical (@criticalCount)</button>
                    <button class="tab @(selectedFilter == "warning" ? "active" : "")" @onclick='() => selectedFilter = "warning"'>Warnings (@warningCount)</button>
                    <button class="tab @(selectedFilter == "info" ? "active" : "")" @onclick='() => selectedFilter = "info"'>Info (@infoCount)</button>
                    <button class="tab tab-muted @(selectedFilter == "dismissed" ? "active" : "")" @onclick='() => selectedFilter = "dismissed"'>Dismissed (@dismissedIssues.Count)</button>
                </div>
            </div>
            <div class="card-body">
                <div class="issues-list">
                    @if (selectedFilter == "dismissed")
                    {
                        @foreach (var issue in dismissedIssues)
                        {
                            <div class="issue-item issue-@issue.Severity.ToLower() issue-dismissed">
                                <div class="issue-icon">
                                    @((MarkupString)GetSeverityIcon(issue.Severity))
                                </div>
                                <div class="issue-body">
                                <div class="issue-header">
                                    <span class="issue-severity">@issue.Severity</span>
                                    <span class="issue-category">@issue.Category</span>
                                    <button class="btn btn-sm btn-ghost issue-action" @onclick="() => RestoreIssue(issue)" title="Restore this issue">
                                        Restore
                                    </button>
                                </div>
                                <div class="issue-title">@issue.Title</div>
                                <div class="issue-description">@issue.Description</div>

                                @if (!string.IsNullOrEmpty(issue.DeviceName) || !string.IsNullOrEmpty(issue.PortName))
                                {
                                    <div class="issue-context">
                                        @if (!string.IsNullOrEmpty(issue.DeviceName))
                                        {
                                            <span class="context-item"><strong>Device:</strong> @issue.DeviceName</span>
                                        }
                                        @if (!string.IsNullOrEmpty(issue.Port))
                                        {
                                            <span class="context-item"><strong>Port:</strong> @issue.Port</span>
                                        }
                                        @if (!string.IsNullOrEmpty(issue.PortName))
                                        {
                                            <span class="context-item"><strong>Port Name:</strong> @issue.PortName</span>
                                        }
                                    </div>
                                }
                                </div>
                            </div>
                        }

                        @if (!dismissedIssues.Any())
                        {
                            <div class="no-issues">
                                <p>No dismissed issues.</p>
                            </div>
                        }
                    }
                    else
                    {
                        @foreach (var issue in GetFilteredIssues())
                        {
                            <div class="issue-item issue-@issue.Severity.ToLower()">
                                <div class="issue-icon">
                                    @((MarkupString)GetSeverityIcon(issue.Severity))
                                </div>
                                <div class="issue-body">
                                    <div class="issue-header">
                                        <span class="issue-severity">@issue.Severity</span>
                                        <span class="issue-category">@issue.Category</span>
                                        <button class="btn btn-sm btn-ghost issue-action" @onclick="() => DismissIssue(issue)" title="Dismiss this issue">
                                            Dismiss
                                        </button>
                                    </div>
                                    <div class="issue-title">@issue.Title</div>
                                    <div class="issue-description">@issue.Description</div>

                                    @if (!string.IsNullOrEmpty(issue.DeviceName) || !string.IsNullOrEmpty(issue.PortName))
                                    {
                                        <div class="issue-context">
                                            @if (!string.IsNullOrEmpty(issue.DeviceName))
                                            {
                                                <span class="context-item"><strong>Device:</strong> @issue.DeviceName</span>
                                            }
                                            @if (!string.IsNullOrEmpty(issue.Port))
                                            {
                                                <span class="context-item"><strong>Port:</strong> @issue.Port</span>
                                            }
                                            @if (!string.IsNullOrEmpty(issue.PortName))
                                            {
                                                <span class="context-item"><strong>Port Name:</strong> @issue.PortName</span>
                                            }
                                            @if (!string.IsNullOrEmpty(issue.CurrentNetwork))
                                            {
                                                <span class="context-item"><strong>Network:</strong> @issue.CurrentNetwork@(issue.CurrentVlan.HasValue ? $" (VLAN {issue.CurrentVlan})" : "")</span>
                                            }
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(issue.Recommendation))
                                    {
                                        <div class="issue-recommendation">
                                            <strong>Recommendation:</strong> @issue.Recommendation
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (!GetFilteredIssues().Any())
                        {
                            <div class="no-issues">
                                <p>No issues found in this category.</p>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    }
    else if (!isRunning)
    {
        <div class="card">
            <div class="card-body text-center">
                <div class="empty-state">
                    <div class="empty-icon">üîç</div>
                    <h3>No Audit Results</h3>
                    <p>Run an audit to analyze your network security and configuration.</p>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isRunning = false;
    private bool hasResults = false;
    private int auditProgress = 0;
    private string currentStep = "";
    private string lastAuditTime = "";

    private bool includeFirewallRules = true;
    private bool includeVlanSecurity = true;
    private bool includePortSecurity = true;
    private bool includeDnsLeakDetection = true;

    private int securityScore = 0;
    private string scoreLabel = "";
    private string scoreClass = "";
    private int criticalCount = 0;
    private int warningCount = 0;
    private int infoCount = 0;

    private string selectedFilter = "all";
    private List<Services.AuditIssue> issues = new();
    private List<Services.AuditIssue> dismissedIssues = new();
    private Services.AuditResult? lastResult;

    protected override async Task OnInitializedAsync()
    {
        // Load previous audit results from database/cache
        var previousResult = await AuditService.LoadLastAuditFromDatabaseAsync();
        if (previousResult != null)
        {
            lastResult = previousResult;
            securityScore = previousResult.Score;
            scoreLabel = previousResult.ScoreLabel;
            scoreClass = previousResult.ScoreClass;

            // Use active (non-dismissed) issues
            var activeIssues = await AuditService.GetActiveIssuesAsync();
            criticalCount = activeIssues.Count(i => i.Severity == "Critical");
            warningCount = activeIssues.Count(i => i.Severity == "Warning");
            infoCount = activeIssues.Count(i => i.Severity == "Info");
            issues = activeIssues;

            // Load dismissed issues
            dismissedIssues = await AuditService.GetDismissedIssuesAsync();

            lastAuditTime = previousResult.CompletedAt.ToString("MMM dd, yyyy HH:mm");
            hasResults = true;
        }
    }

    private async Task RunAudit()
    {
        isRunning = true;
        auditProgress = 0;
        currentStep = "Initializing audit...";
        StateHasChanged();

        try
        {
            await SimulateAuditProgress();

            var result = await AuditService.RunAuditAsync(new Services.AuditOptions
            {
                IncludeFirewallRules = includeFirewallRules,
                IncludeVlanSecurity = includeVlanSecurity,
                IncludePortSecurity = includePortSecurity,
                IncludeDnsLeakDetection = includeDnsLeakDetection
            });

            lastResult = result;
            securityScore = result.Score;
            scoreLabel = result.ScoreLabel;
            scoreClass = result.ScoreClass;

            // Use active (non-dismissed) issues
            var activeIssues = await AuditService.GetActiveIssuesAsync();
            criticalCount = activeIssues.Count(i => i.Severity == "Critical");
            warningCount = activeIssues.Count(i => i.Severity == "Warning");
            infoCount = activeIssues.Count(i => i.Severity == "Info");
            issues = activeIssues;

            // Load dismissed issues
            dismissedIssues = await AuditService.GetDismissedIssuesAsync();

            lastAuditTime = DateTime.Now.ToString("MMM dd, yyyy HH:mm");
            hasResults = true;
        }
        finally
        {
            isRunning = false;
            auditProgress = 100;
            StateHasChanged();
        }
    }

    private async Task SimulateAuditProgress()
    {
        var steps = new[]
        {
            ("Connecting to UniFi Controller...", 20),
            ("Analyzing firewall rules...", 40),
            ("Checking VLAN configuration...", 60),
            ("Validating port security...", 80),
            ("Finalizing results...", 100)
        };

        foreach (var (step, progress) in steps)
        {
            currentStep = step;
            auditProgress = progress;
            StateHasChanged();
            await Task.Delay(500);
        }
    }

    private string? exportError;

    private async Task ExportReport()
    {
        exportError = null;

        if (!hasResults || lastResult == null)
        {
            exportError = "No audit results to export. Run an audit first.";
            return;
        }

        try
        {
            Logger.LogInformation("Starting PDF export with {IssueCount} issues, {NetworkCount} networks, {SwitchCount} switches",
                issues.Count, lastResult.Networks.Count, lastResult.Switches.Count);

            // Build report data from audit results
            // Extract clean network name from gateway name for report title
            var gatewayName = lastResult.Switches.FirstOrDefault(s => s.IsGateway)?.Name ?? "Network";
            var networkName = ExtractNetworkName(gatewayName);
            var reportData = new NetworkOptimizer.Reports.ReportData
            {
                ClientName = networkName,
                GeneratedAt = DateTime.Now,
                SecurityScore = new NetworkOptimizer.Reports.SecurityScore
                {
                    Rating = securityScore >= 90 ? NetworkOptimizer.Reports.SecurityRating.Excellent
                           : securityScore >= 75 ? NetworkOptimizer.Reports.SecurityRating.Good
                           : securityScore >= 60 ? NetworkOptimizer.Reports.SecurityRating.Fair
                           : NetworkOptimizer.Reports.SecurityRating.NeedsWork,
                    CriticalIssueCount = criticalCount,
                    WarningCount = warningCount,
                    TotalPorts = lastResult.Statistics?.TotalPorts ?? 0,
                    DisabledPorts = lastResult.Statistics?.DisabledPorts ?? 0,
                    MacRestrictedPorts = lastResult.Statistics?.MacRestrictedPorts ?? 0
                },

                // Networks
                Networks = lastResult.Networks
                    .Select(n => new NetworkOptimizer.Reports.NetworkInfo
                    {
                        NetworkId = n.Id,
                        Name = n.Name,
                        VlanId = n.VlanId,
                        Subnet = n.Subnet ?? "N/A",
                        Purpose = n.Purpose
                    })
                    .ToList(),

                // Switches with ports
                Switches = lastResult.Switches
                    .Select(s => new NetworkOptimizer.Reports.SwitchDetail
                    {
                        Name = s.Name,
                        Model = s.Model ?? "",
                        ModelName = s.ModelName ?? s.Model ?? "",
                        DeviceType = s.DeviceType ?? "",
                        IsGateway = s.IsGateway,
                        MaxCustomMacAcls = s.MaxCustomMacAcls,
                        Ports = s.Ports
                            .Select(p => new NetworkOptimizer.Reports.PortDetail
                            {
                                PortIndex = p.PortIndex,
                                Name = p.Name,
                                IsUp = p.IsUp,
                                Speed = p.Speed,
                                Forward = p.Forward,
                                IsUplink = p.IsUplink,
                                NativeNetwork = p.NativeNetwork,
                                NativeVlan = p.NativeVlan,
                                ExcludedNetworks = p.ExcludedNetworks,
                                PortSecurityEnabled = p.PortSecurityEnabled,
                                PortSecurityMacs = p.PortSecurityMacs,
                                Isolation = p.Isolation,
                                PoeEnabled = p.PoeEnabled,
                                PoePower = p.PoePower,
                                PoeMode = p.PoeMode ?? ""
                            })
                            .ToList()
                    })
                    .ToList(),

                // Critical issues
                CriticalIssues = issues
                    .Where(i => i.Severity == "Critical")
                    .Select(i => new NetworkOptimizer.Reports.AuditIssue
                    {
                        Severity = NetworkOptimizer.Reports.IssueSeverity.Critical,
                        SwitchName = i.DeviceName ?? "Unknown",
                        PortIndex = int.TryParse(i.Port, out var p) ? p : null,
                        PortName = i.PortName ?? "",
                        CurrentNetwork = i.CurrentNetwork ?? "",
                        CurrentVlan = i.CurrentVlan,
                        Message = i.Description,
                        RecommendedAction = i.Recommendation,
                        // Wireless fields
                        IsWireless = i.IsWireless,
                        ClientName = i.ClientName,
                        ClientMac = i.ClientMac,
                        AccessPoint = i.AccessPoint
                    })
                    .ToList(),

                // Recommended improvements
                RecommendedImprovements = issues
                    .Where(i => i.Severity == "Warning")
                    .Select(i => new NetworkOptimizer.Reports.AuditIssue
                    {
                        Severity = NetworkOptimizer.Reports.IssueSeverity.Warning,
                        SwitchName = i.DeviceName ?? "Unknown",
                        PortIndex = int.TryParse(i.Port, out var p) ? p : null,
                        PortName = i.PortName ?? "",
                        CurrentNetwork = i.CurrentNetwork ?? "",
                        CurrentVlan = i.CurrentVlan,
                        Message = i.Description,
                        RecommendedAction = i.Recommendation,
                        // Wireless fields
                        IsWireless = i.IsWireless,
                        ClientName = i.ClientName,
                        ClientMac = i.ClientMac,
                        AccessPoint = i.AccessPoint
                    })
                    .ToList(),

                // Hardening notes
                HardeningNotes = lastResult.HardeningMeasures
            };

            // Generate PDF
            Logger.LogInformation("Generating PDF with {CriticalCount} critical, {WarningCount} warnings, {SwitchCount} switches",
                reportData.CriticalIssues.Count, reportData.RecommendedImprovements.Count, reportData.Switches.Count);
            var generator = new NetworkOptimizer.Reports.PdfReportGenerator();
            var pdfBytes = generator.GenerateReportBytes(reportData);
            Logger.LogInformation("PDF generated: {Size} bytes", pdfBytes.Length);

            // Download file via JS interop
            var fileName = $"NetworkAudit_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            var base64 = Convert.ToBase64String(pdfBytes);
            Logger.LogInformation("Calling JS downloadFile for {FileName}", fileName);
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", base64);
            Logger.LogInformation("PDF download initiated");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error generating PDF report");
            exportError = $"Error generating PDF: {ex.Message}";
            StateHasChanged();
        }
    }

    private IEnumerable<Services.AuditIssue> GetFilteredIssues()
    {
        if (selectedFilter == "all")
            return issues;
        return issues.Where(i => i.Severity.ToLower() == selectedFilter);
    }

    private string GetSeverityIcon(string severity)
    {
        return severity.ToLower() switch
        {
            // Shield with exclamation - critical/danger
            "critical" => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 2L3 7v6c0 5.25 3.85 10.15 9 11 5.15-.85 9-5.75 9-11V7l-9-5zm-1 14h2v2h-2v-2zm0-8h2v6h-2V8z" opacity="0.2"/><path d="M12 2L3 7v6c0 5.25 3.85 10.15 9 11 5.15-.85 9-5.75 9-11V7l-9-5zm0 2.18l7 3.89v5.43c0 4.14-3.01 8.05-7 8.88-3.99-.83-7-4.74-7-8.88V8.07l7-3.89zM11 8h2v6h-2V8zm0 8h2v2h-2v-2z"/></svg>""",
            // Triangle with exclamation - warning
            "warning" => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M1 21h22L12 2 1 21z" opacity="0.2"/><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14h-2v2h2v-2zm0-6h-2v4h2v-4z"/></svg>""",
            // Circle with i - info
            "info" => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-11h2v6h-2v-6zm0-4h2v2h-2V7z"/></svg>""",
            _ => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>"""
        };
    }

    private async Task DismissIssue(Services.AuditIssue issue)
    {
        await AuditService.DismissIssueAsync(issue);

        // Move from active to dismissed
        issues.Remove(issue);
        dismissedIssues.Add(issue);

        // Update counts
        criticalCount = issues.Count(i => i.Severity == "Critical");
        warningCount = issues.Count(i => i.Severity == "Warning");
        infoCount = issues.Count(i => i.Severity == "Info");

        StateHasChanged();
    }

    private async Task RestoreIssue(Services.AuditIssue issue)
    {
        await AuditService.RestoreIssueAsync(issue);

        // Move from dismissed to active
        dismissedIssues.Remove(issue);
        issues.Add(issue);

        // Update counts
        criticalCount = issues.Count(i => i.Severity == "Critical");
        warningCount = issues.Count(i => i.Severity == "Warning");
        infoCount = issues.Count(i => i.Severity == "Info");

        StateHasChanged();
    }

    /// <summary>
    /// Extract a clean network name from a device name for report titles.
    /// Strips prefixes like [Gateway], [Switch] and parenthetical suffixes like (UCG-Fiber).
    /// Example: "[Gateway] SeaTurtle Home" ‚Üí "SeaTurtle Home"
    /// </summary>
    private static string ExtractNetworkName(string deviceName)
    {
        if (string.IsNullOrWhiteSpace(deviceName))
            return "Network";

        var name = deviceName.Trim();

        // Strip bracketed prefix like [Gateway], [Switch], etc.
        if (name.StartsWith("["))
        {
            var closeBracket = name.IndexOf(']');
            if (closeBracket > 0 && closeBracket < name.Length - 1)
            {
                name = name.Substring(closeBracket + 1).TrimStart();
            }
        }

        // Strip parenthetical suffix like (UCG-Fiber), (UDM Pro), etc.
        var openParen = name.LastIndexOf('(');
        if (openParen > 0 && name.EndsWith(")"))
        {
            name = name.Substring(0, openParen).TrimEnd();
        }

        return string.IsNullOrWhiteSpace(name) ? "Network" : name;
    }
}
