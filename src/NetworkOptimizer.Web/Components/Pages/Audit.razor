@page "/audit"
@using NetworkOptimizer.Audit.Models
@using NetworkOptimizer.Core.Enums
@using NetworkOptimizer.Core.Helpers
@using NetworkOptimizer.Reports
@using NetworkOptimizer.Web.Components.Shared
@using AuditSeverity = NetworkOptimizer.Audit.Models.AuditSeverity
@inject AuditService AuditService
@inject UniFiConnectionService ConnectionService
@inject IJSRuntime JSRuntime
@inject ILogger<Audit> Logger
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Security Audit - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Security & Configuration Audit</h1>
    <p class="page-description">Comprehensive network security analysis</p>
</div>

@if (!ConnectionService.IsConnected && ConnectionService.IsInitialized)
{
    <div class="connection-banner">
        <div class="banner-content">
            <span class="banner-icon">!</span>
            <div class="banner-text">
                <strong>Not Connected</strong>
                <span>Connect to your UniFi controller to run security audits.</span>
            </div>
            <a href="/settings" class="btn btn-primary">Connect Now</a>
        </div>
    </div>
}

<div class="audit-container">
    <!-- Audit Controls -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Audit Controls</h2>
        </div>
        <div class="card-body">
            <div class="audit-controls">
                <button class="btn btn-primary" @onclick="RunAudit" disabled="@(isRunning || !ConnectionService.IsConnected)" style="min-width: 140px;">
                    @if (isRunning)
                    {
                        <span class="spinner"></span>
                        <span>Running...</span>
                    }
                    else
                    {
                        <span>Run Full Audit</span>
                    }
                </button>

                <button class="btn btn-secondary" @onclick="ExportReport" disabled="@(!hasResults)">
                    Export Report
                </button>

                <button class="btn btn-secondary" @onclick="@(() => NavigationManager.NavigateTo("/settings#security-audit"))">
                    Settings
                </button>

                <div class="audit-options">
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includeFirewallRules" />
                        <span>Firewall Rules</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includeVlanSecurity" />
                        <span>VLAN Security</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includePortSecurity" />
                        <span>Port Security</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="includeDnsSecurity" />
                        <span>DNS Security</span>
                    </label>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(exportError))
            {
                <div class="alert alert-danger" style="margin-top: 1rem;">
                    @exportError
                </div>
            }

            @if (isRunning)
            {
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: @auditProgress%"></div>
                    </div>
                    <p class="progress-text">@currentStep</p>
                </div>
            }
        </div>
    </div>

    <!-- Audit Results Summary -->
    @if (hasResults)
    {
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Audit Results Summary</h2>
                <span class="audit-timestamp"><span class="timestamp-label">Last run: </span>@lastAuditTime</span>
            </div>
            <div class="card-body">
                <div class="results-summary">
                    <div class="summary-score">
                        <div class="score-circle score-@scoreClass">
                            <span class="score-value">@securityScore</span>
                            <span class="score-max">/100</span>
                        </div>
                        <div class="score-label">@scoreLabel</div>
                    </div>

                    <div class="issue-counts">
                        <div class="issue-count @(criticalCount > 0 ? "critical" : "")">
                            <span class="count">@criticalCount</span>
                            <span class="label">Critical</span>
                        </div>
                        <div class="issue-count @(warningCount > 0 ? "recommended" : "")">
                            <span class="count">@warningCount</span>
                            <span class="label">Recommended</span>
                        </div>
                        <div class="issue-count info">
                            <span class="count">@infoCount</span>
                            <span class="label">Info</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Issues -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Issues Found</h2>
                <div class="filter-tabs">
                    <button class="tab @(selectedFilter == "all" ? "active" : "")" @onclick='() => selectedFilter = "all"'>All (@issues.Count)</button>
                    <button class="tab @(selectedFilter == "critical" ? "active" : "")" @onclick='() => selectedFilter = "critical"'>Critical (@criticalCount)</button>
                    <button class="tab @(selectedFilter == "recommended" ? "active" : "")" @onclick='() => selectedFilter = "recommended"'>Recommended (@warningCount)</button>
                    <button class="tab @(selectedFilter == "info" ? "active" : "")" @onclick='() => selectedFilter = "info"'>Info (@infoCount)</button>
                    <button class="tab tab-muted @(selectedFilter == "dismissed" ? "active" : "")" @onclick='() => selectedFilter = "dismissed"'>Dismissed (@dismissedIssues.Count)</button>
                </div>
            </div>
            <div class="card-body">
                <div class="issues-list">
                    @if (selectedFilter == "dismissed")
                    {
                        @foreach (var issue in dismissedIssues)
                        {
                            <div class="issue-item issue-@GetSeverityCssClass(issue.Severity) issue-dismissed">
                                <div class="issue-icon">
                                    @((MarkupString)GetSeverityIcon(issue.Severity))
                                </div>
                                <div class="issue-body">
                                <div class="issue-header">
                                    <span class="issue-severity">@GetSeverityDisplayName(issue.Severity)</span>
                                    <span class="issue-category">@issue.Category</span>
                                    <button class="btn btn-sm btn-ghost issue-action" @onclick="() => RestoreIssue(issue)" title="Restore this issue">
                                        Restore
                                    </button>
                                </div>
                                <div class="issue-title">@issue.Title</div>
                                <div class="issue-description">@issue.Description</div>

                                @if (!string.IsNullOrEmpty(issue.DeviceName) || !string.IsNullOrEmpty(issue.PortName))
                                {
                                    var parsed = DisplayFormatters.ParseDeviceOnNetworkDevice(issue.DeviceName);
                                    <div class="issue-context">
                                        @if (!string.IsNullOrEmpty(parsed.ClientName))
                                        {
                                            <span class="context-item"><strong>Device:</strong> @parsed.ClientName</span>
                                        }
                                        @if (!string.IsNullOrEmpty(parsed.NetworkDeviceName))
                                        {
                                            <span class="context-item"><strong>@DisplayFormatters.GetNetworkDeviceLabel(parsed.DeviceType)</strong> @parsed.NetworkDeviceName</span>
                                        }
                                        @if (!string.IsNullOrEmpty(issue.Port))
                                        {
                                            <span class="context-item"><strong>Port:</strong> @issue.Port</span>
                                        }
                                        @if (!string.IsNullOrEmpty(issue.PortName))
                                        {
                                            <span class="context-item"><strong>Port Name:</strong> @issue.PortName</span>
                                        }
                                        @if (issue.IsWireless && !string.IsNullOrEmpty(issue.WifiBand))
                                        {
                                            <span class="context-item"><strong>Band:</strong> @issue.WifiBand</span>
                                        }
                                        @if (!string.IsNullOrEmpty(issue.CurrentNetwork))
                                        {
                                            <span class="context-item"><strong>Network:</strong> @issue.CurrentNetwork@(issue.CurrentVlan.HasValue ? $" (VLAN {issue.CurrentVlan})" : "")</span>
                                        }
                                    </div>
                                }
                                </div>
                            </div>
                        }

                        @if (!dismissedIssues.Any())
                        {
                            <div class="no-issues">
                                <p>No dismissed issues.</p>
                            </div>
                        }
                    }
                    else
                    {
                        @foreach (var issueTypeGroup in GetGroupedFilteredIssues())
                        {
                            var groupCount = issueTypeGroup.Count();
                            var isSingleItem = groupCount == 1;
                            var groupKey = $"{issueTypeGroup.Key.Title}|{issueTypeGroup.Key.Severity}|{issueTypeGroup.Key.Description}|{issueTypeGroup.Key.Recommendation}";
                            var isExpanded = isSingleItem || expandedIssueTypes.Contains(groupKey);
                            var highestSeverity = issueTypeGroup.Key.Severity;
                            var highestSeverityCss = GetSeverityCssClass(highestSeverity);
                            var firstIssue = issueTypeGroup.First();

                            @if (isSingleItem)
                            {
                                // Single item: render as a regular issue card (not collapsible)
                                var issue = firstIssue;
                                <div class="issue-item issue-@GetSeverityCssClass(issue.Severity)">
                                    <div class="issue-icon">
                                        @((MarkupString)GetSeverityIcon(issue.Severity))
                                    </div>
                                    <div class="issue-body">
                                        <div class="issue-header">
                                            <span class="issue-severity">@GetSeverityDisplayName(issue.Severity)</span>
                                            @if (!string.IsNullOrEmpty(issue.ConfigurableSetting))
                                            {
                                                <span class="tooltip-wrapper">
                                                    <a href="/settings#security-audit" class="tooltip-icon issue-settings-icon">
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 018.82 1h2.36a1 1 0 01.98.804l.331 1.652a6.993 6.993 0 011.929 1.115l1.598-.54a1 1 0 011.186.447l1.18 2.044a1 1 0 01-.205 1.251l-1.267 1.113a7.047 7.047 0 010 2.228l1.267 1.113a1 1 0 01.206 1.25l-1.18 2.045a1 1 0 01-1.187.447l-1.598-.54a6.993 6.993 0 01-1.929 1.115l-.33 1.652a1 1 0 01-.98.804H8.82a1 1 0 01-.98-.804l-.331-1.652a6.993 6.993 0 01-1.929-1.115l-1.598.54a1 1 0 01-1.186-.447l-1.18-2.044a1 1 0 01.205-1.251l1.267-1.114a7.05 7.05 0 010-2.227L1.821 7.773a1 1 0 01-.206-1.25l1.18-2.045a1 1 0 011.187-.447l1.598.54A6.993 6.993 0 017.51 3.456l.33-1.652zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                                                        </svg>
                                                    </a>
                                                    <span class="tooltip-content">
                                                        <strong>Configurable Alert</strong><br/>
                                                        You can adjust how this device type is treated when found on your main network(s).
                                                        <a href="/settings#security-audit">Configure in Settings →</a>
                                                    </span>
                                                </span>
                                            }
                                            <button class="btn btn-sm btn-ghost issue-action" @onclick="() => DismissIssue(issue)" @onclick:stopPropagation="true" title="Dismiss this issue">
                                                Dismiss
                                            </button>
                                        </div>
                                        <div class="issue-title">@issue.Title</div>
                                        <div class="issue-description">@issue.Description</div>

                                        @if (!string.IsNullOrEmpty(issue.DeviceName) || !string.IsNullOrEmpty(issue.PortName))
                                        {
                                            var parsed = DisplayFormatters.ParseDeviceOnNetworkDevice(issue.DeviceName);
                                            <div class="issue-context">
                                                @if (!string.IsNullOrEmpty(parsed.ClientName))
                                                {
                                                    <span class="context-item"><strong>Device:</strong> @parsed.ClientName</span>
                                                }
                                                @if (!string.IsNullOrEmpty(parsed.NetworkDeviceName))
                                                {
                                                    <span class="context-item"><strong>@DisplayFormatters.GetNetworkDeviceLabel(parsed.DeviceType)</strong> @parsed.NetworkDeviceName</span>
                                                }
                                                @if (!string.IsNullOrEmpty(issue.Port))
                                                {
                                                    <span class="context-item"><strong>Port:</strong> @issue.Port</span>
                                                }
                                                @if (!string.IsNullOrEmpty(issue.PortName))
                                                {
                                                    <span class="context-item"><strong>Port Name:</strong> @issue.PortName</span>
                                                }
                                                @if (issue.IsWireless && !string.IsNullOrEmpty(issue.WifiBand))
                                                {
                                                    <span class="context-item"><strong>Band:</strong> @issue.WifiBand</span>
                                                }
                                                @if (!string.IsNullOrEmpty(issue.CurrentNetwork))
                                                {
                                                    <span class="context-item"><strong>Network:</strong> @issue.CurrentNetwork@(issue.CurrentVlan.HasValue ? $" (VLAN {issue.CurrentVlan})" : "")</span>
                                                }
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(issue.Recommendation))
                                        {
                                            <div class="issue-recommendation">
                                                <strong>Recommendation:</strong> @issue.Recommendation
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            else
                            {
                                // Multiple items: render as collapsible group
                                <div class="issue-type-group issue-@highestSeverityCss">
                                    <div class="issue-type-header @(isExpanded ? "expanded" : "")"
                                         @onclick="() => ToggleIssueType(groupKey)">
                                        <div class="issue-type-icon">
                                            @((MarkupString)GetSeverityIcon(highestSeverity))
                                        </div>
                                        <div class="issue-type-body">
                                            <div class="issue-header">
                                                <span class="issue-severity">@GetSeverityDisplayName(issueTypeGroup.Key.Severity) (@groupCount)</span>
                                                @if (!string.IsNullOrEmpty(firstIssue.ConfigurableSetting))
                                                {
                                                    <span class="tooltip-wrapper">
                                                        <a href="/settings#security-audit" class="tooltip-icon issue-settings-icon" @onclick:stopPropagation="true">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                                <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 018.82 1h2.36a1 1 0 01.98.804l.331 1.652a6.993 6.993 0 011.929 1.115l1.598-.54a1 1 0 011.186.447l1.18 2.044a1 1 0 01-.205 1.251l-1.267 1.113a7.047 7.047 0 010 2.228l1.267 1.113a1 1 0 01.206 1.25l-1.18 2.045a1 1 0 01-1.187.447l-1.598-.54a6.993 6.993 0 01-1.929 1.115l-.33 1.652a1 1 0 01-.98.804H8.82a1 1 0 01-.98-.804l-.331-1.652a6.993 6.993 0 01-1.929-1.115l-1.598.54a1 1 0 01-1.186-.447l-1.18-2.044a1 1 0 01.205-1.251l1.267-1.114a7.05 7.05 0 010-2.227L1.821 7.773a1 1 0 01-.206-1.25l1.18-2.045a1 1 0 011.187-.447l1.598.54A6.993 6.993 0 017.51 3.456l.33-1.652zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                                                            </svg>
                                                        </a>
                                                        <span class="tooltip-content">
                                                            <strong>Configurable Alert</strong><br/>
                                                            You can adjust how this device type is treated when found on your main network(s).
                                                            <a href="/settings#security-audit">Configure in Settings →</a>
                                                        </span>
                                                    </span>
                                                }
                                            </div>
                                            <div class="issue-title">
                                                @issueTypeGroup.Key.Title
                                            </div>
                                        </div>
                                        <span class="issue-type-chevron">@(isExpanded ? "▲" : "▼")</span>
                                    </div>
                                    @{
                                        // Non-device groups have null Description in key - show description per item
                                        var isDeviceGroup = issueTypeGroup.Key.Description != null;
                                    }
                                    <div class="expand-wrapper @(isExpanded ? "expanded" : "")">
                                        <div class="expand-content">
                                            @if (isDeviceGroup)
                                            {
                                                <div class="issue-type-description">@firstIssue.Description</div>
                                            }
                                            <div class="issue-type-items-list">
                                                @foreach (var issue in issueTypeGroup)
                                                {
                                                    var parsed = DisplayFormatters.ParseDeviceOnNetworkDevice(issue.DeviceName);
                                                    var hasDeviceInfo = !string.IsNullOrEmpty(parsed.ClientName) ||
                                                                       !string.IsNullOrEmpty(parsed.NetworkDeviceName) ||
                                                                       !string.IsNullOrEmpty(issue.Port);
                                                    <div class="issue-type-item">
                                                        @if (isDeviceGroup && hasDeviceInfo)
                                                        {
                                                            <div class="issue-context">
                                                                @if (!string.IsNullOrEmpty(parsed.ClientName))
                                                                {
                                                                    <span class="context-item"><strong>Device:</strong> @parsed.ClientName</span>
                                                                }
                                                                @if (!string.IsNullOrEmpty(parsed.NetworkDeviceName))
                                                                {
                                                                    <span class="context-item"><strong>@DisplayFormatters.GetNetworkDeviceLabel(parsed.DeviceType)</strong> @parsed.NetworkDeviceName</span>
                                                                }
                                                                @if (!string.IsNullOrEmpty(issue.Port))
                                                                {
                                                                    <span class="context-item"><strong>Port:</strong> @issue.Port</span>
                                                                }
                                                                @if (!string.IsNullOrEmpty(issue.PortName))
                                                                {
                                                                    <span class="context-item"><strong>Port Name:</strong> @issue.PortName</span>
                                                                }
                                                                @if (issue.IsWireless && !string.IsNullOrEmpty(issue.WifiBand))
                                                                {
                                                                    <span class="context-item"><strong>Band:</strong> @issue.WifiBand</span>
                                                                }
                                                                @if (!string.IsNullOrEmpty(issue.CurrentNetwork))
                                                                {
                                                                    <span class="context-item"><strong>Network:</strong> @issue.CurrentNetwork@(issue.CurrentVlan.HasValue ? $" (VLAN {issue.CurrentVlan})" : "")</span>
                                                                }
                                                                <button class="btn btn-sm btn-ghost issue-action" @onclick="() => DismissIssue(issue)" @onclick:stopPropagation="true" title="Dismiss this issue">
                                                                    Dismiss
                                                                </button>
                                                            </div>
                                                        }
                                                        else if (!isDeviceGroup)
                                                        {
                                                            @* Non-device group: show description per item *@
                                                            <div class="issue-context">
                                                                <span class="context-item issue-item-description">@issue.Description</span>
                                                                <button class="btn btn-sm btn-ghost issue-action" @onclick="() => DismissIssue(issue)" @onclick:stopPropagation="true" title="Dismiss this issue">
                                                                    Dismiss
                                                                </button>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="issue-context">
                                                                <button class="btn btn-sm btn-ghost issue-action" @onclick="() => DismissIssue(issue)" @onclick:stopPropagation="true" title="Dismiss this issue">
                                                                    Dismiss
                                                                </button>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                            @if (!string.IsNullOrEmpty(firstIssue.Recommendation))
                                            {
                                                <div class="issue-type-recommendation">
                                                    <strong>Recommendation:</strong> @firstIssue.Recommendation
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }

                        @if (!GetFilteredIssues().Any())
                        {
                            <div class="no-issues">
                                <p>No issues found in this category.</p>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Network Reference -->
        @if (lastResult?.Networks.Any() == true)
        {
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Network Reference</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Network</th>
                                <th>VLAN</th>
                                <th>Subnet</th>
                                <th>Purpose</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var network in lastResult.Networks.OrderBy(n => n.VlanId))
                            {
                                <tr>
                                    <td>@network.Name</td>
                                    <td>@(network.VlanId == 1 ? $"{network.VlanId} (native)" : network.VlanId.ToString())</td>
                                    <td>@(network.Subnet ?? "N/A")</td>
                                    <td>@network.Purpose</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        }

        <!-- DNS Security -->
        @if (includeDnsSecurity && lastResult?.DnsSecurity != null)
        {
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">DNS Security</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Configuration</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>DNS-over-HTTPS (DoH)</td>
                                <td class="@GetDohStatusClass()">
                                    @GetDohStatusText()
                                </td>
                                <td>@GetDohStatusDisplay()</td>
                            </tr>
                            <tr>
                                <td>DNS Leak Prevention (Port 53)</td>
                                <td class="@(lastResult.DnsSecurity.DnsLeakProtection ? "status-success" : "status-warning")">
                                    @(lastResult.DnsSecurity.DnsLeakProtection ? "Protected" : "Unprotected")
                                </td>
                                <td>@(lastResult.DnsSecurity.DnsLeakProtection ? "External DNS queries blocked" : "Devices can bypass network DNS")</td>
                            </tr>
                            <tr>
                                <td>DNS-over-TLS (Port 853)</td>
                                <td class="@(lastResult.DnsSecurity.DotBlocked ? "status-success" : "status-warning")">
                                    @(lastResult.DnsSecurity.DotBlocked ? "Blocked" : "Open")
                                </td>
                                <td>@(lastResult.DnsSecurity.DotBlocked ? "DoT queries blocked" : "Devices can use external DoT")</td>
                            </tr>
                            <tr>
                                <td>DoH Bypass Prevention</td>
                                <td class="@(lastResult.DnsSecurity.DohBypassBlocked ? "status-success" : "status-warning")">
                                    @(lastResult.DnsSecurity.DohBypassBlocked ? "Blocked" : "Open")
                                </td>
                                <td>@(lastResult.DnsSecurity.DohBypassBlocked ? "Public DoH providers blocked" : "Devices can use external DoH")</td>
                            </tr>
                            <tr>
                                <td>WAN DNS Configuration</td>
                                <td class="@GetWanDnsStatusClass()">
                                    @GetWanDnsStatus()
                                </td>
                                <td>@GetWanDnsDetails()</td>
                            </tr>
                            <tr>
                                <td>Device DNS Configuration</td>
                                <td class="@GetDeviceDnsStatusClass()">
                                    @GetDeviceDnsStatus()
                                </td>
                                <td>@GetDeviceDnsDetails()</td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                    <div class="dns-summary @GetDnsProtectionClass()">
                        <strong>Overall:</strong> @GetDnsProtectionSummary()
                    </div>
                </div>
            </div>
        }

        <!-- Hardening Measures -->
        @if (GetFilteredHardeningMeasures().Any())
        {
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Hardening Measures in Place</h2>
                </div>
                <div class="card-body">
                    <ul class="hardening-list">
                        @foreach (var measure in GetFilteredHardeningMeasures())
                        {
                            <li>@measure</li>
                        }
                    </ul>
                </div>
            </div>
        }

        <!-- Switch/Port Details -->
        @if (includePortSecurity && lastResult?.Switches.Any() == true)
        {
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Switch & Port Details</h2>
                </div>
                <div class="card-body">
                    @foreach (var sw in lastResult.Switches)
                    {
                        <div class="switch-section">
                            <h3 class="switch-title">
                                <DeviceIcon Model="@sw.ModelName" Size="lg" />
                                @FormatDeviceName(sw.Name, sw.IsGateway) <span class="switch-model">(@sw.ModelName)</span>
                            </h3>
                            <div class="table-responsive">
                            <table class="data-table port-table">
                                <thead>
                                    <tr>
                                        <th>Port</th>
                                        <th>Name</th>
                                        <th>Link</th>
                                        <th>PoE</th>
                                        <th>Port Sec</th>
                                        <th>Forward</th>
                                        <th>Native VLAN</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var port in sw.Ports)
                                    {
                                        var (status, statusClass) = GetPortStatus(port, sw.MaxCustomMacAcls > 0);
                                        // Check for any issues on this port (IoT/Camera placement, etc.)
                                        // Use MAC address for reliable switch identification when available
                                        var portIssue = issues.FirstOrDefault(i => !i.IsWireless && i.Port == port.PortIndex.ToString() && MatchesSwitch(i, sw));
                                        var hasPortIssue = portIssue != null;
                                        var finalClass = hasPortIssue ? (portIssue!.Severity == AuditSeverity.Critical ? "row-critical" : "row-warning") : statusClass;
                                        var finalStatus = hasPortIssue ? portIssue!.Title : status;
                                        <tr class="@finalClass">
                                            <td>@port.PortIndex</td>
                                            <td>@port.Name</td>
                                            <td>@GetLinkStatus(port)</td>
                                            <td>@GetPoeStatus(port)</td>
                                            <td>@GetPortSecurityStatus(port)</td>
                                            <td>@(port.Forward == "customize" ? "custom" : port.Forward)</td>
                                            <td>@(port.NativeNetwork != null ? $"{port.NativeNetwork} ({port.NativeVlan})" : (port.Forward == "disabled" ? "-" : ""))</td>
                                            <td>@finalStatus</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                            </div>
                            @if (sw.MaxCustomMacAcls == 0)
                            {
                                <p class="switch-note">Note: @sw.ModelName doesn't support MAC ACLs</p>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Wireless Clients -->
        @if (includeVlanSecurity && lastResult?.WirelessClients.Any() == true)
        {
            var apGroups = lastResult.WirelessClients.GroupBy(wc => wc.AccessPointName ?? "Unknown AP").OrderBy(g => g.Key);
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Wireless Clients by Access Point</h2>
                </div>
                <div class="card-body">
                    @foreach (var ap in apGroups)
                    {
                        var apModel = ap.FirstOrDefault()?.AccessPointModelName;
                        <div class="ap-section">
                            <h3 class="ap-title">
                                <DeviceIcon Model="@apModel" Size="lg" />
                                @ap.Key <span class="client-count">(@ap.Count() clients)</span>
                            </h3>
                            <div class="table-responsive">
                            <table class="data-table wireless-client-table">
                                <thead>
                                    <tr>
                                        <th>Client</th>
                                        <th>Type</th>
                                        <th>Network</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var client in ap.OrderBy(c => c.DisplayName))
                                    {
                                        var clientIssue = issues.FirstOrDefault(i => i.IsWireless && i.ClientMac == client.Mac);
                                        var hasIssue = clientIssue != null;
                                        var statusClass = hasIssue ? (clientIssue!.Severity == AuditSeverity.Critical ? "row-critical" : "row-warning") : "";
                                        var statusText = hasIssue ? clientIssue!.Title : "OK";
                                        var networkDisplay = DisplayFormatters.FormatNetworkWithVlan(client.NetworkName, client.VlanId);
                                        <tr class="@statusClass">
                                            <td>@client.DisplayName</td>
                                            <td>@client.DeviceCategory</td>
                                            <td>@networkDisplay</td>
                                            <td>@statusText</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Offline Clients (from history) -->
        @if (includeVlanSecurity && lastResult?.OfflineClients.Any() == true)
        {
            var offlineGroups = lastResult.OfflineClients
                .GroupBy(c => c.LastUplinkName ?? "Unknown")
                .OrderBy(g => g.Key);
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Offline Wireless Clients (Last 30 Days)</h2>
                </div>
                <div class="card-body">
                    @foreach (var group in offlineGroups)
                    {
                        var apModel = group.FirstOrDefault()?.LastUplinkModelName;
                        <div class="ap-section">
                            <h3 class="ap-title">
                                <DeviceIcon Model="@apModel" Size="lg" />
                                @group.Key <span class="client-count">(@group.Count() clients)</span>
                            </h3>
                            <div class="table-responsive">
                            <table class="data-table offline-client-table">
                                <thead>
                                    <tr>
                                        <th>Client</th>
                                        <th>Type</th>
                                        <th>Network</th>
                                        <th>Last Seen</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var client in group.OrderBy(c => c.DisplayName))
                                    {
                                        var clientIssue = issues.FirstOrDefault(i => i.IsWireless && i.ClientMac == client.Mac);
                                        var hasIssue = clientIssue != null;
                                        var statusClass = hasIssue
                                            ? (clientIssue!.Severity == AuditSeverity.Critical ? "row-critical" :
                                               clientIssue.Severity == AuditSeverity.Informational ? "" : "row-warning")
                                            : "";
                                        var statusText = hasIssue ? clientIssue!.Title : "OK";
                                        var networkDisplay = DisplayFormatters.FormatNetworkWithVlan(
                                            client.LastNetwork?.Name, client.LastNetwork?.VlanId);
                                        var recentBadge = client.IsRecentlyActive ? "" : " (stale)";
                                        <tr class="@statusClass">
                                            <td>@client.DisplayName</td>
                                            <td>@client.Detection.CategoryName</td>
                                            <td>@networkDisplay</td>
                                            <td>@client.LastSeenDisplay@recentBadge</td>
                                            <td>@statusText</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Port Security Summary -->
        @if (includePortSecurity && lastResult?.Switches.Any() == true)
        {
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Port Security Coverage Summary</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Device</th>
                                <th>Total</th>
                                <th>Disabled</th>
                                <th>MAC Restricted</th>
                                <th>Unprotected Active</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var sw in lastResult.Switches)
                            {
                                var totalPorts = sw.Ports.Count;
                                var disabledPorts = sw.Ports.Count(p => p.Forward == "disabled");
                                var macRestricted = sw.Ports.Count(p => p.PortSecurityMacs.Any());
                                var unprotectedActive = sw.Ports.Count(p => p.Forward == "native" && p.IsUp && !p.PortSecurityMacs.Any() && !p.IsUplink);
                                <tr>
                                    <td class="icon-cell"><DeviceIcon Model="@sw.ModelName" Size="md" /></td>
                                    <td>@sw.Name</td>
                                    <td>@totalPorts</td>
                                    <td>@disabledPorts</td>
                                    <td>@(sw.MaxCustomMacAcls > 0 ? macRestricted.ToString() : "0 (no ACL support)")</td>
                                    <td>@unprotectedActive</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        }
    }
    else if (!isRunning)
    {
        <div class="card">
            <div class="card-body text-center">
                <div class="empty-state">
                    <div class="empty-icon-img"><img src="/icons/shield-v2.png" alt="" /></div>
                    <h3>No Audit Results</h3>
                    <p>Run an audit to analyze your network security and configuration.</p>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isRunning = false;
    private bool hasResults = false;
    private string currentStep = "";
    private string lastAuditTime = "";
    private int auditProgress = 0;

    private bool includeFirewallRules = true;
    private bool includeVlanSecurity = true;
    private bool includePortSecurity = true;
    private bool includeDnsSecurity = true;

    private int securityScore = 0;
    private string scoreLabel = "";
    private string scoreClass = "";
    private int criticalCount = 0;
    private int warningCount = 0;
    private int infoCount = 0;

    private string selectedFilter = "all";
    private List<Services.AuditIssue> issues = new();
    private List<Services.AuditIssue> dismissedIssues = new();
    private Services.AuditResult? lastResult;

    // Collapsible issue type state - starts collapsed by default
    private HashSet<string> expandedIssueTypes = new();

    protected override async Task OnInitializedAsync()
    {
        // Wait for auto-connect to complete (if credentials are saved)
        // This prevents the "Not Connected" banner from flashing after page reload
        await ConnectionService.WaitForConnectionAsync();

        // Load previous audit results from database/cache
        var previousResult = await AuditService.LoadLastAuditFromDatabaseAsync();
        if (previousResult != null)
        {
            lastResult = previousResult;
            securityScore = previousResult.Score;
            scoreLabel = previousResult.ScoreLabel;
            scoreClass = previousResult.ScoreClass;

            // Use active (non-dismissed) issues
            var activeIssues = await AuditService.GetActiveIssuesAsync();
            criticalCount = activeIssues.Count(i => i.Severity == AuditSeverity.Critical);
            warningCount = activeIssues.Count(i => i.Severity == AuditSeverity.Recommended);
            infoCount = activeIssues.Count(i => i.Severity == AuditSeverity.Informational);
            issues = activeIssues;

            // Load dismissed issues
            dismissedIssues = await AuditService.GetDismissedIssuesAsync();

            lastAuditTime = previousResult.CompletedAt.ToString("MMM dd, yyyy HH:mm");
            hasResults = true;
        }
    }

    private async Task RunAudit()
    {
        isRunning = true;
        auditProgress = 0;
        currentStep = "Connecting to controller...";
        StateHasChanged();

        try
        {
            // Run audit and progress animation in parallel
            var auditTask = AuditService.RunAuditAsync(new Services.AuditOptions
            {
                IncludeFirewallRules = includeFirewallRules,
                IncludeVlanSecurity = includeVlanSecurity,
                IncludePortSecurity = includePortSecurity,
                IncludeDnsSecurity = includeDnsSecurity
            });

            // Progress steps run while audit executes
            var progressSteps = new[]
            {
                (20, "Fetching network data..."),
                (40, "Analyzing firewall rules..."),
                (60, "Checking port security..."),
                (80, "Evaluating DNS configuration...")
            };

            foreach (var (progress, step) in progressSteps)
            {
                if (auditTask.IsCompleted) break;
                await Task.Delay(400);
                auditProgress = progress;
                currentStep = step;
                StateHasChanged();
            }

            // Wait for audit to complete
            var result = await auditTask;
            auditProgress = 100;
            currentStep = "Complete!";
            StateHasChanged();

            lastResult = result;
            securityScore = result.Score;
            scoreLabel = result.ScoreLabel;
            scoreClass = result.ScoreClass;

            // Use active (non-dismissed) issues
            var activeIssues = await AuditService.GetActiveIssuesAsync();
            criticalCount = activeIssues.Count(i => i.Severity == AuditSeverity.Critical);
            warningCount = activeIssues.Count(i => i.Severity == AuditSeverity.Recommended);
            infoCount = activeIssues.Count(i => i.Severity == AuditSeverity.Informational);
            issues = activeIssues;

            // Load dismissed issues
            dismissedIssues = await AuditService.GetDismissedIssuesAsync();

            lastAuditTime = DateTime.Now.ToString("MMM dd, yyyy HH:mm");
            hasResults = true;
        }
        finally
        {
            isRunning = false;
            StateHasChanged();
        }
    }

    private string? exportError;

    private async Task ExportReport()
    {
        exportError = null;

        if (!hasResults || lastResult == null)
        {
            exportError = "No audit results to export. Run an audit first.";
            return;
        }

        try
        {
            Logger.LogInformation("Starting PDF export with {IssueCount} issues, {NetworkCount} networks, {SwitchCount} switches",
                issues.Count, lastResult.Networks.Count, lastResult.Switches.Count);

            // Build report data from audit results
            // Extract clean network name from gateway name for report title
            var gateway = lastResult.Switches.FirstOrDefault(s => s.IsGateway);
            var gatewayName = gateway?.Name ?? "Gateway";
            var networkName = ExtractNetworkName(gatewayName);

            // Helper to get device name for issues - firewall issues use gateway, others use DeviceName
            string GetIssueDeviceName(Services.AuditIssue issue)
            {
                if (!string.IsNullOrEmpty(issue.DeviceName))
                    return issue.DeviceName;
                if (issue.IsWireless)
                    return issue.AccessPoint ?? "Wireless";
                // Firewall issues (no device, no port, not wireless) belong to gateway
                return gatewayName;
            }
            var reportData = new NetworkOptimizer.Reports.ReportData
            {
                ClientName = networkName,
                GeneratedAt = DateTime.Now,
                SecurityScore = new NetworkOptimizer.Reports.SecurityScore
                {
                    Rating = securityScore >= 90 ? NetworkOptimizer.Reports.SecurityRating.Excellent
                           : securityScore >= 75 ? NetworkOptimizer.Reports.SecurityRating.Good
                           : securityScore >= 60 ? NetworkOptimizer.Reports.SecurityRating.Fair
                           : NetworkOptimizer.Reports.SecurityRating.NeedsWork,
                    CriticalIssueCount = criticalCount,
                    WarningCount = warningCount,
                    TotalPorts = lastResult.Statistics?.TotalPorts ?? 0,
                    DisabledPorts = lastResult.Statistics?.DisabledPorts ?? 0,
                    MacRestrictedPorts = lastResult.Statistics?.MacRestrictedPorts ?? 0
                },

                // Networks
                Networks = lastResult.Networks
                    .Select(n => new NetworkOptimizer.Reports.NetworkInfo
                    {
                        NetworkId = n.Id,
                        Name = n.Name,
                        VlanId = n.VlanId,
                        Subnet = n.Subnet ?? "N/A",
                        Purpose = n.Purpose,
                        Type = NetworkOptimizer.Reports.NetworkInfo.ParsePurpose(n.Purpose)
                    })
                    .ToList(),

                // Switches with ports
                Switches = lastResult.Switches
                    .Select(s => new NetworkOptimizer.Reports.SwitchDetail
                    {
                        Name = s.Name,
                        Model = s.Model ?? "",
                        ModelName = s.ModelName ?? s.Model ?? "",
                        DeviceType = s.DeviceType ?? "",
                        IsGateway = s.IsGateway,
                        MaxCustomMacAcls = s.MaxCustomMacAcls,
                        Ports = s.Ports
                            .Select(p => new NetworkOptimizer.Reports.PortDetail
                            {
                                PortIndex = p.PortIndex,
                                Name = p.Name,
                                IsUp = p.IsUp,
                                Speed = p.Speed,
                                Forward = p.Forward,
                                IsUplink = p.IsUplink,
                                NativeNetwork = p.NativeNetwork,
                                NativeVlan = p.NativeVlan,
                                ExcludedNetworks = p.ExcludedNetworks,
                                PortSecurityEnabled = p.PortSecurityEnabled,
                                PortSecurityMacs = p.PortSecurityMacs,
                                Isolation = p.Isolation,
                                PoeEnabled = p.PoeEnabled,
                                PoePower = p.PoePower,
                                PoeMode = p.PoeMode ?? ""
                            })
                            .ToList()
                    })
                    .ToList(),

                // Critical issues
                CriticalIssues = issues
                    .Where(i => i.Severity == AuditSeverity.Critical)
                    .Select(i => new NetworkOptimizer.Reports.AuditIssue
                    {
                        Severity = NetworkOptimizer.Reports.IssueSeverity.Critical,
                        SwitchName = GetIssueDeviceName(i),
                        SwitchMac = i.DeviceMac,
                        PortIndex = int.TryParse(i.Port, out var p) ? p : null,
                        PortId = int.TryParse(i.Port, out _) ? null : i.Port,  // Non-integer port IDs (e.g., "WAN1")
                        PortName = i.PortName ?? "",
                        CurrentNetwork = i.CurrentNetwork ?? "",
                        CurrentVlan = i.CurrentVlan,
                        Message = i.Description,
                        RecommendedAction = i.Recommendation,
                        // Wireless fields
                        IsWireless = i.IsWireless,
                        ClientName = i.ClientName,
                        ClientMac = i.ClientMac,
                        AccessPoint = i.AccessPoint,
                        WifiBand = i.WifiBand
                    })
                    .ToList(),

                // Recommended improvements
                RecommendedImprovements = issues
                    .Where(i => i.Severity == AuditSeverity.Recommended)
                    .Select(i => new NetworkOptimizer.Reports.AuditIssue
                    {
                        Severity = NetworkOptimizer.Reports.IssueSeverity.Warning,
                        SwitchName = GetIssueDeviceName(i),
                        SwitchMac = i.DeviceMac,
                        PortIndex = int.TryParse(i.Port, out var p) ? p : null,
                        PortId = int.TryParse(i.Port, out _) ? null : i.Port,  // Non-integer port IDs (e.g., "WAN1")
                        PortName = i.PortName ?? "",
                        CurrentNetwork = i.CurrentNetwork ?? "",
                        CurrentVlan = i.CurrentVlan,
                        Message = i.Description,
                        RecommendedAction = i.Recommendation,
                        // Wireless fields
                        IsWireless = i.IsWireless,
                        ClientName = i.ClientName,
                        ClientMac = i.ClientMac,
                        AccessPoint = i.AccessPoint,
                        WifiBand = i.WifiBand
                    })
                    .ToList(),

                // Hardening notes (filtered based on checkbox settings)
                HardeningNotes = GetFilteredHardeningMeasures(),

                // DNS Security (only include if checkbox enabled)
                DnsSecurity = includeDnsSecurity && lastResult.DnsSecurity != null ? new NetworkOptimizer.Reports.DnsSecuritySummary
                {
                    DohEnabled = lastResult.DnsSecurity.DohEnabled,
                    DohState = lastResult.DnsSecurity.DohState,
                    DohProviders = lastResult.DnsSecurity.DohProviders.ToList(),
                    DohConfigNames = lastResult.DnsSecurity.DohConfigNames.ToList(),
                    DnsLeakProtection = lastResult.DnsSecurity.DnsLeakProtection,
                    DotBlocked = lastResult.DnsSecurity.DotBlocked,
                    DohBypassBlocked = lastResult.DnsSecurity.DohBypassBlocked,
                    FullyProtected = lastResult.DnsSecurity.FullyProtected,
                    WanDnsServers = lastResult.DnsSecurity.WanDnsServers.ToList(),
                    WanDnsPtrResults = lastResult.DnsSecurity.WanDnsPtrResults.ToList(),
                    WanDnsMatchesDoH = lastResult.DnsSecurity.WanDnsMatchesDoH,
                    WanDnsOrderCorrect = lastResult.DnsSecurity.WanDnsOrderCorrect,
                    WanDnsProvider = lastResult.DnsSecurity.WanDnsProvider,
                    ExpectedDnsProvider = lastResult.DnsSecurity.ExpectedDnsProvider,
                    MismatchedDnsServers = lastResult.DnsSecurity.MismatchedDnsServers.ToList(),
                    MatchedDnsServers = lastResult.DnsSecurity.MatchedDnsServers.ToList(),
                    InterfacesWithMismatch = lastResult.DnsSecurity.InterfacesWithMismatch.ToList(),
                    InterfacesWithoutDns = lastResult.DnsSecurity.InterfacesWithoutDns.ToList(),
                    DeviceDnsPointsToGateway = lastResult.DnsSecurity.DeviceDnsPointsToGateway,
                    TotalDevicesChecked = lastResult.DnsSecurity.TotalDevicesChecked,
                    DevicesWithCorrectDns = lastResult.DnsSecurity.DevicesWithCorrectDns,
                    DhcpDeviceCount = lastResult.DnsSecurity.DhcpDeviceCount,
                    // Third-party DNS
                    HasThirdPartyDns = lastResult.DnsSecurity.HasThirdPartyDns,
                    IsPiholeDetected = lastResult.DnsSecurity.IsPiholeDetected,
                    ThirdPartyDnsProviderName = lastResult.DnsSecurity.ThirdPartyDnsProviderName,
                    ThirdPartyNetworks = lastResult.DnsSecurity.ThirdPartyNetworks
                        .Select(n => new NetworkOptimizer.Reports.ThirdPartyDnsNetworkInfo
                        {
                            NetworkName = n.NetworkName,
                            VlanId = n.VlanId,
                            DnsServerIp = n.DnsServerIp,
                            DnsProviderName = n.DnsProviderName
                        })
                        .ToList()
                } : null,

                // Access Points with wireless clients (grouped by AP MAC for accurate grouping)
                AccessPoints = lastResult.WirelessClients
                    .GroupBy(wc => wc.AccessPointMac ?? "unknown")
                    .Select(g =>
                    {
                        var firstClient = g.First();
                        return new NetworkOptimizer.Reports.AccessPointDetail
                        {
                            Name = firstClient.AccessPointName ?? "Unknown AP",
                            Mac = g.Key,
                            Model = firstClient.AccessPointModel ?? string.Empty,
                            ModelName = firstClient.AccessPointModelName ?? string.Empty,
                            Clients = g.Select(wc => {
                                var clientIssue = issues.FirstOrDefault(i => i.IsWireless && i.ClientMac == wc.Mac);
                                return new NetworkOptimizer.Reports.WirelessClientDetail
                                {
                                    DisplayName = wc.DisplayName,
                                    Mac = wc.Mac,
                                    Network = wc.NetworkName,
                                    VlanId = wc.VlanId,
                                    DeviceCategory = wc.DeviceCategory,
                                    VendorName = wc.VendorName,
                                    DetectionConfidence = wc.DetectionConfidence,
                                    IsIoT = wc.IsIoT,
                                    IsCamera = wc.IsCamera,
                                    HasIssue = clientIssue != null,
                                    IssueTitle = clientIssue?.Title,
                                    IssueMessage = clientIssue?.Description
                                };
                            }).ToList()
                        };
                    })
                    .OrderBy(ap => ap.Name)
                    .ToList(),

                // Offline clients from history API
                OfflineClients = lastResult.OfflineClients
                    .Select(oc => {
                        var clientIssue = issues.FirstOrDefault(i => i.IsWireless && i.ClientMac == oc.Mac);
                        return new NetworkOptimizer.Reports.OfflineClientDetail
                        {
                            DisplayName = oc.DisplayName,
                            Mac = oc.Mac ?? "",
                            Network = oc.LastNetwork?.Name,
                            VlanId = oc.LastNetwork?.VlanId,
                            DeviceCategory = oc.Detection.CategoryName,
                            LastUplinkName = oc.LastUplinkName,
                            LastSeenDisplay = oc.LastSeenDisplay,
                            IsRecentlyActive = oc.IsRecentlyActive,
                            IsIoT = oc.Detection.Category.IsIoT(),
                            IsCamera = oc.Detection.Category.IsSurveillance(),
                            HasIssue = clientIssue != null,
                            IssueTitle = clientIssue?.Title,
                            IssueSeverity = clientIssue?.Severity.ToString()
                        };
                    })
                    .ToList()
            };

            // Generate PDF
            Logger.LogInformation("Generating PDF with {CriticalCount} critical, {WarningCount} warnings, {SwitchCount} switches",
                reportData.CriticalIssues.Count, reportData.RecommendedImprovements.Count, reportData.Switches.Count);
            var generator = new NetworkOptimizer.Reports.PdfReportGenerator();
            var pdfBytes = generator.GenerateReportBytes(reportData);
            Logger.LogInformation("PDF generated: {Size} bytes", pdfBytes.Length);

            // Download file via JS interop
            var fileName = $"NetworkAudit_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            var base64 = Convert.ToBase64String(pdfBytes);
            Logger.LogInformation("Calling JS downloadFile for {FileName}", fileName);
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/pdf", base64);
            Logger.LogInformation("PDF download initiated");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error generating PDF report");
            exportError = $"Error generating PDF: {ex.Message}";
            StateHasChanged();
        }
    }

    private IEnumerable<Services.AuditIssue> GetFilteredIssues()
    {
        if (selectedFilter == "all")
            return issues;
        return issues.Where(i => GetSeverityCssClass(i.Severity) == selectedFilter);
    }

    private IEnumerable<IGrouping<(string Title, AuditSeverity Severity, string? Description, string Recommendation), Services.AuditIssue>> GetGroupedFilteredIssues()
    {
        // Smart grouping based on issue type:
        // - Device issues (has DeviceName/Port): group by Title+Severity+Description+Recommendation
        // - Non-device issues: group by Title+Severity+Recommendation only (Description shown per-item)
        return GetFilteredIssues()
            .GroupBy(i => (
                i.Title,
                i.Severity,
                // For device issues, include Description in key; for non-device, use null to collapse
                HasDeviceInfo(i) ? i.Description : null,
                i.Recommendation
            ))
            .OrderBy(g => GetSeverityOrder(g.Key.Severity))
            .ThenBy(g => g.Key.Title);
    }

    private bool HasDeviceInfo(Services.AuditIssue issue)
    {
        return !string.IsNullOrEmpty(issue.DeviceName) || !string.IsNullOrEmpty(issue.Port);
    }

    private int GetSeverityOrder(AuditSeverity severity)
    {
        return severity switch
        {
            AuditSeverity.Critical => 1,
            AuditSeverity.Recommended => 2,
            _ => 3
        };
    }

    private void ToggleIssueType(string issueType)
    {
        if (expandedIssueTypes.Contains(issueType))
            expandedIssueTypes.Remove(issueType);
        else
            expandedIssueTypes.Add(issueType);
    }

    private string GetSeverityIcon(AuditSeverity severity)
    {
        return severity switch
        {
            // Shield with exclamation - critical/danger
            AuditSeverity.Critical => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 2L3 7v6c0 5.25 3.85 10.15 9 11 5.15-.85 9-5.75 9-11V7l-9-5zm-1 14h2v2h-2v-2zm0-8h2v6h-2V8z" opacity="0.2"/><path d="M12 2L3 7v6c0 5.25 3.85 10.15 9 11 5.15-.85 9-5.75 9-11V7l-9-5zm0 2.18l7 3.89v5.43c0 4.14-3.01 8.05-7 8.88-3.99-.83-7-4.74-7-8.88V8.07l7-3.89zM11 8h2v6h-2V8zm0 8h2v2h-2v-2z"/></svg>""",
            // Triangle with exclamation - recommended (was warning)
            AuditSeverity.Recommended => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M1 21h22L12 2 1 21z" opacity="0.2"/><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14h-2v2h2v-2zm0-6h-2v4h2v-4z"/></svg>""",
            // Circle with i - info
            AuditSeverity.Informational => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-11h2v6h-2v-6zm0-4h2v2h-2V7z"/></svg>""",
            _ => """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>"""
        };
    }

    /// <summary>
    /// Get display-friendly name for severity (shows "Info" instead of "Informational")
    /// </summary>
    private static string GetSeverityDisplayName(AuditSeverity severity) => severity switch
    {
        AuditSeverity.Informational => "Info",
        _ => severity.ToString()
    };

    /// <summary>
    /// Get CSS class suffix for severity (matches existing CSS which uses "info" not "informational")
    /// </summary>
    private static string GetSeverityCssClass(AuditSeverity severity) => severity switch
    {
        AuditSeverity.Informational => "info",
        _ => severity.ToString().ToLowerInvariant()
    };

    private async Task DismissIssue(Services.AuditIssue issue)
    {
        await AuditService.DismissIssueAsync(issue);

        // Move from active to dismissed
        issues.Remove(issue);
        dismissedIssues.Add(issue);

        // Update counts
        criticalCount = issues.Count(i => i.Severity == AuditSeverity.Critical);
        warningCount = issues.Count(i => i.Severity == AuditSeverity.Recommended);
        infoCount = issues.Count(i => i.Severity == AuditSeverity.Informational);

        StateHasChanged();
    }

    private async Task RestoreIssue(Services.AuditIssue issue)
    {
        await AuditService.RestoreIssueAsync(issue);

        // Move from dismissed to active
        dismissedIssues.Remove(issue);
        issues.Add(issue);

        // Update counts
        criticalCount = issues.Count(i => i.Severity == AuditSeverity.Critical);
        warningCount = issues.Count(i => i.Severity == AuditSeverity.Recommended);
        infoCount = issues.Count(i => i.Severity == AuditSeverity.Informational);

        StateHasChanged();
    }

    // Device name formatting uses shared DisplayFormatters class
    private static string ExtractNetworkName(string deviceName) => DisplayFormatters.ExtractNetworkName(deviceName);
    private static string FormatDeviceName(string deviceName, bool isGateway) => DisplayFormatters.FormatDeviceName(deviceName, isGateway);

    private string GetDohStatusClass()
    {
        if (lastResult?.DnsSecurity == null) return "";
        var dns = lastResult.DnsSecurity;

        if (dns.DohEnabled) return "status-success";
        if (dns.HasThirdPartyDns) return "status-neutral";
        return "status-warning";
    }

    private string GetDohStatusText()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;

        if (dns.DohEnabled) return "Enabled";
        if (dns.HasThirdPartyDns) return "Third-Party";
        return "Disabled";
    }

    private string GetDohStatusDisplay()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;

        if (dns.DohEnabled)
        {
            return DisplayFormatters.GetDohStatusDisplay(dns.DohEnabled, dns.DohState, dns.DohProviders.ToList(), dns.DohConfigNames.ToList());
        }

        if (dns.HasThirdPartyDns)
        {
            var provider = dns.ThirdPartyDnsProviderName ?? "Third-Party DNS";
            var ips = dns.ThirdPartyNetworks.Select(n => n.DnsServerIp).Distinct().ToList();
            var networks = dns.ThirdPartyNetworks.Select(n => n.NetworkName).Distinct().ToList();
            return $"{provider} ({string.Join(", ", ips)}) on {string.Join(", ", networks)}";
        }

        return "Not Configured";
    }

    private string GetDnsProtectionClass()
    {
        if (lastResult?.DnsSecurity == null) return "";
        var dns = lastResult.DnsSecurity;

        if (dns.FullyProtected) return "dns-protected";
        if (dns.HasThirdPartyDns && dns.DnsLeakProtection) return "dns-protected";
        if (dns.HasThirdPartyDns) return "dns-partial";
        if (dns.DohEnabled) return "dns-partial";
        return "dns-partial";
    }

    private string GetDnsProtectionSummary()
    {
        if (lastResult?.DnsSecurity == null) return "Unknown";
        var dns = lastResult.DnsSecurity;

        if (dns.FullyProtected) return "Full DNS Protection";

        if (dns.HasThirdPartyDns)
        {
            var provider = dns.ThirdPartyDnsProviderName ?? "Third-Party DNS";
            if (dns.DnsLeakProtection)
                return $"{provider} with Leak Prevention";
            return $"{provider} (Consider adding leak prevention)";
        }

        if (dns.DohEnabled) return "Partial Protection";
        return "Not Protected";
    }

    /// <summary>
    /// Filter hardening measures based on which audit sections are enabled.
    /// DNS-related notes are filtered when DNS Security is disabled.
    /// VLAN-related notes are filtered when VLAN Security is disabled.
    /// </summary>
    private List<string> GetFilteredHardeningMeasures()
    {
        if (lastResult?.HardeningMeasures == null)
            return new List<string>();

        return lastResult.HardeningMeasures
            .Where(m => ShouldShowHardeningMeasure(m))
            .ToList();
    }

    private bool ShouldShowHardeningMeasure(string measure)
    {
        var lowerMeasure = measure.ToLowerInvariant();

        // DNS-related measures (filter when DNS Security is disabled)
        if (!includeDnsSecurity)
        {
            if (lowerMeasure.Contains("dns") ||
                lowerMeasure.Contains("doh") ||
                lowerMeasure.Contains("dot") ||
                lowerMeasure.Contains("wan dns") ||
                lowerMeasure.Contains("nextdns") ||
                lowerMeasure.Contains("cloudflare") ||
                lowerMeasure.Contains("point to gateway") ||
                lowerMeasure.Contains("leak prevention"))
            {
                return false;
            }
        }

        // VLAN-related measures (filter when VLAN Security is disabled)
        if (!includeVlanSecurity)
        {
            if (lowerMeasure.Contains("vlan") ||
                lowerMeasure.Contains("isolated") ||
                lowerMeasure.Contains("security vlan") ||
                lowerMeasure.Contains("iot vlan") ||
                lowerMeasure.Contains("camera"))
            {
                return false;
            }
        }

        // Port security measures (filter when Port Security is disabled)
        if (!includePortSecurity)
        {
            if (lowerMeasure.Contains("mac") ||
                lowerMeasure.Contains("port") ||
                lowerMeasure.Contains("acl"))
            {
                return false;
            }
        }

        return true;
    }

    private string GetWanDnsStatusClass()
    {
        if (lastResult?.DnsSecurity == null) return "";
        var dns = lastResult.DnsSecurity;
        if (!dns.WanDnsServers.Any()) return "status-neutral";
        if (dns.WanDnsMatchesDoH && !dns.WanDnsOrderCorrect) return "status-warning";
        if (dns.WanDnsMatchesDoH) return "status-success";
        return "status-warning";
    }

    private string GetWanDnsStatus()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;
        if (!dns.WanDnsServers.Any()) return "Not Configured";
        if (dns.WanDnsMatchesDoH && !dns.WanDnsOrderCorrect) return "Wrong Order";
        if (dns.WanDnsMatchesDoH) return "Matched";
        return "Mismatched";
    }

    private string GetWanDnsDetails()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;
        if (!dns.WanDnsServers.Any() && !dns.InterfacesWithoutDns.Any()) return "No WAN DNS servers configured";

        return DisplayFormatters.GetWanDnsDisplay(
            dns.WanDnsServers.ToList(), dns.WanDnsPtrResults.ToList(),
            dns.MatchedDnsServers.ToList(), dns.MismatchedDnsServers.ToList(),
            dns.InterfacesWithMismatch.ToList(), dns.InterfacesWithoutDns.ToList(),
            dns.WanDnsProvider, dns.ExpectedDnsProvider, dns.WanDnsMatchesDoH, dns.WanDnsOrderCorrect);
    }

    private string GetDeviceDnsStatusClass()
    {
        if (lastResult?.DnsSecurity == null) return "";
        var dns = lastResult.DnsSecurity;
        if (dns.TotalDevicesChecked == 0 && dns.DhcpDeviceCount == 0) return "status-neutral";
        if (dns.DeviceDnsPointsToGateway) return "status-success";
        return "status-warning";
    }

    private string GetDeviceDnsStatus()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;
        if (dns.TotalDevicesChecked == 0 && dns.DhcpDeviceCount == 0) return "No Devices";
        if (dns.DeviceDnsPointsToGateway) return "Correct";
        return "Misconfigured";
    }

    private string GetDeviceDnsDetails()
    {
        if (lastResult?.DnsSecurity == null) return "N/A";
        var dns = lastResult.DnsSecurity;
        return DisplayFormatters.GetDeviceDnsDisplay(
            dns.TotalDevicesChecked, dns.DevicesWithCorrectDns, dns.DhcpDeviceCount, dns.DeviceDnsPointsToGateway);
    }

    /// <summary>
    /// Determines if an audit issue belongs to a specific switch.
    /// Uses MAC address for reliable identification when available.
    /// </summary>
    private static bool MatchesSwitch(Services.AuditIssue issue, Services.SwitchReference sw)
    {
        // Prefer MAC matching when available (reliable unique identifier)
        if (!string.IsNullOrEmpty(issue.DeviceMac) && !string.IsNullOrEmpty(sw.Mac))
        {
            return issue.DeviceMac.Equals(sw.Mac, StringComparison.OrdinalIgnoreCase);
        }

        // Fall back to name matching for backwards compatibility
        return issue.DeviceName?.Contains(sw.Name) ?? false;
    }

    private string GetLinkStatus(Services.PortReference port) =>
        DisplayFormatters.GetLinkStatus(port.IsUp, port.Speed);

    private string GetPoeStatus(Services.PortReference port) =>
        DisplayFormatters.GetPoeStatus(port.PoePower, port.PoeMode, port.PoeEnabled);

    private string GetPortSecurityStatus(Services.PortReference port) =>
        DisplayFormatters.GetPortSecurityStatus(port.PortSecurityMacs.Count, port.PortSecurityEnabled);

    private (string Status, string StatusClass) GetPortStatus(Services.PortReference port, bool supportsAcls)
    {
        if (port.Forward == "disabled")
            return ("Disabled", "");

        if (!port.IsUp && port.Forward != "disabled")
            return ("Off", "");

        if (port.IsUplink || port.Name.ToLower().Contains("uplink"))
            return ("Trunk", "");

        if (port.Forward == "all")
            return ("Trunk", "");

        if (port.Forward == "custom" || port.Forward == "customize")
        {
            if (port.Name.ToLower().Contains("ap") || port.Name.ToLower().Contains("access point"))
                return ("AP", "");
            return ("OK", "");
        }

        if (port.Forward == "native")
        {
            if (port.IsUp && supportsAcls && !port.PortSecurityMacs.Any() && !port.IsUplink)
                return ("No MAC", "row-warning");
            return ("OK", "");
        }

        return ("OK", "");
    }
}
