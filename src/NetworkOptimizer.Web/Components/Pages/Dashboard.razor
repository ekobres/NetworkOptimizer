@page "/"
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Storage.Models
@inject DashboardService DashboardService
@inject UniFiConnectionService ConnectionService
@inject Iperf3SpeedTestService SpeedTestService
@inject IAdminAuthService AdminAuthService
@inject NavigationManager NavigationManager
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Dashboard - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Dashboard</h1>
    <p class="page-description">Network overview and health status</p>
</div>

@if (_passwordSource == AdminPasswordSource.AutoGenerated)
{
    <div class="connection-banner" style="background: var(--warning-bg, #fff3cd); border-color: var(--warning-border, #ffc107); color: #856404;">
        <div class="banner-content">
            <span class="banner-icon" style="background: var(--warning-color, #856404); color: white;">!</span>
            <div class="banner-text">
                <strong style="color: #664d03;">Using Auto-Generated Password</strong>
                <span style="color: #664d03;">Set a permanent admin password in Settings to secure your installation.</span>
            </div>
            <a href="/settings#admin-password" class="btn btn-warning">Set Password</a>
        </div>
    </div>
}

@if (!ConnectionService.IsConnected && ConnectionService.IsInitialized)
{
    <div class="connection-banner @(!string.IsNullOrEmpty(ConnectionService.LastError) ? "connection-error" : "")">
        <div class="banner-content">
            <span class="banner-icon">!</span>
            <div class="banner-text">
                @if (!string.IsNullOrEmpty(ConnectionService.LastError))
                {
                    <strong>Connection Error</strong>
                    <span>@ConnectionService.LastError</span>
                }
                else
                {
                    <strong>Not Connected</strong>
                    <span>Connect to your UniFi Console (Controller) to view network data.</span>
                }
            </div>
            <a href="/settings" class="btn btn-primary">@(!string.IsNullOrEmpty(ConnectionService.LastError) ? "Check Settings" : "Connect Now")</a>
        </div>
    </div>
}

<NetworkOptimizer.Web.Components.Shared.UpdateChecker />
<NetworkOptimizer.Web.Components.Shared.SponsorshipBanner />

<div class="dashboard-grid">
    <!-- Quick Stats -->
    <div class="stats-row">
        <a href="#device-status" class="stat-card stat-card-link">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
                    <path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" opacity="0.7"></path>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10Zm4-10a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z" opacity="0.6"></path>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M16 12a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm-1 0a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" style="fill: var(--primary-hover)"></path>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10Zm-1 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">
                    @if (_loading)
                    {
                        <span class="spinner-sm"></span>
                    }
                    else
                    {
                        @deviceCount
                    }
                </div>
                <div class="stat-label">Total Devices</div>
            </div>
        </a>

        <a href="/audit" class="stat-card stat-card-link">
            <img src="/icons/shield-v2.png" alt="" class="stat-icon-img" />
            <div class="stat-content">
                <div class="stat-value">
                    @if (_loading)
                    {
                        <span class="spinner-sm"></span>
                    }
                    else
                    {
                        @securityScore
                    }
                </div>
                <div class="stat-label">Security Score</div>
            </div>
        </a>

        <a href="/sqm" class="stat-card stat-card-link stat-success">
            <img src="/icons/sqm-v3.png" alt="" class="stat-icon-img" />
            <div class="stat-content">
                <div class="stat-value stat-value-text">
                    @if (_loading)
                    {
                        <span class="spinner-sm"></span>
                    }
                    else if (sqmStatus == "Not Configured")
                    {
                        <span class="desktop-label">Not Configured</span>
                        <span class="mobile-label">Off</span>
                    }
                    else
                    {
                        @sqmStatus
                    }
                </div>
                <div class="stat-label">
                    <span class="desktop-label">Adaptive SQM Status</span>
                    <span class="mobile-label">Adaptive SQM</span>
                </div>
            </div>
        </a>

        <a href="#recent-alerts" class="stat-card stat-card-link stat-warning">
            <img src="/icons/warning-v2.png" alt="" class="stat-icon-img stat-icon-sm" />
            <div class="stat-content">
                <div class="stat-value">
                    @if (_loading)
                    {
                        <span class="spinner-sm"></span>
                    }
                    else
                    {
                        @alertCount
                    }
                </div>
                <div class="stat-label">Active Alerts</div>
            </div>
        </a>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Security Score Gauge -->
        <div class="card clickable-card" @onclick="@(() => NavigationManager.NavigateTo("/audit"))">
            <div class="card-header">
                <a href="/audit" class="card-title-link" @onclick:stopPropagation><h2 class="card-title">Security Posture</h2></a>
            </div>
            <div class="card-body">
                @if (_loading)
                {
                    <div class="loading-state">
                        <span class="spinner-sm"></span>
                        <span>Loading...</span>
                    </div>
                }
                else
                {
                    <SecurityScoreGauge Score="@securityScore" />
                }
                <div class="security-summary">
                    <div class="summary-item">
                        <span class="summary-label">Critical Issues:</span>
                        <span class="summary-value @(criticalIssues > 0 ? "critical" : "")">
                            @if (_loading)
                            {
                                <span class="spinner-sm"></span>
                            }
                            else
                            {
                                @criticalIssues
                            }
                        </span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Recommended:</span>
                        <span class="summary-value @(warningIssues > 0 ? "recommended" : "")">
                            @if (_loading)
                            {
                                <span class="spinner-sm"></span>
                            }
                            else
                            {
                                @warningIssues
                            }
                        </span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Last Audit:</span>
                        <span class="summary-value">
                            @if (_loading)
                            {
                                <span class="spinner-sm"></span>
                            }
                            else
                            {
                                @lastAuditTime
                            }
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SQM Status Panel -->
        <div class="card">
            <div class="card-header">
                <a href="/sqm" class="card-title-link"><h2 class="card-title">Adaptive SQM</h2></a>
            </div>
            <div class="card-body">
                <SqmStatusPanel @key="_sqmPanelKey" />
            </div>
        </div>

        <!-- Cellular Modem Stats -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Cellular Stats (5G / LTE)</h2>
            </div>
            <div class="card-body">
                <CellularStatsPanel />
            </div>
        </div>

        <!-- LAN Speed Test Stats -->
        <div class="card clickable-card" @onclick="@(() => NavigationManager.NavigateTo("/speedtest"))">
            <div class="card-header">
                <a href="/speedtest" class="card-title-link" @onclick:stopPropagation><h2 class="card-title">LAN Speed Test</h2></a>
                <a href="/speedtest" class="card-action" @onclick:stopPropagation>View All →</a>
            </div>
            <div class="card-body">
                @if (_speedTestLoading)
                {
                    <div class="loading-state">
                        <span class="spinner-sm"></span>
                        <span>Loading...</span>
                    </div>
                }
                else if (_recentSpeedTests.Count == 0)
                {
                    <div class="empty-state">
                        <p>No speed tests yet</p>
                    </div>
                }
                else
                {
                    <div class="speed-test-list">
                        @foreach (var test in _recentSpeedTests)
                        {
                            <div class="speed-test-row">
                                <span class="speed-test-device">@(test.DeviceName ?? "Unknown")</span>
                                <span class="speed-test-speeds">
                                    <span class="speed-down">↓@test.DownloadMbps.ToString("F0")</span>
                                    <span class="speed-up">↑@test.UploadMbps.ToString("F0")</span>
                                </span>
                                <span class="speed-test-time">@test.TestTime.ToLocalTime().ToString("MMM d, h:mm tt")</span>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Recent Alerts -->
        <div class="card card-span-2" id="recent-alerts">
            <div class="card-header">
                <a href="/audit" class="card-title-link"><h2 class="card-title">Recent Alerts</h2></a>
                <a href="/audit" class="card-action">View All →</a>
            </div>
            <div class="card-body">
                <AlertsList @key="_alertsListKey" MaxItems="5" OnAlertDismissed="OnAlertDismissed" />
            </div>
        </div>

        <!-- Device Overview -->
        <div class="card card-span-2" id="device-status">
            <div class="card-header">
                <h2 class="card-title">Device Status</h2>
            </div>
            <div class="card-body">
                @if (_loading)
                {
                    <div class="loading-state">
                        <span class="spinner-sm"></span>
                        <span>Loading devices...</span>
                    </div>
                }
                else if (devices.Count == 0)
                {
                    <div class="empty-state">
                        <p>No devices found. Connect to your UniFi Console to see devices.</p>
                    </div>
                }
                else
                {
                    <div class="device-grid">
                        @foreach (var device in devices)
                        {
                            <DeviceCard Device="@device" />
                        }
                    </div>
                }
            </div>
        </div>

    </div>
</div>

@code {
    private bool _loading = true;
    private bool _speedTestLoading = true;
    private int deviceCount = 0;
    private int securityScore = 0;
    private string sqmStatus = "Not Configured";
    private int alertCount = 0;
    private int criticalIssues = 0;
    private int warningIssues = 0;
    private string lastAuditTime = "Never";
    private List<Services.DeviceInfo> devices = new();
    private List<Iperf3Result> _recentSpeedTests = new();
    private int _sqmPanelKey = 0;
    private int _alertsListKey = 0;
    private AdminPasswordSource _passwordSource = AdminPasswordSource.None;

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        ConnectionService.OnConnectionChanged += OnConnectionChanged;

        // Fire and forget - page renders immediately with spinners, data loads in background
        _ = LoadAllDataAsync();
    }

    private async void OnConnectionChanged()
    {
        // Connection changed (new site, reconnect, etc.) - refresh all data
        _sqmPanelKey++; // Force SqmStatusPanel to recreate
        _alertsListKey++; // Force AlertsList to recreate
        await Task.WhenAll(
            LoadDashboardData(),
            LoadSpeedTestData()
        );
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadAllDataAsync()
    {
        // Check password source (don't wait for controller)
        try
        {
            _passwordSource = await AdminAuthService.GetPasswordSourceAsync();
        }
        catch
        {
            // Ignore - will show as None
        }

        // Brief wait for controller connection
        await ConnectionService.WaitForConnectionAsync();

        // Load in parallel
        await Task.WhenAll(
            LoadDashboardData(),
            LoadSpeedTestData()
        );

        await InvokeAsync(StateHasChanged);
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // If navigating to dashboard, reload data
        if (e.Location.EndsWith("/") || e.Location.EndsWith("/dashboard", StringComparison.OrdinalIgnoreCase))
        {
            _sqmPanelKey++; // Force SqmStatusPanel to recreate
            _alertsListKey++; // Force AlertsList to recreate
            await Task.WhenAll(
                LoadDashboardData(),
                LoadSpeedTestData()
            );
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        ConnectionService.OnConnectionChanged -= OnConnectionChanged;
    }

    private async Task LoadSpeedTestData()
    {
        _speedTestLoading = true;
        try
        {
            var results = await SpeedTestService.GetRecentResultsAsync(10);
            _recentSpeedTests = results.Where(r => r.Success).Take(5).ToList();
        }
        catch
        {
            // Ignore errors - just show empty state
        }
        finally
        {
            _speedTestLoading = false;
        }
    }

    private async Task LoadDashboardData()
    {
        _loading = true;
        try
        {
            var data = await DashboardService.GetDashboardDataAsync();
            deviceCount = data.DeviceCount;
            securityScore = data.SecurityScore;
            sqmStatus = data.SqmStatus;
            alertCount = data.AlertCount;
            criticalIssues = data.CriticalIssues;
            warningIssues = data.WarningIssues;
            lastAuditTime = data.LastAuditTime;
            devices = data.Devices;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnAlertDismissed()
    {
        // Refresh dashboard data when an alert is dismissed
        await LoadDashboardData();
        StateHasChanged();
    }
}
