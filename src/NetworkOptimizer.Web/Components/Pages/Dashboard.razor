@page "/"
@using NetworkOptimizer.Web.Services
@inject DashboardService DashboardService
@inject UniFiConnectionService ConnectionService
@rendermode InteractiveServer

<PageTitle>Dashboard - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Dashboard</h1>
    <p class="page-description">Network overview and health status</p>
</div>

@if (!ConnectionService.IsConnected)
{
    <div class="connection-banner">
        <div class="banner-content">
            <span class="banner-icon">!</span>
            <div class="banner-text">
                <strong>Not Connected</strong>
                <span>Connect to your UniFi controller to view real network data.</span>
            </div>
            <a href="/settings" class="btn btn-primary">Connect Now</a>
        </div>
    </div>
}

<div class="dashboard-grid">
    <!-- Quick Stats -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
                    <path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" opacity="0.4"></path>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10Zm4-10a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z" opacity="0.4"></path>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M16 12a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm-1 0a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10Zm-1 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">@deviceCount</div>
                <div class="stat-label">Total Devices</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üõ°Ô∏è</div>
            <div class="stat-content">
                <div class="stat-value">@securityScore</div>
                <div class="stat-label">Security Score</div>
            </div>
        </div>

        <div class="stat-card stat-success">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-content">
                <div class="stat-value">@sqmStatus</div>
                <div class="stat-label">SQM Status</div>
            </div>
        </div>

        <div class="stat-card stat-warning">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-content">
                <div class="stat-value">@alertCount</div>
                <div class="stat-label">Active Alerts</div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Security Score Gauge -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Security Posture</h2>
            </div>
            <div class="card-body">
                <SecurityScoreGauge Score="@securityScore" />
                <div class="security-summary">
                    <div class="summary-item">
                        <span class="summary-label">Critical Issues:</span>
                        <span class="summary-value critical">@criticalIssues</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Warnings:</span>
                        <span class="summary-value warning">@warningIssues</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Last Audit:</span>
                        <span class="summary-value">@lastAuditTime</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SQM Status Panel -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">SQM Performance</h2>
            </div>
            <div class="card-body">
                <SqmStatusPanel />
            </div>
        </div>

        <!-- Cellular Modem Stats -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Cellular (5G/LTE)</h2>
            </div>
            <div class="card-body">
                <CellularStatsPanel />
            </div>
        </div>

        <!-- Recent Alerts -->
        <div class="card card-span-2">
            <div class="card-header">
                <h2 class="card-title">Recent Alerts</h2>
                <a href="/audit" class="card-action">View All</a>
            </div>
            <div class="card-body">
                <AlertsList MaxItems="5" />
            </div>
        </div>

        <!-- Device Overview -->
        <div class="card card-span-2">
            <div class="card-header">
                <h2 class="card-title">Device Status</h2>
            </div>
            <div class="card-body">
                <div class="device-grid">
                    @foreach (var device in devices)
                    {
                        <DeviceCard Device="@device" />
                    }
                </div>
            </div>
        </div>

        <!-- Agent Status -->
        <div class="card card-span-2">
            <div class="card-header">
                <h2 class="card-title">Agent Health</h2>
                <a href="/agents" class="card-action">Manage Agents</a>
            </div>
            <div class="card-body">
                <AgentStatusTable MaxAgents="5" />
            </div>
        </div>
    </div>
</div>

@code {
    private int deviceCount = 0;
    private int securityScore = 0;
    private string sqmStatus = "Not Configured";
    private int alertCount = 0;
    private int criticalIssues = 0;
    private int warningIssues = 0;
    private string lastAuditTime = "Never";
    private List<Services.DeviceInfo> devices = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        var data = await DashboardService.GetDashboardDataAsync();
        deviceCount = data.DeviceCount;
        securityScore = data.SecurityScore;
        sqmStatus = data.SqmStatus;
        alertCount = data.AlertCount;
        criticalIssues = data.CriticalIssues;
        warningIssues = data.WarningIssues;
        lastAuditTime = data.LastAuditTime;
        devices = data.Devices;
    }
}
