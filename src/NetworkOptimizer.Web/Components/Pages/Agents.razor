@page "/agents"
@inject AgentService AgentService
@rendermode InteractiveServer

<PageTitle>Agents - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Agent Management</h1>
    <p class="page-description">Deploy and monitor distributed monitoring agents</p>
</div>

<div class="agents-container">
    <!-- Agent Overview -->
    <div class="stats-row">
        <div class="stat-card stat-success">
            <div class="stat-icon">‚úì</div>
            <div class="stat-content">
                <div class="stat-value">@activeAgents</div>
                <div class="stat-label">Active Agents</div>
            </div>
        </div>

        <div class="stat-card stat-warning">
            <div class="stat-icon">‚ö†</div>
            <div class="stat-content">
                <div class="stat-value">@inactiveAgents</div>
                <div class="stat-label">Inactive</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <div class="stat-value">@totalMetrics</div>
                <div class="stat-label">Metrics/min</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-content">
                <div class="stat-value">@avgLatency</div>
                <div class="stat-label">Avg Latency (ms)</div>
            </div>
        </div>
    </div>

    <!-- Deploy New Agent -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Deploy New Agent</h2>
        </div>
        <div class="card-body">
            <div class="deployment-wizard">
                <div class="wizard-step">
                    <h3>Step 1: Select Agent Type</h3>
                    <div class="agent-type-selector">
                        <label class="radio-card @(selectedAgentType == "udm" ? "selected" : "")" @onclick='() => selectedAgentType = "udm"'>
                            <input type="radio" name="agentType" value="udm" checked="@(selectedAgentType == "udm")" />
                            <div class="card-icon">üñ•Ô∏è</div>
                            <div class="card-title">UDM/UCG Gateway Agent</div>
                            <div class="card-description">SQM, speedtest, latency monitoring</div>
                        </label>

                        <label class="radio-card @(selectedAgentType == "linux" ? "selected" : "")" @onclick='() => selectedAgentType = "linux"'>
                            <input type="radio" name="agentType" value="linux" checked="@(selectedAgentType == "linux")" />
                            <div class="card-icon">üêß</div>
                            <div class="card-title">Linux System Agent</div>
                            <div class="card-description">CPU, memory, disk, Docker stats</div>
                        </label>

                        <label class="radio-card @(selectedAgentType == "snmp" ? "selected" : "")" @onclick='() => selectedAgentType = "snmp"'>
                            <input type="radio" name="agentType" value="snmp" checked="@(selectedAgentType == "snmp")" />
                            <div class="card-icon">üì°</div>
                            <div class="card-title">SNMP Poller</div>
                            <div class="card-description">Switches, APs, SNMP devices</div>
                        </label>
                    </div>
                </div>

                <div class="wizard-step">
                    <h3>Step 2: Connection Details</h3>
                    <div class="form-group">
                        <label class="form-label">Hostname/IP Address</label>
                        <input type="text" class="form-control" @bind="agentHost" placeholder="192.168.1.1" />
                    </div>

                    @if (selectedAgentType != "snmp")
                    {
                        <div class="form-group">
                            <label class="form-label">SSH Username</label>
                            <input type="text" class="form-control" @bind="sshUsername" placeholder="root" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Authentication Method</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="authMethod" checked="@(authMethod == "password")" @onchange='() => authMethod = "password"' />
                                    <span>Password</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="authMethod" checked="@(authMethod == "key")" @onchange='() => authMethod = "key"' />
                                    <span>SSH Key</span>
                                </label>
                            </div>
                        </div>

                        @if (authMethod == "password")
                        {
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" @bind="sshPassword" />
                            </div>
                        }
                        else
                        {
                            <div class="form-group">
                                <label class="form-label">SSH Private Key Path</label>
                                <input type="text" class="form-control" @bind="sshKeyPath" placeholder="/app/ssh-keys/id_rsa" />
                            </div>
                        }

                        <button class="btn btn-secondary" @onclick="TestConnection">
                            @if (testingConnection)
                            {
                                <span class="spinner"></span>
                                <span>Testing...</span>
                            }
                            else
                            {
                                <span>Test Connection</span>
                            }
                        </button>

                        @if (!string.IsNullOrEmpty(connectionTestResult))
                        {
                            <div class="alert alert-@connectionTestClass">
                                @connectionTestResult
                            </div>
                        }
                    }
                </div>

                <div class="wizard-step">
                    <h3>Step 3: Deploy Agent</h3>
                    <div class="deployment-options">
                        <button class="btn btn-primary" @onclick="DeployAgent" disabled="@deployButtonDisabled">
                            Deploy via SSH
                        </button>
                        <button class="btn btn-secondary" @onclick="GenerateScripts">
                            Generate Scripts for Manual Install
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Agents -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Active Agents</h2>
        </div>
        <div class="card-body">
            <AgentStatusTable />
        </div>
    </div>
</div>

@code {
    private int activeAgents = 3;
    private int inactiveAgents = 1;
    private int totalMetrics = 1250;
    private int avgLatency = 15;

    private string selectedAgentType = "udm";
    private string agentHost = "";
    private string sshUsername = "root";
    private string authMethod = "key";
    private string sshPassword = "";
    private string sshKeyPath = "/app/ssh-keys/id_rsa";

    private bool testingConnection = false;
    private string connectionTestResult = "";
    private string connectionTestClass = "";
    private bool deployButtonDisabled => string.IsNullOrWhiteSpace(agentHost);

    protected override async Task OnInitializedAsync()
    {
        await LoadAgentData();
    }

    private async Task LoadAgentData()
    {
        var data = await AgentService.GetAgentSummaryAsync();
        activeAgents = data.ActiveCount;
        inactiveAgents = data.InactiveCount;
        totalMetrics = data.TotalMetrics;
        avgLatency = data.AvgLatency;
    }

    private async Task TestConnection()
    {
        testingConnection = true;
        connectionTestResult = "";
        StateHasChanged();

        try
        {
            await Task.Delay(1500); // Simulate connection test
            var success = await AgentService.TestConnectionAsync(agentHost, sshUsername, authMethod, sshPassword, sshKeyPath);

            if (success)
            {
                connectionTestResult = "‚úì Connected successfully";
                connectionTestClass = "success";
            }
            else
            {
                connectionTestResult = "‚úó Connection failed. Check credentials.";
                connectionTestClass = "danger";
            }
        }
        finally
        {
            testingConnection = false;
            StateHasChanged();
        }
    }

    private async Task DeployAgent()
    {
        // TODO: Implement agent deployment
        await Task.CompletedTask;
    }

    private async Task GenerateScripts()
    {
        // TODO: Implement script generation
        await Task.CompletedTask;
    }
}
