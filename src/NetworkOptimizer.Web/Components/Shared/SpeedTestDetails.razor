@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.UniFi.Models
@using NetworkOptimizer.Web.Services

<div class="speed-results">
    <div class="speed-result download">
        <div class="speed-icon">
            <svg viewBox="0 0 24 24" width="32" height="32">
                <path d="M12 4v12m0 0l-4-4m4 4l4-4M5 18h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div class="speed-details">
            <div class="speed-label">From Device <span class="tooltip-icon tooltip-icon-sm" data-tooltip="Data transferred from the tested device to this server">?</span></div>
            <div class="speed-value">@DownloadMbps.ToString("F1") <span class="speed-unit">Mbps</span></div>
            <div class="speed-meta">@FormatBytes(DownloadBytes) transferred</div>
        </div>
    </div>
    <div class="speed-result upload">
        <div class="speed-icon">
            <svg viewBox="0 0 24 24" width="32" height="32">
                <path d="M12 20V8m0 0l4 4m-4-4l-4 4M5 6h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div class="speed-details">
            <div class="speed-label">To Device <span class="tooltip-icon tooltip-icon-sm" data-tooltip="Data transferred to the tested device from this server">?</span></div>
            <div class="speed-value">@UploadMbps.ToString("F1") <span class="speed-unit">Mbps</span></div>
            <div class="speed-meta">@FormatBytes(UploadBytes) transferred</div>
        </div>
    </div>
</div>
@if (DownloadRetransmits > 0 || UploadRetransmits > 0)
{
    <div class="retransmits-info">
        <small>Retransmits: @DownloadRetransmits from / @UploadRetransmits to</small>
    </div>
}
<div class="test-details">
    <span>Device: @DeviceName (@DeviceHost)</span>
    <span>Duration: @DurationSeconds seconds</span>
    <span>Streams: @ParallelStreams parallel</span>
    <span>Time: @TestTime.ToLocalTime().ToString("g")</span>
</div>

@if (PathAnalysis != null)
{
    <div class="path-analysis">
        @if (PathAnalysis.Path.IsValid)
        {
            <div class="path-summary">
                <div class="path-max-speed">
                    <span class="speed-value">@FormatSpeed(PathAnalysis.Path.TheoreticalMaxMbps)</span>
                    <span class="speed-label">max</span>
                </div>
                <div class="efficiency-grades">
                    <div class="grade-item">
                        <span class="grade-badge @GetGradeClass(PathAnalysis.FromDeviceGrade)" title="From device to server">
                            ‚Üë @PathAnalysis.FromDeviceEfficiencyPercent.ToString("F0")%
                        </span>
                    </div>
                    <div class="grade-item">
                        <span class="grade-badge @GetGradeClass(PathAnalysis.ToDeviceGrade)" title="From server to device">
                            ‚Üì @PathAnalysis.ToDeviceEfficiencyPercent.ToString("F0")%
                        </span>
                    </div>
                </div>
            </div>

            @if (PathAnalysis.Path.Hops.Count > 0)
            {
                <div class="path-visualization">
                    @for (var i = 0; i < PathAnalysis.Path.Hops.Count; i++)
                    {
                        var hop = PathAnalysis.Path.Hops[i];
                        var hopSpeed = hop.IngressSpeedMbps > 0 ? hop.IngressSpeedMbps : hop.EgressSpeedMbps;
                        <div class="path-hop @(hop.IsBottleneck ? "bottleneck" : "") @GetHopTypeClass(hop.Type)">
                            <span class="hop-icon">@GetHopIcon(hop.Type)</span>
                            <span class="hop-name">@hop.DeviceName</span>
                            @if (hopSpeed > 0)
                            {
                                <span class="hop-speed">@FormatSpeed(hopSpeed)</span>
                            }
                        </div>
                        @if (i < PathAnalysis.Path.Hops.Count - 1)
                        {
                            <div class="path-connector">
                                <span class="connector-line"></span>
                            </div>
                        }
                    }
                </div>
            }

            @if (PathAnalysis.Path.HasRealBottleneck && !string.IsNullOrEmpty(PathAnalysis.Path.BottleneckDescription))
            {
                <div class="bottleneck-warning">
                    ‚ö†Ô∏è @PathAnalysis.Path.BottleneckDescription
                </div>
            }

            @if (PathAnalysis.Path.RequiresRouting)
            {
                <div class="routing-badge">
                    üîÄ Inter-VLAN via @(PathAnalysis.Path.GatewayDevice ?? "gateway")
                </div>
            }
        }
        else
        {
            <div class="path-error">
                @(PathAnalysis.Path.ErrorMessage ?? "Path analysis unavailable")
            </div>
        }

        @if (PathAnalysis.Insights.Count > 0 || PathAnalysis.Recommendations.Count > 0)
        {
            <div class="path-notes">
                @foreach (var insight in PathAnalysis.Insights)
                {
                    <div class="note insight">üí° @insight</div>
                }
                @foreach (var rec in PathAnalysis.Recommendations)
                {
                    <div class="note recommendation">üìà @rec</div>
                }
            </div>
        }
    </div>
}

@code {
    [Parameter] public double DownloadMbps { get; set; }
    [Parameter] public double UploadMbps { get; set; }
    [Parameter] public long DownloadBytes { get; set; }
    [Parameter] public long UploadBytes { get; set; }
    [Parameter] public int DownloadRetransmits { get; set; }
    [Parameter] public int UploadRetransmits { get; set; }
    [Parameter] public string DeviceName { get; set; } = "";
    [Parameter] public string DeviceHost { get; set; } = "";
    [Parameter] public int DurationSeconds { get; set; }
    [Parameter] public int ParallelStreams { get; set; }
    [Parameter] public DateTime TestTime { get; set; }

    /// <summary>
    /// Path analysis result (set automatically when using Result parameter)
    /// </summary>
    [Parameter] public PathAnalysisResult? PathAnalysis { get; set; }

    /// <summary>
    /// Convenience parameter to set all values from an Iperf3Result
    /// </summary>
    [Parameter] public Iperf3Result? Result { get; set; }

    /// <summary>
    /// Convenience parameter to set all values from a GatewaySpeedTestResult
    /// </summary>
    [Parameter] public GatewaySpeedTestResult? GatewayResult { get; set; }

    protected override void OnParametersSet()
    {
        if (Result != null)
        {
            DownloadMbps = Result.DownloadMbps;
            UploadMbps = Result.UploadMbps;
            DownloadBytes = Result.DownloadBytes;
            UploadBytes = Result.UploadBytes;
            DownloadRetransmits = Result.DownloadRetransmits;
            UploadRetransmits = Result.UploadRetransmits;
            DeviceName = Result.DeviceName ?? "";
            DeviceHost = Result.DeviceHost;
            DurationSeconds = Result.DurationSeconds;
            ParallelStreams = Result.ParallelStreams;
            TestTime = Result.TestTime;
            // Only use Result.PathAnalysis if no separate PathAnalysis was passed
            PathAnalysis ??= Result.PathAnalysis;
        }
        else if (GatewayResult != null)
        {
            DownloadMbps = GatewayResult.DownloadMbps;
            UploadMbps = GatewayResult.UploadMbps;
            DownloadBytes = GatewayResult.DownloadBytes;
            UploadBytes = GatewayResult.UploadBytes;
            DownloadRetransmits = GatewayResult.DownloadRetransmits;
            UploadRetransmits = GatewayResult.UploadRetransmits;
            DeviceName = "Gateway";
            DeviceHost = GatewayResult.GatewayHost ?? "";
            DurationSeconds = GatewayResult.DurationSeconds;
            ParallelStreams = GatewayResult.ParallelStreams;
            TestTime = GatewayResult.TestTime;
        }
    }

    private string FormatBytes(long bytes)
    {
        if (bytes < 1024)
            return $"{bytes} B";
        if (bytes < 1024 * 1024)
            return $"{bytes / 1024.0:F1} KB";
        if (bytes < 1024 * 1024 * 1024)
            return $"{bytes / (1024.0 * 1024.0):F1} MB";
        return $"{bytes / (1024.0 * 1024.0 * 1024.0):F2} GB";
    }

    private string FormatSpeed(int mbps)
    {
        if (mbps >= 1000)
        {
            var gbps = mbps / 1000.0;
            return gbps % 1 == 0 ? $"{(int)gbps} Gbps" : $"{gbps:F1} Gbps";
        }
        return $"{mbps} Mbps";
    }

    private string GetGradeClass(PerformanceGrade grade) => grade switch
    {
        PerformanceGrade.Excellent => "grade-excellent",
        PerformanceGrade.Good => "grade-good",
        PerformanceGrade.Fair => "grade-fair",
        PerformanceGrade.Poor => "grade-poor",
        PerformanceGrade.Critical => "grade-critical",
        _ => ""
    };

    private string GetHopTypeClass(HopType type) => type switch
    {
        HopType.Client => "hop-client",
        HopType.Switch => "hop-switch",
        HopType.AccessPoint => "hop-ap",
        HopType.Gateway => "hop-gateway",
        _ => ""
    };

    private string GetHopIcon(HopType type) => type switch
    {
        HopType.Client => "üíª",
        HopType.Switch => "üîÄ",
        HopType.AccessPoint => "üì°",
        HopType.Gateway => "üåê",
        _ => "‚Ä¢"
    };
}
