@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.WiFi
@using NetworkOptimizer.WiFi.Models
@using Microsoft.Extensions.Logging
@inject WiFiOptimizerService WiFiService
@inject UniFiConnectionService ConnectionService
@inject ILogger<ClientTimeline> Logger

<div class="client-timeline-container">
    <div class="timeline-header">
        <h3>Client Stats</h3>

        <div class="timeline-controls">
            <!-- Client Selector -->
            <div class="client-selector">
                <select class="form-select" @bind="_selectedClientMac" @bind:after="OnClientSelected">
                    <option value="">Select a client...</option>
                    @foreach (var client in _clients)
                    {
                        <option value="@client.Mac">@client.Name (@client.Mac)</option>
                    }
                </select>
            </div>

            <!-- Time Range -->
            <div class="time-range-selector">
                @foreach (var range in _timeRanges)
                {
                    <button class="time-btn @(range.Key == _selectedRange ? "active" : "")"
                            @onclick="() => SelectTimeRange(range.Key)"
                            disabled="@string.IsNullOrEmpty(_selectedClientMac)">
                        @range.Key
                    </button>
                }
            </div>
        </div>
    </div>

    @if (string.IsNullOrEmpty(_selectedClientMac))
    {
        <div class="timeline-empty">
            <p>Select a client to view their connection timeline</p>
        </div>
    }
    else if (_loading)
    {
        <div class="timeline-loading">
            <span class="spinner"></span>
            <span>Loading client data...</span>
        </div>
    }
    else
    {
        <!-- Client Info Banner -->
        @if (_selectedClient != null)
        {
            <div class="client-info-banner">
                <div class="client-info-main">
                    <span class="client-name">@_selectedClient.Name</span>
                    <span class="client-mac">@_selectedClient.Mac</span>
                </div>
                <div class="client-info-details">
                    <div class="info-item">
                        <span class="info-label">Connected To:</span>
                        <span class="info-value">@(_selectedClient.ApName ?? "Unknown AP")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Band:</span>
                        <span class="info-value band-badge @GetBandCssClass(_selectedClient.Band)">
                            @_selectedClient.Band.ToDisplayString()
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Channel:</span>
                        <span class="info-value">@(_selectedClient.Channel?.ToString() ?? "-")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Signal:</span>
                        <span class="info-value @GetSignalClass(_selectedClient.Signal)">
                            @(_selectedClient.Signal?.ToString() ?? "-") dBm
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">TX/RX Rate:</span>
                        <span class="info-value" data-tooltip="TX = AP transmits to client (download), RX = AP receives from client (upload)">@FormatRate(_selectedClient.TxRate) / @FormatRate(_selectedClient.RxRate)</span>
                    </div>
                </div>
            </div>
        }

        <!-- Signal Strength Chart -->
        <div class="timeline-chart-section">
            <div class="chart-header">
                <span class="chart-title">Signal Strength</span>
                <div class="chart-filters">
                    <label class="filter-checkbox">
                        <input type="checkbox" @bind="_showSignal" @bind:after="OnChartFilterChanged" />
                        <span class="checkbox-label signal">Signal</span>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" @bind="_showTxRetries" @bind:after="OnChartFilterChanged" />
                        <span class="checkbox-label retries">TX Retries</span>
                    </label>
                </div>
            </div>

            @if (_clientMetrics.Count > 0)
            {
                @* Key forces chart recreation when series visibility changes *@
                <ApexChart @ref="_signalChart" TItem="ClientChartPoint"
                           @key="_chartKey"
                           Options="_signalChartOptions"
                           Height="200">

                    @if (_showSignal)
                    {
                        <ApexPointSeries TItem="ClientChartPoint"
                                         Items="_signalData"
                                         Name="Signal (dBm)"
                                         SeriesType="SeriesType.Area"
                                         XValue="e => e.Timestamp"
                                         YValue="e => e.Value"
                                         OrderBy="e => e.X" />
                    }
                    @if (_showTxRetries)
                    {
                        <ApexPointSeries TItem="ClientChartPoint"
                                         Items="_txRetryData"
                                         Name="TX Retries %"
                                         SeriesType="SeriesType.Line"
                                         XValue="e => e.Timestamp"
                                         YValue="e => e.Value"
                                         OrderBy="e => e.X" />
                    }
                </ApexChart>
            }
            else
            {
                <div class="chart-empty">
                    <p>No historical data available for this client</p>
                </div>
            }
        </div>

        <!-- Connection Events List -->
        <div class="events-section">
            <div class="events-header">
                <span class="events-title">Connection Events</span>
                <span class="events-count">@_connectionEvents.Count events</span>
            </div>

            @if (_connectionEvents.Count == 0)
            {
                <div class="events-empty">
                    <p>No connection events recorded</p>
                </div>
            }
            else
            {
                <div class="events-list">
                    @foreach (var evt in _connectionEvents.Take(50))
                    {
                        <div class="event-item @GetEventTypeClass(evt.Type)">
                            <div class="event-icon">@GetEventIcon(evt.Type)</div>
                            <div class="event-content">
                                <div class="event-title">@GetEventTitle(evt)</div>
                                <div class="event-details">@GetEventDetails(evt)</div>
                            </div>
                            <div class="event-time">@evt.Timestamp.ToLocalTime().ToString("MMM d, h:mm tt")</div>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    private bool _loading = false;
    private string _selectedClientMac = "";
    private string _selectedRange = "1D";
    private bool _showSignal = true;
    private bool _showTxRetries = true;
    private string _chartKey = "signal_retries"; // Key to force chart recreation

    private List<WirelessClientSnapshot> _clients = new();
    private WirelessClientSnapshot? _selectedClient;
    private List<ClientWiFiMetrics> _clientMetrics = new();
    private List<ClientConnectionEvent> _connectionEvents = new();

    // Chart data
    private ApexChart<ClientChartPoint>? _signalChart;
    private ApexChartOptions<ClientChartPoint> _signalChartOptions = new();
    private List<ClientChartPoint> _signalData = new();
    private List<ClientChartPoint> _txRetryData = new();

    private readonly Dictionary<string, TimeSpan> _timeRanges = new()
    {
        { "1h", TimeSpan.FromHours(1) },
        { "1D", TimeSpan.FromDays(1) },
        { "1W", TimeSpan.FromDays(7) },
        { "1M", TimeSpan.FromDays(30) }
    };

    protected override async Task OnInitializedAsync()
    {
        InitializeChartOptions();
        await LoadClientsAsync();
    }

    private void InitializeChartOptions()
    {
        _signalChartOptions = new ApexChartOptions<ClientChartPoint>
        {
            Chart = new Chart
            {
                Background = "transparent",
                Toolbar = new Toolbar { Show = false },
                Zoom = new Zoom { Enabled = true },
                Animations = new Animations { Enabled = true, Speed = 300 }
            },
            Xaxis = new XAxis
            {
                Type = XAxisType.Datetime,
                Labels = new XAxisLabels
                {
                    Style = new AxisLabelStyle { Colors = "#9ca3af" },
                    DatetimeFormatter = new DatetimeFormatter
                    {
                        Hour = "HH:mm",
                        Day = "MMM dd"
                    }
                }
            },
            Grid = new Grid { BorderColor = "#374151", StrokeDashArray = 3 },
            Stroke = new Stroke { Curve = Curve.Smooth, Width = 2 },
            Legend = new Legend { Show = false },
            Tooltip = new Tooltip
            {
                Theme = Mode.Dark,
                X = new TooltipX { Format = "MMM dd, HH:mm" }
            }
        };

        // Set up Y-axes, colors, and fill based on initial filter state
        UpdateChartOptionsForVisibleSeries();
    }

    private async Task LoadClientsAsync()
    {
        _clients = await WiFiService.GetWirelessClientsAsync();
    }

    private async Task OnClientSelected()
    {
        if (string.IsNullOrEmpty(_selectedClientMac))
        {
            _selectedClient = null;
            _clientMetrics.Clear();
            _connectionEvents.Clear();
            return;
        }

        await LoadClientDataAsync();
    }

    private async Task SelectTimeRange(string range)
    {
        _selectedRange = range;
        if (!string.IsNullOrEmpty(_selectedClientMac))
        {
            await LoadClientDataAsync();
        }
    }

    private async Task LoadClientDataAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Get current client info
            _selectedClient = _clients.FirstOrDefault(c => c.Mac == _selectedClientMac);

            // Get historical metrics
            var end = DateTimeOffset.UtcNow;
            var start = end - _timeRanges[_selectedRange];

            var granularity = _selectedRange switch
            {
                "1h" => MetricGranularity.FiveMinutes,
                "1D" => MetricGranularity.FiveMinutes,
                "1W" => MetricGranularity.Hourly,
                "1M" => MetricGranularity.Daily,
                _ => MetricGranularity.FiveMinutes
            };

            Logger.LogInformation("Loading client metrics for {Mac}, range={Range}, granularity={Gran}",
                _selectedClientMac, _selectedRange, granularity);

            _clientMetrics = await WiFiService.GetClientMetricsAsync(_selectedClientMac, start, end, granularity);

            Logger.LogInformation("Loaded {Count} client metrics data points", _clientMetrics.Count);

            // Transform for charts
            TransformChartData();

            Logger.LogInformation("Transformed chart data: Signal={SignalCount}, TxRetry={RetryCount}",
                _signalData.Count, _txRetryData.Count);

            // Fetch real connection events from UniFi
            _connectionEvents = await WiFiService.GetClientConnectionEventsAsync(_selectedClientMac);
            // Filter to time range and sort newest first
            _connectionEvents = _connectionEvents
                .Where(e => e.Timestamp >= start && e.Timestamp <= end)
                .OrderByDescending(e => e.Timestamp)
                .ToList();

            Logger.LogInformation("Loaded {Count} connection events", _connectionEvents.Count);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void TransformChartData()
    {
        // Create new lists to trigger Blazor change detection
        var newSignalData = new List<ClientChartPoint>();
        var newTxRetryData = new List<ClientChartPoint>();

        foreach (var metric in _clientMetrics.OrderBy(m => m.Timestamp))
        {
            var ts = metric.Timestamp.ToLocalTime().DateTime;

            if (metric.Signal.HasValue)
            {
                newSignalData.Add(new ClientChartPoint(ts, metric.Signal.Value));
            }

            newTxRetryData.Add(new ClientChartPoint(ts, metric.TxRetryPct ?? 0));
        }

        _signalData = newSignalData;
        _txRetryData = newTxRetryData;

        // Ensure chart options match current filter state
        UpdateChartOptionsForVisibleSeries();
    }

    private Task OnChartFilterChanged()
    {
        // Rebuild chart options to match visible series
        UpdateChartOptionsForVisibleSeries();

        // Update the key to force chart recreation with new series/colors/axes
        _chartKey = $"{_showSignal}_{_showTxRetries}_{DateTime.UtcNow.Ticks}";

        return Task.CompletedTask;
    }

    private void UpdateChartOptionsForVisibleSeries()
    {
        var yAxes = new List<YAxis>();
        var colors = new List<string>();
        var fillTypes = new List<FillType>();

        if (_showSignal)
        {
            yAxes.Add(new YAxis
            {
                SeriesName = "Signal (dBm)",
                Min = -100,
                Max = -20,
                Labels = new YAxisLabels
                {
                    Style = new AxisLabelStyle { Colors = "#3b82f6" },
                    Formatter = "function(val) { return val + ' dBm'; }"
                }
            });
            colors.Add("#3b82f6");
            fillTypes.Add(FillType.Gradient);
        }

        if (_showTxRetries)
        {
            yAxes.Add(new YAxis
            {
                SeriesName = "TX Retries %",
                Opposite = _showSignal, // Only opposite if signal is also shown
                Min = 0,
                Max = 100,
                Labels = new YAxisLabels
                {
                    Style = new AxisLabelStyle { Colors = "#ef4444" },
                    Formatter = "function(val) { return val.toFixed(1) + '%'; }"
                }
            });
            colors.Add("#ef4444");
            fillTypes.Add(FillType.Solid);
        }

        // Update chart options
        _signalChartOptions.Yaxis = yAxes;
        _signalChartOptions.Colors = colors;
        _signalChartOptions.Fill = new Fill
        {
            Type = fillTypes,
            Gradient = new FillGradient
            {
                ShadeIntensity = 0.3,
                OpacityFrom = 0.4,
                OpacityTo = 0.1
            }
        };
    }

    private string GetEventTitle(ClientConnectionEvent evt) => evt.Type switch
    {
        ClientConnectionEventType.Roamed => $"Roamed to {evt.ToApName ?? "unknown AP"}",
        ClientConnectionEventType.Connected => $"Connected to {evt.ApName ?? "AP"}",
        ClientConnectionEventType.Disconnected => "Disconnected",
        _ => "Event"
    };

    private string GetEventDetails(ClientConnectionEvent evt) => evt.Type switch
    {
        ClientConnectionEventType.Roamed =>
            $"{evt.FromApName ?? "?"} → {evt.ToApName ?? "?"}" +
            (evt.PreviousSignal.HasValue && evt.Signal.HasValue
                ? $" ({evt.PreviousSignal} → {evt.Signal} dBm)"
                : "") +
            (!string.IsNullOrEmpty(evt.RadioBand)
                ? $" · {evt.GetRadioBandDisplay()}"
                : ""),

        ClientConnectionEventType.Connected =>
            (evt.WifiStats ?? "") +
            (!string.IsNullOrEmpty(evt.IpAddress) ? $" · IP: {evt.IpAddress}" : ""),

        ClientConnectionEventType.Disconnected =>
            (!string.IsNullOrEmpty(evt.Duration) ? $"Duration: {evt.Duration}" : "") +
            (!string.IsNullOrEmpty(evt.DataUp) && !string.IsNullOrEmpty(evt.DataDown)
                ? $" · {evt.DataUp} up / {evt.DataDown} down"
                : "") +
            (evt.Signal.HasValue ? $" · Last signal: {evt.Signal} dBm" : ""),

        _ => evt.WifiStats ?? ""
    };

    private string GetBandCssClass(RadioBand band) => band switch
    {
        RadioBand.Band2_4GHz => "band-2ghz",
        RadioBand.Band5GHz => "band-5ghz",
        RadioBand.Band6GHz => "band-6ghz",
        _ => ""
    };

    private string GetSignalClass(int? signal) => signal switch
    {
        >= -50 => "signal-excellent",
        >= -60 => "signal-good",
        >= -70 => "signal-fair",
        _ => "signal-poor"
    };

    private string FormatRate(long? rateKbps)
    {
        if (!rateKbps.HasValue) return "-";
        var rateMbps = rateKbps.Value / 1000.0;
        return rateMbps >= 1000 ? $"{rateMbps / 1000.0:F1} Gbps" : $"{rateMbps:F0} Mbps";
    }

    private string GetEventTypeClass(ClientConnectionEventType type) => type switch
    {
        ClientConnectionEventType.Connected => "event-connect",
        ClientConnectionEventType.Disconnected => "event-disconnect",
        ClientConnectionEventType.Roamed => "event-roam",
        _ => ""
    };

    private string GetEventIcon(ClientConnectionEventType type) => type switch
    {
        ClientConnectionEventType.Connected => "+",
        ClientConnectionEventType.Disconnected => "-",
        ClientConnectionEventType.Roamed => "→",
        _ => "•"
    };

    public class ClientChartPoint
    {
        public DateTime Timestamp { get; set; }
        public decimal Value { get; set; }
        public long X => new DateTimeOffset(Timestamp).ToUnixTimeMilliseconds();

        public ClientChartPoint(DateTime timestamp, double value)
        {
            Timestamp = timestamp;
            Value = (decimal)value;
        }
    }
}
