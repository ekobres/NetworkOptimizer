@using NetworkOptimizer.Web.Services
@inject GatewaySpeedTestService SpeedTestService

<div class="speed-test-panel">
    @if (isLoading)
    {
        <div class="loading-state">
            <span class="spinner"></span>
            <span>Loading...</span>
        </div>
    }
    else if (!isConfigured)
    {
        <div class="sqm-unavailable">
            <div class="sqm-status">
                <span class="status-indicator status-disconnected"></span>
                <span class="status-label">Not Configured</span>
            </div>
            <p class="status-message">Gateway SSH not configured for speed tests.</p>
            <div class="sqm-actions">
                <a href="/settings" class="btn btn-sm btn-primary">Configure Gateway</a>
            </div>
        </div>
    }
    else
    {
        <div class="sqm-header">
            <div class="sqm-status">
                <span class="status-indicator status-@(lastResult?.Success == true ? "active" : "disconnected")"></span>
                <span class="status-label">Gateway Speed Test</span>
            </div>
            @if (lastResult != null)
            {
                <div class="tc-timestamp">
                    <small>Last test: @lastResult.TestTime.ToLocalTime().ToString("g")</small>
                </div>
            }
        </div>

        @if (lastResult != null && lastResult.Success)
        {
            <!-- Speed Results -->
            <div class="speed-results">
                <div class="speed-result download">
                    <div class="speed-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                            <path d="M12 4v12m0 0l-4-4m4 4l4-4M5 18h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="speed-info">
                        <div class="speed-value">@lastResult.DownloadMbps.ToString("F1")</div>
                        <div class="speed-label">Mbps Down</div>
                    </div>
                </div>
                <div class="speed-result upload">
                    <div class="speed-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                            <path d="M12 20V8m0 0l4 4m-4-4l-4 4M5 6h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="speed-info">
                        <div class="speed-value">@lastResult.UploadMbps.ToString("F1")</div>
                        <div class="speed-label">Mbps Up</div>
                    </div>
                </div>
            </div>

            @if (lastResult.DownloadRetransmits > 0 || lastResult.UploadRetransmits > 0)
            {
                <div class="retransmits-info">
                    <small>Retransmits: @lastResult.DownloadRetransmits down / @lastResult.UploadRetransmits up</small>
                </div>
            }
        }
        else if (lastResult != null && !lastResult.Success)
        {
            <div class="test-error">
                <p>@lastResult.Error</p>
            </div>
        }
        else
        {
            <div class="no-results">
                <p>No speed test results yet. Run a test to measure gateway bandwidth.</p>
            </div>
        }

        <div class="sqm-actions">
            <button class="btn btn-sm btn-primary" @onclick="RunSpeedTest" disabled="@isRunning">
                @if (isRunning)
                {
                    <span class="spinner-sm"></span>
                    <span>Testing... (@testProgress)</span>
                }
                else
                {
                    <span>Run Speed Test</span>
                }
            </button>
            <a href="/settings" class="btn btn-sm btn-secondary">Settings</a>
        </div>
    }
</div>

<style>
    .speed-test-panel {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .speed-results {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .speed-result {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--card-bg-secondary, #1a1d23);
        border-radius: 8px;
    }

    .speed-result.download .speed-icon {
        color: var(--success-color, #22c55e);
    }

    .speed-result.upload .speed-icon {
        color: var(--info-color, #0ea5e9);
    }

    .speed-info {
        display: flex;
        flex-direction: column;
    }

    .speed-value {
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1;
        color: var(--text-primary, #fff);
    }

    .speed-label {
        font-size: 0.75rem;
        color: var(--text-muted, #888);
        text-transform: uppercase;
    }

    .retransmits-info {
        text-align: center;
        color: var(--text-muted, #888);
        font-size: 0.8rem;
    }

    .test-error {
        padding: 1rem;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 8px;
        color: var(--danger-color, #ef4444);
        font-size: 0.9rem;
    }

    .no-results {
        padding: 1rem;
        text-align: center;
        color: var(--text-muted, #888);
        font-size: 0.9rem;
    }
</style>

@code {
    private bool isLoading = true;
    private bool isConfigured = false;
    private bool isRunning = false;
    private string testProgress = "";
    private GatewaySpeedTestResult? lastResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var settings = await SpeedTestService.GetSettingsAsync();
            isConfigured = settings.Enabled && settings.HasCredentials && !string.IsNullOrEmpty(settings.Host);
            lastResult = SpeedTestService.GetLastResult();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RunSpeedTest()
    {
        isRunning = true;
        testProgress = "Starting...";
        StateHasChanged();

        try
        {
            testProgress = "Checking iperf3...";
            StateHasChanged();
            await Task.Delay(100); // Let UI update

            testProgress = "Download test...";
            StateHasChanged();

            lastResult = await SpeedTestService.RunSpeedTestAsync();
        }
        finally
        {
            isRunning = false;
            StateHasChanged();
        }
    }
}
