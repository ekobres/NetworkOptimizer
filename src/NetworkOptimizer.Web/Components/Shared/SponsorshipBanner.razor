@using NetworkOptimizer.Web.Services
@inject ISponsorshipService SponsorshipService

@if (_nag != null)
{
    <div class="sponsorship-banner">
        <div class="banner-content">
            <span class="banner-icon">&#x2665;</span>
            <div class="banner-text">
                <strong>@_nag.Quip</strong>
                <span>
                    <a href="@_nag.ActionUrl" target="_blank" rel="noopener noreferrer">@_nag.ActionText</a>
                    <span class="banner-separator">&nbsp;|&nbsp;</span>
                    <span class="banner-commercial">Commercial use? Email <a href="mailto:tj@ozarkconnect.net">tj@ozarkconnect.net</a> for licensing.</span>
                </span>
            </div>
            <div class="banner-actions">
                <button class="btn-sponsor" @onclick="AlreadySponsorAsync">I already sponsor</button>
                <button class="btn-dismiss" @onclick="DismissAsync">Dismiss</button>
            </div>
        </div>
    </div>
}

@code {
    /// <summary>
    /// When true, always shows the banner (for Settings page preview).
    /// When false (default), respects daily limit and progressive display.
    /// </summary>
    [Parameter]
    public bool AlwaysShow { get; set; } = false;

    private SponsorshipNag? _nag;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadNagAsync();
        }
    }

    private async Task LoadNagAsync()
    {
        try
        {
            _nag = await SponsorshipService.GetCurrentNagAsync(AlwaysShow);

            if (_nag != null)
            {
                await InvokeAsync(StateHasChanged);
            }
        }
        catch
        {
            // Silently fail - sponsorship banner is non-critical
        }
    }

    private async Task DismissAsync()
    {
        if (_nag != null && !AlwaysShow)
        {
            try
            {
                await SponsorshipService.MarkLevelShownAsync(_nag.Level);
            }
            catch
            {
                // Still hide it
            }
        }
        _nag = null;
        StateHasChanged();
    }

    private async Task AlreadySponsorAsync()
    {
        try
        {
            await SponsorshipService.MarkAsAlreadySponsorAsync();
        }
        catch
        {
            // Still hide it
        }
        _nag = null;
        StateHasChanged();
    }
}
