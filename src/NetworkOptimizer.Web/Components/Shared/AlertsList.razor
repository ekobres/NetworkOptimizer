@using NetworkOptimizer.Web.Services
@inject UniFiConnectionService ConnectionService
@inject AuditService AuditService

<div class="alerts-list">
    @if (isLoading)
    {
        <div class="loading-state">
            <span class="spinner"></span>
            <span>Loading alerts...</span>
        </div>
    }
    else if (ConnectionService.IsInitialized && !ConnectionService.IsConnected)
    {
        <div class="no-alerts">
            <div class="no-alerts-icon">!</div>
            <p>Connect to a UniFi controller to view alerts.</p>
            <a href="/settings" class="btn btn-sm btn-primary">Go to Settings</a>
        </div>
    }
    else if (!ConnectionService.IsInitialized)
    {
        <div class="loading-state">
            <span class="spinner"></span>
            <span>Connecting...</span>
        </div>
    }
    else if (!alerts.Any())
    {
        <div class="no-alerts">
            <div class="no-alerts-icon">âœ“</div>
            <p>No active alerts. Your network is running smoothly!</p>
        </div>
    }
    else
    {
        @foreach (var alert in GetDisplayAlerts())
        {
            <div class="alert-item alert-@alert.Severity.ToLower()">
                <div class="alert-icon">
                    @((MarkupString)GetAlertIcon(alert.Severity))
                </div>
                <div class="alert-content">
                    <div class="alert-header">
                        <h4 class="alert-title">@alert.Title</h4>
                        <span class="alert-time">@alert.Time</span>
                    </div>
                    <p class="alert-message">@alert.Message</p>
                    @if (!string.IsNullOrEmpty(alert.Source))
                    {
                        <div class="alert-source">Source: @alert.Source</div>
                    }
                </div>
                <div class="alert-actions">
                    <button class="btn btn-sm btn-ghost" @onclick="() => DismissAlert(alert.Id)">
                        Dismiss
                    </button>
                    @if (!string.IsNullOrEmpty(alert.ActionUrl))
                    {
                        <a href="@alert.ActionUrl" class="btn btn-sm btn-primary">
                            View Details
                        </a>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int? MaxItems { get; set; }

    [Parameter]
    public EventCallback OnAlertDismissed { get; set; }

    private List<AlertInfo> alerts = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        // Wait for connection service to initialize before loading alerts
        await ConnectionService.EnsureInitializedAsync();
        await LoadAlerts();
    }

    private async Task LoadAlerts()
    {
        isLoading = true;
        try
        {
            alerts.Clear();

            if (!ConnectionService.IsConnected)
            {
                return;
            }

            // Use active (non-dismissed) issues - only actionable ones (Critical/Recommended)
            // TODO: Once we have clients with many alerts, move filtering and Take() to backend/query side
            var activeIssues = await AuditService.GetActiveIssuesAsync();
            var actionableIssues = activeIssues
                .Where(i => i.Severity == "Critical" || i.Severity == "Recommended")
                .OrderBy(i => i.Severity == "Critical" ? 0 : 1) // Critical first
                .ThenBy(i => i.Category) // Then by category for grouping
                .ToList();

            if (actionableIssues.Any())
            {
                var id = 1;
                var timeAgo = AuditService.LastAuditTime.HasValue
                    ? FormatTimeAgo(AuditService.LastAuditTime.Value)
                    : "Recently";

                foreach (var issue in actionableIssues.Take(10))
                {
                    alerts.Add(new AlertInfo
                    {
                        Id = id++,
                        Severity = issue.Severity,
                        Title = issue.Title,
                        Message = issue.Description,
                        Source = issue.Category,
                        Time = timeAgo,
                        ActionUrl = "/audit",
                        IssueKey = AuditService.GetIssueKey(issue)
                    });
                }
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private string FormatTimeAgo(DateTime time)
    {
        var elapsed = DateTime.UtcNow - time;
        if (elapsed.TotalMinutes < 1)
            return "Just now";
        if (elapsed.TotalMinutes < 60)
            return $"{(int)elapsed.TotalMinutes} mins ago";
        if (elapsed.TotalHours < 24)
            return $"{(int)elapsed.TotalHours} hours ago";
        return $"{(int)elapsed.TotalDays} days ago";
    }

    private IEnumerable<AlertInfo> GetDisplayAlerts()
    {
        var displayAlerts = alerts.AsEnumerable();
        if (MaxItems.HasValue)
        {
            displayAlerts = displayAlerts.Take(MaxItems.Value);
        }
        return displayAlerts;
    }

    private string GetAlertIcon(string severity)
    {
        return severity.ToLower() switch
        {
            // Shield with X - critical/danger
            "critical" => """<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 2L3 7v6c0 5.25 3.85 10.15 9 11 5.15-.85 9-5.75 9-11V7l-9-5zm-1 14h2v2h-2v-2zm0-8h2v6h-2V8z" opacity="0.2"/><path d="M12 2L3 7v6c0 5.25 3.85 10.15 9 11 5.15-.85 9-5.75 9-11V7l-9-5zm0 2.18l7 3.89v5.43c0 4.14-3.01 8.05-7 8.88-3.99-.83-7-4.74-7-8.88V8.07l7-3.89zM11 8h2v6h-2V8zm0 8h2v2h-2v-2z"/></svg>""",
            // Triangle with exclamation - recommended (was warning)
            "recommended" => """<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M1 21h22L12 2 1 21z" opacity="0.2"/><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14h-2v2h2v-2zm0-6h-2v4h2v-4z"/></svg>""",
            // Circle with i - info
            "info" or "informational" => """<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-11h2v6h-2v-6zm0-4h2v2h-2V7z"/></svg>""",
            _ => """<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>"""
        };
    }

    private async Task DismissAlert(int alertId)
    {
        var alert = alerts.FirstOrDefault(a => a.Id == alertId);
        if (alert != null)
        {
            // Find the original issue and dismiss it in the service
            var activeIssues = await AuditService.GetActiveIssuesAsync();
            var issue = activeIssues.FirstOrDefault(i => AuditService.GetIssueKey(i) == alert.IssueKey);
            if (issue != null)
            {
                await AuditService.DismissIssueAsync(issue);
            }
            alerts.Remove(alert);

            // Notify parent to refresh counts
            await OnAlertDismissed.InvokeAsync();
        }
        StateHasChanged();
    }

    public class AlertInfo
    {
        public int Id { get; set; }
        public string Severity { get; set; } = "";
        public string Title { get; set; } = "";
        public string Message { get; set; } = "";
        public string Source { get; set; } = "";
        public string Time { get; set; } = "";
        public string? ActionUrl { get; set; }
        public string IssueKey { get; set; } = "";
    }
}
