@using NetworkOptimizer.Web.Services
@inject AgentService AgentService

<div class="agent-status-table">
    @if (isLoading)
    {
        <div class="loading-state">
            <span class="spinner"></span>
            <span>Loading agents...</span>
        </div>
    }
    else if (!agents.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">robot</div>
            <h3>No Agents Deployed</h3>
            <p>Deploy monitoring agents to start collecting metrics.</p>
            <a href="/agents" class="btn btn-primary">Deploy Agent</a>
        </div>
    }
    else
    {
        <table class="data-table">
            <thead>
                <tr>
                    <th>Agent Name</th>
                    <th>Type</th>
                    <th>Host</th>
                    <th>Status</th>
                    <th>Last Check-in</th>
                    <th>Metrics/min</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var agent in GetDisplayAgents())
                {
                    <tr class="agent-row agent-@agent.Status.ToLower()">
                        <td>
                            <div class="agent-name">
                                <span class="agent-icon">@GetAgentIcon(agent.Type)</span>
                                <span>@agent.Name</span>
                            </div>
                        </td>
                        <td>@agent.Type</td>
                        <td>@agent.Host</td>
                        <td>
                            <span class="status-badge status-@agent.Status.ToLower()">
                                <span class="status-dot"></span>
                                @agent.Status
                            </span>
                        </td>
                        <td>@FormatLastCheckIn(agent.LastCheckIn)</td>
                        <td>@agent.MetricsPerMin</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-secondary" @onclick="() => ViewAgent(agent.Id)">
                                    View
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => RemoveAgent(agent.Id)">
                                    Remove
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    [Parameter]
    public int? MaxAgents { get; set; }

    private List<AgentDetails> agents = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadAgents();
    }

    private async Task LoadAgents()
    {
        isLoading = true;
        try
        {
            agents = await AgentService.GetAllAgentsAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private IEnumerable<AgentDetails> GetDisplayAgents()
    {
        var displayAgents = agents.AsEnumerable();
        if (MaxAgents.HasValue)
        {
            displayAgents = displayAgents.Take(MaxAgents.Value);
        }
        return displayAgents;
    }

    private string FormatLastCheckIn(DateTime lastCheckIn)
    {
        var elapsed = DateTime.UtcNow - lastCheckIn;
        if (elapsed.TotalSeconds < 60)
            return $"{(int)elapsed.TotalSeconds}s ago";
        if (elapsed.TotalMinutes < 60)
            return $"{(int)elapsed.TotalMinutes}m ago";
        if (elapsed.TotalHours < 24)
            return $"{(int)elapsed.TotalHours}h ago";
        return $"{(int)elapsed.TotalDays}d ago";
    }

    private string GetAgentIcon(string agentType)
    {
        return agentType.ToLower() switch
        {
            "udm/ucg" => "globe",
            "linux" => "terminal",
            "snmp" => "broadcast",
            _ => "robot"
        };
    }

    private void ViewAgent(int agentId)
    {
        // TODO: Navigate to agent details
    }

    private async Task RemoveAgent(int agentId)
    {
        await AgentService.RemoveAgentAsync(agentId);
        await LoadAgents();
    }
}
